<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Đệm hát – Pattern tay phải (CDN Guitar) – Debug build</title>

  <!-- CDN: soundfont-player (cần internet) -->
  <script src="https://cdn.jsdelivr.net/npm/soundfont-player@0.12.0/dist/soundfont-player.min.js"></script>

  <style>
    :root{
      --text:#e8eef7; --muted:#9fb0c7; --accent:#6aa9ff;
      --danger:#ff6a6a; --good:#52d18f; --line:rgba(255,255,255,.10);
    }
    *{box-sizing:border-box}
    body{
      margin:0; color:var(--text);
      font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background:linear-gradient(180deg,#070a0f 0%, #0b0f14 40%, #070a0f 100%);
      padding:env(safe-area-inset-top) 0 env(safe-area-inset-bottom) 0;
    }
    header{
      position:sticky; top:0; z-index:10;
      background:rgba(11,15,20,.78); backdrop-filter: blur(10px);
      border-bottom:1px solid rgba(255,255,255,.08);
      padding:12px 14px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .title{font-weight:950}
    .status{font-size:12px;color:var(--muted);display:flex;align-items:center;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .dot{width:10px;height:10px;border-radius:999px;background:var(--danger);box-shadow:0 0 0 3px rgba(255,106,106,.14)}
    .dot.on{background:var(--good);box-shadow:0 0 0 3px rgba(82,209,143,.16)}
    main{padding:14px}
    .grid{max-width:1040px;margin:0 auto;display:grid;gap:12px}
    .card{
      background:rgba(18,26,36,.88);
      border:1px solid rgba(255,255,255,.08);
      border-radius:14px; overflow:hidden;
      box-shadow:0 10px 30px rgba(0,0,0,.25);
    }
    .hd{
      padding:10px 12px;
      background:rgba(15,22,32,.92);
      border-bottom:1px solid rgba(255,255,255,.08);
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
    }
    .bd{padding:12px}
    .big{display:flex;align-items:baseline;gap:10px;flex-wrap:wrap}
    .cur{font-size:42px;font-weight:950;color:var(--accent);letter-spacing:.3px}
    .next{font-size:14px;color:var(--muted)}
    .hint{color:var(--muted);font-size:13px;line-height:1.5}
    .controls{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-top:10px}
    button, select{
      appearance:none;
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:12px 10px; border-radius:12px;
      font-weight:900;
      -webkit-tap-highlight-color:transparent;
    }
    button{cursor:pointer; user-select:none}
    button:active{transform:scale(.98)}
    button.primary{background:rgba(106,169,255,.18);border-color:rgba(106,169,255,.35)}
    button.danger{background:rgba(255,106,106,.14);border-color:rgba(255,106,106,.30)}
    button.good{background:rgba(82,209,143,.14);border-color:rgba(82,209,143,.30)}
    .lyrics{font-size:18px;line-height:1.75;white-space:pre-wrap}
    .ch{
      display:inline-block;
      padding:.08em .38em; margin:0 .10em;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.05);
      color:#cfe2ff;
      font-weight:950;
      cursor:pointer;
    }
    .ch.active{
      background:rgba(106,169,255,.25);
      border-color:rgba(106,169,255,.55);
      box-shadow:0 0 0 3px rgba(106,169,255,.18);
    }
    .footer{
      position:sticky; bottom:0; z-index:20;
      background:rgba(11,15,20,.85); backdrop-filter: blur(10px);
      border-top:1px solid rgba(255,255,255,.08);
      padding:10px 14px;
    }
    .footer .row{
      max-width:1040px;margin:0 auto;
      display:grid;grid-template-columns:1fr 1.3fr 1fr;gap:10px
    }
    .pill{
      font-size:12px;color:var(--muted);
      padding:6px 10px;border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      display:inline-flex;gap:8px;align-items:center;justify-content:center;
      white-space:nowrap;
    }
    .pill b{color:var(--text)}
    .split{display:flex;gap:10px;justify-content:center;align-items:center;flex-wrap:wrap}
    input[type="range"]{width:180px}
    .beats{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .beat{
      width:34px;height:34px;border-radius:10px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.04);
      display:flex;align-items:center;justify-content:center;
      color:var(--muted);font-weight:950;
    }
    .beat.on{
      background:rgba(82,209,143,.16);
      border-color:rgba(82,209,143,.35);
      color:var(--text);
      box-shadow:0 0 0 3px rgba(82,209,143,.14);
    }

    #gate{
      position:fixed; inset:0; z-index:9999;
      background:rgba(0,0,0,.72);
      display:flex; align-items:center; justify-content:center;
      padding:24px;
    }
    #gate .box{
      width:min(720px,100%);
      border-radius:16px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(18,26,36,.92);
      box-shadow:0 18px 60px rgba(0,0,0,.45);
      padding:18px;
    }
    #gate h2{margin:0 0 8px 0;font-size:18px}
    #gate p{margin:0 0 12px 0;color:var(--muted);line-height:1.5}
    #gate button{width:100%;padding:14px 12px;font-size:18px}
    .patnote{color:var(--muted);font-size:13px}
    .err{
      margin-top:10px;
      border:1px solid rgba(255,106,106,.35);
      background:rgba(255,106,106,.10);
      color:#ffd4d4;
      padding:10px 12px;
      border-radius:12px;
      font-size:13px;
      display:none;
      white-space:pre-wrap;
    }

    details.card summary{
      list-style:none;
      cursor:pointer;
      user-select:none;
      padding:10px 12px;
      font-weight:950;
      background:rgba(15,22,32,.92);
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    details.card summary::-webkit-details-marker{display:none}
    .optGrid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }
    @media (max-width:720px){
      .optGrid{grid-template-columns:1fr;}
    }
    .optRow{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:8px 10px;border-radius:14px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
    }
    .optRow span{color:var(--muted);font-size:12px;font-weight:900}
    .optRow select{padding:10px 10px;border-radius:12px}
  </style>
</head>

<body>
  <div id="gate">
    <div class="box">
      <h2>Bật âm thanh + tải tiếng guitar (CDN)</h2>
      <p>
        Chạm nút dưới để trình duyệt cho phép audio (iOS cần “unlock”). Sau đó app tải tiếng guitar qua CDN (cần internet).
      </p>
      <button class="primary" id="gateBtn">Tap to Enable Audio</button>
      <div id="gateErr" class="err"></div>
      <p class="patnote" style="margin-top:10px">
        Nếu mở bằng Zalo/Facebook in-app hoặc mở file dạng file:// trong Files, hãy “Open in Safari/Chrome” và tốt nhất mở qua http/https.
      </p>
      <p class="patnote" style="margin-top:8px">
        Nếu các CDN bị chặn (jsDelivr/GitHub Pages), instrument sẽ không load được và app chỉ chạy “silent mode”.
      </p>
    </div>
  </div>

  <header>
    <div class="title">Đệm hát – Pattern tay phải (CDN guitar) – Debug build</div>
    <div class="status">
      <span class="dot" id="audDot"></span><span id="audText">Audio: chưa bật</span>
      <span class="pill">Beat: <b id="beatText">—</b></span>
      <span class="pill">Mode: <b id="modeText">Silent</b></span>
    </div>
  </header>

  <main>
    <div class="grid">

      <section class="card">
        <div class="hd">
          <div>
            <div class="big">
              <div class="cur" id="curChord">—</div>
              <div class="next" id="nextChord">Next: —</div>
            </div>
            <div class="hint">
              Bấm <b>NEXT</b> để đổi hợp âm. Pattern chạy liên tục để bạn bám nhịp mà hát.
              Nếu thấy “lạc quẻ”, mở <b>Debug options</b> để thử từng giả thuyết (U kéo xuống trầm, X dày, trùng bass, v.v.).
            </div>
          </div>
          <div class="beats" id="beats"></div>
        </div>

        <div class="bd">
          <div class="controls">
            <button class="primary" id="btnEnable">Bật âm thanh</button>
            <button id="btnPrev">Prev</button>
            <button class="primary" id="btnNext">Next</button>
            <button id="btnHit">Hit / Chát</button>
            <button class="danger" id="btnReset">Reset</button>
            <button id="btnMute">Mute</button>
          </div>

          <div style="margin-top:12px" class="split">
            <div style="min-width:260px;flex:1">
              <div class="hint" style="margin-bottom:8px">Instrument:</div>
              <select id="instSel">
                <option value="acoustic_guitar_nylon" selected>acoustic_guitar_nylon (bolero hợp)</option>
                <option value="acoustic_guitar_steel">acoustic_guitar_steel</option>
                <option value="electric_guitar_clean">electric_guitar_clean</option>
              </select>
            </div>
            <div style="min-width:320px;flex:1">
              <div class="hint" style="margin-bottom:8px">Pattern tay phải:</div>
              <select id="patternSel"></select>
            </div>
          </div>

          <div style="margin-top:12px" class="split">
            <div class="pill"><span>Tempo</span> <b id="tempoVal">72</b></div>
            <input id="tempo" type="range" min="50" max="130" value="72" />
            <div class="pill"><span>Vol</span> <b id="volVal">75%</b></div>
            <input id="vol" type="range" min="10" max="100" value="75" />
          </div>

          <div style="margin-top:10px" class="split">
            <div class="pill"><span>Strum</span> <b id="strumVal">120ms</b></div>
            <input id="strum" type="range" min="70" max="220" value="120" />
            <div class="pill"><span>Humanize</span> <b id="humVal">10%</b></div>
            <input id="humanize" type="range" min="0" max="30" value="10" />
          </div>

          <div style="margin-top:10px" class="split">
            <button id="btnGroove" class="good">Groove: ON</button>
            <button id="btnClick" class="primary">Click: ON</button>
            <button id="btnCount" class="primary">Count-in: ON</button>
            <select id="quantSel" style="min-width:220px">
              <option value="beat" selected>Quantize: Beat (mượt)</option>
              <option value="bar">Quantize: Bar (rất chắc)</option>
              <option value="off">Quantize: OFF (đổi ngay)</option>
            </select>
          </div>

          <div class="hint" style="margin-top:10px" id="patDesc">—</div>
          <div class="hint" style="margin-top:6px" id="loadInfo">Instrument: chưa load</div>

          <!-- Debug / Options -->
          <details class="card" style="margin-top:12px">
            <summary>Debug options (để tìm nguyên nhân “lạc quẻ”)</summary>
            <div class="bd">
              <div class="optGrid">
                <div class="optRow">
                  <span>Strum range</span>
                  <select id="optStrumRange">
                    <option value="full">FULL (dày)</option>
                    <option value="drop1" selected>Drop LOW-1 (khuyên)</option>
                    <option value="top4">Top 4 notes</option>
                    <option value="top3">Top 3 notes</option>
                  </select>
                </div>

                <div class="optRow">
                  <span>Upstroke (U)</span>
                  <select id="optUpstroke">
                    <option value="reverseFull">Reverse full</option>
                    <option value="highOnly" selected>High-only (khuyên)</option>
                  </select>
                </div>

                <div class="optRow">
                  <span>Chop (X)</span>
                  <select id="optChop">
                    <option value="shortStrum" selected>Short strum</option>
                    <option value="highOnly">High-only + short (khuyên)</option>
                    <option value="percOnly">Perc only (không chord)</option>
                  </select>
                </div>

                <div class="optRow">
                  <span>Remove bass from VOICE</span>
                  <select id="optRemoveBass">
                    <option value="on" selected>ON (khuyên)</option>
                    <option value="off">OFF</option>
                  </select>
                </div>

                <div class="optRow">
                  <span>Voicing style</span>
                  <select id="optVoicing">
                    <option value="base" selected>Base (như cũ)</option>
                    <option value="triad">Triad (nhẹ)</option>
                    <option value="midHigh">Mid/High (gọn)</option>
                  </select>
                </div>

                <div class="optRow">
                  <span>Dominant “êm”</span>
                  <select id="optDomSoft">
                    <option value="off" selected>OFF</option>
                    <option value="sus4">A7/E7 -> sus4 (đỡ chỏi)</option>
                    <option value="minor">A7->Am, E7->Em (an toàn)</option>
                  </select>
                </div>

                <div class="optRow">
                  <span>Bass mode</span>
                  <select id="optBassMode">
                    <option value="root" selected>Root only</option>
                    <option value="root5">Root–5th (luân phiên)</option>
                    <option value="off">OFF</option>
                  </select>
                </div>

                <div class="optRow">
                  <span>Transpose (test tông)</span>
                  <select id="optTranspose">
                    <option value="0" selected>0</option>
                    <option value="1">+1</option><option value="2">+2</option><option value="3">+3</option>
                    <option value="-1">-1</option><option value="-2">-2</option><option value="-3">-3</option>
                  </select>
                </div>

                <div class="optRow">
                  <span>Timing offset</span>
                  <select id="optOffset">
                    <option value="0" selected>0ms</option>
                    <option value="15">+15ms</option>
                    <option value="30">+30ms</option>
                    <option value="-15">-15ms</option>
                    <option value="-30">-30ms</option>
                  </select>
                </div>

                <div class="optRow" style="grid-column:1/-1;justify-content:flex-start">
                  <span style="margin-right:10px">Debug:</span>
                  <span class="hint" id="optDebugNote" style="margin:0;color:var(--text);font-weight:900">—</span>
                </div>
              </div>

              <div class="hint" style="margin-top:10px">
                Gợi ý test nhanh: <b>Triad + Remove bass + Upstroke High-only</b> rồi bấm <b>Am</b> và hát câu đầu.
                Nếu tự nhiên “ăn” hơn, nguyên nhân thường là <b>U kéo xuống trầm / strum quá dày / trùng bass</b>.
              </div>
            </div>
          </details>
        </div>
      </section>

      <section class="card">
        <div class="hd"><div><b>Lời + hợp âm</b></div><small style="color:var(--muted)">hợp âm trong [ ] là nút</small></div>
        <div class="bd"><div class="lyrics" id="lyrics"></div></div>
      </section>

    </div>
  </main>

  <div class="footer">
    <div class="row">
      <button id="tapPrev">◀︎ Prev</button>
      <button class="primary" id="tapNext" style="padding:14px 10px;font-size:18px">NEXT</button>
      <button id="tapHit">⟲ Hit</button>
    </div>
  </div>

<script>
/* =========================
   A) LỜI + HỢP ÂM
   ========================= */
const RAW = `1. Tuổi đời chân đơn [Am] côi gót mòn đại lộ [F] buồn
Đèn [G] đêm bóng mờ nhạt [C] nhòa
[A7] Hồn lắng tâm [Dm] tư, đi vào dĩ [Am] vãng
Đường tình không chung [E7] lối mang nuối tiếc cho [F] nhau [E7]

2. Ngày nào tay trong [Am] tay lối về cùng hẹn [F] hò
Dìu [G] em giấc mộng vừa [C] tròn
[A7] Tình thắm môi [Dm] hồng, đêm dài lưu [Am] luyến,
Nghẹn ngào trong thương [E7] nhớ vì mai bước theo [Am] chồng. [Dm] [Am]

ĐK:
Em sang ngang [F] rồi chôn kỷ [G] niệm vào thương [C] nhớ
Hôn lên tóc [Am] mềm lệ [A7] sầu thắm ướt đôi [Dm] mi
Xin em một [G] lần cho ước nguyện tình yêu [E7] cuối
Thương yêu không [G] thành thôi giã [E7] từ đi em [Am] ơi.

3. Người về lên xe [Am] hoa, kỷ niệm buồn vào [F] hồn
Bờ [G] môi tắt hẳn nụ [C] cười
[A7] Giây phút bên [Dm] nhau nay còn đâu [Am] nữa
Người về trong thương [E7] nhớ người đi nhớ thương [Am] người.`;

function normalizeChordName(ch){ return ch.trim(); }

const chordEvents = [];
const lyricsEl = document.getElementById('lyrics');

(function renderLyrics(){
  const re = /\[([^\]]+)\]/g;
  let idx = 0;
  lyricsEl.innerHTML = RAW.replace(re, (_, chordText) => {
    const chord = normalizeChordName(chordText);
    return `<span class="ch" data-idx="${idx++}" data-ch="${encodeURIComponent(chord)}">${chord}</span>`;
  });
  [...lyricsEl.querySelectorAll('.ch')].forEach(sp => chordEvents.push({
    chord: decodeURIComponent(sp.dataset.ch),
    span: sp
  }));
})();

/* =========================
   B) PATTERNS (B/D/U/X/.)
   ========================= */
const PATTERNS = [
  { id:"bolero_basic", name:"Bolero (B-X-B-X) – thưa, dễ hát", sig:{beats:4, sub:2},
    desc:"Bolero cơ bản: 1 bass, 2 chát, 3 bass, 4 chát.",
    steps:["B",".","X",".","B",".","X","."] },
  { id:"bolero_plus", name:"Bolero (B-XU-B-XU) – mượt hơn", sig:{beats:4, sub:2},
    desc:"Bolero mượt: thêm U nhẹ sau chát.",
    steps:["B",".","X","U","B",".","X","U"] },
  { id:"ballad_8", name:"Ballad (D X U) – backbeat rõ", sig:{beats:4, sub:2},
    desc:"Ballad/slow rock: nhấn 2–4 bằng X.",
    steps:["D",".","X","U","D",".","X","U"] },
  { id:"pop_8", name:"Pop 8th – phổ biến", sig:{beats:4, sub:2},
    desc:"Pop 8th: nền đều, không quá dày.",
    steps:["D",".","D","U","D",".","D","U"] },
  { id:"rumba_basic", name:"Rumba – lắc lư", sig:{beats:4, sub:2},
    desc:"Rumba cơ bản: có nhịp lệch tạo cảm giác “đi”.",
    steps:["D",".","D","U",".","U","D","U"] },
  { id:"reggae_chop", name:"Reggae chop – offbeat X", sig:{beats:4, sub:2},
    desc:"Reggae: chát ở offbeat (&).",
    steps:[".","X",".","X",".","X",".","X"] },
  { id:"waltz_3", name:"Waltz 3/4 (B X X)", sig:{beats:3, sub:2},
    desc:"Nhịp 3/4: 1 bass, 2–3 chát/chord.",
    steps:["B",".","X",".","X","."] },
  { id:"pop_16_light", name:"Pop 16th nhẹ", sig:{beats:4, sub:4},
    desc:"Pop 16th nhẹ: thêm chuyển động 16th nhưng vẫn thở.",
    steps:["D",".","U",".","D",".","U",".","D",".","U",".","D",".","U","."] },
  { id:"funk_16", name:"Funk 16th (dày)", sig:{beats:4, sub:4},
    desc:"Funk/disco 16th: rất dày, nên giảm tempo khi hát.",
    steps:["D","U","D","U","X","U","D","U","D","U","X","U","D","U","D","U"] },
];

const patternSel = document.getElementById('patternSel');
for(const p of PATTERNS){
  const opt = document.createElement('option');
  opt.value = p.id;
  opt.textContent = p.name;
  patternSel.appendChild(opt);
}
patternSel.value = "bolero_basic";

/* =========================
   C) AUDIO (iOS unlock mạnh)
   ========================= */
let audioCtx = null;
let instrument = null;
let isMuted = false;

const audDot = document.getElementById('audDot');
const audText = document.getElementById('audText');
const loadInfo = document.getElementById('loadInfo');
const patDesc = document.getElementById('patDesc');
const beatText = document.getElementById('beatText');
const modeText = document.getElementById('modeText');
const gateEl = document.getElementById('gate');
const gateErrEl = document.getElementById('gateErr');

function setAudioUI(on){
  audDot.classList.toggle('on', !!on);
  audText.textContent = on ? "Audio: đã bật" : "Audio: chưa bật";
  modeText.textContent = (audioCtx && instrument) ? "Audio" : "Silent";
}
function ensureAudio(){
  if(audioCtx) return;
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  setAudioUI(true);
}

// Soundfont base (mp3) – CDN
const SOUNDFONT_BASE = "https://gleitz.github.io/midi-js-soundfonts/FluidR3_GM/";
function nameToUrl(name, soundfont, format){
  return `${SOUNDFONT_BASE}${name}-${format}.js`;
}

async function loadInstrument(name){
  ensureAudio();
  if(audioCtx.state === "suspended") await audioCtx.resume();

  loadInfo.textContent = `Instrument: đang load ${name}...`;
  instrument = await window.Soundfont.instrument(audioCtx, name, {
    format: "mp3",
    soundfont: "FluidR3_GM",
    nameToUrl
  });
  loadInfo.textContent = `Instrument: OK (${name})`;
  setAudioUI(true);
}

/* iOS unlock: resume + tiny beep trong gesture */
async function unlockAudioIOS(){
  ensureAudio();
  if(audioCtx.state === "suspended") await audioCtx.resume();

  const t = audioCtx.currentTime;
  const osc = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  osc.type = "sine";
  osc.frequency.setValueAtTime(880, t);
  g.gain.setValueAtTime(0.0001, t);
  g.gain.exponentialRampToValueAtTime(0.03, t + 0.005);
  g.gain.exponentialRampToValueAtTime(0.0001, t + 0.03);
  osc.connect(g); g.connect(audioCtx.destination);
  osc.start(t);
  osc.stop(t + 0.04);
}

let enabling = false;
async function enableFromGesture(){
  if(enabling) return;
  enabling = true;
  gateErrEl.style.display = "none";
  gateErrEl.textContent = "";

  try{
    await unlockAudioIOS();
    await loadInstrument(document.getElementById('instSel').value);

    // chỉ ẩn gate khi load OK
    gateEl.style.display = 'none';
    updatePatternUI();

    // nếu đã có chord hiện tại thì vào transport luôn (tùy Groove)
    if(currentChordName && grooveOn && !isMuted) startTransport();
  }catch(e){
    const msg = "Không bật được âm thanh / tải instrument.\n\n" +
      (e?.message ?? String(e)) +
      "\n\nGợi ý:\n- Mở bằng Safari/Chrome thật (không in-app)\n- Mở qua http/https\n- Kiểm tra CDN jsDelivr & GitHub Pages có bị chặn không";
    gateErrEl.style.display = "block";
    gateErrEl.textContent = msg;
    setAudioUI(!!audioCtx);
  }finally{
    enabling = false;
  }
}

/* attach gesture events (iOS picky) */
function attachGesture(el){
  ["pointerdown","touchstart","mousedown","click"].forEach(evt=>{
    el.addEventListener(evt, (ev)=>{ ev.preventDefault(); enableFromGesture(); }, {passive:false});
  });
}
attachGesture(document.getElementById('gateBtn'));
attachGesture(document.getElementById('btnEnable'));

/* =========================
   D) VOICINGS / BASS (base + options)
   ========================= */
const VOICE_BASE = {
  "Am": ["A2","E3","A3","C4","E4"],
  "A7": ["A2","E3","G3","C#4","E4"],
  "Dm": ["D3","A3","D4","F4"],
  "E7": ["E2","B2","D3","G#3","B3","E4"],
  "F":  ["F2","C3","F3","A3","C4","F4"],
  "G":  ["G2","D3","G3","B3","D4","G4"],
  "C":  ["C3","G3","C4","E4","G4"],
  "Em": ["E2","B2","E3","G3","B3","E4"],

  // sus4 để “êm” dominant
  "A7sus4": ["A2","E3","G3","D4","E4"],
  "E7sus4": ["E2","B2","D3","A3","B3","E4"],
};

const VOICE_TRIAD = {
  "Am": ["A3","C4","E4"],
  "A7": ["A3","C#4","E4","G4"],
  "Dm": ["D4","F4","A4"],
  "E7": ["E3","G#3","B3","D4"],
  "F":  ["A3","C4","F4"],
  "G":  ["G3","B3","D4"],
  "C":  ["C4","E4","G4"],
  "Em": ["E3","G3","B3"],

  "A7sus4": ["A3","D4","E4","G4"],
  "E7sus4": ["E3","A3","B3","D4"],
};

const VOICE_MIDHIGH = {
  "Am": ["E3","A3","C4","E4"],
  "A7": ["E3","G3","C#4","E4"],
  "Dm": ["A3","D4","F4","A4"],
  "E7": ["B2","D3","G#3","B3","E4"],
  "F":  ["C3","F3","A3","C4","F4"],
  "G":  ["D3","G3","B3","D4","G4"],
  "C":  ["G3","C4","E4","G4"],
  "Em": ["B2","E3","G3","B3","E4"],

  "A7sus4": ["E3","G3","D4","E4"],
  "E7sus4": ["B2","D3","A3","B3","E4"],
};

const BASS_ROOT = {"Am":"A2","A7":"A2","Dm":"D3","E7":"E2","F":"F2","G":"G2","C":"C3","Em":"E2","A7sus4":"A2","E7sus4":"E2"};
const BASS_5TH  = {"Am":"E3","A7":"E3","Dm":"A3","E7":"B2","F":"C3","G":"D3","C":"G3","Em":"B2","A7sus4":"E3","E7sus4":"B2"};

/* =========================
   E) OPTIONS (Debug engine)
   ========================= */
const OPT = {
  strumRange: "drop1",      // full | drop1 | top4 | top3
  upstroke: "highOnly",     // reverseFull | highOnly
  chop: "shortStrum",       // shortStrum | highOnly | percOnly
  removeBassFromVoice: true,
  voicing: "base",          // base | triad | midHigh
  domSoft: "off",           // off | sus4 | minor
  bassMode: "root",         // root | root5 | off
  transpose: 0,
  offsetMs: 0,
};

const debugNoteEl = document.getElementById("optDebugNote");

// Note transpose
const NOTE_TO_SEMI = {C:0,"C#":1,D:2,"D#":3,E:4,F:5,"F#":6,G:7,"G#":8,A:9,"A#":10,B:11};
const SEMI_TO_NOTE = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];

function parseNoteName(s){
  const m = /^([A-G])(#?)(-?\d+)$/.exec(s);
  if(!m) return null;
  const name = m[1] + (m[2] || "");
  const oct = +m[3];
  return {name, oct};
}
function toMidi(note){
  const p = parseNoteName(note);
  if(!p) return null;
  return (p.oct + 1) * 12 + NOTE_TO_SEMI[p.name];
}
function fromMidi(midi){
  const oct = Math.floor(midi/12) - 1;
  const semi = ((midi % 12) + 12) % 12;
  return `${SEMI_TO_NOTE[semi]}${oct}`;
}
function trNote(note, semis){
  const m = toMidi(note);
  if(m == null) return note;
  return fromMidi(m + semis);
}
function trNotes(arr, semis){
  if(!arr || !semis) return arr;
  return arr.map(n => trNote(n, semis));
}

function getVoiceDict(){
  if(OPT.voicing === "triad") return VOICE_TRIAD;
  if(OPT.voicing === "midHigh") return VOICE_MIDHIGH;
  return VOICE_BASE;
}

// “Làm êm” dominant để tránh cấn giai điệu
function mapChordSoft(ch){
  if(OPT.domSoft === "minor"){
    if(ch === "A7") return "Am";
    if(ch === "E7") return "Em";
  }
  if(OPT.domSoft === "sus4"){
    if(ch === "A7") return "A7sus4";
    if(ch === "E7") return "E7sus4";
  }
  return ch;
}

function pickStrumNotes(ch, stroke){
  const dict = getVoiceDict();
  const base = dict[ch] || VOICE_BASE[ch];
  if(!base) return null;

  let notes = [...base];

  // remove bass duplication (bỏ nốt thấp nhất)
  if(OPT.removeBassFromVoice && notes.length >= 4){
    notes = notes.slice(1);
  }

  // range
  if(OPT.strumRange === "top4") notes = notes.slice(-4);
  if(OPT.strumRange === "top3") notes = notes.slice(-3);

  // upstroke behavior
  if(stroke === "U"){
    if(OPT.upstroke === "highOnly"){
      notes = notes.slice(-4).reverse();  // quan trọng: không kéo xuống trầm
    }else{
      notes = notes.reverse();
    }
  }

  return trNotes(notes, OPT.transpose);
}

function pickBass(ch, stepIndex){
  if(OPT.bassMode === "off") return null;
  if(OPT.bassMode === "root") return trNote(BASS_ROOT[ch] || null, OPT.transpose);

  // root5: luân phiên root–5th
  const isRoot = (stepIndex % 2) === 0;
  const note = isRoot ? (BASS_ROOT[ch] || null) : (BASS_5TH[ch] || BASS_ROOT[ch] || null);
  return trNote(note, OPT.transpose);
}

function setDebug(text){
  if(debugNoteEl) debugNoteEl.textContent = text;
}

function bindOpt(id, fn){
  const el = document.getElementById(id);
  if(!el) return;
  el.addEventListener("change", () => fn(el.value));
  fn(el.value);
}

bindOpt("optStrumRange", v => OPT.strumRange = v);
bindOpt("optUpstroke",   v => OPT.upstroke = v);
bindOpt("optChop",       v => OPT.chop = v);
bindOpt("optRemoveBass", v => OPT.removeBassFromVoice = (v === "on"));
bindOpt("optVoicing",    v => OPT.voicing = v);
bindOpt("optDomSoft",    v => OPT.domSoft = v);
bindOpt("optBassMode",   v => OPT.bassMode = v);
bindOpt("optTranspose",  v => OPT.transpose = +v);
bindOpt("optOffset",     v => OPT.offsetMs = +v);

/* =========================
   F) AUDIO PLAY HELPERS
   ========================= */
function getVol(){ return (+document.getElementById('vol').value)/100; }
function getStrumMs(){ return +document.getElementById('strum').value; }
function getHumanize(){ return (+document.getElementById('humanize').value)/100; }

function playNote(note, t, gain=0.70, dur=0.25){
  if(!instrument || !audioCtx || isMuted) return;
  instrument.play(note, t, { gain: Math.max(0.06, gain*getVol()), duration: dur });
}

function playStrum(chIn, t, stroke="D", baseGain=0.55, dur=0.35){
  if(!instrument || !audioCtx || isMuted) return;

  const ch = mapChordSoft(chIn);
  const notes = pickStrumNotes(ch, stroke);
  if(!notes || !notes.length) return;

  const strumMs = getStrumMs();
  const hum = getHumanize();
  const t0 = t + (OPT.offsetMs/1000);

  notes.forEach((note, i) => {
    const jitter = (Math.random()*2 - 1) * hum;
    const tt = t0 + i*(strumMs/1000)*(1 + jitter);
    const g = Math.max(0.06, getVol()*(baseGain*(0.95 - i*0.08)));
    instrument.play(note, tt, { gain: g, duration: dur });
  });

  setDebug(`Chord=${chIn}→${ch}, stroke=${stroke}, notes=[${notes.join(", ")}]`);
}

function playChop(chIn, t){
  if(!instrument || !audioCtx || isMuted) return;

  if(OPT.chop === "percOnly"){
    // chỉ “cụp” như gõ (dùng click nhỏ)
    click(t + (OPT.offsetMs/1000), false);
    setDebug(`Chop=percOnly (${chIn})`);
    return;
  }

  const oldRange = OPT.strumRange;
  if(OPT.chop === "highOnly") OPT.strumRange = "top3";

  playStrum(chIn, t, "D", 0.30, 0.08);

  OPT.strumRange = oldRange;
}

/* Click metronome */
let clickOn = true;
function click(t, strong=false){
  if(!audioCtx || isMuted || !clickOn) return;
  const osc = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  osc.type = "square";
  osc.frequency.setValueAtTime(strong ? 1200 : 900, t);
  g.gain.setValueAtTime(0.0001, t);
  g.gain.exponentialRampToValueAtTime(strong ? 0.06 : 0.045, t + 0.005);
  g.gain.exponentialRampToValueAtTime(0.0001, t + 0.06);
  osc.connect(g);
  g.connect(audioCtx.destination);
  osc.start(t);
  osc.stop(t + 0.07);
}

/* =========================
   G) TRANSPORT (pattern runner)
   ========================= */
let grooveOn = true;
let countInOn = true;
let tempoBpm = 72;

let currentChordName = null;
let queuedChordName = null;

let phase = "idle"; // idle | countin | play
let transportStart = 0;
let nextStepTime = 0;
let stepIndex = 0;
let schedTimer = null;

function now(){ return audioCtx?.currentTime ?? 0; }
function beatDur(){ return 60 / tempoBpm; }

function getPattern(){
  const id = patternSel.value;
  return PATTERNS.find(p => p.id === id) || PATTERNS[0];
}
function stepDur(){
  const p = getPattern();
  return beatDur() / p.sig.sub;
}
function stepsPerBar(){
  const p = getPattern();
  return p.sig.beats * p.sig.sub;
}
function currentBeatNumber(p){
  return Math.floor(stepIndex / p.sig.sub) + 1;
}
function shouldApplyQueued(p){
  const mode = document.getElementById('quantSel').value;
  if(mode === "off") return true;
  if(mode === "beat") return (stepIndex % p.sig.sub) === 0;
  if(mode === "bar") return (stepIndex % (p.sig.beats * p.sig.sub)) === 0;
  return false;
}

function startTransport(){
  if(!audioCtx || !instrument || schedTimer) return;

  const t0 = now() + 0.06;
  transportStart = t0;
  nextStepTime = t0;
  stepIndex = 0;
  phase = (countInOn ? "countin" : "play");

  schedTimer = setInterval(scheduler, 25);
}
function stopTransport(){
  if(schedTimer) clearInterval(schedTimer);
  schedTimer = null;
  phase = "idle";
  beatText.textContent = "—";
  updateBeatLights(0, getPattern().sig.beats);
}

function scheduler(){
  if(!audioCtx || isMuted || !grooveOn || !instrument) return;

  const lookAhead = 0.22;
  const p = getPattern();
  const sd = stepDur();
  const spb = stepsPerBar();

  while(nextStepTime < now() + lookAhead){
    const t = nextStepTime;

    // click on beats
    if((stepIndex % p.sig.sub) === 0){
      const beat = currentBeatNumber(p);
      click(t, beat === 1);
    }

    // count-in for 1 bar
    if(phase === "countin"){
      if(stepIndex >= spb){
        phase = "play";
        stepIndex = 0;
      }
    }

    // apply queued chord on boundary
    if(queuedChordName && phase === "play" && shouldApplyQueued(p)){
      currentChordName = queuedChordName;
      queuedChordName = null;
    }

    // play step
    if(phase === "play" && currentChordName){
      const token = p.steps[stepIndex % spb] ?? ".";
      const ch = mapChordSoft(currentChordName);

      if(token === "B"){
        const bass = pickBass(ch, stepIndex);
        if(bass) playNote(bass, t + (OPT.offsetMs/1000), 0.78, 0.24);
      } else if(token === "D"){
        playStrum(ch, t, "D", 0.58, 0.34);
      } else if(token === "U"){
        playStrum(ch, t, "U", 0.42, 0.26);
      } else if(token === "X"){
        playChop(ch, t);
      }
    }

    nextStepTime += sd;
    stepIndex = (stepIndex + 1) % spb;
  }
}

/* =========================
   H) UI: beats indicator
   ========================= */
const beatsEl = document.getElementById('beats');
function renderBeatLights(n){
  beatsEl.innerHTML = "";
  for(let i=1;i<=n;i++){
    const d = document.createElement('div');
    d.className = "beat";
    d.textContent = String(i);
    beatsEl.appendChild(d);
  }
}
function updateBeatLights(beat, total){
  const cells = [...beatsEl.querySelectorAll('.beat')];
  if(cells.length !== total) renderBeatLights(total);
  [...beatsEl.querySelectorAll('.beat')].forEach((c, i) => c.classList.toggle('on', (i+1) === beat));
}
function updatePatternUI(){
  const p = getPattern();
  patDesc.textContent = p.desc + `  | Nhịp: ${p.sig.beats}/4  | Lưới: ${p.sig.sub===2 ? "8th" : "16th"}`;
  beatText.textContent = `${p.sig.beats}/4`;
  renderBeatLights(p.sig.beats);
}
updatePatternUI();

patternSel.addEventListener('change', () => {
  updatePatternUI();
  if(schedTimer){
    stopTransport();
    if(currentChordName && grooveOn && audioCtx && instrument && !isMuted) startTransport();
  }
});

// animate beat lights
(function raf(){
  try{
    if(audioCtx && schedTimer && !isMuted && grooveOn){
      const p = getPattern();
      const sd = stepDur();
      const elapsed = Math.max(0, now() - transportStart);
      const curStep = Math.floor(elapsed / sd) % stepsPerBar();
      const beat = Math.floor(curStep / p.sig.sub) + 1;
      updateBeatLights(beat, p.sig.beats);
    }
  }catch(e){}
  requestAnimationFrame(raf);
})();

/* =========================
   I) CHORD TIMELINE (Prev/Next)
   ========================= */
let curIdx = 0;
const curChordEl = document.getElementById('curChord');
const nextChordEl = document.getElementById('nextChord');

function clampIdx(i){ return Math.max(0, Math.min(chordEvents.length-1, i)); }

function setActive(i, doPlay=false){
  if(!chordEvents.length) return;
  curIdx = clampIdx(i);

  chordEvents.forEach(ev => ev.span.classList.remove('active'));
  const ev = chordEvents[curIdx];
  ev.span.classList.add('active');

  curChordEl.textContent = ev.chord;
  nextChordEl.textContent = "Next: " + (chordEvents[curIdx+1]?.chord ?? "—");

  ev.span.scrollIntoView({behavior:"smooth", block:"center", inline:"nearest"});
  if(doPlay) requestChord(ev.chord);
}
if(chordEvents.length) setActive(0,false);

function requestChord(ch){
  // luôn cho phép “vào bài” (highlight + set chord) kể cả silent mode
  if(!currentChordName){
    currentChordName = ch;
    if(audioCtx && instrument){
      playStrum(currentChordName, now()+0.02, "D", 0.55, 0.40);
      if(grooveOn) startTransport();
    }
    setAudioUI(!!audioCtx);
    return;
  }

  if(!(audioCtx && instrument)){
    currentChordName = ch; // silent mode: chỉ đổi chord để bám lời
    setDebug(`Silent: set chord ${ch}`);
    return;
  }

  const mode = document.getElementById('quantSel').value;
  if(mode === "off"){
    currentChordName = ch;
    playStrum(currentChordName, now()+0.02, "D", 0.40, 0.22);
    return;
  }

  queuedChordName = ch;
  playStrum(ch, now()+0.02, "D", 0.16, 0.16);
}

function next(){ setActive(curIdx+1, true); }
function prev(){ setActive(curIdx-1, true); }
function hit(){
  if(!chordEvents.length) return;
  if(audioCtx && instrument) playChop(chordEvents[curIdx].chord, now()+0.02);
}
function resetAll(){
  stopTransport();
  currentChordName = null;
  queuedChordName = null;
  isMuted = false;
  document.getElementById('btnMute').textContent = "Mute";
  document.getElementById('btnMute').classList.remove('danger');
  if(chordEvents.length) setActive(0,false);
  setDebug("Reset");
  setAudioUI(!!audioCtx);
}

/* =========================
   J) UI wiring
   ========================= */
document.getElementById('btnNext').addEventListener('click', () => next());
document.getElementById('btnPrev').addEventListener('click', () => prev());
document.getElementById('btnHit').addEventListener('click', () => hit());
document.getElementById('btnReset').addEventListener('click', resetAll);

document.getElementById('tapNext').addEventListener('click', () => next());
document.getElementById('tapPrev').addEventListener('click', () => prev());
document.getElementById('tapHit').addEventListener('click', () => hit());

document.getElementById('btnMute').addEventListener('click', (e) => {
  isMuted = !isMuted;
  e.target.textContent = isMuted ? "Unmute" : "Mute";
  e.target.classList.toggle('danger', isMuted);
  setAudioUI(!!audioCtx);
});

document.getElementById('btnGroove').addEventListener('click', (e) => {
  grooveOn = !grooveOn;
  e.target.textContent = grooveOn ? "Groove: ON" : "Groove: OFF";
  e.target.classList.toggle('good', grooveOn);
  if(!grooveOn) stopTransport();
  else if(currentChordName && audioCtx && instrument && !isMuted) startTransport();
});

document.getElementById('btnClick').addEventListener('click', (e) => {
  clickOn = !clickOn;
  e.target.textContent = clickOn ? "Click: ON" : "Click: OFF";
  e.target.classList.toggle('primary', clickOn);
});

document.getElementById('btnCount').addEventListener('click', (e) => {
  countInOn = !countInOn;
  e.target.textContent = countInOn ? "Count-in: ON" : "Count-in: OFF";
  e.target.classList.toggle('primary', countInOn);
});

// instrument switch
document.getElementById('instSel').addEventListener('change', async (e) => {
  if(!audioCtx) return; // chưa bật audio
  try{
    await loadInstrument(e.target.value);
  }catch(err){
    gateErrEl.style.display = "block";
    gateErrEl.textContent = String(err);
  }
});

lyricsEl.addEventListener('click', (e) => {
  const t = e.target.closest('.ch');
  if(!t) return;
  setActive(+t.dataset.idx, true);
});

function hookSlider(id, outId, fmt, onChange){
  const s = document.getElementById(id);
  const out = document.getElementById(outId);
  const upd = () => {
    const v = +s.value;
    out.textContent = fmt(v);
    if(onChange) onChange(v);
  };
  s.addEventListener('input', upd);
  upd();
}
hookSlider('tempo','tempoVal', v => `${v}`, v => tempoBpm = v);
hookSlider('vol','volVal', v => `${v}%`);
hookSlider('strum','strumVal', v => `${v}ms`);
hookSlider('humanize','humVal', v => `${v}%`);

// keyboard
window.addEventListener('keydown', (e) => {
  if(e.code === 'ArrowRight' || e.code === 'Space'){ e.preventDefault(); next(); }
  if(e.code === 'ArrowLeft'){ e.preventDefault(); prev(); }
  if(e.key.toLowerCase() === 'r'){ hit(); }
});

// initial UI
setAudioUI(false);
</script>
</body>
</html>