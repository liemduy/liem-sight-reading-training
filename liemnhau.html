<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Đệm hát – bấm tới đâu, đàn tới đó</title>
  <style>
    :root{
      --bg:#0b0f14; --panel:#121a24; --panel2:#0f1620;
      --text:#e8eef7; --muted:#9fb0c7; --accent:#6aa9ff; --danger:#ff6a6a;
      --good:#52d18f;
    }
    *{box-sizing:border-box}
    body{
      margin:0; background:linear-gradient(180deg,#070a0f 0%, #0b0f14 35%, #080b10 100%);
      color:var(--text); font:16px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      padding:env(safe-area-inset-top) 0 env(safe-area-inset-bottom) 0;
    }
    header{
      position:sticky; top:0; z-index:10;
      backdrop-filter: blur(10px);
      background:rgba(11,15,20,.75);
      border-bottom:1px solid rgba(255,255,255,.08);
      padding:12px 14px;
      display:flex; gap:10px; align-items:center; justify-content:space-between;
    }
    .title{font-weight:700; letter-spacing:.2px}
    .status{font-size:12px; color:var(--muted); display:flex; gap:8px; align-items:center;}
    .dot{width:10px; height:10px; border-radius:999px; background:var(--danger); box-shadow:0 0 0 3px rgba(255,106,106,.15);}
    .dot.on{background:var(--good); box-shadow:0 0 0 3px rgba(82,209,143,.18);}
    main{padding:14px}
    .grid{display:grid; grid-template-columns:1fr; gap:12px; max-width:980px; margin:0 auto;}
    .card{
      background:rgba(18,26,36,.88);
      border:1px solid rgba(255,255,255,.08);
      border-radius:14px; overflow:hidden;
      box-shadow:0 10px 30px rgba(0,0,0,.25);
    }
    .card .hd{
      padding:10px 12px;
      background:rgba(15,22,32,.9);
      border-bottom:1px solid rgba(255,255,255,.08);
      display:flex; justify-content:space-between; align-items:center; gap:10px;
    }
    .card .hd small{color:var(--muted)}
    .card .bd{padding:12px}
    .bigchord{display:flex; align-items:baseline; gap:10px; flex-wrap:wrap;}
    .bigchord .cur{font-size:42px; font-weight:800; letter-spacing:.5px; color:var(--accent);}
    .bigchord .next{font-size:14px; color:var(--muted);}
    .controls{display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; margin-top:10px;}
    button{
      appearance:none; border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.06);
      color:var(--text); padding:12px 10px; border-radius:12px;
      font-weight:700; cursor:pointer;
      transition:transform .05s ease, background .15s ease, border-color .15s ease;
      user-select:none; -webkit-tap-highlight-color: transparent;
    }
    button:active{transform:scale(.98)}
    button.primary{background:rgba(106,169,255,.18); border-color:rgba(106,169,255,.35);}
    button.danger{background:rgba(255,106,106,.14); border-color:rgba(255,106,106,.30);}
    .hint{color:var(--muted); font-size:13px;}
    .lyrics{font-size:18px; line-height:1.75; white-space:pre-wrap;}
    .ch{
      display:inline-block;
      padding:.08em .38em; margin:0 .10em;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.05);
      color:#cfe2ff; font-weight:800; cursor:pointer;
    }
    .ch.active{
      background:rgba(106,169,255,.25);
      border-color:rgba(106,169,255,.55);
      box-shadow:0 0 0 3px rgba(106,169,255,.18);
    }
    .footerbar{
      position:sticky; bottom:0; z-index:20;
      background:rgba(11,15,20,.85);
      backdrop-filter: blur(10px);
      border-top:1px solid rgba(255,255,255,.08);
      padding:10px 14px;
    }
    .footerbar .row{
      max-width:980px; margin:0 auto;
      display:grid; grid-template-columns:1fr 1.3fr 1fr;
      gap:10px; align-items:center;
    }
    .pad{padding-bottom:24px}
    .pill{
      font-size:12px; color:var(--muted);
      padding:6px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.04);
      display:inline-flex; gap:8px; align-items:center; justify-content:center;
      white-space:nowrap;
    }
    .pill b{color:var(--text)}
    .split{display:flex; gap:10px; justify-content:center; align-items:center; flex-wrap:wrap;}
    input[type="range"]{width:140px}
    .kbd{
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;
      font-size:12px; padding:2px 6px; border-radius:6px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.05); color:var(--text);
    }
  </style>
</head>
<body>
  <header>
    <div class="title">Đệm hát (bấm hợp âm theo ca sĩ)</div>
    <div class="status">
      <span class="dot" id="audDot"></span>
      <span id="audText">Audio: chưa bật</span>
    </div>
  </header>

  <main>
    <div class="grid">

      <section class="card">
        <div class="hd">
          <div>
            <div class="bigchord">
              <div class="cur" id="curChord">—</div>
              <div class="next" id="nextChord">Next: —</div>
            </div>
            <div class="hint">
              Chạm vào hợp âm trong lời để nghe thử. Khi hát/đệm: bấm <span class="kbd">NEXT</span> đúng lúc đổi hợp âm.
            </div>
          </div>
          <small id="idxInfo">0 / 0</small>
        </div>

        <div class="bd">
          <div class="controls">
            <button class="primary" id="btnEnable">Bật âm thanh</button>
            <button id="btnPrev">Prev</button>
            <button class="primary" id="btnNext">Next</button>
            <button id="btnReplay">Replay chord</button>
            <button class="danger" id="btnReset">Reset</button>
            <button id="btnMute">Mute</button>
          </div>

          <div style="margin-top:10px" class="split">
            <div class="pill"><span>Strum</span> <b id="strumVal">45ms</b></div>
            <input id="strum" type="range" min="20" max="90" value="45" />
            <div class="pill"><span>Bright</span> <b id="brightVal">55%</b></div>
            <input id="bright" type="range" min="15" max="85" value="55" />
            <div class="pill"><span>Vol</span> <b id="volVal">70%</b></div>
            <input id="vol" type="range" min="10" max="100" value="70" />
          </div>

          <div class="hint pad" style="margin-top:8px">
            Safari: lần đầu phải bấm <b>Bật âm thanh</b>. Sau đó chỉ việc <b>Next</b> theo ca sĩ.
          </div>
        </div>
      </section>

      <section class="card">
        <div class="hd">
          <div><b>Lời + hợp âm</b></div>
          <small>Hợp âm trong ngoặc vuông biến thành “nút”</small>
        </div>
        <div class="bd">
          <div class="lyrics" id="lyrics"></div>
        </div>
      </section>

      <section class="card">
        <div class="hd">
          <div><b>Kịch bản sử dụng</b></div>
          <small>Manual tap, không auto-tempo</small>
        </div>
        <div class="bd">
          <ol style="margin:0; padding-left:18px; line-height:1.65">
            <li>Mở file bằng Safari.</li>
            <li>Bấm <b>Bật âm thanh</b> (đèn xanh).</li>
            <li><b>Reset</b> về đầu bài.</li>
            <li>Ca sĩ tới chỗ đổi hợp âm → bấm <b>NEXT</b>.</li>
            <li>Lỡ bấm sai → <b>Prev</b>. Muốn nghe lại → <b>Replay</b>. Cần im ngay → <b>Mute</b>.</li>
          </ol>
        </div>
      </section>

    </div>
  </main>

  <div class="footerbar">
    <div class="row">
      <button id="tapLeft">◀︎ Prev</button>
      <button class="primary" id="tapNext" style="padding:14px 10px; font-size:18px">NEXT (tap theo ca sĩ)</button>
      <button id="tapReplay">⟲ Replay</button>
    </div>
  </div>

<script>
/* ========= 1) INPUT ========= */
const RAW = `1. Tuổi đời chân đơn [Am] côi gót mòn đại lộ [F] buồn
Đèn [G] đêm bóng mờ nhạt [C] nhòa
[A7] Hồn lắng tâm [Dm] tư, đi vào dĩ [Am] vãng
Đường tình không chung [E7] lối mang nuối tiếc cho [F] nhau [E7]

2. Ngày nào tay trong [Am] tay lối về cùng hẹn [F] hò
Dìu [G] em giấc mộng vừa [C] tròn
[A7] Tình thắm môi [Dm] hồng, đêm dài lưu [Am] luyến,
Nghẹn ngào trong thương [E7] nhớ vì mai bước theo [Am] chồng. [Dm] [Am]

ĐK:
Em sang ngang [F] rồi chôn kỷ [G] niệm vào thương [C] nhớ
Hôn lên tóc [Am] mềm lệ [A7] sầu thắm ướt đôi [Dm] mi
Xin em một [G] lần cho ước nguyện tình yêu [E7] cuối
Thương yêu không [G] thành thôi giã [E7] từ đi em [Am] ơi.

3. Người về lên xe [Am] hoa, kỷ niệm buồn vào [F] hồn
Bờ [G] môi tắt hẳn nụ [C] cười
[A7] Giây phút bên [Dm] nhau nay còn đâu [Am] nữa
Người về trong thương [E7] nhớ người đi nhớ thương [Am] người.`;

function normalizeChordName(ch){ return ch.trim(); }

/* ========= 2) PARSE + RENDER ========= */
const chordEvents = []; // {chord, span}
const lyricsEl = document.getElementById('lyrics');

function renderLyrics(raw){
  const re = /\[([^\]]+)\]/g;
  let idx = 0;
  const html = raw.replace(re, (_, chordText) => {
    const chord = normalizeChordName(chordText);
    return `<span class="ch" data-idx="${idx}" data-ch="${encodeURIComponent(chord)}">${chord}</span>`;
  , idx++);
  lyricsEl.innerHTML = html;
  [...lyricsEl.querySelectorAll('.ch')].forEach((sp, i) => {
    chordEvents.push({ chord: decodeURIComponent(sp.dataset.ch), span: sp });
  });
}
renderLyrics(RAW);

/* ========= 3) AUDIO (Karplus-Strong) ========= */
let audioCtx = null;
let masterGain = null;
let isMuted = false;

const audDot = document.getElementById('audDot');
const audText = document.getElementById('audText');

function midiToFreq(m){ return 440 * Math.pow(2, (m - 69) / 12); }

function makeNoiseBuffer(ctx, duration = 0.03){
  const sr = ctx.sampleRate;
  const len = Math.max(1, Math.floor(sr * duration));
  const buf = ctx.createBuffer(1, len, sr);
  const data = buf.getChannelData(0);
  for(let i=0;i<len;i++) data[i] = (Math.random()*2 - 1) * (0.6 + 0.4*Math.random());
  return buf;
}

function pluck(ctx, freq, when, dur, bright=0.55, level=0.25, pan=0.0){
  const delayTime = 1 / freq;

  const noise = ctx.createBufferSource();
  noise.buffer = makeNoiseBuffer(ctx, 0.02 + 0.01*(1-bright));

  const noiseGain = ctx.createGain();
  noiseGain.gain.setValueAtTime(level, when);
  noiseGain.gain.exponentialRampToValueAtTime(0.0008, when + 0.03);

  const delay = ctx.createDelay(1.0);
  delay.delayTime.setValueAtTime(delayTime, when);

  const feedback = ctx.createGain();
  const fb = 0.86 - (freq/1600)*0.12;
  feedback.gain.setValueAtTime(Math.max(0.72, Math.min(0.90, fb)), when);

  const damp = ctx.createBiquadFilter();
  damp.type = "lowpass";
  damp.frequency.setValueAtTime(1200 + bright*5200, when);
  damp.Q.setValueAtTime(0.35, when);

  const body = ctx.createBiquadFilter();
  body.type = "peaking";
  body.frequency.setValueAtTime(180 + bright*70, when);
  body.Q.setValueAtTime(0.9, when);
  body.gain.setValueAtTime(6.0, when);

  const body2 = ctx.createBiquadFilter();
  body2.type = "peaking";
  body2.frequency.setValueAtTime(420 + bright*120, when);
  body2.Q.setValueAtTime(1.2, when);
  body2.gain.setValueAtTime(4.0, when);

  const outGain = ctx.createGain();
  outGain.gain.setValueAtTime(level, when);
  outGain.gain.exponentialRampToValueAtTime(0.00012, when + dur);

  const panner = (ctx.createStereoPanner ? ctx.createStereoPanner() : null);
  if(panner) panner.pan.setValueAtTime(pan, when);

  noise.connect(noiseGain);
  noiseGain.connect(delay);
  delay.connect(damp);
  damp.connect(feedback);
  feedback.connect(delay);

  delay.connect(body);
  body.connect(body2);
  body2.connect(outGain);

  if(panner){ outGain.connect(panner); panner.connect(masterGain); }
  else{ outGain.connect(masterGain); }

  noise.start(when);
  noise.stop(when + 0.05);

  setTimeout(() => {
    try{
      noise.disconnect(); noiseGain.disconnect(); delay.disconnect(); feedback.disconnect();
      damp.disconnect(); body.disconnect(); body2.disconnect(); outGain.disconnect();
      if(panner) panner.disconnect();
    }catch(e){}
  }, Math.max(50, (dur+0.2)*1000));
}

// Voicings (MIDI) – đủ dùng cho bài này
const VOICINGS = {
  "Am":[45,52,57,60,64],
  "A7":[45,52,55,61,64],
  "Dm":[50,57,62,65],
  "E7":[40,47,50,56,59,64],
  "F":[41,48,53,57,60,65],
  "G":[43,50,55,59,62,67],
  "C":[48,55,60,64,67],
};

const NOTE_INDEX = {C:0,"C#":1,Db:1,D:2,"D#":3,Eb:3,E:4,F:5,"F#":6,Gb:6,G:7,"G#":8,Ab:8,A:9,"A#":10,Bb:10,B:11};
function parseChord(ch){
  const m = ch.match(/^([A-G])([b#]?)(.*)$/);
  if(!m) return null;
  const root = m[1] + (m[2]||"");
  const rest = (m[3]||"").toLowerCase();
  const isMinor = rest.startsWith("m") && !rest.startsWith("maj");
  const isDom7 = rest.includes("7") && !rest.includes("maj7");
  const rootPc = NOTE_INDEX[root];
  if(rootPc === undefined) return null;
  return {rootPc,isMinor,isDom7};
}
function buildFallbackVoicing(ch){
  const info = parseChord(ch);
  if(!info) return [52,55,59];
  const baseMidi = 45 + ((info.rootPc - 9 + 12) % 12);
  const third = info.isMinor ? 3 : 4;
  const notes = [baseMidi, baseMidi+7, baseMidi+12, baseMidi+12+third, baseMidi+12+7];
  if(info.isDom7) notes.push(baseMidi+12+10);
  return notes.sort((a,b)=>a-b);
}

function ensureAudio(){
  if(audioCtx) return true;
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  masterGain = audioCtx.createGain();
  masterGain.gain.value = 0.7;
  masterGain.connect(audioCtx.destination);
  audDot.classList.add('on');
  audText.textContent = "Audio: đã bật";
  return true;
}

function playChord(chordName){
  ensureAudio();
  if(audioCtx.state === 'suspended') audioCtx.resume();
  if(isMuted) return;

  const strumMs = +document.getElementById('strum').value;
  const bright = (+document.getElementById('bright').value)/100;
  const vol = (+document.getElementById('vol').value)/100;
  masterGain.gain.setValueAtTime(vol, audioCtx.currentTime);

  const when0 = audioCtx.currentTime + 0.01;
  const voicing = VOICINGS[chordName] || buildFallbackVoicing(chordName);

  voicing.forEach((midi, i) => {
    const freq = midiToFreq(midi);
    const when = when0 + i*(strumMs/1000);
    const dur = 2.4 - i*0.12;
    const level = 0.22 - i*0.015;
    const pan = (i - (voicing.length-1)/2) * 0.10 + (Math.random()*0.04-0.02);
    pluck(audioCtx, freq, when, Math.max(1.1, dur), bright, Math.max(0.08, level), pan);
  });
}

/* ========= 4) TIMELINE (Prev/Next/Replay/Reset) ========= */
let curIdx = 0;
const curChordEl = document.getElementById('curChord');
const nextChordEl = document.getElementById('nextChord');
const idxInfoEl = document.getElementById('idxInfo');

function clampIdx(i){ return Math.max(0, Math.min(chordEvents.length-1, i)); }

function setActive(i, play=false){
  if(!chordEvents.length) return;
  curIdx = clampIdx(i);

  chordEvents.forEach(ev => ev.span.classList.remove('active'));
  const ev = chordEvents[curIdx];
  ev.span.classList.add('active');

  curChordEl.textContent = ev.chord;
  nextChordEl.textContent = "Next: " + (chordEvents[curIdx+1]?.chord ?? "—");
  idxInfoEl.textContent = `${curIdx+1} / ${chordEvents.length}`;

  ev.span.scrollIntoView({behavior:"smooth", block:"center", inline:"nearest"});
  if(play) playChord(ev.chord);
}

if(chordEvents.length) setActive(0,false);

function next(){ setActive(curIdx + 1, true); }
function prev(){ setActive(curIdx - 1, true); }
function replay(){ if(chordEvents.length) playChord(chordEvents[curIdx].chord); }
function reset(){ if(chordEvents.length) setActive(0,false); }

document.getElementById('btnEnable').addEventListener('click', () => { ensureAudio(); replay(); });
document.getElementById('btnNext').addEventListener('click', next);
document.getElementById('btnPrev').addEventListener('click', prev);
document.getElementById('btnReplay').addEventListener('click', replay);
document.getElementById('btnReset').addEventListener('click', reset);

document.getElementById('tapNext').addEventListener('click', next);
document.getElementById('tapLeft').addEventListener('click', prev);
document.getElementById('tapReplay').addEventListener('click', replay);

document.getElementById('btnMute').addEventListener('click', (e) => {
  isMuted = !isMuted;
  e.target.textContent = isMuted ? "Unmute" : "Mute";
  e.target.classList.toggle('danger', isMuted);
});

lyricsEl.addEventListener('click', (e) => {
  const t = e.target.closest('.ch');
  if(!t) return;
  setActive(+t.dataset.idx, true);
});

function hookSlider(id, outId, fmt){
  const s = document.getElementById(id);
  const out = document.getElementById(outId);
  const upd = () => out.textContent = fmt(+s.value);
  s.addEventListener('input', upd); upd();
}
hookSlider('strum','strumVal', v => `${v}ms`);
hookSlider('bright','brightVal', v => `${v}%`);
hookSlider('vol','volVal', v => `${v}%`);

window.addEventListener('keydown', (e) => {
  if(e.code === 'ArrowRight' || e.code === 'Space'){ e.preventDefault(); next(); }
  if(e.code === 'ArrowLeft'){ prev(); }
  if(e.key.toLowerCase() === 'r'){ replay(); }
});
</script>
</body>
</html>