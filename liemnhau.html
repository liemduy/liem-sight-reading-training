<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Đệm hát – Guitar (CDN soundfont)</title>

  <!-- CDN: soundfont-player -->
  <script src="https://cdn.jsdelivr.net/npm/soundfont-player@0.12.0/dist/soundfont-player.min.js"></script>

  <style>
    :root{--bg:#0b0f14;--panel:#121a24;--text:#e8eef7;--muted:#9fb0c7;--accent:#6aa9ff;--danger:#ff6a6a;--good:#52d18f}
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#070a0f 0%,#0b0f14 40%,#070a0f 100%);color:var(--text);font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    header{position:sticky;top:0;z-index:10;background:rgba(11,15,20,.78);backdrop-filter:blur(10px);border-bottom:1px solid rgba(255,255,255,.08);padding:12px 14px;display:flex;justify-content:space-between;gap:10px;align-items:center}
    .title{font-weight:800}
    .status{font-size:12px;color:var(--muted);display:flex;gap:8px;align-items:center}
    .dot{width:10px;height:10px;border-radius:999px;background:var(--danger);box-shadow:0 0 0 3px rgba(255,106,106,.14)}
    .dot.on{background:var(--good);box-shadow:0 0 0 3px rgba(82,209,143,.16)}
    main{padding:14px}
    .grid{max-width:980px;margin:0 auto;display:grid;gap:12px}
    .card{background:rgba(18,26,36,.88);border:1px solid rgba(255,255,255,.08);border-radius:14px;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .hd{padding:10px 12px;background:rgba(15,22,32,.92);border-bottom:1px solid rgba(255,255,255,.08);display:flex;justify-content:space-between;align-items:center;gap:10px}
    .bd{padding:12px}
    .big{display:flex;gap:10px;align-items:baseline;flex-wrap:wrap}
    .cur{font-size:42px;font-weight:900;color:var(--accent)}
    .next{font-size:14px;color:var(--muted)}
    .controls{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-top:10px}
    button{appearance:none;border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.06);color:var(--text);padding:12px 10px;border-radius:12px;font-weight:900;cursor:pointer;user-select:none;-webkit-tap-highlight-color:transparent}
    button.primary{background:rgba(106,169,255,.18);border-color:rgba(106,169,255,.35)}
    button.danger{background:rgba(255,106,106,.14);border-color:rgba(255,106,106,.30)}
    .hint{color:var(--muted);font-size:13px;line-height:1.5}
    .lyrics{font-size:18px;line-height:1.75;white-space:pre-wrap}
    .ch{display:inline-block;padding:.08em .38em;margin:0 .10em;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.05);color:#cfe2ff;font-weight:900;cursor:pointer}
    .ch.active{background:rgba(106,169,255,.25);border-color:rgba(106,169,255,.55);box-shadow:0 0 0 3px rgba(106,169,255,.18)}
    .footer{position:sticky;bottom:0;z-index:20;background:rgba(11,15,20,.85);backdrop-filter:blur(10px);border-top:1px solid rgba(255,255,255,.08);padding:10px 14px}
    .footer .row{max-width:980px;margin:0 auto;display:grid;grid-template-columns:1fr 1.3fr 1fr;gap:10px}
    input[type="range"]{width:160px}
    .pill{font-size:12px;color:var(--muted);padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.04);display:inline-flex;gap:8px;align-items:center;justify-content:center;white-space:nowrap}
    .pill b{color:var(--text)}
    .split{display:flex;gap:10px;justify-content:center;align-items:center;flex-wrap:wrap}

    /* Tap-to-enable overlay (Safari) */
    #gate{position:fixed;inset:0;z-index:9999;background:rgba(0,0,0,.72);display:flex;align-items:center;justify-content:center;padding:24px}
    #gate .box{width:min(560px,100%);border-radius:16px;border:1px solid rgba(255,255,255,.14);background:rgba(18,26,36,.92);box-shadow:0 18px 60px rgba(0,0,0,.45);padding:18px}
    #gate h2{margin:0 0 8px 0;font-size:18px}
    #gate p{margin:0 0 12px 0;color:var(--muted)}
    #gate button{width:100%;padding:14px 12px;font-size:18px}
    .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:12px;padding:2px 6px;border-radius:6px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.05)}
    select{width:100%;padding:12px 10px;border-radius:12px;border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.06);color:var(--text);font-weight:800}
  </style>
</head>
<body>
  <div id="gate">
    <div class="box">
      <h2>Bật âm thanh + tải tiếng guitar (CDN)</h2>
      <p>Chạm nút dưới để Safari cho phép audio. Sau đó app sẽ tải tiếng <span class="kbd">acoustic_guitar_nylon</span> từ soundfont (cần internet).</p>
      <button class="primary" id="gateBtn">Tap to Enable Audio</button>
      <p style="margin-top:10px">Nếu bạn mở trong Zalo/Facebook/Files preview: hãy “Open in Safari”.</p>
    </div>
  </div>

  <header>
    <div class="title">Đệm hát (CDN guitar)</div>
    <div class="status"><span class="dot" id="audDot"></span><span id="audText">Audio: chưa bật</span></div>
  </header>

  <main>
    <div class="grid">

      <section class="card">
        <div class="hd">
          <div>
            <div class="big">
              <div class="cur" id="curChord">—</div>
              <div class="next" id="nextChord">Next: —</div>
            </div>
            <div class="hint">Bấm <span class="kbd">NEXT</span> theo ca sĩ. Chạm hợp âm trong lời để nhảy nhanh.</div>
          </div>
          <small id="idxInfo" style="color:var(--muted)">0 / 0</small>
        </div>

        <div class="bd">
          <div class="controls">
            <button class="primary" id="btnEnable">Bật âm thanh</button>
            <button id="btnPrev">Prev</button>
            <button class="primary" id="btnNext">Next</button>
            <button id="btnReplay">Replay</button>
            <button class="danger" id="btnReset">Reset</button>
            <button id="btnMute">Mute</button>
          </div>

          <div style="margin-top:12px">
            <div class="hint" style="margin-bottom:8px">Chọn tiếng (instrument):</div>
            <select id="instSel">
              <option value="acoustic_guitar_nylon" selected>acoustic_guitar_nylon (bolero hợp)</option>
              <option value="acoustic_guitar_steel">acoustic_guitar_steel</option>
              <option value="electric_guitar_clean">electric_guitar_clean</option>
            </select>
          </div>

          <div style="margin-top:10px" class="split">
            <div class="pill"><span>Strum</span> <b id="strumVal">90ms</b></div>
            <input id="strum" type="range" min="50" max="160" value="90" />
            <div class="pill"><span>Vol</span> <b id="volVal">75%</b></div>
            <input id="vol" type="range" min="10" max="100" value="75" />
          </div>

          <div class="hint" style="margin-top:10px" id="loadInfo">Instrument: chưa load</div>
        </div>
      </section>

      <section class="card">
        <div class="hd"><div><b>Lời + hợp âm</b></div><small style="color:var(--muted)">hợp âm trong [ ] là nút</small></div>
        <div class="bd"><div class="lyrics" id="lyrics"></div></div>
      </section>

    </div>
  </main>

  <div class="footer">
    <div class="row">
      <button id="tapPrev">◀︎ Prev</button>
      <button class="primary" id="tapNext" style="padding:14px 10px;font-size:18px">NEXT</button>
      <button id="tapReplay">⟲ Replay</button>
    </div>
  </div>

<script>
/* ===== 1) INPUT ===== */
const RAW = `1. Tuổi đời chân đơn [Am] côi gót mòn đại lộ [F] buồn
Đèn [G] đêm bóng mờ nhạt [C] nhòa
[A7] Hồn lắng tâm [Dm] tư, đi vào dĩ [Am] vãng
Đường tình không chung [E7] lối mang nuối tiếc cho [F] nhau [E7]

2. Ngày nào tay trong [Am] tay lối về cùng hẹn [F] hò
Dìu [G] em giấc mộng vừa [C] tròn
[A7] Tình thắm môi [Dm] hồng, đêm dài lưu [Am] luyến,
Nghẹn ngào trong thương [E7] nhớ vì mai bước theo [Am] chồng. [Dm] [Am]

ĐK:
Em sang ngang [F] rồi chôn kỷ [G] niệm vào thương [C] nhớ
Hôn lên tóc [Am] mềm lệ [A7] sầu thắm ướt đôi [Dm] mi
Xin em một [G] lần cho ước nguyện tình yêu [E7] cuối
Thương yêu không [G] thành thôi giã [E7] từ đi em [Am] ơi.

3. Người về lên xe [Am] hoa, kỷ niệm buồn vào [F] hồn
Bờ [G] môi tắt hẳn nụ [C] cười
[A7] Giây phút bên [Dm] nhau nay còn đâu [Am] nữa
Người về trong thương [E7] nhớ người đi nhớ thương [Am] người.`;

/* ===== 2) PARSE + RENDER ===== */
function normalizeChordName(ch){ return ch.trim(); }
const chordEvents = [];
const lyricsEl = document.getElementById('lyrics');

(function renderLyrics(){
  const re = /\[([^\]]+)\]/g;
  let idx = 0;
  const html = RAW.replace(re, (_, chordText) => {
    const chord = normalizeChordName(chordText);
    return `<span class="ch" data-idx="${idx++}" data-ch="${encodeURIComponent(chord)}">${chord}</span>`;
  });
  lyricsEl.innerHTML = html;
  [...lyricsEl.querySelectorAll('.ch')].forEach(sp => chordEvents.push({
    chord: decodeURIComponent(sp.dataset.ch),
    span: sp
  }));
})();

/* ===== 3) AUDIO via Soundfont (CDN) ===== */
let audioCtx = null;
let instrument = null;
let isMuted = false;
let activeNotes = []; // returned nodes to stop

const audDot = document.getElementById('audDot');
const audText = document.getElementById('audText');
const loadInfo = document.getElementById('loadInfo');

function setAudioUI(on){
  audDot.classList.toggle('on', !!on);
  audText.textContent = on ? "Audio: đã bật" : "Audio: chưa bật";
}

function ensureAudio(){
  if(audioCtx) return true;
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  setAudioUI(true);
  return true;
}

async function loadInstrument(name){
  ensureAudio();
  if(audioCtx.state === 'suspended') await audioCtx.resume();

  loadInfo.textContent = `Instrument: đang load ${name}...`;
  // Soundfont.instrument(ctx, name) -> Promise<instrument>
  instrument = await window.Soundfont.instrument(audioCtx, name);
  loadInfo.textContent = `Instrument: OK (${name})`;
}

async function enableAudio(){
  ensureAudio();
  if(audioCtx.state === 'suspended') await audioCtx.resume();
  document.getElementById('gate').style.display = 'none';
  // load current instrument
  await loadInstrument(document.getElementById('instSel').value);
  // quick test
  replay();
}

function stopActive(){
  for(const n of activeNotes){
    try{ if(n && typeof n.stop === 'function') n.stop(0); }catch(e){}
  }
  activeNotes = [];
}

function playChord(ch){
  if(!instrument || !audioCtx) return;
  if(isMuted) return;

  stopActive();

  const strumMs = +document.getElementById('strum').value;
  const vol = (+document.getElementById('vol').value)/100;

  // Voicing notes (tên nốt) — đủ cho bolero cơ bản
  const VOICE = {
    "Am": ["A2","E3","A3","C4","E4"],
    "A7": ["A2","E3","G3","C#4","E4"],
    "Dm": ["D3","A3","D4","F4"],
    "E7": ["E2","B2","D3","G#3","B3","E4"],
    "F":  ["F2","C3","F3","A3","C4","F4"],
    "G":  ["G2","D3","G3","B3","D4","G4"],
    "C":  ["C3","G3","C4","E4","G4"],
  };

  const notes = VOICE[ch] || []; // nếu hợp âm lạ: thôi, im để khỏi “giả”
  if(!notes.length) return;

  const t0 = audioCtx.currentTime + 0.02;

  notes.forEach((note, i) => {
    const t = t0 + i*(strumMs/1000);
    // instrument.play(note, time, {gain, duration})
    const node = instrument.play(note, t, { gain: Math.max(0.08, vol*(0.95 - i*0.08)), duration: 2.2 });
    activeNotes.push(node);
  });
}

/* ===== 4) TIMELINE ===== */
let curIdx = 0;
const curChordEl = document.getElementById('curChord');
const nextChordEl = document.getElementById('nextChord');
const idxInfoEl = document.getElementById('idxInfo');

function clampIdx(i){ return Math.max(0, Math.min(chordEvents.length-1, i)); }

function setActive(i, play=false){
  if(!chordEvents.length) return;
  curIdx = clampIdx(i);

  chordEvents.forEach(ev => ev.span.classList.remove('active'));
  const ev = chordEvents[curIdx];
  ev.span.classList.add('active');

  curChordEl.textContent = ev.chord;
  nextChordEl.textContent = "Next: " + (chordEvents[curIdx+1]?.chord ?? "—");
  idxInfoEl.textContent = `${curIdx+1} / ${chordEvents.length}`;

  ev.span.scrollIntoView({behavior:"smooth", block:"center", inline:"nearest"});
  if(play) playChord(ev.chord);
}

if(chordEvents.length) setActive(0,false);

function next(){ setActive(curIdx+1, true); }
function prev(){ setActive(curIdx-1, true); }
function replay(){ if(chordEvents.length) playChord(chordEvents[curIdx].chord); }
function reset(){ if(chordEvents.length) setActive(0,false); }

/* ===== UI ===== */
document.getElementById('gateBtn').addEventListener('click', enableAudio);
document.getElementById('btnEnable').addEventListener('click', enableAudio);

document.getElementById('btnNext').addEventListener('click', next);
document.getElementById('btnPrev').addEventListener('click', prev);
document.getElementById('btnReplay').addEventListener('click', replay);
document.getElementById('btnReset').addEventListener('click', reset);

document.getElementById('tapNext').addEventListener('click', next);
document.getElementById('tapPrev').addEventListener('click', prev);
document.getElementById('tapReplay').addEventListener('click', replay);

document.getElementById('btnMute').addEventListener('click', (e) => {
  isMuted = !isMuted;
  e.target.textContent = isMuted ? "Unmute" : "Mute";
  e.target.classList.toggle('danger', isMuted);
  if(isMuted) stopActive();
});

lyricsEl.addEventListener('click', (e) => {
  const t = e.target.closest('.ch');
  if(!t) return;
  setActive(+t.dataset.idx, true);
});

document.getElementById('instSel').addEventListener('change', async (e) => {
  if(!audioCtx) return;
  await loadInstrument(e.target.value);
});

function hookSlider(id, outId, fmt){
  const s = document.getElementById(id);
  const out = document.getElementById(outId);
  const upd = () => out.textContent = fmt(+s.value);
  s.addEventListener('input', upd); upd();
}
hookSlider('strum','strumVal', v => `${v}ms`);
hookSlider('vol','volVal', v => `${v}%`);

window.addEventListener('keydown', (e) => {
  if(e.code === 'ArrowRight' || e.code === 'Space'){ e.preventDefault(); next(); }
  if(e.code === 'ArrowLeft'){ prev(); }
  if(e.key.toLowerCase() === 'r'){ replay(); }
});
</script>
</body>
</html>