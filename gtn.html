<!doctype html>
<html lang="vi">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no"
    />
    <meta name="theme-color" content="#0b0f14" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <title>Guitar Nhậu</title>

    <style>
      :root{
        --bg:#0b0f14;
        --panel:#121924;
        --border:#223047;
        --text:#e7edf5;
        --muted:rgba(231,237,245,.75);
        --hero:#ff8a00;
        --heroBorder:#ffb15a;
        --ok:rgba(72,255,179,.20);
        --warn:rgba(255,184,107,.20);
      }

      html, body { height:100%; width:100%; margin:0; background:var(--bg); color:var(--text); }
      body{
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
        -webkit-tap-highlight-color: transparent;
        user-select:none;
        touch-action: manipulation;
        overflow:hidden;
      }

      /* Landscape overlay */
      #orientationOverlay{
        position:fixed; inset:0;
        background:rgba(0,0,0,.92);
        z-index:9999;
        display:flex;
        align-items:center;
        justify-content:center;
      }
      #orientationOverlay.hidden{ display:none; }
      .overlayCard{
        width:min(560px, 92vw);
        background:var(--panel);
        border:1px solid var(--border);
        border-radius:18px;
        padding:18px;
        text-align:center;
      }
      .overlayTitle{ font-weight:900; font-size:20px; margin-bottom:8px; }
      .overlaySub{ color:var(--muted); }

      /* Layout 3 columns */
      #app{
        height:100%;
        width:100%;
        display:flex;
        gap:12px;
        padding:12px;
        box-sizing:border-box;
      }
      .col{
        height:100%;
        background:var(--panel);
        border:1px solid var(--border);
        border-radius:18px;
        box-sizing:border-box;
        overflow:hidden;
        display:flex;
        flex-direction:column;
      }
      #colLeft{ width:30%; min-width:280px; }
      #colMid{ width:55%; min-width:320px; }
      #colRight{ width:15%; min-width:140px; }

      .section{
        padding:12px;
        border-bottom:1px solid var(--border);
      }
      .sectionTitle{
        font-weight:900;
        margin-bottom:10px;
        letter-spacing:.2px;
      }

      /* Buttons */
      button{
        background:#1f2b3e;
        border:1px solid #2d3f5c;
        color:var(--text);
        border-radius:14px;
        padding:12px 12px;
        cursor:pointer;
      }
      button:active{ transform: translateY(1px); }

      /* Left column - Melody Pad */
      .melodyRow{
        display:grid;
        grid-template-columns: repeat(7, 1fr);
        gap:8px;
      }
      .melodyBtn{
        padding:12px 8px;
        font-weight:900;
        white-space:pre-line;
        min-height:62px;
      }

      /* Pattern slots */
      .slotsGrid{
        display:grid;
        grid-template-columns: repeat(3, 1fr);
        gap:10px;
      }
      .slotBtn{
        border-radius:999px;
        min-height:64px;
        font-weight:900;
        white-space:pre-line;
      }
      .slotBtn.empty{
        border-style:dashed;
        opacity:.9;
      }
      .slotBtn.active{
        outline:2px solid #72a7ff;
        box-shadow: 0 0 18px rgba(114,167,255,.35);
      }

      /* Master control */
      .master{
        display:flex;
        gap:10px;
        height:100%;
      }
      .hero{
        flex:1;
        background:var(--hero);
        border:1px solid var(--heroBorder);
        color:#0b0f14;
        font-weight:1000;
        font-size:22px;
        border-radius:18px;
        display:flex;
        flex-direction:column;
        justify-content:center;
        align-items:center;
        position:relative;
        min-height:160px;
      }
      .hero small{
        position:absolute;
        left:12px;
        bottom:10px;
        font-size:12px;
        font-weight:900;
        opacity:.85;
      }
      .rightGrid{
        width:46%;
        display:flex;
        flex-direction:column;
        gap:10px;
      }
      .btnFill{
        background:#7a2a3c;
        border:1px solid #a83a52;
        font-weight:900;
        padding:14px 10px;
        border-radius:16px;
      }
      .miniControls{
        background:#0f1520;
        border:1px solid #2d3f5c;
        border-radius:16px;
        padding:10px;
      }
      .ctrlRow{
        display:grid;
        grid-template-columns: 42px 1fr 42px;
        gap:8px;
        align-items:center;
        margin-top:8px;
      }
      .ctrlRow .val{
        text-align:center;
        font-weight:1000;
        font-size:16px;
      }
      .ctrlLabel{
        font-weight:900;
        color:var(--muted);
        font-size:12px;
      }

      /* Center column */
      .headerTop{
        display:flex;
        align-items:center;
        gap:10px;
        flex-wrap:wrap;
      }
      .songTitle{
        font-weight:1000;
        font-size:18px;
      }
      select{
        background:#0f1520;
        border:1px solid #2d3f5c;
        color:var(--text);
        border-radius:12px;
        padding:10px;
      }
      .headerMeta{
        display:flex;
        gap:10px;
        flex-wrap:wrap;
        margin-top:10px;
        color:var(--muted);
        font-size:13px;
      }
      .playBtn{
        background:#2a4a7a;
        border:1px solid #3a66a8;
        font-weight:900;
        padding:12px 14px;
        border-radius:14px;
      }
      .stopBtn{
        background:#5a1f2c;
        border:1px solid #7a2a3c;
        font-weight:900;
        padding:12px 14px;
        border-radius:14px;
      }

      .freestyleRow{
        display:flex;
        gap:8px;
        overflow-x:auto;
        padding-bottom:6px;
      }
      .freestyleRow button{
        border-radius:999px;
        padding:10px 12px;
        font-weight:900;
        white-space:nowrap;
      }

      .lyrics{
        flex:1;
        overflow:auto;
        padding:12px;
        font-size:22px;
        line-height:1.55;
        white-space:pre-wrap;
      }
      .chord{ font-weight:1000; padding:0 5px; border-radius:10px; }
      .chord-active{ background:var(--ok); }
      .chord-queued{ background:var(--warn); }
      .chord-past{ opacity:.55; }

      /* Right column - Dynamics slider vertical */
      .dynWrap{
        flex:1;
        display:flex;
        flex-direction:column;
        gap:10px;
        padding:12px;
      }
      .dynLabelTop, .dynLabelBottom{
        font-weight:1000;
        color:var(--muted);
        text-align:center;
      }
      .dynSliderWrap{
        flex:1;
        display:flex;
        justify-content:center;
        align-items:center;
      }
      input[type="range"].vertical{
        -webkit-appearance:none;
        appearance:none;
        width: 260px;
        height: 38px;
        transform: rotate(-90deg);
        background:transparent;
      }
      input[type="range"].vertical::-webkit-slider-runnable-track{
        height:10px;
        background:#0f1520;
        border:1px solid #2d3f5c;
        border-radius:999px;
      }
      input[type="range"].vertical::-webkit-slider-thumb{
        -webkit-appearance:none;
        appearance:none;
        width:34px;
        height:34px;
        border-radius:50%;
        background:#e7edf5;
        border:1px solid #2d3f5c;
        margin-top:-13px;
      }

      /* Modal pattern picker */
      #patternModal{
        position:fixed; inset:0;
        background:rgba(0,0,0,.72);
        display:none;
        align-items:center;
        justify-content:center;
        z-index:9998;
      }
      #patternModal.open{ display:flex; }
      .modalCard{
        width:min(720px, 92vw);
        max-height:min(80vh, 680px);
        overflow:auto;
        background:var(--panel);
        border:1px solid var(--border);
        border-radius:18px;
        padding:14px;
      }
      .modalTitle{ font-weight:1000; font-size:16px; margin-bottom:10px; }
      .patternList{
        display:grid;
        grid-template-columns: 1fr;
        gap:10px;
      }
      .patternItem{
        display:flex;
        justify-content:space-between;
        align-items:center;
        gap:10px;
        padding:12px;
        border:1px solid #2d3f5c;
        border-radius:14px;
        background:#0f1520;
      }
      .patternItem .name{ font-weight:1000; }
      .patternItem .meta{ color:var(--muted); font-size:12px; }
      .modalActions{ display:flex; justify-content:flex-end; margin-top:12px; }
    </style>
  </head>

  <body>
    <!-- Portrait overlay -->
    <div id="orientationOverlay" class="hidden">
      <div class="overlayCard">
        <div class="overlayTitle">Xoay ngang máy để bắt đầu nhậu!</div>
        <div class="overlaySub">Landscape only</div>
      </div>
    </div>

    <!-- Pattern picker modal -->
    <div id="patternModal">
      <div class="modalCard">
        <div class="modalTitle" id="modalTitle">Chọn điệu</div>
        <div class="patternList" id="patternList"></div>
        <div class="modalActions">
          <button id="btnModalClose">Đóng</button>
        </div>
      </div>
    </div>

    <!-- App layout -->
    <div id="app">
      <!-- LEFT: Control Panel -->
      <div class="col" id="colLeft">
        <!-- Melody Pad -->
        <div class="section">
          <div class="sectionTitle">Smart Melody Pad</div>
          <div class="melodyRow">
            <button class="melodyBtn" id="mel0">1</button>
            <button class="melodyBtn" id="mel1">2</button>
            <button class="melodyBtn" id="mel2">3</button>
            <button class="melodyBtn" id="mel3">4</button>
            <button class="melodyBtn" id="mel4">5</button>
            <button class="melodyBtn" id="mel5">6</button>
            <button class="melodyBtn" id="mel6">7</button>
          </div>
        </div>

        <!-- Pattern Slots -->
        <div class="section">
          <div class="sectionTitle">Pattern Slots</div>
          <div class="slotsGrid">
            <button class="slotBtn empty" id="slot0">+</button>
            <button class="slotBtn empty" id="slot1">+</button>
            <button class="slotBtn empty" id="slot2">+</button>
            <button class="slotBtn empty" id="slot3">+</button>
            <button class="slotBtn empty" id="slot4">+</button>
            <button class="slotBtn empty" id="slot5">+</button>
          </div>
        </div>

        <!-- Master Control -->
        <div class="section" style="border-bottom:0; flex:1; display:flex; flex-direction:column;">
          <div class="sectionTitle">Master Control</div>

          <div class="master" style="flex:1;">
            <button class="hero" id="btnNextChord">
              NEXT CHORD
              <small>Tiếp theo: <span id="nextChordPreview">—</span></small>
            </button>

            <div class="rightGrid">
              <button class="btnFill" id="btnFill">QUẠT VÀO (FILL)</button>

              <div class="miniControls">
                <div class="ctrlLabel">Transpose</div>
                <div class="ctrlRow">
                  <button id="btnTransMinus">-</button>
                  <div class="val" id="transposeVal">0</div>
                  <button id="btnTransPlus">+</button>
                </div>

                <div class="ctrlLabel" style="margin-top:10px;">BPM</div>
                <div class="ctrlRow">
                  <button id="btnBpmMinus">-</button>
                  <div class="val" id="bpmVal">78</div>
                  <button id="btnBpmPlus">+</button>
                </div>
              </div>

              <!-- Optional debug toggles (can hide later) -->
              <div class="miniControls">
                <div class="ctrlLabel">Chế độ đổi hợp âm</div>
                <select id="changeMode" style="width:100%;">
                  <option value="nextBar" selected>Đầu ô nhịp</option>
                  <option value="immediate">Đổi ngay</option>
                </select>

                <div class="ctrlLabel" style="margin-top:10px;">Metronome</div>
                <select id="metroMode" style="width:100%;">
                  <option value="off" selected>Tắt</option>
                  <option value="on">Bật</option>
                </select>
              </div>
            </div>
          </div>

          <div style="margin-top:10px; color:var(--muted); font-size:12px;">
            Status: <span id="status">—</span>
          </div>
        </div>
      </div>

      <!-- MIDDLE: The Stage -->
      <div class="col" id="colMid">
        <!-- Header -->
        <div class="section">
          <div class="headerTop">
            <div class="songTitle" id="songTitle">Guitar Nhậu</div>
            <select id="songSelect"></select>
            <button class="playBtn" id="btnPlay">Play</button>
            <button class="stopBtn" id="btnStop">Stop</button>
          </div>

          <div class="headerMeta">
            <div>Điệu: <span id="songGenre">—</span></div>
            <div>Pattern: <span id="activePattern">—</span></div>
            <div>Chord: <span id="activeChord">—</span></div>
            <div>Queued: <span id="queuedChord">—</span></div>
          </div>
        </div>

        <!-- Freestyle Row (sticky) -->
        <div class="section" style="position:sticky; top:0; z-index:5; background:var(--panel);">
          <div class="sectionTitle" style="margin-bottom:8px;">Freestyle Chord Row</div>
          <div class="freestyleRow" id="freestyleRow"></div>
        </div>

        <!-- Lyrics -->
        <div class="lyrics" id="lyricsView"></div>
      </div>

      <!-- RIGHT: Dynamics -->
      <div class="col" id="colRight">
        <div class="section" style="border-bottom:0; flex:1; display:flex; flex-direction:column;">
          <div class="sectionTitle">Dynamics</div>

          <div class="dynWrap">
            <div class="dynLabelTop">MẠNH (Quạt)</div>
            <div class="dynSliderWrap">
              <input id="dynSlider" class="vertical" type="range" min="0" max="100" value="50" />
            </div>
            <div class="dynLabelBottom">NHẸ (Rải)</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tone.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.18/Tone.js"></script>
    <!-- App -->
    <script type="module" src="./app.js"></script>
  </body>
</html>
