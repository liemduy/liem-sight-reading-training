<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bolero Laboratory - T·ª± Ch·ªânh Th√¥ng S·ªë</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.18/Tone.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/soundfont-player@0.12.0/dist/soundfont-player.min.js"></script>

  <style>
    :root { --bg: #121214; --panel: #1c1c1f; --accent: #4cc9f0; --text: #e0e0e0; }
    body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; padding: 20px; font-size: 14px; }
    
    h2 { color: var(--accent); margin-bottom: 5px; }
    .subtitle { color: #888; font-size: 0.85rem; margin-bottom: 20px; }

    .main-grid { display: grid; grid-template-columns: 250px 1fr; gap: 20px; max-width: 1000px; margin: 0 auto; }
    
    /* C·ªôt tr√°i: Master Controls */
    .controls-panel { background: var(--panel); padding: 15px; border-radius: 8px; border: 1px solid #333; height: fit-content; }
    
    .control-group { margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #333; }
    .control-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #bbb; }
    input[type=range] { width: 100%; accent-color: var(--accent); cursor: pointer; }
    
    button { 
      width: 100%; padding: 10px; margin-top: 5px; border: none; border-radius: 4px; 
      font-weight: bold; cursor: pointer; transition: 0.2s; 
    }
    .btn-play { background: var(--accent); color: #000; }
    .btn-stop { background: #ef233c; color: #fff; display: none; }
    .btn-preset { background: #333; color: #fff; margin-bottom: 5px; font-size: 0.8rem; }
    .btn-preset:hover { background: #444; }

    /* C·ªôt ph·∫£i: Step Matrix */
    .matrix-panel { background: var(--panel); padding: 15px; border-radius: 8px; border: 1px solid #333; }
    
    .step-row { 
      display: grid; grid-template-columns: 60px 1fr 1fr 1fr 40px; 
      gap: 10px; align-items: center; padding: 8px 0; border-bottom: 1px solid #2a2a2a; 
    }
    .step-row:last-child { border-bottom: none; }
    .step-label { font-weight: bold; color: var(--accent); }
    
    .slider-col { display: flex; flex-direction: column; }
    .slider-col span { font-size: 0.7rem; color: #666; margin-bottom: 2px; }
    
    .val-display { font-family: monospace; color: #fff; text-align: right; }

    /* Visualizer */
    .viz-bar { height: 4px; background: #333; margin-top: 5px; position: relative; width: 100%; }
    .viz-cursor { 
      position: absolute; top: -2px; bottom: -2px; width: 2px; background: #ff0000; 
      left: 0%; transition: left 0.1s linear; 
    }

    .chord-select { display: flex; gap: 5px; margin-top: 10px; }
    .btn-chord { background: #222; border: 1px solid #444; color: #fff; flex: 1; }
    .btn-chord.active { background: var(--accent); color: #000; border-color: var(--accent); }

  </style>
</head>
<body>

<div class="main-grid">
  <div class="controls-panel">
    <h2>üéõ Bolero Lab</h2>
    <p class="subtitle">Tinh ch·ªânh t·ª´ng mili-gi√¢y</p>

    <div class="control-group">
      <label>Tr·∫°ng th√°i</label>
      <div id="status" style="color: #ffb703; font-size: 0.9rem;">Ch·ªù t·∫£i...</div>
      <button id="btn-play" class="btn-play" onclick="initAudio()">‚ñ∂ T·∫¢I & CH∆†I</button>
      <button id="btn-stop" class="btn-stop" onclick="stopAudio()">‚èπ D·ª™NG</button>
    </div>

    <div class="control-group">
      <label>T·ªëc ƒë·ªô (BPM): <span id="disp-bpm">80</span></label>
      <input type="range" id="bpm" min="50" max="140" value="80" oninput="updateMaster('bpm', this.value)">
    </div>

    <div class="control-group">
      <label>Tone (EQ)</label>
      <div class="slider-col">
        <span>Low / Bass (<span id="disp-low">0</span> dB)</span>
        <input type="range" min="-20" max="10" value="0" step="1" oninput="updateEQ('low', this.value)">
      </div>
      <div class="slider-col" style="margin-top:10px;">
        <span>High / Treble (<span id="disp-high">0</span> dB)</span>
        <input type="range" min="-20" max="10" value="0" step="1" oninput="updateEQ('high', this.value)">
      </div>
    </div>

    <div class="control-group">
      <label>H·ª£p √¢m</label>
      <div class="chord-select">
        <button class="btn-chord active" onclick="setChord('Am')">Am</button>
        <button class="btn-chord" onclick="setChord('Dm')">Dm</button>
        <button class="btn-chord" onclick="setChord('E7')">E7</button>
      </div>
    </div>

    <div class="control-group">
      <label>Preset (M·∫´u)</label>
      <button class="btn-preset" onclick="loadPreset('video')">Ki·ªÉu Video (L∆°i)</button>
      <button class="btn-preset" onclick="loadPreset('robot')">Ki·ªÉu ƒê·ªÅu (Robot)</button>
    </div>
  </div>

  <div class="matrix-panel">
    <div style="display:flex; justify-content:space-between; margin-bottom:10px; border-bottom:1px solid #444; padding-bottom:5px;">
      <span style="font-weight:bold">B∆∞·ªõc (Step)</span>
      <span>Th·ªùi ƒëi·ªÉm (0-4)</span>
      <span>ƒê·ªô d√†i (Gi√¢y)</span>
      <span>L·ª±c ƒë√°nh (Velocity)</span>
      <span>#</span>
    </div>
    
    <div id="steps-container">
      </div>
    
    <div class="viz-bar">
      <div id="cursor" class="viz-cursor"></div>
    </div>
  </div>
</div>

<script>
  // ================= DATA =================
  const CHORDS = {
    "Am": { bass: 5, frets: [-1, 0, 2, 2, 1, 0] },
    "Dm": { bass: 4, frets: [-1, -1, 0, 2, 3, 1] },
    "E7": { bass: 5, frets: [0, 2, 0, 1, 0, 0] }
  };
  const TUNING = [40, 45, 50, 55, 59, 64];

  // C·∫•u tr√∫c 9 b∆∞·ªõc chu·∫©n
  // Time: T√≠nh b·∫±ng s·ªë ph√°ch (Beats). 4/4 c√≥ 4 ph√°ch (0.0 ƒë·∫øn 4.0)
  let stepsData = [
    { id: 0, label: "B√ôM 1", type: "bass", time: 0.00, dur: 1.0, vel: 1.0 },
    { id: 1, label: "1",     type: "pluck1",time: 0.65, dur: 0.2, vel: 0.6 },
    { id: 2, label: "2",     type: "pluck2",time: 0.75, dur: 0.2, vel: 0.7 },
    { id: 3, label: "3",     type: "pluck3",time: 0.85, dur: 0.2, vel: 0.8 },
    { id: 4, label: "CH√ÅT",  type: "chat",  time: 1.00, dur: 0.05, vel: 0.9 }, // Beat 2
    { id: 5, label: "B√ôM 2", type: "alt",   time: 1.50, dur: 0.5, vel: 0.85 }, // ƒê·∫£o ph√°ch
    { id: 6, label: "CH√ÅT",  type: "chat",  time: 2.00, dur: 0.05, vel: 0.9 }, // Beat 3
    { id: 7, label: "B√ôM 3", type: "alt",   time: 2.50, dur: 0.5, vel: 0.85 },
    { id: 8, label: "CH√ÅT",  type: "chat",  time: 3.00, dur: 0.05, vel: 0.9 }, // Beat 4
  ];

  // ================= AUDIO ENGINE =================
  let guitar, eq, loop;
  let currentChord = "Am";
  let isReady = false;

  async function initAudio() {
    if(isReady) { startLoop(); return; }

    const btn = document.getElementById('btn-play');
    btn.disabled = true;
    btn.innerText = "ƒêANG T·∫¢I...";
    document.getElementById('status').innerText = "ƒêang t·∫£i b·ªô ti·∫øng...";

    await Tone.start();
    
    // 1. T·∫°o EQ (3-band)
    eq = new Tone.EQ3(0, 0, 0); // Low, Mid, High
    eq.toDestination();

    // 2. T·∫£i Soundfont (Steel Guitar cho ƒëanh)
    try {
      guitar = await Soundfont.instrument(Tone.context.rawContext, 'acoustic_guitar_steel', { destination: eq });
      
      isReady = true;
      document.getElementById('status').innerText = "S·∫µn s√†ng!";
      btn.style.display = 'none';
      document.getElementById('btn-stop').style.display = 'inline-block';
      
      startLoop();
    } catch(e) {
      document.getElementById('status').innerText = "L·ªói: " + e;
      btn.disabled = false;
    }
  }

  function startLoop() {
    Tone.Transport.bpm.value = document.getElementById('bpm').value;
    
    // Loop 1 √¥ nh·ªãp (1m)
    loop = new Tone.Loop((time) => {
      // M·ªói l·∫ßn loop ch·∫°y (ƒë·∫ßu √¥ nh·ªãp), ta l√™n l·ªãch cho c√°c s·ª± ki·ªán d·ª±a tr√™n Slider
      stepsData.forEach(step => {
        // T√≠nh th·ªùi gian tuy·ªát ƒë·ªëi: time (ƒë·∫ßu loop) + step.time (offset t√≠nh b·∫±ng beat)
        // Convert beat sang gi√¢y: Tone.Time("4n").toSeconds() * step.time ... 
        // Tone.js h·ªó tr·ª£ c·ªông chu·ªói: time + "0:0:0" nh∆∞ng slider l√† float.
        // C√°ch d·ªÖ nh·∫•t: D√πng Transport.seconds l√†m m·ªëc.
        
        // Schedule relative to current measure
        // L∆∞u √Ω: step.time l√† s·ªë beat (0 - 4).
        // C·∫ßn convert sang th·ªùi gian chu·∫©n c·ªßa Tone.
        // D√πng c√∫ ph√°p "0:0:0" c·ªßa Tone h∆°i ph·ª©c t·∫°p v·ªõi float slider.
        // Ta d√πng Transport.schedule cho t·ª´ng n·ªët trong kho·∫£ng th·ªùi gian n√†y.
      });
      
      // C√°ch tr√™n h∆°i kh√≥ sync real-time.
      // C√°ch t·ªët h∆°n: Loop ch·∫°y m·ªói 1/16 note (Sixteenth) v√† check xem c√≥ s·ª± ki·ªán n√†o g·∫ßn ƒë√≥ kh√¥ng?
      // KH√îNG. C√°ch t·ªët nh·∫•t cho "Lab" l√† schedule t·∫•t c·∫£ events cho 1 Bar s·∫Øp t·ªõi.
      
      stepsData.forEach(s => {
          // Convert Beat (float) -> Time string "0:0:0" format is tricky.
          // Let's use arithmetic: 1 Beat = "4n".
          let triggerTime = time + Tone.Time("4n").toSeconds() * s.time;
          
          playStep(s, triggerTime);
      });
      
      // Visual feedback cursor
      Tone.Draw.schedule(() => {
        animateCursor();
      }, time);

    }, "1m").start(0);

    Tone.Transport.start();
  }

  function stopAudio() {
    Tone.Transport.stop();
    if(loop) loop.dispose();
    document.getElementById('btn-play').style.display = 'inline-block';
    document.getElementById('btn-play').innerText = "TI·∫æP T·ª§C";
    document.getElementById('btn-play').disabled = false;
    document.getElementById('btn-stop').style.display = 'none';
  }

  function playStep(step, time) {
    if(!guitar) return;
    const chord = CHORDS[currentChord];
    let notes = [];
    
    // Logic ch·ªçn n·ªët
    if(step.type === 'bass') {
      notes = [getNote(chord.bass)];
    } else if (step.type === 'alt') {
      let alt = (currentChord === 'Dm') ? 5 : (chord.bass === 5 ? 4 : 5);
      notes = [getNote(alt)];
    } else if (step.type.startsWith('pluck')) {
      let offset = parseInt(step.type.replace('pluck','')); // 1, 2, 3
      if(step.type === 'pluck3') {
        // N·ªët s·ªë 3 th∆∞·ªùng l√† qu·∫°t nh·∫π
        notes = [getNote(3), getNote(2), getNote(1)];
      } else {
        notes = [getNote(chord.bass - offset)];
      }
    } else if (step.type === 'chat') {
      notes = [getNote(1), getNote(2), getNote(3)];
    }

    // Play
    notes.forEach((n, idx) => {
      if(!n) return;
      // Stagger ch√°t/strum m·ªôt ch√∫t cho t·ª± nhi√™n
      let stagger = (step.type === 'chat' || step.type === 'pluck3') ? idx * 0.01 : 0;
      
      guitar.play(n, time + stagger, {
        duration: step.dur,
        gain: step.vel,
        attack: 0.001,
        release: step.type === 'chat' ? 0.05 : 0.1 // Force release ng·∫Øn cho ch√°t
      });
    });
  }

  function getNote(stringIdx) {
    const chord = CHORDS[currentChord];
    const arrIdx = 6 - stringIdx;
    const fret = chord.frets[arrIdx];
    if(fret === -1) return null;
    return TUNING[arrIdx] + fret;
  }

  // ================= UI LOGIC =================
  const container = document.getElementById('steps-container');

  function renderSteps() {
    container.innerHTML = '';
    stepsData.forEach((s, idx) => {
      const div = document.createElement('div');
      div.className = 'step-row';
      div.innerHTML = `
        <div class="step-label">${s.label}</div>
        
        <div class="slider-col">
          <span>Th·ªùi ƒëi·ªÉm: <b id="val-time-${idx}">${s.time.toFixed(2)}</b></span>
          <input type="range" min="0" max="3.9" step="0.05" value="${s.time}" 
                 oninput="updateStep(${idx}, 'time', this.value)">
        </div>
        
        <div class="slider-col">
          <span>ƒê·ªô d√†i: <b id="val-dur-${idx}">${s.dur}s</b></span>
          <input type="range" min="0.05" max="1.5" step="0.05" value="${s.dur}" 
                 oninput="updateStep(${idx}, 'dur', this.value)">
        </div>

        <div class="slider-col">
          <span>L·ª±c: <b id="val-vel-${idx}">${s.vel}</b></span>
          <input type="range" min="0.1" max="1.2" step="0.1" value="${s.vel}" 
                 oninput="updateStep(${idx}, 'vel', this.value)">
        </div>

        <div style="text-align:center; color:#555; font-size:0.8rem">
           ${idx+1}
        </div>
      `;
      container.appendChild(div);
    });
  }

  window.updateStep = function(idx, field, val) {
    val = parseFloat(val);
    stepsData[idx][field] = val;
    document.getElementById(`val-${field}-${idx}`).innerText = (field === 'dur') ? val + 's' : val;
    
    // N·∫øu ch·ªânh Time, s·∫Øp x·∫øp l·∫°i m·∫£ng ƒë·ªÉ ƒë·∫£m b·∫£o logic (Optional, nh∆∞ng t·ªët cho visual)
    // stepsData.sort((a,b) => a.time - b.time); // ƒê·ª´ng sort n√≥ng, s·∫Ω nh·∫£y UI
  }

  window.updateMaster = function(type, val) {
    if(type === 'bpm') {
      document.getElementById('disp-bpm').innerText = val;
      Tone.Transport.bpm.value = val;
    }
  }

  window.updateEQ = function(type, val) {
    document.getElementById(`disp-${type}`).innerText = val;
    if(!eq) return;
    if(type === 'low') eq.low.value = val;
    if(type === 'high') eq.high.value = val;
  }

  window.setChord = function(c) {
    currentChord = c;
    document.querySelectorAll('.btn-chord').forEach(b => {
      b.classList.toggle('active', b.innerText === c);
    });
  }

  window.loadPreset = function(type) {
    if(type === 'video') {
      // Ki·ªÉu l∆°i: 1-2-3 d√≠nh ch√πm v√†o cu·ªëi ph√°ch 1
      stepsData[0].time = 0.0; // B√πm
      stepsData[1].time = 0.65; // 1
      stepsData[2].time = 0.75; // 2
      stepsData[3].time = 0.85; // 3
      stepsData[4].time = 1.0; // Ch√°t
      stepsData[4].dur = 0.05; // Ch√°t c·ª•t
    } else {
      // Ki·ªÉu robot: ƒê·ªÅu nhau
      stepsData[0].time = 0.0;
      stepsData[1].time = 0.25;
      stepsData[2].time = 0.50;
      stepsData[3].time = 0.75;
      stepsData[4].time = 1.0;
      stepsData[4].dur = 0.2; // Ch√°t d√†i h∆°n ch√∫t
    }
    renderSteps();
  }

  function animateCursor() {
    const cursor = document.getElementById('cursor');
    cursor.style.transition = 'none';
    cursor.style.left = '0%';
    setTimeout(() => {
      cursor.style.transition = `left ${Tone.Time("1m").toSeconds()}s linear`;
      cursor.style.left = '100%';
    }, 20);
  }

  // Init
  renderSteps();

</script>
</body>
</html>
