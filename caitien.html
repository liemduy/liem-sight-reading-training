<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Bolero Beer Mode - Auto & Percentage</title>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.18/Tone.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/soundfont-player@0.12.0/dist/soundfont-player.min.js"></script>

  <style>
    :root {
      --bg: #121214;
      --card: #1c1c1f;
      --accent: #ff9f1c; /* M√†u v√†ng cam bia */
      --text: #e0e0e0;
      --success: #2ec4b6;
      --error: #e71d36;
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Segoe UI', sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 10px;
      margin: 0;
      user-select: none;
    }

    h2 { color: var(--accent); margin: 10px 0; font-size: 1.4rem; text-transform: uppercase; letter-spacing: 1px; }
    
    .container {
      background: var(--card);
      padding: 15px;
      border-radius: 12px;
      width: 100%;
      max-width: 600px; /* R·ªông h∆°n ch√∫t ƒë·ªÉ ch·ª©a input */
      box-shadow: 0 4px 15px rgba(0,0,0,0.5);
      border: 1px solid #333;
    }

    /* GRID 9 B∆Ø·ªöC */
    .sequencer-grid {
      display: grid;
      grid-template-columns: repeat(9, 1fr);
      gap: 4px;
      margin-bottom: 5px;
    }
    
    .seq-step {
      background: #333;
      border-radius: 4px 4px 0 0;
      height: 40px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 0.65rem;
      text-align: center;
      color: #999;
      border: 1px solid #444;
      transition: all 0.1s;
      position: relative;
    }
    
    .seq-step.active {
      background: var(--accent);
      color: #000;
      font-weight: bold;
      border-color: var(--accent);
      z-index: 10;
      transform: scale(1.05);
      box-shadow: 0 0 10px var(--accent);
    }

    /* INPUT PH·∫¶N TRƒÇM */
    .percent-row {
      display: grid;
      grid-template-columns: repeat(9, 1fr);
      gap: 4px;
      margin-bottom: 15px;
    }

    .percent-input {
      width: 100%;
      background: #111;
      border: 1px solid #444;
      color: var(--accent);
      text-align: center;
      font-size: 0.8rem;
      padding: 5px 0;
      border-radius: 0 0 4px 4px;
      box-sizing: border-box;
    }
    .percent-input:focus { outline: none; border-color: var(--accent); background: #222; }

    /* VALIDATION TOTAL */
    .total-display {
      text-align: right;
      font-size: 0.8rem;
      margin-bottom: 10px;
      font-weight: bold;
    }
    .total-ok { color: var(--success); }
    .total-bad { color: var(--error); }

    /* Info Box */
    .info-box {
      background: #000;
      color: var(--accent);
      font-family: monospace;
      padding: 10px;
      border-radius: 6px;
      text-align: center;
      margin-bottom: 15px;
      border: 1px solid #333;
      min-height: 24px;
      font-size: 0.9rem;
    }

    /* N√∫t Trigger Th·ªß C√¥ng */
    #btn-trigger {
      width: 100%;
      padding: 15px;
      background: #333;
      border: 2px solid #555;
      border-radius: 8px;
      color: #888;
      font-size: 1.1rem;
      font-weight: bold;
      cursor: pointer;
      margin-bottom: 15px;
      transition: 0.1s;
    }
    #btn-trigger:active:not([disabled]) {
      background: #555; transform: scale(0.98); color: #fff;
    }

    /* AUTO PLAY SECTION */
    .auto-section {
      background: #25252a;
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #444;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .auto-header { display: flex; justify-content: space-between; align-items: center; }
    
    #btn-auto {
      background: var(--accent);
      color: #000;
      border: none;
      padding: 10px 20px;
      border-radius: 50px;
      font-weight: bold;
      cursor: pointer;
      font-size: 1rem;
      width: 100%;
    }
    #btn-auto.playing { background: var(--error); color: white; animation: pulse 1s infinite; }

    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.8; } 100% { opacity: 1; } }

    /* H·ª£p √¢m */
    .chord-row { display: flex; gap: 8px; margin-bottom: 10px; }
    .btn-chord {
      flex: 1;
      padding: 10px;
      background: #333;
      border: 1px solid #555;
      color: #fff;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
    }
    .btn-chord.active {
      background: var(--accent);
      color: #000;
    }

    /* Overlay Load */
    #overlay-load {
      position: absolute; top:0; left:0; width:100%; height:100%;
      background: rgba(0,0,0,0.9);
      display: flex; flex-direction: column;
      justify-content: center; align-items: center;
      z-index: 100;
      border-radius: 12px;
    }
    .btn-load {
      background: var(--accent); color: #000; padding: 15px 30px;
      font-size: 1.2rem; font-weight: bold; border: none; border-radius: 50px;
      cursor: pointer; box-shadow: 0 0 20px var(--accent);
    }

    input[type=range] { width: 100%; accent-color: var(--accent); }
  </style>
</head>
<body>

<div class="container" style="position: relative;">
  
  <div id="overlay-load">
    <h2 style="margin-bottom: 20px;">üç∫ BOLERO BEER MODE</h2>
    <button class="btn-load" onclick="initAudio()">R√ìT BIA & T·∫¢I TI·∫æNG</button>
    <p id="status-text" style="margin-top:10px; color: #888;">C·∫ßn t·∫£i soundfont (~5s)</p>
  </div>

  <div style="display:flex; justify-content:space-between; align-items:center;">
    <h2>üéöÔ∏è T√πy Ch·ªânh Nh·ªãp</h2>
    <button onclick="resetPercentages()" style="background:#444; border:none; color:#fff; padding:4px 8px; border-radius:4px; cursor:pointer; font-size:0.7rem;">Reset %</button>
  </div>

  <div class="sequencer-grid" id="seq-grid"></div>
  
  <div class="percent-row" id="percent-grid"></div>

  <div class="total-display" id="total-check">T·ªïng: 0%</div>

  <div class="info-box" id="info-display">S·∫µn s√†ng...</div>

  <button id="btn-trigger" onclick="manualPlay()" disabled>
    üñêÔ∏è G·∫¢Y TAY (Space)
  </button>

  <div class="chord-row">
    <button class="btn-chord active" onclick="setChord('Am')">Am</button>
    <button class="btn-chord" onclick="setChord('Dm')">Dm</button>
    <button class="btn-chord" onclick="setChord('E7')">E7</button>
  </div>

  <div class="auto-section">
    <div class="auto-header">
      <span style="font-weight:bold; color:#fff;">üç∫ Auto Play (√ön Bia)</span>
    </div>
    
    <div style="display:flex; align-items:center; gap:10px; font-size:0.9rem; margin-bottom:5px;">
      <label>T·ªëc ƒë·ªô:</label>
      <input type="range" id="bpm" min="40" max="120" value="70" oninput="document.getElementById('bpm-val').innerText = this.value">
      <span id="bpm-val" style="width:30px; text-align:right;">70</span> BPM
    </div>

    <div style="display:flex; align-items:center; gap:10px; font-size:0.9rem; margin-bottom:10px;">
       <input type="checkbox" id="chk-auto-chord" checked> 
       <label for="chk-auto-chord">T·ª± ƒë·ªïi h·ª£p √¢m sau</label>
       <input type="number" id="bars-limit" value="2" min="1" max="8" style="width:40px; background:#111; border:1px solid #444; color:#fff; text-align:center;">
       <span>√¥ nh·ªãp</span>
    </div>

    <button id="btn-auto" onclick="toggleAutoPlay()" disabled>‚ñ∂ B·∫ÆT ƒê·∫¶U AUTO</button>
  </div>

</div>

<script>
  // ================= DATA =================
  const TUNING = [40, 45, 50, 55, 59, 64];

  // S·ª¨A L·ªñI B√ôM+1: M·ªü d√¢y Bass ph·ª• (thay -1 b·∫±ng 0 ho·∫∑c fret chu·∫©n)
  const CHORDS = {
    "Am": { name: "La Th·ª©", bass: 5, frets: [0, 0, 2, 2, 1, 0] }, // D√¢y 6 m·ªü (0) ƒë·ªÉ ƒë√°nh B√πm+1
    "Dm": { name: "R√™ Th·ª©", bass: 4, frets: [-1, 0, 0, 2, 3, 1] }, // D√¢y 5 m·ªü (0) ƒë·ªÉ ƒë√°nh B√πm+1
    "E7": { name: "Mi 7",   bass: 5, frets: [0, 2, 0, 1, 0, 0] }   // D√¢y 6 m·ªü s·∫µn
  };
  const CHORD_LOOP = ["Am", "Dm", "E7"];

  const STEPS = [
    { id: 0, label: "B√ôM",   defPct: 15 },
    { id: 1, label: "1",     defPct: 6 },
    { id: 2, label: "2",     defPct: 6 },
    { id: 3, label: "3",     defPct: 6 },
    { id: 4, label: "CH√ÅT",  defPct: 12 },
    { id: 5, label: "B√ôM",   defPct: 20 },
    { id: 6, label: "CH√ÅT",  defPct: 10 },
    { id: 7, label: "B√ôM+1", defPct: 15 },
    { id: 8, label: "CH√ÅT",  defPct: 10 }
  ];
  // T·ªïng default = 100%

  // ================= STATE =================
  let guitar = null;
  let currentChord = "Am";
  let stepIndex = 0;
  let isAutoPlaying = false;
  let autoTimeout = null;
  let barCount = 0;

  // ================= INIT UI =================
  const seqGrid = document.getElementById('seq-grid');
  const pctGrid = document.getElementById('percent-grid');

  function initUI() {
    seqGrid.innerHTML = '';
    pctGrid.innerHTML = '';

    STEPS.forEach(s => {
      // Label Step
      const d = document.createElement('div');
      d.className = 'seq-step';
      d.id = `step-${s.id}`;
      d.innerHTML = `<span>${s.label}</span>`;
      seqGrid.appendChild(d);

      // Input %
      const inp = document.createElement('input');
      inp.type = 'number';
      inp.className = 'percent-input';
      inp.id = `pct-${s.id}`;
      inp.value = s.defPct;
      inp.oninput = validateTotal; // Check t·ªïng khi nh·∫≠p
      pctGrid.appendChild(inp);
    });
    validateTotal();
  }

  function validateTotal() {
    let total = 0;
    STEPS.forEach(s => {
      total += parseFloat(document.getElementById(`pct-${s.id}`).value) || 0;
    });
    const disp = document.getElementById('total-check');
    disp.innerText = `T·ªïng: ${total}%`;
    if(total === 100) {
      disp.className = 'total-display total-ok';
      disp.innerText += " (Chu·∫©n)";
      return true;
    } else {
      disp.className = 'total-display total-bad';
      disp.innerText += " (Ph·∫£i b·∫±ng 100%)";
      return false;
    }
  }

  function resetPercentages() {
    STEPS.forEach(s => document.getElementById(`pct-${s.id}`).value = s.defPct);
    validateTotal();
  }

  // ================= AUDIO ENGINE =================
  async function initAudio() {
    const btn = document.querySelector('.btn-load');
    btn.innerText = "‚è≥ ƒêANG T·∫¢I...";
    btn.disabled = true;

    await Tone.start();
    try {
      guitar = await Soundfont.instrument(Tone.context.rawContext, 'acoustic_guitar_nylon');
      
      document.getElementById('overlay-load').style.display = 'none';
      document.getElementById('btn-trigger').disabled = false;
      document.getElementById('btn-auto').disabled = false;
      
      highlightStep(0);
      document.getElementById('info-display').innerText = "ƒê√£ s·∫µn s√†ng. Ch·ªçn ch·∫ø ƒë·ªô ch∆°i!";
    } catch(e) {
      alert("L·ªói t·∫£i: " + e);
    }
  }

  function getNote(chordKey, stringIdx) {
    if(!guitar) return null;
    const c = CHORDS[chordKey];
    const arrIdx = 6 - stringIdx; 
    const fret = c.frets[arrIdx];
    if(fret === -1) return null;
    return TUNING[arrIdx] + fret;
  }

  // ================= PLAY LOGIC =================
  function playSoundForStep(idx) {
    if(!guitar) return;
    const chord = CHORDS[currentChord];
    const stepID = STEPS[idx].id;
    let notes = [];
    let msg = "";
    
    // Logic g·∫£y d√¢y
    switch(stepID) {
      case 0: // B√πm G·ªëc
      case 5: 
        notes = [getNote(currentChord, chord.bass)];
        msg = `B√ôM (D√¢y ${chord.bass})`;
        playNotes(notes, 1.0, 1.2);
        break;

      case 1: // 1
        notes = [getNote(currentChord, chord.bass - 1)];
        msg = `1 (D√¢y ${chord.bass - 1})`;
        playNotes(notes, 0.4, 0.7);
        break;
      case 2: // 2
        notes = [getNote(currentChord, chord.bass - 2)];
        msg = `2 (D√¢y ${chord.bass - 2})`;
        playNotes(notes, 0.4, 0.7);
        break;
      case 3: // 3 (Qu·∫°t xu·ªëng)
        notes = [3,2,1].map(s => getNote(currentChord, s));
        msg = "3 (Qu·∫°t xu·ªëng)";
        playStrum(notes, 0.02, 0.8, false); // false = ko ng·∫Øt
        break;
      
      case 4: case 6: case 8: // CH√ÅT (Qu·∫°t l√™n + Ng·∫Øt)
        notes = [1,2,3].map(s => getNote(currentChord, s));
        msg = "CH√ÅT (Qu·∫°t l√™n)";
        playStrum(notes, 0.015, 0.9, true); // true = ng·∫Øt ti·∫øng
        break;

      case 7: // B√ôM + 1
        let altBass = chord.bass + 1;
        if(altBass > 6) altBass = chord.bass - 1; // Fallback n·∫øu bass l√† 6 th√¨ ƒë√°nh 5
        notes = [getNote(currentChord, altBass)];
        msg = `B√ôM PH·ª§ (D√¢y ${altBass})`;
        playNotes(notes, 1.0, 1.1);
        break;
    }
    
    document.getElementById('info-display').innerText = msg;
    highlightStep(idx);
  }

  function playNotes(notes, dur, vel) {
    notes.forEach(n => {
      if(n) guitar.play(n, Tone.now(), { duration: dur, gain: vel });
    });
  }
  
  function playStrum(notes, stagger, vel, mute) {
    notes.forEach((n, i) => {
      if(n) {
        let opts = { duration: mute ? 0.1 : 0.5, gain: vel, release: mute ? 0.05 : 0.1 };
        guitar.play(n, Tone.now() + (i * stagger), opts);
      }
    });
  }

  function highlightStep(idx) {
    document.querySelectorAll('.seq-step').forEach(e => e.classList.remove('active'));
    document.getElementById(`step-${idx}`).classList.add('active');
  }

  // ================= CONTROL LOGIC =================
  
  // 1. MANUAL MODE
  function manualPlay() {
    if(isAutoPlaying) return;
    playSoundForStep(stepIndex);
    advanceStep();
  }
  
  document.body.onkeydown = (e) => {
    if(e.code === 'Space') { 
      e.preventDefault(); 
      if(isAutoPlaying) {
         toggleAutoPlay(); // Space ƒë·ªÉ d·ª´ng auto
      } else {
         manualPlay();
         document.getElementById('btn-trigger').style.background = "#555";
      }
    }
  }
  document.body.onkeyup = (e) => {
    if(e.code === 'Space' && !isAutoPlaying) document.getElementById('btn-trigger').style.background = "#333";
  }

  // 2. AUTO PLAY MODE
  function toggleAutoPlay() {
    const btn = document.getElementById('btn-auto');
    if(isAutoPlaying) {
      // Stop
      isAutoPlaying = false;
      clearTimeout(autoTimeout);
      btn.innerHTML = "‚ñ∂ B·∫ÆT ƒê·∫¶U AUTO";
      btn.classList.remove('playing');
      document.getElementById('btn-trigger').disabled = false;
    } else {
      // Start
      if(!validateTotal()) { alert("T·ªïng % ph·∫£i l√† 100 m·ªõi ch·∫°y ƒë∆∞·ª£c nha bro!"); return; }
      isAutoPlaying = true;
      btn.innerHTML = "‚èπ D·ª™NG L·∫†I (√ön bia ƒëi)";
      btn.classList.add('playing');
      document.getElementById('btn-trigger').disabled = true;
      runAutoLoop();
    }
  }

  function runAutoLoop() {
    if(!isAutoPlaying) return;

    // 1. Play current step
    playSoundForStep(stepIndex);

    // 2. Calculate delay for NEXT step
    // Cycle Duration (ms) = (60 / BPM) * 4 beats * 1000
    const bpm = document.getElementById('bpm').value;
    const totalCycleMs = (60 / bpm) * 4 * 1000;
    
    // Duration of THIS step based on %
    const pct = parseFloat(document.getElementById(`pct-${STEPS[stepIndex].id}`).value) || 10;
    const delayMs = totalCycleMs * (pct / 100);

    // 3. Advance logic
    advanceStep();

    // 4. Schedule next
    autoTimeout = setTimeout(runAutoLoop, delayMs);
  }

  function advanceStep() {
    stepIndex++;
    if(stepIndex >= STEPS.length) {
      stepIndex = 0;
      barCount++;
      checkAutoChord();
    }
  }

  function checkAutoChord() {
    if(!document.getElementById('chk-auto-chord').checked) return;
    const limit = parseInt(document.getElementById('bars-limit').value);
    
    if(barCount >= limit) {
      barCount = 0;
      // Next chord
      let currIdx = CHORD_LOOP.indexOf(currentChord);
      let nextIdx = (currIdx + 1) % CHORD_LOOP.length;
      setChord(CHORD_LOOP[nextIdx]);
    }
  }

  window.setChord = function(c) {
    currentChord = c;
    document.querySelectorAll('.btn-chord').forEach(b => b.classList.toggle('active', b.innerText === c));
    if(isAutoPlaying) { // Hi·ªáu ·ª©ng nh√°y
        const ib = document.getElementById('info-display');
        ib.style.background = "#333";
        setTimeout(()=>ib.style.background="#000", 100);
    }
  }

  // Start
  initUI();
</script>

</body>
</html>
