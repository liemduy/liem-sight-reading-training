<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Bolero Timeline Pro - N·ªët Nh·∫°c</title>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.18/Tone.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/soundfont-player@0.12.0/dist/soundfont-player.min.js"></script>

  <style>
    :root {
      --bg: #121214; --card: #1e1e24; --accent: #00e676; --text: #eee;
      --seg-bass: #e63946; --seg-fill: #457b9d; --seg-chat: #1d3557;
    }
    body { background: var(--bg); color: var(--text); font-family: sans-serif; padding: 10px; margin: 0; user-select: none; display: flex; flex-direction: column; align-items: center; }

    .container {
      background: var(--card); padding: 15px; border-radius: 12px;
      width: 100%; max-width: 900px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); border: 1px solid #333;
    }
    
    h2 { color: var(--accent); margin: 0 0 15px 0; font-size: 1.2rem; text-transform: uppercase; }

    /* TIMELINE */
    .timeline-container {
      display: flex; height: 120px; width: 100%; background: #000;
      border: 2px solid #555; border-radius: 8px; overflow: hidden; margin-bottom: 10px;
    }
    
    .segment {
      position: relative; height: 100%; display: flex; flex-direction: column;
      align-items: center; justify-content: center; border-right: 1px solid rgba(0,0,0,0.5);
      font-size: 0.75rem; transition: background 0.1s; min-width: 20px;
    }
    .segment.playing { filter: brightness(1.4); box-shadow: inset 0 0 20px #fff; }
    
    /* M√†u s·∫Øc */
    .type-bass { background: var(--seg-bass); color: #fff; }
    .type-fill { background: var(--seg-fill); color: #fff; }
    .type-chat { background: var(--seg-chat); color: #fff; }

    /* Resizer Handle */
    .resizer {
      position: absolute; right: -6px; top: 0; bottom: 0; width: 12px;
      cursor: col-resize; z-index: 10; display: flex; justify-content: center;
    }
    .resizer::after { content:""; width: 2px; height: 100%; background: rgba(255,255,255,0.3); }
    .resizer:hover::after { background: #fff; width: 4px; box-shadow: 0 0 5px #fff; }

    /* Note Dropdown */
    .note-select {
      margin-top: 5px; background: rgba(0,0,0,0.3); color: #fff; border: 1px solid rgba(255,255,255,0.2);
      border-radius: 4px; font-size: 0.7rem; padding: 2px; cursor: pointer; width: 90%; text-align: center;
      appearance: none; -webkit-appearance: none;
    }
    .note-select:hover { background: rgba(255,255,255,0.1); }
    
    /* Control Bar */
    .controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; background: #2a2a2e; padding: 10px; border-radius: 8px; }
    
    button { cursor: pointer; border: none; font-weight: bold; border-radius: 4px; padding: 8px 16px; }
    .btn-apply { background: #ff9f1c; color: #000; margin-left: 10px; }
    .btn-play { background: var(--accent); color: #000; padding: 12px 24px; font-size: 1rem; width: 100%; margin-top: 10px;}
    .btn-play.stop { background: #e63946; color: #fff; }
    
    .chord-btn { flex: 1; padding: 12px; background: #333; color: #fff; border: 1px solid #555; margin-right: 5px; }
    .chord-btn.active { background: var(--accent); color: #000; }
    
    /* Overlay */
    #overlay {
      position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.9);
      z-index: 999; display: flex; flex-direction: column; justify-content: center; align-items: center;
    }
    .btn-load { font-size: 1.5rem; padding: 20px 40px; border-radius: 50px; background: var(--accent); }

    .note-icon { font-family: 'Segoe UI Symbol', sans-serif; font-size: 1.2rem; line-height: 1; }
  </style>
</head>
<body>

<div class="container" style="position: relative;">
  
  <div id="overlay">
    <h2>BOLERO STUDIO PRO</h2>
    <button class="btn-load" onclick="initAudio()">B·∫ÆT ƒê·∫¶U</button>
    <p style="color:#aaa; margin-top:10px;">Ch·ªù t·∫£i soundfont...</p>
  </div>

  <div style="display:flex; justify-content:space-between; align-items:center;">
    <h2>Timeline & N·ªët Nh·∫°c</h2>
    <div style="display:flex; align-items:center;">
       <span style="font-size:0.8rem; color:#aaa; margin-right:5px;">T·ªïng h·ª£p n·ªët:</span>
       <button class="btn-apply" onclick="applyNotesToPercent()">√ÅP D·ª§NG N·ªêT</button>
    </div>
  </div>

  <div class="timeline-container" id="timeline">
    </div>

  <div class="controls">
    <div style="display:flex; align-items:center; gap:10px;">
      <span style="font-size:0.9rem;">T·ªëc ƒë·ªô:</span>
      <input type="range" id="bpm" min="40" max="120" value="70" oninput="document.getElementById('bpm-v').innerText=this.value">
      <span id="bpm-v" style="font-weight:bold; color:var(--accent);">70</span> BPM
    </div>
    
    <label style="font-size:0.9rem; cursor:pointer;">
      <input type="checkbox" id="chk-auto" checked> T·ª± ƒë·ªïi h·ª£p √¢m
    </label>
  </div>

  <div style="display:flex; margin-bottom:10px;">
    <button class="chord-btn active" onclick="setChord('Am')">Am</button>
    <button class="chord-btn" onclick="setChord('Dm')">Dm</button>
    <button class="chord-btn" onclick="setChord('E7')">E7</button>
  </div>

  <button id="btn-play" class="btn-play" onclick="togglePlay()">‚ñ∂ CH·∫†Y AUTO</button>

</div>

<script>
  // ================= CONSTANTS =================
  const NOTES_VAL = {
    "1": { label: "ùÖù Tr√≤n (4)", val: 4.0 },
    "1/2": { label: "ùÖû Tr·∫Øng (2)", val: 2.0 },
    "1/4": { label: "‚ô© ƒêen (1)", val: 1.0 },
    "1/8": { label: "‚ô™ ƒê∆°n (0.5)", val: 0.5 },
    "1/16": { label: "ùÖ° K√©p (0.25)", val: 0.25 },
    "1/32": { label: "ùÖ°ùÖ° Tam (0.125)", val: 0.125 }
  };

  const DEFAULT_STEPS = [
    { id: 0, label: "B√ôM", type: "bass", note: "1/8." }, // ƒê∆°n ch·∫•m d√¥i
    { id: 1, label: "1", type: "fill", note: "1/32" },
    { id: 2, label: "2", type: "fill", note: "1/32" },
    { id: 3, label: "3", type: "fill", note: "1/32" },
    { id: 4, label: "CH√ÅT", type: "chat", note: "1/8" },
    { id: 5, label: "B√ôM", type: "bass", note: "1/8" },
    { id: 6, label: "CH√ÅT", type: "chat", note: "1/4" }, // ƒêen
    { id: 7, label: "B√ôM+1", type: "bass", note: "1/8" },
    { id: 8, label: "CH√ÅT", type: "chat", note: "1/8" }
  ];

  // Helper ƒë·ªÉ l·∫•y value t·ª´ key n·ªët (v√¨ key tr√™n l√† string cho ƒë·∫πp, ta c·∫ßn map l·∫°i logic)
  // Th·ª±c t·∫ø user ch·ªçn t·ª´ dropdown, ta l∆∞u value 4, 2, 1, 0.5... v√†o state
  
  // State
  let steps = DEFAULT_STEPS.map(s => {
    // Map default note string to value for init
    let val = 0.5; // Default 1/8
    if(s.note === "1/4") val = 1;
    if(s.note === "1/8.") val = 0.75;
    if(s.note === "1/32") val = 0.125;
    return { ...s, noteVal: val, pct: 11.1 }; // pct s·∫Ω t√≠nh l·∫°i sau
  });

  let guitar = null;
  let isPlaying = false;
  let currentStep = 0;
  let timer = null;
  let currentChord = "Am";
  let barCount = 0;

  // Audio Data
  const TUNING = [40, 45, 50, 55, 59, 64];
  const CHORDS = { "Am":{b:5,f:[0,0,2,2,1,0]}, "Dm":{b:4,f:[-1,0,0,2,3,1]}, "E7":{b:5,f:[0,2,0,1,0,0]} };
  const LOOP = ["Am","Dm","E7"];

  // ================= UI BUILDER =================
  const timeline = document.getElementById('timeline');

  function renderTimeline() {
    timeline.innerHTML = '';
    steps.forEach((step, idx) => {
      const el = document.createElement('div');
      el.className = `segment type-${step.type}`;
      el.id = `seg-${idx}`;
      el.style.width = `${step.pct}%`;
      
      // N·ªôi dung √¥
      let html = `
        <span style="font-weight:bold">${step.label}</span>
        <span id="pct-${idx}" style="font-size:0.6rem; opacity:0.8">${step.pct.toFixed(1)}%</span>
        
        <select class="note-select" onchange="updateNote(${idx}, this.value)">
          <option value="4" ${step.noteVal==4?'selected':''}>ùÖù Tr√≤n</option>
          <option value="2" ${step.noteVal==2?'selected':''}>ùÖû Tr·∫Øng</option>
          <option value="1.5" ${step.noteVal==1.5?'selected':''}>‚ô©. ƒêen ch·∫•m</option>
          <option value="1" ${step.noteVal==1?'selected':''}>‚ô© ƒêen</option>
          <option value="0.75" ${step.noteVal==0.75?'selected':''}>‚ô™. ƒê∆°n ch·∫•m</option>
          <option value="0.5" ${step.noteVal==0.5?'selected':''}>‚ô™ ƒê∆°n</option>
          <option value="0.25" ${step.noteVal==0.25?'selected':''}>ùÖ° K√©p</option>
          <option value="0.125" ${step.noteVal==0.125?'selected':''}>ùÖ°ùÖ° Tam</option>
        </select>
      `;

      // Resizer
      if(idx < steps.length - 1) {
        html += `<div class="resizer" onmousedown="initDrag(event, ${idx})" ontouchstart="initDrag(event, ${idx})"></div>`;
      }
      
      el.innerHTML = html;
      timeline.appendChild(el);
    });
  }

  window.updateNote = function(idx, val) {
    steps[idx].noteVal = parseFloat(val);
  }

  // ================= LOGIC T√çNH PH·∫¶N TRƒÇM T·ª™ N·ªêT =================
  window.applyNotesToPercent = function() {
    // 1. T√≠nh t·ªïng gi√° tr·ªã n·ªët nh·∫°c
    let totalVal = steps.reduce((sum, s) => sum + s.noteVal, 0);
    
    if (totalVal === 0) return;

    // 2. Chia l·∫°i ph·∫ßn trƒÉm
    steps.forEach((s, idx) => {
      s.pct = (s.noteVal / totalVal) * 100;
      // Update UI width
      const seg = document.getElementById(`seg-${idx}`);
      const lbl = document.getElementById(`pct-${idx}`);
      if(seg) {
        seg.style.width = `${s.pct}%`;
        lbl.innerText = `${s.pct.toFixed(1)}%`;
      }
    });
    
    // Hi·ªáu ·ª©ng b√°o th√†nh c√¥ng
    const btn = document.querySelector('.btn-apply');
    const oldText = btn.innerText;
    btn.innerText = "OK! ƒê√É T√çNH %";
    btn.style.background = "#fff";
    setTimeout(() => {
        btn.innerText = oldText;
        btn.style.background = "#ff9f1c";
    }, 1000);
  }

  // ================= DRAG & RESIZE LOGIC =================
  let startX, dragIdx;
  
  window.initDrag = function(e, idx) {
    e.preventDefault();
    dragIdx = idx;
    startX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
    document.addEventListener('mousemove', onDrag);
    document.addEventListener('mouseup', stopDrag);
    document.addEventListener('touchmove', onDrag, {passive:false});
    document.addEventListener('touchend', stopDrag);
  }

  function onDrag(e) {
    if (dragIdx === null) return;
    const clientX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
    const deltaX = clientX - startX;
    
    const containerW = timeline.getBoundingClientRect().width;
    const deltaPct = (deltaX / containerW) * 100;

    // T√≠nh to√°n l·∫°i chi·ªÅu r·ªông
    let leftPct = steps[dragIdx].pct + deltaPct;
    let rightPct = steps[dragIdx+1].pct - deltaPct;

    // Gi·ªõi h·∫°n Min 2% ƒë·ªÉ kh√¥ng b·ªã t·ªãt
    if(leftPct < 2 || rightPct < 2) return;

    // C·∫≠p nh·∫≠t State t·∫°m th·ªùi (ch∆∞a commit startX m·ªõi ƒë·ªÉ m∆∞·ª£t)
    // Th·ª±c ra ƒë·ªÉ m∆∞·ª£t th√¨ n√™n update startX v√† c·ªông d·ªìn, nh∆∞ng logic ƒë∆°n gi·∫£n n√†y ƒë·ªß d√πng cho web.
    // Update UI tr·ª±c ti·∫øp
    document.getElementById(`seg-${dragIdx}`).style.width = `${leftPct}%`;
    document.getElementById(`pct-${dragIdx}`).innerText = `${leftPct.toFixed(1)}%`;
    
    document.getElementById(`seg-${dragIdx+1}`).style.width = `${rightPct}%`;
    document.getElementById(`pct-${dragIdx+1}`).innerText = `${rightPct.toFixed(1)}%`;
    
    // L∆∞u t·∫°m v√†o state ƒë·ªÉ d√πng cho l·∫ßn k√©o ti·∫øp theo
    // (L∆∞u √Ω: C√°ch n√†y ƒë∆°n gi·∫£n h√≥a vi·ªác "d·ªìn toa", ch·ªâ ·∫£nh h∆∞·ªüng 2 √¥ k·ªÅ nhau)
    steps[dragIdx].pct = leftPct;
    steps[dragIdx+1].pct = rightPct;
    
    startX = clientX; // Reset m·ªëc k√©o ƒë·ªÉ c·ªông d·ªìn m∆∞·ª£t h∆°n
  }

  function stopDrag() {
    dragIdx = null;
    document.removeEventListener('mousemove', onDrag);
    document.removeEventListener('mouseup', stopDrag);
    document.removeEventListener('touchmove', onDrag);
    document.removeEventListener('touchend', stopDrag);
  }

  // ================= AUDIO ENGINE =================
  async function initAudio() {
    document.querySelector('.btn-load').innerText = "ƒêANG T·∫¢I...";
    await Tone.start();
    try {
      guitar = await Soundfont.instrument(Tone.context.rawContext, 'acoustic_guitar_nylon');
      document.getElementById('overlay').style.display = 'none';
      // Init l·∫ßn ƒë·∫ßu v·ªõi c√¥ng th·ª©c Bolero chu·∫©n
      applyNotesToPercent(); 
    } catch(e) { alert(e); }
  }

  function togglePlay() {
    const btn = document.getElementById('btn-play');
    if(isPlaying) {
      isPlaying = false; clearTimeout(timer);
      btn.innerHTML = "‚ñ∂ CH·∫†Y AUTO"; btn.classList.remove('stop');
      document.querySelectorAll('.segment').forEach(s => s.classList.remove('playing'));
    } else {
      isPlaying = true; btn.innerHTML = "‚èπ D·ª™NG L·∫†I"; btn.classList.add('stop');
      runLoop();
    }
  }

  function runLoop() {
    if(!isPlaying) return;
    
    // Play sound
    playStep(currentStep);
    
    // Highlight
    document.querySelectorAll('.segment').forEach(s => s.classList.remove('playing'));
    document.getElementById(`seg-${currentStep}`).classList.add('playing');

    // Calc delay
    const bpm = document.getElementById('bpm').value;
    // T·ªïng th·ªùi gian 1 √¥ nh·ªãp (gi·∫£ s·ª≠ t·ªïng c√°c note l√† 4 - tr√≤n, ho·∫∑c t√πy user set)
    // Nh∆∞ng ta d√πng logic: 100% width = 4 beats (4/4 time signature)
    const totalBarMs = (60/bpm) * 4 * 1000;
    const delay = totalBarMs * (steps[currentStep].pct / 100);

    // Next
    currentStep++;
    if(currentStep >= steps.length) {
      currentStep = 0;
      barCount++;
      if(document.getElementById('chk-auto').checked && barCount >= 2) {
        barCount = 0;
        let i = LOOP.indexOf(currentChord);
        setChord(LOOP[(i+1)%LOOP.length]);
      }
    }
    
    timer = setTimeout(runLoop, delay);
  }

  function playStep(idx) {
    if(!guitar) return;
    const s = steps[idx];
    const c = CHORDS[currentChord];
    const now = Tone.now();
    
    // Logic g·∫£y ƒë∆°n gi·∫£n h√≥a
    const getN = (str) => {
        let arrIdx = 6-str; 
        let f = c.f[arrIdx];
        return (f===-1)?null : TUNING[arrIdx]+f;
    };

    if(s.label === "B√ôM") playNote([getN(c.b)], 1.0, 1.2);
    else if(s.label === "B√ôM+1") {
       let alt = c.b+1; if(alt>6) alt=c.b-1;
       playNote([getN(alt)], 1.0, 1.1);
    }
    else if(s.label === "1") playNote([getN(c.b-1)], 0.3, 0.7);
    else if(s.label === "2") playNote([getN(c.b-2)], 0.3, 0.7);
    else if(s.label === "3") { // Strum down
       [3,2,1].forEach((str,i) => {
          let n = getN(str); if(n) guitar.play(n, now+i*0.015, {duration:0.5, gain:0.8});
       });
    }
    else if(s.label === "CH√ÅT") { // Strum up mute
       [1,2,3].forEach((str,i) => {
          let n = getN(str); if(n) guitar.play(n, now+i*0.01, {duration:0.1, gain:0.9, release:0.05});
       });
    }
  }
  
  function playNote(ns, d, v) { ns.forEach(n => { if(n) guitar.play(n, Tone.now(), {duration:d, gain:v}); }); }

  window.setChord = function(c) {
    currentChord = c;
    document.querySelectorAll('.chord-btn').forEach(b => b.classList.toggle('active', b.innerText === c));
  }

  // Init Render
  renderTimeline();

</script>
</body>
</html>
