<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Bolero Manual Mode - T·ª± G·∫£y ƒê√†n</title>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.18/Tone.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/soundfont-player@0.12.0/dist/soundfont-player.min.js"></script>

  <style>
    :root {
      --bg: #121214;
      --card: #1c1c1f;
      --accent: #00e676; /* M√†u xanh l√° n·ªïi b·∫≠t */
      --text: #e0e0e0;
      --btn-active: #2e7d32;
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Segoe UI', sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 10px;
      margin: 0;
      user-select: none; /* Ch·ªëng b√¥i ƒëen khi click nhanh */
      touch-action: manipulation; /* T·ªëi ∆∞u cho c·∫£m ·ª©ng */
    }

    h2 { color: var(--accent); margin: 10px 0; font-size: 1.5rem; }
    
    .container {
      background: var(--card);
      padding: 15px;
      border-radius: 12px;
      width: 100%;
      max-width: 450px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.5);
      border: 1px solid #333;
    }

    /* Hi·ªÉn th·ªã b∆∞·ªõc (Sequencer) */
    .sequencer-grid {
      display: grid;
      grid-template-columns: repeat(9, 1fr);
      gap: 3px;
      margin-bottom: 15px;
    }
    
    .seq-step {
      background: #333;
      border-radius: 3px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      color: #777;
      border: 1px solid #444;
      transition: all 0.1s;
    }
    
    .seq-step.active {
      background: var(--accent);
      color: #000;
      font-weight: bold;
      transform: scale(1.1);
      box-shadow: 0 0 8px var(--accent);
      border-color: var(--accent);
    }

    /* Info Box */
    .info-box {
      background: #000;
      color: var(--accent);
      font-family: monospace;
      padding: 10px;
      border-radius: 6px;
      text-align: center;
      margin-bottom: 15px;
      border: 1px solid #333;
      min-height: 24px;
    }

    /* N√∫t G·∫£y ƒê√†n L·ªõn */
    #btn-trigger {
      width: 100%;
      height: 100px;
      background: radial-gradient(circle, #444 0%, #222 100%);
      border: 2px solid #555;
      border-radius: 16px;
      color: #888;
      font-size: 1.5rem;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      transition: all 0.05s;
      margin-bottom: 20px;
      box-shadow: 0 5px 0 #111;
    }

    #btn-trigger:active:not([disabled]) {
      transform: translateY(4px);
      box-shadow: 0 1px 0 #111;
      background: radial-gradient(circle, var(--accent) 0%, #00600f 100%);
      color: #000;
      border-color: var(--accent);
    }
    
    #btn-trigger:disabled { opacity: 0.5; cursor: not-allowed; }

    /* H·ª£p √¢m */
    .chord-row { display: flex; gap: 8px; margin-bottom: 15px; }
    .btn-chord {
      flex: 1;
      padding: 12px;
      background: #333;
      border: 1px solid #555;
      color: #fff;
      border-radius: 8px;
      font-size: 1.1rem;
      font-weight: bold;
      cursor: pointer;
    }
    .btn-chord.active {
      background: var(--accent);
      color: #000;
      box-shadow: 0 0 10px rgba(0, 230, 118, 0.4);
    }

    /* Auto Rotation Controls */
    .auto-controls {
      background: #25252a;
      padding: 10px;
      border-radius: 8px;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border: 1px solid #444;
    }
    
    .switch { position: relative; display: inline-block; width: 40px; height: 20px; margin-right: 10px;}
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
    .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: var(--accent); }
    input:checked + .slider:before { transform: translateX(20px); }

    input[type=number] {
      width: 40px;
      background: #111;
      border: 1px solid #444;
      color: #fff;
      border-radius: 4px;
      padding: 4px;
      text-align: center;
    }

    /* Load button overlay */
    #overlay-load {
      position: absolute; top:0; left:0; width:100%; height:100%;
      background: rgba(0,0,0,0.85);
      display: flex; flex-direction: column;
      justify-content: center; align-items: center;
      z-index: 100;
      border-radius: 12px;
    }
    .btn-load {
      background: var(--accent); color: #000; padding: 15px 30px;
      font-size: 1.2rem; font-weight: bold; border: none; border-radius: 50px;
      cursor: pointer; box-shadow: 0 0 20px var(--accent);
    }

  </style>
</head>
<body>

<div class="container" style="position: relative;">
  
  <div id="overlay-load">
    <h2 style="margin-bottom: 20px;">Bolero Simulator</h2>
    <button class="btn-load" onclick="initAudio()">B·∫ÆT ƒê·∫¶U (T·∫¢I TI·∫æNG)</button>
    <p id="status-text" style="margin-top:10px; font-size: 0.8rem; color: #888;">Nh·∫•n ƒë·ªÉ t·∫£i th∆∞ vi·ªán √¢m thanh...</p>
  </div>

  <div style="display:flex; justify-content:space-between; align-items:center;">
    <h2>üé∏ T·ª± G·∫£y ƒê√†n</h2>
    <span style="font-size: 0.8rem; color:#888;">Reset: <button onclick="resetPattern()" style="background:#444; border:none; color:#fff; padding:2px 6px; border-radius:4px; cursor:pointer;">‚Ü∫</button></span>
  </div>

  <div class="sequencer-grid" id="seq-grid">
    </div>

  <div class="info-box" id="info-display">
    S·∫µn s√†ng...
  </div>

  <button id="btn-trigger" onclick="playNextStep()" disabled>
    <span>G·∫¢Y</span>
    <span style="font-size: 0.8rem; font-weight: normal; margin-top: 5px;">(Nh·∫•n ph√≠m Space ho·∫∑c Click)</span>
  </button>

  <div class="chord-row">
    <button class="btn-chord active" onclick="manualSetChord('Am')">Am</button>
    <button class="btn-chord" onclick="manualSetChord('Dm')">Dm</button>
    <button class="btn-chord" onclick="manualSetChord('E7')">E7</button>
  </div>

  <div class="auto-controls">
    <div style="display:flex; align-items:center;">
      <label class="switch">
        <input type="checkbox" id="chk-auto-rotate">
        <span class="slider"></span>
      </label>
      <span style="margin-left: 5px;">T·ª± ƒë·ªïi h·ª£p √¢m</span>
    </div>
    
    <div>
      Sau <input type="number" id="bars-count" value="2" min="1" max="8"> √¥ nh·ªãp
    </div>
  </div>

</div>

<script>
  // ================= D·ªÆ LI·ªÜU NH·∫†C L√ù =================
  const TUNING = [40, 45, 50, 55, 59, 64]; // E A D G B E

  const CHORDS = {
    "Am": { name: "La Th·ª©", bass: 5, frets: [-1, 0, 2, 2, 1, 0] },
    "Dm": { name: "R√™ Th·ª©", bass: 4, frets: [-1, -1, 0, 2, 3, 1] },
    "E7": { name: "Mi 7",   bass: 5, frets: [0, 2, 0, 1, 0, 0] }
  };

  // Th·ª© t·ª± v√≤ng h·ª£p √¢m m·∫∑c ƒë·ªãnh: Am -> Dm -> E7 -> Am...
  const CHORD_PROGRESSION = ["Am", "Dm", "E7"]; 

  // M·∫´u 9 b∆∞·ªõc theo y√™u c·∫ßu
  const PATTERN_STEPS = [
    { id: 0, label: "B√ôM",   desc: "Bass G·ªëc" },
    { id: 1, label: "1",     desc: "D√¢y d∆∞·ªõi" },
    { id: 2, label: "2",     desc: "D√¢y d∆∞·ªõi" },
    { id: 3, label: "3",     desc: "Qu·∫°t nh·∫π xu·ªëng" },
    { id: 4, label: "CH√ÅT",  desc: "H·∫•t l√™n 3 d√¢y" },
    { id: 5, label: "B√ôM",   desc: "Bass G·ªëc" },
    { id: 6, label: "CH√ÅT",  desc: "H·∫•t l√™n 3 d√¢y" },
    { id: 7, label: "B√ôM +1",desc: "Bass Ph·ª• (Tr√™n 1 d√¢y)" },
    { id: 8, label: "CH√ÅT",  desc: "H·∫•t l√™n 3 d√¢y" }
  ];

  // ================= STATE =================
  let guitar = null;
  let currentChordKey = "Am";
  let currentStepIndex = 0;
  let barCounter = 0; // ƒê·∫øm s·ªë √¥ nh·ªãp ƒë√£ ch∆°i xong
  let isReady = false;

  // ================= UI SETUP =================
  const seqGrid = document.getElementById('seq-grid');
  
  // T·∫°o 9 √¥ hi·ªÉn th·ªã
  PATTERN_STEPS.forEach(step => {
    const div = document.createElement('div');
    div.className = 'seq-step';
    div.id = `step-${step.id}`;
    div.innerText = step.label;
    seqGrid.appendChild(div);
  });

  const infoBox = document.getElementById('info-display');
  const btnTrigger = document.getElementById('btn-trigger');
  
  // B·∫Øt s·ª± ki·ªán b√†n ph√≠m (Space bar) ƒë·ªÉ g·∫£y
  document.body.onkeydown = function(e) { 
    if(e.code === "Space" && isReady) {
      e.preventDefault(); // Ch·∫∑n cu·ªôn trang
      playNextStep();
      // Hi·ªáu ·ª©ng n√∫t b·∫•m
      btnTrigger.style.transform = "translateY(4px)";
      btnTrigger.style.background = "radial-gradient(circle, var(--accent) 0%, #00600f 100%)";
      btnTrigger.style.color = "#000";
    }
  }
  document.body.onkeyup = function(e) {
    if(e.code === "Space") {
       btnTrigger.style.transform = "none";
       btnTrigger.style.background = "";
       btnTrigger.style.color = "";
    }
  }

  // ================= LOGIC √ÇM THANH =================
  async function initAudio() {
    const btnLoad = document.querySelector('.btn-load');
    const statusText = document.getElementById('status-text');
    
    btnLoad.disabled = true;
    btnLoad.innerText = "ƒêANG T·∫¢I...";
    statusText.innerText = "ƒêang k·∫øt n·ªëi soundfont (kho·∫£ng 5-10s)...";

    await Tone.start();

    try {
      // D√πng ti·∫øng Nylon cho m·ªÅm m·∫°i
      guitar = await Soundfont.instrument(Tone.context.rawContext, 'acoustic_guitar_nylon');
      
      isReady = true;
      document.getElementById('overlay-load').style.display = 'none';
      btnTrigger.disabled = false;
      highlightStep(0); // S·∫µn s√†ng ·ªü b∆∞·ªõc 0
      infoBox.innerText = `S·∫µn s√†ng: ${CHORDS[currentChordKey].name}`;
      
    } catch(e) {
      statusText.innerText = "L·ªói t·∫£i: " + e;
      btnLoad.disabled = false;
    }
  }

  function getNote(chordKey, stringIdx) {
    if (stringIdx < 1 || stringIdx > 6) return null;
    const chord = CHORDS[chordKey];
    const arrIdx = 6 - stringIdx;
    const fret = chord.frets[arrIdx];
    if(fret === -1) return null;
    return TUNING[arrIdx] + fret;
  }

  // H√ÄM QUAN TR·ªåNG NH·∫§T: X·ª¨ L√ù G·∫¢Y ƒê√ÄN
  function playNextStep() {
    if (!guitar) return;

    const chordData = CHORDS[currentChordKey];
    const bassString = chordData.bass;
    const step = PATTERN_STEPS[currentStepIndex];
    
    let notes = [];
    let msg = "";
    let duration = 0.5;
    let velocity = 1.0;
    
    // Logic x√°c ƒë·ªãnh d√¢y g·∫£y theo y√™u c·∫ßu
    switch(step.id) {
      case 0: // B√ôM (G·ªëc)
      case 5:
        notes = [getNote(currentChordKey, bassString)];
        msg = `B√ôM - D√¢y ${bassString} (Bass G·ªëc)`;
        duration = 1.5; 
        break;

      case 1: // 1 (D∆∞·ªõi Bass)
        notes = [getNote(currentChordKey, bassString - 1)];
        msg = `1 - D√¢y ${bassString - 1}`;
        velocity = 0.7;
        break;

      case 2: // 2 (D∆∞·ªõi n·ªØa)
        notes = [getNote(currentChordKey, bassString - 2)];
        msg = `2 - D√¢y ${bassString - 2}`;
        velocity = 0.7;
        break;

      case 3: // 3 (Qu·∫°t nh·∫π xu·ªëng c√°c d√¢y c√≤n l·∫°i)
        // L·∫•y 3 d√¢y d∆∞·ªõi c√πng
        notes = [getNote(currentChordKey, 3), getNote(currentChordKey, 2), getNote(currentChordKey, 1)];
        msg = "3 - Qu·∫°t xu·ªëng";
        velocity = 0.8;
        // R·∫£i nh·∫π (Arpeggio Down)
        notes.forEach((n, i) => {
           if(n) guitar.play(n, Tone.now() + i*0.02, { duration: 0.5, gain: velocity });
        });
        notes = []; // ƒê√£ play ·ªü tr√™n, set r·ªóng ƒë·ªÉ ko play ·ªü d∆∞·ªõi
        break;

      case 4: // CH√ÅT (H·∫•t l√™n 3 d√¢y)
      case 6:
      case 8:
        notes = [getNote(currentChordKey, 1), getNote(currentChordKey, 2), getNote(currentChordKey, 3)];
        msg = "CH√ÅT - Qu·∫°t l√™n (Ng·∫Øt ti·∫øng)";
        // K·ªπ thu·∫≠t ch√°t: ng·∫Øn, ƒëanh, release nhanh
        notes.forEach((n, i) => {
           if(n) guitar.play(n, Tone.now() + i*0.01, { duration: 0.1, release: 0.05, gain: 0.9, attack: 0.001 });
        });
        notes = []; 
        break;

      case 7: // B√ôM + 1 (Bass ph·ª•: tr√™n d√¢y g·ªëc 1 d√¢y)
        let altBass = bassString + 1;
        // X·ª≠ l√Ω bi√™n: N·∫øu Bass l√† 6 th√¨ kh√¥ng th·ªÉ +1 -> ƒê√°nh d√¢y 5 ho·∫∑c 4
        if (altBass > 6) altBass = bassString - 1; 
        
        notes = [getNote(currentChordKey, altBass)];
        msg = `B√ôM - D√¢y ${altBass} (Bass Ph·ª•)`;
        duration = 1.5;
        break;
    }

    // Play c√°c n·ªët ƒë∆°n (n·∫øu ch∆∞a play ·ªü case strum)
    if(notes.length > 0) {
      notes.forEach(n => {
        if(n) guitar.play(n, Tone.now(), { duration: duration, gain: velocity });
      });
    }

    // C·∫≠p nh·∫≠t UI
    infoBox.innerText = msg;
    highlightStep(currentStepIndex);

    // TƒÉng b∆∞·ªõc
    currentStepIndex++;

    // X·ª¨ L√ù H·∫æT V√íNG (LOOP)
    if (currentStepIndex >= PATTERN_STEPS.length) {
      currentStepIndex = 0; // Quay v·ªÅ ƒë·∫ßu
      barCounter++; // TƒÉng ƒë·∫øm s·ªë √¥ nh·ªãp
      checkAutoRotate(); // Ki·ªÉm tra c√≥ c·∫ßn ƒë·ªïi h·ª£p √¢m kh√¥ng
    }
  }

  // ================= HELPER FUNCTIONS =================

  function highlightStep(idx) {
    // X√≥a active c≈©
    document.querySelectorAll('.seq-step').forEach(el => el.classList.remove('active'));
    // Active m·ªõi
    const el = document.getElementById(`step-${idx}`);
    if(el) el.classList.add('active');
  }

  function checkAutoRotate() {
    const isAuto = document.getElementById('chk-auto-rotate').checked;
    if (!isAuto) return;

    const barsLimit = parseInt(document.getElementById('bars-count').value);
    
    if (barCounter >= barsLimit) {
      // ƒê·ªïi h·ª£p √¢m ti·∫øp theo trong v√≤ng
      let currentIdx = CHORD_PROGRESSION.indexOf(currentChordKey);
      let nextIdx = (currentIdx + 1) % CHORD_PROGRESSION.length;
      let nextChord = CHORD_PROGRESSION[nextIdx];
      
      manualSetChord(nextChord);
      barCounter = 0; // Reset ƒë·∫øm √¥ nh·ªãp
      
      // Hi·ªáu ·ª©ng b√°o hi·ªáu ƒë·ªïi h·ª£p √¢m
      infoBox.style.background = "#333";
      setTimeout(() => infoBox.style.background = "#000", 200);
    }
  }

  function manualSetChord(key) {
    currentChordKey = key;
    // Update n√∫t active
    document.querySelectorAll('.btn-chord').forEach(btn => {
      btn.classList.toggle('active', btn.innerText === key);
    });
    // Th√¥ng b√°o
    if(isReady) infoBox.innerText = `ƒê√£ chuy·ªÉn: ${CHORDS[key].name} (Bass ${CHORDS[key].bass})`;
  }

  function resetPattern() {
    currentStepIndex = 0;
    barCounter = 0;
    highlightStep(0);
    infoBox.innerText = "ƒê√£ Reset v·ªÅ ƒë·∫ßu nh·ªãp";
  }

</script>
</body>
</html>
