<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bolero Laboratory - V3 (Stable)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.18/Tone.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/soundfont-player@0.12.0/dist/soundfont-player.min.js"></script>

  <style>
    :root { --bg: #121214; --panel: #1c1c1f; --accent: #00e676; --text: #e0e0e0; }
    body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; padding: 20px; font-size: 14px; }
    
    h2 { color: var(--accent); margin-bottom: 5px; }
    .subtitle { color: #888; font-size: 0.85rem; margin-bottom: 20px; }

    .main-grid { display: grid; grid-template-columns: 260px 1fr; gap: 20px; max-width: 1100px; margin: 0 auto; }
    
    .controls-panel, .matrix-panel { background: var(--panel); padding: 15px; border-radius: 8px; border: 1px solid #333; }
    
    .control-group { margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #333; }
    .control-group label { display: block; margin-bottom: 8px; font-weight: bold; color: #bbb; }
    input[type=range] { width: 100%; accent-color: var(--accent); cursor: pointer; }
    
    button { 
      width: 100%; padding: 12px; margin-top: 5px; border: none; border-radius: 4px; 
      font-weight: bold; cursor: pointer; transition: 0.2s; font-size: 1rem;
    }
    .btn-play { background: var(--accent); color: #000; }
    .btn-stop { background: #ff5252; color: #fff; display: none; }
    .btn-preset { background: #333; color: #fff; margin-bottom: 5px; font-size: 0.85rem; padding: 8px; }
    .btn-preset:hover { background: #444; }

    .step-row { 
      display: grid; grid-template-columns: 60px 1fr 1fr 1fr 40px; 
      gap: 15px; align-items: center; padding: 10px 0; border-bottom: 1px solid #2a2a2a; 
    }
    .step-row:last-child { border-bottom: none; }
    .step-label { font-weight: bold; color: var(--accent); }
    
    .slider-col { display: flex; flex-direction: column; }
    .slider-col span { font-size: 0.75rem; color: #888; margin-bottom: 4px; }
    
    .viz-bar { height: 6px; background: #333; margin-top: 15px; position: relative; width: 100%; border-radius: 3px; overflow: hidden; }
    .viz-cursor { 
      position: absolute; top: 0; bottom: 0; width: 4px; background: #ff0000; 
      left: 0%; box-shadow: 0 0 10px red;
    }

    .chord-select { display: flex; gap: 5px; margin-top: 10px; }
    .btn-chord { background: #222; border: 1px solid #444; color: #fff; flex: 1; font-size: 0.9rem; padding: 10px; }
    .btn-chord.active { background: var(--accent); color: #000; border-color: var(--accent); }

    /* Responsive */
    @media (max-width: 768px) {
      .main-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

<div class="main-grid">
  <div class="controls-panel">
    <h2>üéõ Bolero Lab V3</h2>
    <p class="subtitle">Phi√™n b·∫£n ·ªïn ƒë·ªãnh (Nylon Guitar)</p>

    <div class="control-group">
      <label>Tr·∫°ng th√°i</label>
      <div id="status" style="color: #ffb703; font-size: 0.9rem; margin-bottom: 10px;">S·∫µn s√†ng</div>
      <button id="btn-play" class="btn-play" onclick="initAudio()">‚ñ∂ T·∫¢I & CH∆†I</button>
      <button id="btn-stop" class="btn-stop" onclick="stopAudio()">‚èπ D·ª™NG</button>
    </div>

    <div class="control-group">
      <label>T·ªëc ƒë·ªô (BPM): <span id="disp-bpm">80</span></label>
      <input type="range" id="bpm" min="50" max="140" value="80" oninput="updateMaster('bpm', this.value)">
    </div>

    <div class="control-group">
      <label>EQ (Ch·ªânh m√†u √¢m)</label>
      <div class="slider-col">
        <span>Bass (<span id="disp-low">0</span> dB)</span>
        <input type="range" min="-20" max="10" value="0" step="1" oninput="updateEQ('low', this.value)">
      </div>
      <div class="slider-col" style="margin-top:10px;">
        <span>Treble (<span id="disp-high">0</span> dB)</span>
        <input type="range" min="-20" max="10" value="0" step="1" oninput="updateEQ('high', this.value)">
      </div>
    </div>

    <div class="control-group">
      <label>H·ª£p √¢m</label>
      <div class="chord-select">
        <button class="btn-chord active" onclick="setChord('Am')">Am</button>
        <button class="btn-chord" onclick="setChord('Dm')">Dm</button>
        <button class="btn-chord" onclick="setChord('E7')">E7</button>
      </div>
    </div>

    <div class="control-group">
      <label>C√†i ƒë·∫∑t s·∫µn (Preset)</label>
      <button class="btn-preset" onclick="loadPreset('video')">1. Ki·ªÉu Video (L∆°i nh·ªãp)</button>
      <button class="btn-preset" onclick="loadPreset('robot')">2. Ki·ªÉu Robot (ƒê·ªÅu)</button>
    </div>
  </div>

  <div class="matrix-panel">
    <div style="display:flex; justify-content:space-between; margin-bottom:10px; border-bottom:1px solid #444; padding-bottom:5px; font-size:0.8rem; color:#aaa;">
      <span style="font-weight:bold; width:60px;">B∆∞·ªõc</span>
      <span>Th·ªùi ƒëi·ªÉm (Beat 0-4)</span>
      <span>ƒê·ªô d√†i (Gi√¢y)</span>
      <span>L·ª±c (Velocity)</span>
      <span>#</span>
    </div>
    
    <div id="steps-container">
      </div>
    
    <div class="viz-bar">
      <div id="cursor" class="viz-cursor"></div>
    </div>
  </div>
</div>

<script>
  // ================= DATA =================
  const CHORDS = {
    "Am": { bass: 5, frets: [-1, 0, 2, 2, 1, 0] },
    "Dm": { bass: 4, frets: [-1, -1, 0, 2, 3, 1] },
    "E7": { bass: 5, frets: [0, 2, 0, 1, 0, 0] }
  };
  // Tuning chu·∫©n MIDI: E2 A2 D3 G3 B3 E4
  const TUNING = [40, 45, 50, 55, 59, 64];

  // D·ªØ li·ªáu m·∫∑c ƒë·ªãnh (Preset Video)
  let stepsData = [
    { id: 0, label: "B√ôM 1", type: "bass",   time: 0.00, dur: 1.0,  vel: 1.0 },
    { id: 1, label: "1",     type: "pluck1", time: 0.65, dur: 0.2,  vel: 0.65 },
    { id: 2, label: "2",     type: "pluck2", time: 0.75, dur: 0.2,  vel: 0.7 },
    { id: 3, label: "3",     type: "pluck3", time: 0.85, dur: 0.2,  vel: 0.75 },
    { id: 4, label: "CH√ÅT",  type: "chat",   time: 1.00, dur: 0.05, vel: 0.9 },
    { id: 5, label: "B√ôM 2", type: "alt",    time: 1.50, dur: 0.6,  vel: 0.85 },
    { id: 6, label: "CH√ÅT",  type: "chat",   time: 2.00, dur: 0.05, vel: 0.9 },
    { id: 7, label: "B√ôM 3", type: "alt",    time: 2.50, dur: 0.6,  vel: 0.85 },
    { id: 8, label: "CH√ÅT",  type: "chat",   time: 3.00, dur: 0.05, vel: 0.9 },
  ];

  // ================= AUDIO ENGINE =================
  let guitar = null;
  let eq = null;
  let loop = null;
  let currentChord = "Am";
  let isPlaying = false;

  async function initAudio() {
    if(isPlaying) return;

    const btn = document.getElementById('btn-play');
    const status = document.getElementById('status');
    
    btn.disabled = true;
    btn.innerText = "‚è≥ ƒêANG T·∫¢I...";
    status.innerText = "ƒêang k·∫øt n·ªëi th∆∞ vi·ªán √¢m thanh...";

    try {
      await Tone.start();
      
      // T·∫°o EQ
      if (!eq) {
        eq = new Tone.EQ3(0, 0, 0).toDestination();
      }

      // T·∫£i Soundfont: D√πng Nylon cho an to√†n (√≠t l·ªói thi·∫øu n·ªët)
      if (!guitar) {
        guitar = await Soundfont.instrument(Tone.context.rawContext, 'acoustic_guitar_nylon', { 
          destination: eq,
          gain: 2.5 // TƒÉng gain v√¨ d√¢y nilon h∆°i nh·ªè
        });
      }
      
      isPlaying = true;
      status.innerText = "‚úÖ ƒêang ch∆°i";
      btn.style.display = 'none';
      document.getElementById('btn-stop').style.display = 'inline-block';
      
      startLoop();
    } catch(e) {
      console.error(e);
      status.innerText = "‚ùå L·ªói: " + e.message;
      btn.innerText = "TH·ª¨ L·∫†I";
      btn.disabled = false;
    }
  }

  function startLoop() {
    Tone.Transport.bpm.value = document.getElementById('bpm').value;
    
    // H·ªßy loop c≈© n·∫øu c√≥
    if(loop) loop.dispose();

    loop = new Tone.Loop((time) => {
      // Loop m·ªói 1 √¥ nh·ªãp (measure)
      
      // L√™n l·ªãch cho c√°c n·ªët trong √¥ nh·ªãp n√†y
      stepsData.forEach(s => {
        // T√≠nh th·ªùi gian trigger: 1 beat = "4n"
        // Tone.js Time calculation
        let offset = Tone.Time("4n").toSeconds() * s.time;
        playStep(s, time + offset);
      });
      
      // Animation thanh ch·∫°y
      Tone.Draw.schedule(() => {
        animateCursor();
      }, time);

    }, "1m").start(0);

    Tone.Transport.start();
  }

  function stopAudio() {
    Tone.Transport.stop();
    if(loop) loop.cancel();
    isPlaying = false;
    document.getElementById('status').innerText = "ƒê√£ d·ª´ng";
    document.getElementById('btn-play').style.display = 'inline-block';
    document.getElementById('btn-play').innerText = "‚ñ∂ TI·∫æP T·ª§C";
    document.getElementById('btn-play').disabled = false;
    document.getElementById('btn-stop').style.display = 'none';
  }

  function playStep(step, time) {
    if(!guitar) return;
    const chord = CHORDS[currentChord];
    let notes = [];
    
    try {
      if(step.type === 'bass') {
        notes = [getNote(chord.bass)];
      } else if (step.type === 'alt') {
        // ƒê·∫£o bass th√¥ng minh
        let alt = (currentChord === 'Dm') ? 5 : (chord.bass === 5 ? 4 : 5);
        notes = [getNote(alt)];
      } else if (step.type.startsWith('pluck')) {
        let offset = parseInt(step.type.replace('pluck',''));
        if(step.type === 'pluck3') {
          // N·ªët 3: Qu·∫°t nh·∫π 3 d√¢y cao
          notes = [getNote(3), getNote(2), getNote(1)];
        } else {
          notes = [getNote(chord.bass - offset)];
        }
      } else if (step.type === 'chat') {
        notes = [getNote(1), getNote(2), getNote(3)];
      }

      // Ph√°t √¢m thanh
      notes.forEach((n, idx) => {
        if(!n) return;
        
        // Stagger (R·∫£i) nh·∫π cho t·ª± nhi√™n
        let stagger = (step.type === 'chat' || step.type === 'pluck3') ? idx * 0.012 : 0;
        
        // Randomize nh·∫π th·ªùi gian (Humanize)
        let human = (Math.random() * 0.01) - 0.005;

        // Ch·∫ø ƒë·ªô "Ch√°t" ƒë·∫∑c bi·ªát: Ng·∫Øt ti·∫øng c·ª±c nhanh
        let opts = {
          duration: step.dur,
          gain: step.vel,
          attack: 0.002
        };

        if (step.type === 'chat') {
           opts.release = 0.05; // C·ª•t ng·ªßn
           opts.gain = step.vel * 0.8; // Gi·∫£m volume ch√°t ch√∫t
        } else {
           opts.release = 0.2; // Ng√¢n b√¨nh th∆∞·ªùng
        }

        // TRY-CATCH ƒë·ªÉ b·∫Øt l·ªói thi·∫øu n·ªët
        try {
          guitar.play(n, time + stagger + human, opts);
        } catch (err) {
          console.warn("Skipped note:", n);
        }
      });
    } catch (e) {
      console.error("Logic error in playStep", e);
    }
  }

  function getNote(stringIdx) {
    if (!stringIdx) return null;
    const chord = CHORDS[currentChord];
    const arrIdx = 6 - stringIdx;
    if (arrIdx < 0 || arrIdx > 5) return null;
    const fret = chord.frets[arrIdx];
    if(fret === -1) return null;
    return TUNING[arrIdx] + fret;
  }

  // ================= UI LOGIC =================
  const container = document.getElementById('steps-container');

  function renderSteps() {
    container.innerHTML = '';
    stepsData.forEach((s, idx) => {
      const div = document.createElement('div');
      div.className = 'step-row';
      div.innerHTML = `
        <div class="step-label">${s.label}</div>
        
        <div class="slider-col">
          <span>Th·ªùi ƒëi·ªÉm: <b id="val-time-${idx}">${s.time.toFixed(2)}</b></span>
          <input type="range" min="0" max="3.9" step="0.05" value="${s.time}" 
                 oninput="updateStep(${idx}, 'time', this.value)">
        </div>
        
        <div class="slider-col">
          <span>ƒê·ªô d√†i: <b id="val-dur-${idx}">${s.dur}s</b></span>
          <input type="range" min="0.05" max="1.5" step="0.05" value="${s.dur}" 
                 oninput="updateStep(${idx}, 'dur', this.value)">
        </div>

        <div class="slider-col">
          <span>L·ª±c: <b id="val-vel-${idx}">${s.vel}</b></span>
          <input type="range" min="0.1" max="1.5" step="0.1" value="${s.vel}" 
                 oninput="updateStep(${idx}, 'vel', this.value)">
        </div>

        <div style="text-align:center; color:#555; font-size:0.8rem">
           ${idx+1}
        </div>
      `;
      container.appendChild(div);
    });
  }

  window.updateStep = function(idx, field, val) {
    val = parseFloat(val);
    stepsData[idx][field] = val;
    document.getElementById(`val-${field}-${idx}`).innerText = (field === 'dur') ? val + 's' : val;
  }

  window.updateMaster = function(type, val) {
    if(type === 'bpm') {
      document.getElementById('disp-bpm').innerText = val;
      Tone.Transport.bpm.value = val;
    }
  }

  window.updateEQ = function(type, val) {
    document.getElementById(`disp-${type}`).innerText = val;
    if(eq) {
      if(type === 'low') eq.low.value = val;
      if(type === 'high') eq.high.value = val;
    }
  }

  window.setChord = function(c) {
    currentChord = c;
    document.querySelectorAll('.btn-chord').forEach(b => {
      b.classList.toggle('active', b.innerText === c);
    });
  }

  window.loadPreset = function(type) {
    if(type === 'video') {
      stepsData[0].time = 0.0; stepsData[0].dur = 1.0; // B√πm
      stepsData[1].time = 0.65; // 1 (L∆°i)
      stepsData[2].time = 0.75; // 2
      stepsData[3].time = 0.85; // 3
      stepsData[4].time = 1.0; stepsData[4].dur = 0.05; // Ch√°t
    } else {
      stepsData[0].time = 0.0;
      stepsData[1].time = 0.25; // ƒê·ªÅu
      stepsData[2].time = 0.50;
      stepsData[3].time = 0.75;
      stepsData[4].time = 1.0; stepsData[4].dur = 0.15;
    }
    renderSteps();
  }

  function animateCursor() {
    const cursor = document.getElementById('cursor');
    cursor.style.transition = 'none';
    cursor.style.left = '0%';
    // Trick to trigger reflow
    void cursor.offsetWidth; 
    cursor.style.transition = `left ${Tone.Time("1m").toSeconds()}s linear`;
    cursor.style.left = '100%';
  }

  // Init UI
  renderSteps();

</script>

</body>
</html>
