<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Liem Sight Reading Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vexflow@4.2.2/releases/vexflow-min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        serif: ['"Playfair Display"', 'serif'],
                        sans: ['"Inter"', 'sans-serif'],
                    },
                    colors: {
                        // Custom colors if needed
                    },
                    boxShadow: {
                        'glow': '0 0 20px rgba(79, 70, 229, 0.15)',
                        'glow-red': '0 0 20px rgba(225, 29, 72, 0.15)',
                        'card': '0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03)',
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;800&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
            transition: background-color 0.4s ease, color 0.4s ease;
        }

        /* --- THEMES --- */
        /* Classic (Default) */
        body.theme-classic { background-color: #f8f5f2; color: #1a1a1a; }
        .theme-classic .glass-panel { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(0,0,0,0.05); }
        .theme-classic .accent-text { color: #8b5cf6; } 

        /* Dark */
        body.theme-dark { background-color: #0f172a; color: #f1f5f9; }
        .theme-dark .glass-panel { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.05); }
        .theme-dark .accent-text { color: #a78bfa; }
        .theme-dark svg { filter: invert(1) hue-rotate(180deg) brightness(1.1); }

        /* Ocean */
        body.theme-ocean { background: linear-gradient(180deg, #ecfeff 0%, #cffafe 100%); color: #164e63; }
        .theme-ocean .glass-panel { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(8px); border: 1px solid rgba(6, 182, 212, 0.2); box-shadow: 0 4px 20px -2px rgba(6, 182, 212, 0.1); }
        .theme-ocean .accent-text { color: #0891b2; } 
        .theme-ocean .control-pill { background: rgba(6, 182, 212, 0.1); border-color: rgba(6, 182, 212, 0.2); }
        .theme-ocean .btn-primary { background-color: #0891b2 !important; box-shadow: 0 4px 14px 0 rgba(8, 145, 178, 0.39) !important; }

        /* Christmas */
        body.theme-christmas { background-color: #0f392b; color: #fff; background-image: radial-gradient(rgba(255,255,255,0.1) 1px, transparent 1px); background-size: 30px 30px; }
        .theme-christmas .glass-panel { background: rgba(20, 83, 45, 0.85); backdrop-filter: blur(10px); border: 1px solid rgba(255,215,0,0.2); }
        .theme-christmas .accent-text { color: #fbbf24; } 
        .theme-christmas .btn-primary { background: #dc2626 !important; border-color: #b91c1c !important; }
        
        /* Snow Animation */
        .snow-container { position: fixed; inset: 0; pointer-events: none; z-index: 0; display: none; }
        body.theme-christmas .snow-container { display: block; }
        .snowflake { position: absolute; color: white; animation: fall linear infinite; opacity: 0.7; }
        @keyframes fall { to { transform: translateY(100vh); } }

        /* --- COMPONENTS --- */
        .canvas-container {
            width: 100%; 
            display: flex; 
            justify-content: center; 
            align-items: center;
            background: white; 
            border-radius: 24px; 
            overflow: hidden;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.03);
            border: 1px solid rgba(0,0,0,0.04);
            flex: 1; 
            min-height: 200px;
            position: relative; z-index: 10;
        }
        .theme-dark .canvas-container { background: #1e293b; border-color: #334155; }
        .canvas-container svg { width: 100% !important; height: auto !important; }

        /* Lyric Style Answer */
        .lyric-answer {
            position: absolute;
            bottom: 20px;
            left: 0;
            right: 0;
            text-align: center;
            pointer-events: none;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 20;
        }
        
        .lyric-badge {
            display: inline-block;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(4px);
            padding: 8px 24px;
            border-radius: 99px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border: 1px solid rgba(0,0,0,0.05);
            transform: translateY(10px);
            opacity: 0;
        }
        .theme-dark .lyric-badge { background: rgba(30, 41, 59, 0.95); border-color: rgba(255,255,255,0.1); }
        
        .lyric-answer.visible .lyric-badge {
            transform: translateY(0);
            opacity: 1;
        }

        .btn-mode {
            position: relative; overflow: hidden; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateZ(0);
        }
        .btn-mode:active { transform: scale(0.98); }
        .btn-mode::after {
            content: ''; position: absolute; inset: 0; 
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
            transform: translateX(-100%); transition: 0.5s;
        }
        .btn-mode:hover::after { transform: translateX(100%); }

        .control-pill {
            background: rgba(0,0,0,0.05); border-radius: 999px; padding: 4px;
            display: flex; align-items: center; gap: 4px; transition: 0.2s;
        }
        .theme-dark .control-pill, body.theme-christmas .control-pill { background: rgba(255,255,255,0.1); }
        .control-pill:hover { transform: translateY(-1px); background: rgba(0,0,0,0.08); }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        select { -webkit-appearance: none; appearance: none; background: transparent; border: none; outline: none; font-weight: 600; text-align: center; }
    </style>
</head>
<body class="theme-classic h-[100dvh] flex flex-col overflow-hidden">

    <div class="snow-container" id="snowEffect"></div>

    <!-- Header -->
    <header class="z-50 shrink-0 px-6 py-3 flex flex-col items-center justify-center relative">
        <!-- Logo Area - Clickable to Home -->
        <div class="text-center mb-3 relative cursor-pointer group" onclick="goHome()">
            <h1 class="font-serif text-2xl md:text-3xl font-extrabold tracking-tight accent-text drop-shadow-sm group-hover:scale-105 transition-transform" data-i18n="appTitle">
                Liem Sight Reading
            </h1>
            <div class="h-1 w-12 bg-current opacity-20 mx-auto mt-1 rounded-full group-hover:w-16 transition-all"></div>
        </div>

        <!-- Controls Bar -->
        <div class="flex items-center gap-3 bg-white/50 dark:bg-black/20 backdrop-blur-md p-1 rounded-full shadow-sm border border-white/20">
            <!-- Lang -->
            <div class="control-pill px-3 cursor-pointer relative group">
                <span class="text-xs">üåê</span>
                <select id="langSelect" onchange="changeLanguage(this.value)" class="text-[10px] sm:text-xs uppercase cursor-pointer text-inherit w-full font-bold">
                    <option value="vi">VIE</option>
                    <option value="en">ENG</option>
                    <option value="fr">FRA</option>
                    <option value="es">ESP</option>
                    <option value="th">THA</option>
                </select>
            </div>

            <!-- Theme -->
            <div class="control-pill px-3 cursor-pointer">
                <span class="text-xs">üé®</span>
                <select id="themeSelect" onchange="changeTheme(this.value)" class="text-[10px] sm:text-xs cursor-pointer text-inherit font-bold">
                    <option value="classic">Classic</option>
                    <option value="ocean">Ocean</option>
                    <option value="dark">Dark</option>
                    <option value="christmas">Noel</option>
                </select>
            </div>

            <!-- Mute -->
            <button onclick="toggleMute()" class="control-pill w-7 h-7 justify-center">
                <svg id="icon-sound-on" class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"></path></svg>
                <svg id="icon-sound-off" class="w-3.5 h-3.5 hidden" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z m10.657-9.657a1 1 0 011.414 0l4 4a1 1 0 01-1.414 1.414L18.828 9.414a1 1 0 010-1.414z M21.657 16.657a1 1 0 01-1.414 1.414l-4-4a1 1 0 011.414-1.414l4 4z"></path></svg>
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 w-full max-w-lg mx-auto p-4 overflow-hidden relative z-10 flex flex-col">
        
        <!-- Loading Error -->
        <div id="error-msg" class="hidden absolute inset-0 z-50 flex flex-col items-center justify-center p-6 text-center text-red-500 bg-white/90 backdrop-blur rounded-2xl">
            <p class="font-bold text-lg mb-2" data-i18n="errorTitle">‚ö† L·ªói t·∫£i th∆∞ vi·ªán</p>
            <p class="text-sm" data-i18n="errorMsg">Vui l√≤ng ki·ªÉm tra m·∫°ng v√† t·∫£i l·∫°i trang (F5).</p>
        </div>

        <!-- 1. MENU SCREEN -->
        <div id="menu-screen" class="flex flex-col gap-4 h-full justify-center pb-6">
            <div class="text-center mb-2 opacity-60">
                <p class="text-xs uppercase tracking-[0.2em] font-bold" data-i18n="selectMode">CH·ªåN CH·∫æ ƒê·ªò LUY·ªÜN T·∫¨P</p>
            </div>

            <!-- Treble -->
            <button onclick="startMode('treble')" class="btn-mode glass-panel p-5 rounded-2xl shadow-card hover:shadow-glow flex items-center justify-between group">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full bg-indigo-100 dark:bg-indigo-900/50 flex items-center justify-center text-2xl group-hover:scale-110 transition-transform">üéº</div>
                    <div class="text-left">
                        <h3 class="font-bold text-lg font-serif" data-i18n="modeTreble">Kho√° Sol</h3>
                        <p class="text-xs opacity-70 mt-0.5" data-i18n="descTreble">Tay ph·∫£i</p>
                    </div>
                </div>
                <div class="w-8 h-8 rounded-full border border-current opacity-20 flex items-center justify-center group-hover:opacity-100 group-hover:bg-indigo-500 group-hover:border-transparent group-hover:text-white transition-all">‚ûú</div>
            </button>

            <!-- Bass -->
            <button onclick="startMode('bass')" class="btn-mode glass-panel p-5 rounded-2xl shadow-card hover:shadow-glow-red flex items-center justify-between group">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full bg-rose-100 dark:bg-rose-900/50 flex items-center justify-center text-2xl group-hover:scale-110 transition-transform">ùÑ¢</div>
                    <div class="text-left">
                        <h3 class="font-bold text-lg font-serif" data-i18n="modeBass">Kho√° Fa</h3>
                        <p class="text-xs opacity-70 mt-0.5" data-i18n="descBass">Tay tr√°i</p>
                    </div>
                </div>
                <div class="w-8 h-8 rounded-full border border-current opacity-20 flex items-center justify-center group-hover:opacity-100 group-hover:bg-rose-500 group-hover:border-transparent group-hover:text-white transition-all">‚ûú</div>
            </button>

            <!-- Grand -->
            <button onclick="startMode('grand')" class="btn-mode glass-panel p-5 rounded-2xl shadow-card flex items-center justify-between group border-l-4 border-l-amber-400">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-full bg-amber-100 dark:bg-amber-900/50 flex items-center justify-center text-2xl group-hover:scale-110 transition-transform">üéπ</div>
                    <div class="text-left">
                        <h3 class="font-bold text-lg font-serif" data-i18n="modeGrand">Grand Staff</h3>
                        <p class="text-xs opacity-70 mt-0.5" data-i18n="descGrand">K·∫øt h·ª£p 2 tay</p>
                    </div>
                </div>
                <div class="w-8 h-8 rounded-full border border-current opacity-20 flex items-center justify-center group-hover:opacity-100 group-hover:bg-amber-500 group-hover:border-transparent group-hover:text-white transition-all">‚ûú</div>
            </button>

            <!-- Library Link -->
            <button onclick="showLibrary()" class="glass-panel mt-4 py-4 px-6 rounded-xl flex items-center justify-center gap-3 hover:bg-black/5 dark:hover:bg-white/5 transition-colors">
                <span class="text-xl">üìö</span>
                <span class="font-semibold text-sm tracking-wide" data-i18n="library">Th∆∞ vi·ªán n·ªët nh·∫°c</span>
            </button>
        </div>

        <!-- 2. GAME SCREEN -->
        <div id="game-screen" class="hidden flex-col h-full w-full">
            <!-- New Header -->
            <div class="flex items-center mb-2 px-1 shrink-0 gap-3">
                <button onclick="goHome()" class="p-2 rounded-xl bg-white/50 dark:bg-white/10 hover:bg-white dark:hover:bg-white/20 transition-colors shadow-sm group">
                    <!-- Big Back Arrow Icon -->
                    <svg class="w-6 h-6 text-slate-700 dark:text-slate-200 group-hover:scale-110 transition-transform" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18"></path></svg>
                </button>
                <div class="font-bold text-xl font-serif accent-text tracking-tight" id="mode-title">Mode</div>
            </div>

            <!-- Music Canvas (Flexible Height) -->
            <div class="canvas-container mb-2 shadow-xl" id="canvas-wrapper">
                <div id="notation-output"></div>
                
                <!-- LYRIC STYLE ANSWER (Overlay inside canvas) -->
                <div id="lyric-answer" class="lyric-answer">
                    <div class="lyric-badge">
                        <span class="text-2xl font-black font-serif accent-text mr-2" id="note-name">C4</span>
                        <span class="text-lg font-bold opacity-80" id="note-detail">ƒê√¥</span>
                    </div>
                </div>
            </div>

            <!-- Controls (Fixed Height at Bottom) -->
            <div class="shrink-0 flex flex-col justify-end pb-safe pt-2">
                <button id="action-btn" onclick="handleAction()" class="btn-primary w-full bg-slate-900 dark:bg-indigo-600 text-white font-bold text-lg py-3.5 rounded-2xl shadow-lg hover:shadow-2xl hover:-translate-y-1 active:translate-y-0 transition-all duration-200" data-i18n="btnShow">
                    Hi·ªán ƒë√°p √°n
                </button>
            </div>
        </div>

        <!-- 3. LIBRARY SCREEN -->
        <div id="library-screen" class="hidden flex-col h-full w-full">
            <div class="flex justify-between items-center mb-2 px-2 shrink-0">
                <button onclick="goHome()" class="text-sm font-semibold hover:opacity-70 transition-opacity flex items-center gap-1" data-i18n="menuBack">‚Üê Menu</button>
                <h2 class="font-bold text-xl font-serif accent-text" data-i18n="library">Th∆∞ vi·ªán</h2>
                <div class="w-12"></div>
            </div>
            
            <div class="flex-1 overflow-y-auto no-scrollbar space-y-5 pb-6 pt-2 px-1" id="library-content">
                <!-- Library items will be injected here -->
            </div>
        </div>
    </main>

    <script>
        // --- LOGIC: Theme & Snow ---
        function initTheme() {
            const savedTheme = localStorage.theme || 'ocean'; 
            document.getElementById('themeSelect').value = savedTheme;
            changeTheme(savedTheme);
            createSnow();
        }

        function changeTheme(themeName) {
            document.body.className = `theme-${themeName} h-[100dvh] flex flex-col overflow-hidden`;
            localStorage.theme = themeName;
        }

        function createSnow() {
            const container = document.getElementById('snowEffect');
            container.innerHTML = '';
            for(let i=0; i<40; i++) {
                const flake = document.createElement('div');
                flake.className = 'snowflake text-white select-none';
                flake.style.left = Math.random() * 100 + '%';
                flake.style.animationDuration = (Math.random() * 5 + 5) + 's';
                flake.style.animationDelay = Math.random() * 5 + 's';
                flake.style.fontSize = (Math.random() * 10 + 8) + 'px';
                flake.innerText = '‚ùÑ';
                container.appendChild(flake);
            }
        }

        // --- I18N ---
        const i18n = {
            vi: { appTitle:"Liem Sight Reading", selectMode:"CH·ªåN CH·∫æ ƒê·ªò T·∫¨P", modeTreble:"Kho√° Sol", descTreble:"Tay ph·∫£i (Treble)", modeBass:"Kho√° Fa", descBass:"Tay tr√°i (Bass)", modeGrand:"Grand Staff", descGrand:"K·∫øt h·ª£p 2 tay", library:"Th∆∞ vi·ªán n·ªët", menuBack:"Menu", answerLabel:"ƒê√ÅP √ÅN", btnShow:"Hi·ªán ƒë√°p √°n", btnNext:"C√¢u ti·∫øp theo", octave:"Qu√£ng t√°m", errorTitle:"L·ªói t·∫£i", errorMsg:"Ki·ªÉm tra m·∫°ng (F5)" },
            en: { appTitle:"Liem Sight Reading", selectMode:"PRACTICE MODE", modeTreble:"Treble Clef", descTreble:"Right Hand", modeBass:"Bass Clef", descBass:"Left Hand", modeGrand:"Grand Staff", descGrand:"Both Hands", library:"Library", menuBack:"Menu", answerLabel:"ANSWER", btnShow:"Show Answer", btnNext:"Next Question", octave:"Octave", errorTitle:"Error", errorMsg:"Check Network (F5)" },
            fr: { appTitle:"Liem Lecture", selectMode:"MODE", modeTreble:"Cl√© de Sol", descTreble:"Main Droite", modeBass:"Cl√© de Fa", descBass:"Main Gauche", modeGrand:"Double", descGrand:"Deux Mains", library:"Biblioth√®que", menuBack:"Menu", answerLabel:"R√âPONSE", btnShow:"Voir R√©ponse", btnNext:"Suivant", octave:"Octave", errorTitle:"Erreur", errorMsg:"V√©rifier Connexion" },
            es: { appTitle:"Liem Lectura", selectMode:"MODO", modeTreble:"Clave Sol", descTreble:"Mano Derecha", modeBass:"Clave Fa", descBass:"Mano Izquierda", modeGrand:"Gran Pent.", descGrand:"Ambas Manos", library:"Biblioteca", menuBack:"Men√∫", answerLabel:"RESPUESTA", btnShow:"Ver Respuesta", btnNext:"Siguiente", octave:"Octava", errorTitle:"Error", errorMsg:"Revisar Red" },
            th: { appTitle:"Liem ‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡πÇ‡∏ô‡πâ‡∏ï", selectMode:"‡πÇ‡∏´‡∏°‡∏î‡∏ù‡∏∂‡∏Å‡∏ù‡∏ô", modeTreble:"‡∏Å‡∏∏‡∏ç‡πÅ‡∏à‡∏ã‡∏≠‡∏•", descTreble:"‡∏°‡∏∑‡∏≠‡∏Ç‡∏ß‡∏≤", modeBass:"‡∏Å‡∏∏‡∏ç‡πÅ‡∏à‡∏ü‡∏≤", descBass:"‡∏°‡∏∑‡∏≠‡∏ã‡πâ‡∏≤‡∏¢", modeGrand:"‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î 5 ‡πÄ‡∏™‡πâ‡∏ô‡πÉ‡∏´‡∏ç‡πà", descGrand:"‡∏™‡∏≠‡∏á‡∏°‡∏∑‡∏≠", library:"‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏°‡∏∏‡∏î", menuBack:"‡πÄ‡∏°‡∏ô‡∏π", answerLabel:"‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö", btnShow:"‡πÄ‡∏â‡∏•‡∏¢", btnNext:"‡∏Ç‡πâ‡∏≠‡∏ï‡πà‡∏≠‡πÑ‡∏õ", octave:"‡∏≠‡∏≠‡∏Å‡πÄ‡∏ó‡∏ü", errorTitle:"‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", errorMsg:"‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏ô‡πá‡∏ï" }
        };

        const noteLocales = {
            vi: ["ƒê√¥", "ƒê√¥#", "R√™", "R√™#", "Mi", "Fa", "Fa#", "Sol", "Sol#", "La", "La#", "Si"],
            en: ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"],
            fr: ["Do", "Do#", "R√©", "R√©#", "Mi", "Fa", "Fa#", "Sol", "Sol#", "La", "La#", "Si"],
            es: ["Do", "Do#", "Re", "Re#", "Mi", "Fa", "Fa#", "Sol", "Sol#", "La", "La#", "Si"],
            th: ["‡πÇ‡∏î", "‡πÇ‡∏î#", "‡πÄ‡∏£", "‡πÄ‡∏£#", "‡∏°‡∏µ", "‡∏ü‡∏≤", "‡∏ü‡∏≤#", "‡∏ã‡∏≠‡∏•", "‡∏ã‡∏≠‡∏•#", "‡∏•‡∏≤", "‡∏•‡∏≤#", "‡∏ó‡∏µ"]
        };

        let currentLang = localStorage.lang || 'vi';
        
        // --- CORE SETUP ---
        if (typeof Vex === 'undefined') {
            document.getElementById('error-msg').classList.remove('hidden');
            document.getElementById('menu-screen').classList.add('hidden');
        }
        const VF = Vex.Flow;
        let audioContext = null;
        let isMuted = localStorage.muted === 'true';

        // Init
        document.getElementById('langSelect').value = currentLang;
        initTheme();
        updateTexts();
        updateMuteUI();

        // --- FUNCTIONS ---
        function changeLanguage(lang) {
            currentLang = lang;
            localStorage.lang = lang;
            updateTexts();
            if (!document.getElementById('library-screen').classList.contains('hidden')) {
                document.getElementById('library-content').innerHTML = ""; 
                showLibrary();
            }
            if (currentNotes.length > 0 && document.getElementById('lyric-answer').classList.contains('visible')) {
                 updateAnswerText(true);
            }
            if(mode) {
                let titleKey = mode === 'treble' ? 'modeTreble' : mode === 'bass' ? 'modeBass' : 'modeGrand';
                document.getElementById('mode-title').innerText = i18n[currentLang][titleKey];
            }
        }

        function updateTexts() {
            const texts = i18n[currentLang];
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (texts[key]) el.innerText = texts[key];
            });
            const btn = document.getElementById('action-btn');
            if (btn.classList.contains('bg-emerald-500')) {
                btn.innerText = texts.btnNext;
            } else {
                btn.innerText = texts.btnShow;
            }
        }

        function updateMuteUI() {
            const on = document.getElementById('icon-sound-on');
            const off = document.getElementById('icon-sound-off');
            if(isMuted) { on.classList.add('hidden'); off.classList.remove('hidden'); }
            else { on.classList.remove('hidden'); off.classList.add('hidden'); }
        }

        function toggleMute() {
            isMuted = !isMuted;
            localStorage.muted = isMuted;
            updateMuteUI();
            if (!isMuted) unlockAudio();
        }

        function unlockAudio() {
            if (audioContext && audioContext.state === 'running') return;
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            if (!audioContext) audioContext = new AudioContext();
            if (audioContext.state === 'suspended') audioContext.resume();
            
            const buffer = audioContext.createBuffer(1, 1, 22050);
            const source = audioContext.createBufferSource();
            source.buffer = buffer;
            source.connect(audioContext.destination);
            source.start(0);
            ['touchstart', 'click'].forEach(e => document.removeEventListener(e, unlockAudio));
        }
        ['touchstart', 'click'].forEach(e => document.addEventListener(e, unlockAudio, {once:true}));

        function playFreq(freq) {
            if (isMuted || !audioContext) return;
            const osc = audioContext.createOscillator();
            const gain = audioContext.createGain();
            osc.type = 'triangle';
            osc.frequency.setValueAtTime(freq, audioContext.currentTime);
            gain.gain.setValueAtTime(0, audioContext.currentTime);
            gain.gain.linearRampToValueAtTime(0.5, audioContext.currentTime + 0.05);
            gain.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 1.2);
            osc.connect(gain);
            gain.connect(audioContext.destination);
            osc.start();
            osc.stop(audioContext.currentTime + 1.2);
        }

        // --- DATA ---
        const baseNoteNames = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
        const notes = [];
        for (let i = 21; i <= 108; i++) {
            const oct = Math.floor(i/12)-1;
            const noteIdx = i%12;
            const name = baseNoteNames[noteIdx];
            notes.push({
                midi: i, noteIdx: noteIdx, oct: oct,
                sci: `${name}${oct}`, acc: name.includes("#"),
                freq: 440 * Math.pow(2, (i-69)/12),
                key: `${name.toLowerCase()}/${oct}`
            });
        }

        let mode = null;
        let currentNotes = [];
        let revealed = false;
        
        // RANGES
        const ranges = { 
            treble: { min: 55, max: 84 }, 
            bass: { min: 36, max: 65 }, 
            gTreble: { min: 60, max: 84 }, 
            gBass: { min: 36, max: 60 }    
        };

        function getRandomNote(min, max) {
            const pool = notes.filter(n => n.midi >= min && n.midi <= max && !n.acc);
            return pool[Math.floor(Math.random() * pool.length)];
        }

        // --- APP LOGIC ---
        window.startMode = function(m) {
            unlockAudio();
            mode = m;
            document.getElementById('menu-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.replace('hidden', 'flex');
            
            let titleKey = m === 'treble' ? 'modeTreble' : m === 'bass' ? 'modeBass' : 'modeGrand';
            document.getElementById('mode-title').innerText = i18n[currentLang][titleKey];
            
            nextCard();
        };

        function updateAnswerText(onlyText = false) {
             const n1 = noteLocales[currentLang][currentNotes[0].noteIdx];
             const nameStr = currentNotes.length === 2 
                ? `${currentNotes[0].sci} & ${currentNotes[1].sci}`
                : currentNotes[0].sci;
             const detailStr = currentNotes.length === 2
                ? `${n1} - ${noteLocales[currentLang][currentNotes[1].noteIdx]}`
                : `${n1}`;

             if(!onlyText) {
                 document.getElementById('note-name').innerHTML = nameStr;
                 document.getElementById('note-detail').innerText = detailStr;
             }
        }

        window.nextCard = function() {
            revealed = false;
            const btn = document.getElementById('action-btn');
            const lyric = document.getElementById('lyric-answer');
            
            lyric.classList.remove('visible');
            
            btn.innerText = i18n[currentLang].btnShow;
            btn.className = "w-full bg-slate-900 dark:bg-indigo-600 text-white font-bold text-lg py-3.5 rounded-2xl shadow-lg hover:shadow-xl transition-all mt-auto mb-2";

            if (mode === 'grand') {
                currentNotes = [getRandomNote(ranges.gTreble.min, ranges.gTreble.max), getRandomNote(ranges.gBass.min, ranges.gBass.max)];
            } else {
                const r = ranges[mode];
                currentNotes = [getRandomNote(r.min, r.max)];
            }
            updateAnswerText();
            // Timeout to allow DOM layout before rendering canvas
            setTimeout(renderGameCanvas, 10);
        };

        window.handleAction = function() {
            if (!revealed) {
                revealed = true;
                currentNotes.forEach(n => playFreq(n.freq));
                
                const lyric = document.getElementById('lyric-answer');
                lyric.classList.add('visible');
                
                const btn = document.getElementById('action-btn');
                btn.innerText = i18n[currentLang].btnNext;
                btn.className = "w-full bg-emerald-500 text-white font-bold text-lg py-3.5 rounded-2xl shadow-glow transition-all mt-auto mb-2";
            } else {
                nextCard();
            }
        };

        window.goHome = function() {
            document.getElementById('game-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('flex');
            document.getElementById('library-screen').classList.add('hidden');
            document.getElementById('library-screen').classList.remove('flex');
            document.getElementById('menu-screen').classList.remove('hidden');
        };

        // --- RENDER GAME (OPTIMIZED SPACE) ---
        function renderGameCanvas() {
            const div = document.getElementById("notation-output");
            div.innerHTML = "";
            
            // Dynamic width based on container, but fixed internal coordinate system
            const refW = 500;
            // Higher height for grand staff to avoid clipping
            const refH = mode === 'grand' ? 420 : 300; 
            
            const renderer = new VF.Renderer(div, VF.Renderer.Backends.SVG);
            renderer.resize(refW, refH);
            const ctx = renderer.getContext();
            
            // Adjust ViewBox to fit content perfectly
            ctx.setViewBox(0, 0, refW, refH);
            
            // Slightly reduced scale to fit everything comfortably
            const scale = mode === 'grand' ? 1.2 : 1.4; 
            ctx.scale(scale, scale); 
            
            const w = refW / scale; 
            
            // WIDER STAVE: Increased from 220 to 400 (or near max width)
            const staveWidth = 350; 
            const x = (w - staveWidth) / 2; // Center based on stave width
            
            // Centered Y positions
            const startY = mode === 'grand' ? 50 : 80;
            
            if (mode === 'treble') {
                const s = new VF.Stave(x, startY, staveWidth);
                s.addClef("treble").setContext(ctx).draw();
                drawNote(ctx, s, currentNotes[0], "treble");
            } else if (mode === 'bass') {
                const s = new VF.Stave(x, startY, staveWidth);
                s.addClef("bass").setContext(ctx).draw();
                drawNote(ctx, s, currentNotes[0], "bass");
            } else if (mode === 'grand') {
                const s1 = new VF.Stave(x, startY, staveWidth); 
                const s2 = new VF.Stave(x, startY + 130, staveWidth); 
                
                s1.addClef("treble"); s2.addClef("bass");
                
                new VF.StaveConnector(s1, s2).setType(VF.StaveConnector.type.BRACE).setContext(ctx).draw();
                new VF.StaveConnector(s1, s2).setType(VF.StaveConnector.type.SINGLE_LEFT).setContext(ctx).draw();
                new VF.StaveConnector(s1, s2).setType(VF.StaveConnector.type.SINGLE_RIGHT).setContext(ctx).draw();
                
                s1.setContext(ctx).draw(); 
                s2.setContext(ctx).draw();
                
                drawNote(ctx, s1, currentNotes[0], "treble");
                drawNote(ctx, s2, currentNotes[1], "bass");
            }
        }

        function drawNote(ctx, stave, note, clef) {
            const vn = new VF.StaveNote({clef: clef, keys: [note.key], duration: "w", auto_stem: true});
            vn.setStyle({fillStyle: "black", strokeStyle: "black"});
            const v = new VF.Voice({num_beats: 4, beat_value: 4}).addTickables([vn]);
            // Format to center (width/2)
            new VF.Formatter().joinVoices([v]).format([v], stave.getWidth() - 100); 
            v.draw(ctx, stave);
        }

        // --- RENDER LIBRARY ---
        window.showLibrary = function() {
            unlockAudio();
            document.getElementById('menu-screen').classList.add('hidden');
            document.getElementById('library-screen').classList.replace('hidden', 'flex');
            const container = document.getElementById('library-content');
            if (container.children.length > 0) return; 

            for (let oct = 1; oct <= 7; oct++) {
                const octNotes = notes.filter(n => n.oct === oct && !n.acc);
                if (octNotes.length === 0) continue;

                const card = document.createElement('div');
                card.className = "glass-panel rounded-2xl overflow-hidden mb-4";
                
                const titleKey = i18n[currentLang].octave;
                card.innerHTML = `<div class="px-5 py-3 bg-black/5 dark:bg-white/5 border-b border-black/5 dark:border-white/5 font-serif font-bold text-lg opacity-80">${titleKey} ${oct}</div>`;
                
                const scrollWrap = document.createElement('div');
                scrollWrap.className = "overflow-x-auto library-scroll py-2 flex justify-center library-canvas relative no-scrollbar";
                const canvasDiv = document.createElement('div');
                scrollWrap.appendChild(canvasDiv);
                card.appendChild(scrollWrap);
                container.appendChild(card);

                // FIX: Wider canvas to fit last note (Si)
                const width = 600; 
                const height = 160; 
                
                const renderer = new VF.Renderer(canvasDiv, VF.Renderer.Backends.SVG);
                renderer.resize(width, height);
                const ctx = renderer.getContext();
                
                let clef = "treble"; let staveY = 30; 
                if (oct < 4) { clef = "bass"; staveY = 40; } 
                else if (oct >= 6) { staveY = 70; }

                const stave = new VF.Stave(10, staveY, width - 20);
                stave.addClef(clef).setContext(ctx).draw();

                const vfNotes = octNotes.map(n => new VF.StaveNote({clef: clef, keys: [n.key], duration: "q", auto_stem: true}));
                const voice = new VF.Voice({num_beats: vfNotes.length, beat_value: 4}).addTickables(vfNotes);
                
                // Formatter: Spread notes evenly
                new VF.Formatter().joinVoices([voice]).format([voice], width - 50);
                voice.draw(ctx, stave);

                vfNotes.forEach((vn, i) => {
                    const n = octNotes[i];
                    const x = vn.getAbsoluteX();
                    const btn = document.createElement('button');
                    const locName = noteLocales[currentLang][n.noteIdx];
                    btn.className = "absolute top-0 h-full w-12 hover:bg-indigo-500/10 flex flex-col justify-end items-center pb-2 transition-colors";
                    // Center button relative to note head
                    btn.style.left = (x - 20) + "px"; 
                    btn.innerHTML = `<span class="text-[10px] font-bold text-slate-600 bg-white/90 px-1.5 py-0.5 rounded-full shadow-sm font-sans transition-all">${locName}</span>`;
                    
                    btn.onclick = () => {
                        playFreq(n.freq);
                        const span = btn.firstElementChild;
                        span.classList.add('bg-indigo-500', 'text-white', 'scale-110');
                        setTimeout(() => span.classList.remove('bg-indigo-500', 'text-white', 'scale-110'), 200);
                    };
                    scrollWrap.appendChild(btn);
                });
            }
        }
    </script>
</body>
</html>
