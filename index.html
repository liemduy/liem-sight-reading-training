<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Luy·ªán Sight Reading Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vexflow@4.2.2/releases/vexflow-min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: { bg: '#1a1b1e', card: '#25262b', text: '#c1c2c5', border: '#2c2e33' }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
        }
        
        /* Game Canvas Wrapper */
        .canvas-wrapper {
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.02);
            aspect-ratio: 16/10; 
            max-height: 300px;
            position: relative;
        }

        .dark .canvas-wrapper { background: #25262b; }

        /* SVG Styling */
        .canvas-wrapper svg, .library-canvas svg {
            width: 100% !important;
            height: auto !important;
            display: block;
        }
        
        .dark .canvas-wrapper svg, .dark .library-canvas svg {
            filter: invert(1) hue-rotate(180deg) brightness(1.2);
        }

        /* Library Styling */
        .library-scroll { -webkit-overflow-scrolling: touch; }
        
        /* Custom scrollbar hide for cleaner look */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="h-[100dvh] flex flex-col text-gray-800 bg-[#f3f4f6] dark:bg-dark-bg dark:text-dark-text overflow-hidden transition-colors duration-300">

    <!-- Header -->
    <header class="bg-indigo-600 dark:bg-indigo-900 text-white p-3 shadow-md z-10 shrink-0 flex justify-between items-center px-4">
        <h1 class="text-lg font-bold truncate">üéπ Sight Reading Pro</h1>
        <div class="flex items-center gap-3">
            <button onclick="toggleMute()" class="p-2 rounded-full hover:bg-white/20 active:bg-white/30">
                <svg id="icon-sound-on" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"></path></svg>
                <svg id="icon-sound-off" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z m10.657-9.657a1 1 0 011.414 0l4 4a1 1 0 01-1.414 1.414L18.828 9.414a1 1 0 010-1.414z M21.657 16.657a1 1 0 01-1.414 1.414l-4-4a1 1 0 011.414-1.414l4 4z"></path><line x1="1" y1="1" x2="23" y2="23" stroke="currentColor" stroke-width="2"></line></svg>
            </button>
            <button onclick="toggleDarkMode()" class="p-2 rounded-full hover:bg-white/20 active:bg-white/30">
                <svg id="icon-sun" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                <svg id="icon-moon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
            </button>
        </div>
    </header>

    <main class="flex-1 flex flex-col p-4 max-w-md mx-auto w-full gap-4 overflow-hidden relative">
        <!-- Error Message -->
        <div id="error-msg" class="hidden absolute inset-0 bg-white dark:bg-dark-bg z-50 flex flex-col items-center justify-center p-6 text-center text-red-600">
            <p class="font-bold text-xl mb-2">‚ö† L·ªói t·∫£i th∆∞ vi·ªán</p>
            <p>Vui l√≤ng ki·ªÉm tra m·∫°ng v√† t·∫£i l·∫°i trang (F5).</p>
        </div>

        <!-- MENU SCREEN -->
        <div id="menu-screen" class="flex flex-col gap-3 h-full justify-center overflow-y-auto pb-4 px-1">
            <button onclick="startMode('treble')" class="btn bg-white dark:bg-dark-card dark:border-dark-border border-l-4 border-blue-500 p-5 rounded-xl shadow-sm flex items-center justify-between">
                <div class="text-left">
                    <h3 class="font-bold text-lg dark:text-gray-200">Kho√° Sol</h3>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Treble Clef</p>
                </div>
                <span class="text-3xl">üéº</span>
            </button>
            <button onclick="startMode('bass')" class="btn bg-white dark:bg-dark-card dark:border-dark-border border-l-4 border-red-500 p-5 rounded-xl shadow-sm flex items-center justify-between">
                <div class="text-left">
                    <h3 class="font-bold text-lg dark:text-gray-200">Kho√° Fa</h3>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Bass Clef</p>
                </div>
                <span class="text-3xl">ùÑ¢</span>
            </button>
            <button onclick="startMode('grand')" class="btn bg-white dark:bg-dark-card dark:border-dark-border border-l-4 border-purple-500 p-5 rounded-xl shadow-sm flex items-center justify-between">
                <div class="text-left">
                    <h3 class="font-bold text-lg dark:text-gray-200">2 Tay</h3>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Grand Staff</p>
                </div>
                <span class="text-3xl">üéπ</span>
            </button>
            <button onclick="showLibrary()" class="btn bg-gray-800 dark:bg-gray-700 text-white p-4 rounded-xl shadow mt-4 flex items-center justify-center gap-2">
                <span>üìö</span> Th∆∞ vi·ªán n·ªët
            </button>
        </div>

        <!-- GAME SCREEN -->
        <div id="game-screen" class="hidden flex-col h-full w-full">
            <div class="flex justify-between items-center mb-2 shrink-0">
                <button onclick="goHome()" class="text-sm font-medium text-gray-600 dark:text-gray-300 bg-gray-200 dark:bg-gray-700 px-4 py-2 rounded-lg">‚Üê Menu</button>
                <div class="font-bold text-indigo-600 dark:text-indigo-400" id="mode-title">Ch·∫ø ƒë·ªô</div>
                <div class="w-16"></div> 
            </div>

            <div class="canvas-wrapper mb-2" id="canvas-wrapper">
                <div id="notation-output"></div>
            </div>

            <div class="flex-1 flex flex-col justify-end gap-2 pb-safe">
                <div id="answer-box" class="flex-1 flex flex-col items-center justify-center opacity-0 transition-opacity duration-200">
                    <p class="text-gray-400 text-xs uppercase tracking-wider">ƒê√°p √°n</p>
                    <h2 class="text-5xl font-black text-gray-800 dark:text-white mt-1" id="note-name">C4</h2>
                    <p class="text-lg text-indigo-600 dark:text-indigo-400 font-medium mt-1 text-center leading-snug" id="note-detail">ƒê√¥ trung</p>
                </div>
                <button id="action-btn" onclick="handleAction()" class="btn w-full bg-indigo-600 dark:bg-indigo-700 text-white font-bold text-xl py-4 rounded-2xl shadow-lg mt-auto mb-2">Hi·ªán ƒë√°p √°n</button>
            </div>
        </div>

        <!-- LIBRARY SCREEN -->
        <div id="library-screen" class="hidden flex-col h-full w-full">
            <div class="flex justify-between items-center mb-4 shrink-0">
                <button onclick="goHome()" class="text-sm font-medium text-gray-600 dark:text-gray-300 bg-gray-200 dark:bg-gray-700 px-4 py-2 rounded-lg">‚Üê Menu</button>
                <h2 class="font-bold text-lg dark:text-gray-200">Th∆∞ vi·ªán</h2>
                <div class="w-16"></div>
            </div>
            <div class="flex-1 overflow-y-auto library-scroll space-y-4 px-1 pb-4" id="library-content"></div>
        </div>
    </main>

    <script>
        // --- SETUP ---
        if (typeof Vex === 'undefined') {
            document.getElementById('error-msg').classList.remove('hidden');
            document.getElementById('menu-screen').classList.add('hidden');
        }

        const VF = Vex.Flow;
        let audioContext = null;
        let isMuted = localStorage.muted === 'true';

        function updateMuteUI() {
            document.getElementById('icon-sound-on').classList.toggle('hidden', isMuted);
            document.getElementById('icon-sound-off').classList.toggle('hidden', !isMuted);
        }
        function toggleMute() {
            isMuted = !isMuted;
            localStorage.muted = isMuted;
            updateMuteUI();
            if (!isMuted) unlockAudio();
        }
        updateMuteUI();

        function toggleDarkMode() {
            const isDark = document.documentElement.classList.toggle('dark');
            document.getElementById('icon-sun').classList.toggle('hidden', !isDark);
            document.getElementById('icon-moon').classList.toggle('hidden', isDark);
            localStorage.theme = isDark ? 'dark' : 'light';
        }
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) toggleDarkMode();

        function unlockAudio() {
            if (audioContext && audioContext.state === 'running') return;
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            if (!audioContext) audioContext = new AudioContext();
            if (audioContext.state === 'suspended') audioContext.resume();
            
            const buffer = audioContext.createBuffer(1, 1, 22050);
            const source = audioContext.createBufferSource();
            source.buffer = buffer;
            source.connect(audioContext.destination);
            source.start(0);
            ['touchstart', 'click'].forEach(e => document.removeEventListener(e, unlockAudio));
        }
        ['touchstart', 'click'].forEach(e => document.addEventListener(e, unlockAudio, {once:true}));

        function playFreq(freq) {
            if (isMuted || !audioContext) return;
            const osc = audioContext.createOscillator();
            const gain = audioContext.createGain();
            osc.type = 'triangle';
            osc.frequency.setValueAtTime(freq, audioContext.currentTime);
            gain.gain.setValueAtTime(0, audioContext.currentTime);
            gain.gain.linearRampToValueAtTime(0.5, audioContext.currentTime + 0.05);
            gain.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 1.2);
            osc.connect(gain);
            gain.connect(audioContext.destination);
            osc.start();
            osc.stop(audioContext.currentTime + 1.2);
        }

        const noteNames = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
        const vietNames = {"C":"ƒê√¥","C#":"ƒê√¥#","D":"R√™","D#":"R√™#","E":"Mi","F":"Fa","F#":"Fa#","G":"Sol","G#":"Sol#","A":"La","A#":"La#","B":"Si"};
        const notes = [];
        for (let i = 21; i <= 108; i++) {
            const oct = Math.floor(i/12)-1;
            const name = noteNames[i%12];
            notes.push({
                midi: i, note: name, oct: oct,
                sci: `${name}${oct}`, viet: vietNames[name],
                acc: name.includes("#"),
                freq: 440 * Math.pow(2, (i-69)/12),
                key: `${name.toLowerCase()}/${oct}`
            });
        }

        let mode = null;
        let currentNotes = [];
        let revealed = false;
        const ranges = { treble: { min: 60, max: 79 }, bass: { min: 41, max: 60 }, gTreble: { min: 60, max: 79 }, gBass: { min: 41, max: 60 } };

        function getRandomNote(min, max) {
            const pool = notes.filter(n => n.midi >= min && n.midi <= max && !n.acc);
            return pool[Math.floor(Math.random() * pool.length)];
        }

        window.startMode = function(m) {
            unlockAudio();
            mode = m;
            document.getElementById('menu-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.replace('hidden', 'flex');
            document.getElementById('mode-title').innerText = m === 'treble' ? 'Kho√° Sol' : m === 'bass' ? 'Kho√° Fa' : 'Grand Staff';
            nextCard();
        };

        window.nextCard = function() {
            revealed = false;
            const btn = document.getElementById('action-btn');
            document.getElementById('answer-box').style.opacity = '0';
            btn.innerText = "Hi·ªán ƒë√°p √°n";
            btn.className = "btn w-full bg-indigo-600 dark:bg-indigo-700 text-white font-bold text-xl py-4 rounded-2xl shadow-lg mt-auto mb-2";

            if (mode === 'grand') {
                currentNotes = [getRandomNote(ranges.gTreble.min, ranges.gTreble.max), getRandomNote(ranges.gBass.min, ranges.gBass.max)];
            } else {
                const r = ranges[mode];
                currentNotes = [getRandomNote(r.min, r.max)];
            }

            if (currentNotes.length === 2) {
                document.getElementById('note-name').innerHTML = `<span class="text-3xl">${currentNotes[0].sci}</span> & <span class="text-3xl">${currentNotes[1].sci}</span>`;
                document.getElementById('note-detail').innerHTML = `${currentNotes[0].viet} - ${currentNotes[1].viet}`;
            } else {
                document.getElementById('note-name').innerText = currentNotes[0].sci;
                document.getElementById('note-detail').innerText = currentNotes[0].viet;
            }
            renderGameCanvas();
        };

        window.handleAction = function() {
            if (!revealed) {
                revealed = true;
                currentNotes.forEach(n => playFreq(n.freq));
                document.getElementById('answer-box').style.opacity = '1';
                const btn = document.getElementById('action-btn');
                btn.innerText = "C√¢u ti·∫øp theo ‚û°";
                btn.className = "btn w-full bg-green-600 text-white font-bold text-xl py-4 rounded-2xl shadow-lg mt-auto mb-2";
            } else {
                nextCard();
            }
        };

        window.goHome = function() {
            document.getElementById('game-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('flex');
            document.getElementById('library-screen').classList.add('hidden');
            document.getElementById('library-screen').classList.remove('flex');
            document.getElementById('menu-screen').classList.remove('hidden');
        };

        // --- RENDERING GAME ---
        function renderGameCanvas() {
            const div = document.getElementById("notation-output");
            div.innerHTML = "";
            const refWidth = 500; 
            const refHeight = 300; 
            const renderer = new VF.Renderer(div, VF.Renderer.Backends.SVG);
            renderer.resize(refWidth, refHeight);
            const ctx = renderer.getContext();
            ctx.setViewBox(0, 0, refWidth, refHeight);
            ctx.scale(1.5, 1.5); 
            const w = refWidth / 1.5; 
            const x = (w - 200) / 2;
            
            if (mode === 'treble') {
                const stave = new VF.Stave(x, 50, 200);
                stave.addClef("treble").setContext(ctx).draw();
                drawNote(ctx, stave, currentNotes[0], "treble");
            } else if (mode === 'bass') {
                const stave = new VF.Stave(x, 50, 200);
                stave.addClef("bass").setContext(ctx).draw();
                drawNote(ctx, stave, currentNotes[0], "bass");
            } else if (mode === 'grand') {
                const s1 = new VF.Stave(x, 20, 200);
                const s2 = new VF.Stave(x, 110, 200);
                s1.addClef("treble"); s2.addClef("bass");
                new VF.StaveConnector(s1, s2).setType(VF.StaveConnector.type.BRACE).setContext(ctx).draw();
                new VF.StaveConnector(s1, s2).setType(VF.StaveConnector.type.SINGLE_LEFT).setContext(ctx).draw();
                new VF.StaveConnector(s1, s2).setType(VF.StaveConnector.type.SINGLE_RIGHT).setContext(ctx).draw();
                s1.setContext(ctx).draw(); s2.setContext(ctx).draw();
                drawNote(ctx, s1, currentNotes[0], "treble");
                drawNote(ctx, s2, currentNotes[1], "bass");
            }
        }

        function drawNote(ctx, stave, note, clef) {
            const vn = new VF.StaveNote({clef: clef, keys: [note.key], duration: "w", auto_stem: true});
            vn.setStyle({fillStyle: "black", strokeStyle: "black"});
            const v = new VF.Voice({num_beats: 4, beat_value: 4}).addTickables([vn]);
            new VF.Formatter().joinVoices([v]).format([v], 100);
            v.draw(ctx, stave);
        }

        // --- RENDERING LIBRARY (FIXED) ---
        window.showLibrary = function() {
            unlockAudio();
            document.getElementById('menu-screen').classList.add('hidden');
            document.getElementById('library-screen').classList.replace('hidden', 'flex');
            const container = document.getElementById('library-content');
            if (container.children.length > 0) return; 

            for (let oct = 1; oct <= 7; oct++) {
                const octNotes = notes.filter(n => n.oct === oct && !n.acc);
                if (octNotes.length === 0) continue;

                const card = document.createElement('div');
                card.className = "bg-white dark:bg-dark-card rounded-xl shadow-sm border border-gray-100 dark:border-dark-border";
                card.innerHTML = `<div class="px-4 py-2 bg-gray-50 dark:bg-gray-800 border-b dark:border-gray-700 font-bold dark:text-gray-300">Qu√£ng t√°m ${oct}</div>`;
                
                const scrollWrap = document.createElement('div');
                scrollWrap.className = "overflow-x-auto library-scroll py-2 flex justify-center library-canvas relative no-scrollbar";
                
                const canvasDiv = document.createElement('div');
                scrollWrap.appendChild(canvasDiv);
                card.appendChild(scrollWrap);
                container.appendChild(card);

                // --- LOGIC FIX: TƒÉng chi·ªÅu cao & kho·∫£ng c√°ch ---
                const width = 400; // ƒê·ªß r·ªông ƒë·ªÉ kh√¥ng b·ªã c·∫Øt ƒëu√¥i
                const height = 160; // TƒÉng chi·ªÅu cao ƒë·ªÉ ch·ª©a n·ªët cao/th·∫•p
                
                const renderer = new VF.Renderer(canvasDiv, VF.Renderer.Backends.SVG);
                renderer.resize(width, height);
                const ctx = renderer.getContext();
                
                // Ch·ªçn kho√° v√† v·ªã tr√≠ Y ph√π h·ª£p
                let clef = "treble";
                let staveY = 30; // M·∫∑c ƒë·ªãnh
                
                if (oct < 4) {
                    clef = "bass";
                    staveY = 40; // ƒê·∫©y xu·ªëng m·ªôt ch√∫t cho qu√£ng tr·∫ßm
                } else if (oct >= 6) {
                    // Qu√£ng si√™u cao: ƒê·∫©y Stave xu·ªëng nhi·ªÅu h∆°n ƒë·ªÉ n·ªët kh√¥ng ch·∫°m tr·∫ßn
                    staveY = 70; 
                }

                // V·∫Ω Stave r·ªông h·∫øt canvas
                const stave = new VF.Stave(10, staveY, width - 20);
                stave.addClef(clef).setContext(ctx).draw();

                // T·∫°o n·ªët
                const vfNotes = octNotes.map(n => {
                    // X·ª≠ l√Ω hi·ªÉn th·ªã 8va (n·∫øu c·∫ßn thi·∫øt, ho·∫∑c ƒë·ªÉ vexflow t·ª± render ledger lines)
                    // ·ªû ƒë√¢y ta c·ª© ƒë·ªÉ ledger lines nh∆∞ng nh·ªù tƒÉng height v√† staveY n√™n s·∫Ω kh√¥ng b·ªã c·∫Øt
                    return new VF.StaveNote({
                        clef: clef, keys: [n.key], duration: "q", auto_stem: true
                    });
                });

                const voice = new VF.Voice({num_beats: vfNotes.length, beat_value: 4}).addTickables(vfNotes);
                // D√†n tr·∫£i n·ªët ƒë·ªÅu ra to√†n b·ªô chi·ªÅu r·ªông
                new VF.Formatter().joinVoices([voice]).format([voice], width - 60);
                voice.draw(ctx, stave);

                // T·∫°o n√∫t b·∫•m
                vfNotes.forEach((vn, i) => {
                    const n = octNotes[i];
                    const x = vn.getAbsoluteX();
                    const btn = document.createElement('button');
                    // N√∫t b·∫•m cao h·∫øt chi·ªÅu cao th·∫ª ƒë·ªÉ d·ªÖ b·∫•m
                    btn.className = "absolute top-0 h-full w-10 hover:bg-black/5 flex flex-col justify-end items-center pb-2";
                    btn.style.left = (x - 15) + "px";
                    btn.innerHTML = `<span class="text-xs font-bold text-indigo-600 bg-white/90 px-1 rounded shadow-sm border border-indigo-100">${n.viet}</span>`;
                    btn.onclick = () => {
                        playFreq(n.freq);
                        btn.firstElementChild.style.color = "red";
                        setTimeout(()=>btn.firstElementChild.style.color = "", 200);
                    };
                    scrollWrap.appendChild(btn);
                });
            }
        }
    </script>
</body>
</html>
