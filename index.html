<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Liem Sight Reading Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vexflow@4.2.2/releases/vexflow-min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        serif: ['"Playfair Display"', 'Georgia', 'Cambria', 'serif'],
                        sans: ['"Inter"', 'system-ui', 'sans-serif'],
                        musical: ['"Times New Roman"', 'serif'] // Font ri√™ng cho n·ªët nh·∫°c/ti√™u ƒë·ªÅ c·ªï ƒëi·ªÉn
                    },
                    colors: {
                        // Classic Theme
                        paper: '#f9f7f1',
                        ink: '#2b2b2b',
                        
                        // Christmas Theme
                        xmasRed: '#c41e3a',
                        xmasGreen: '#165b33',
                        xmasGold: '#ffbf00',

                        // Ocean Theme
                        oceanDeep: '#0f172a',
                        oceanBlue: '#3b82f6',
                        oceanLight: '#e0f2fe'
                    },
                    animation: {
                        'snow': 'snow 10s linear infinite',
                    },
                    keyframes: {
                        snow: {
                            '0%': { transform: 'translateY(-10px)', opacity: '0' },
                            '50%': { opacity: '1' },
                            '100%': { transform: 'translateY(100vh)', opacity: '0' }
                        }
                    }
                }
            }
        }
    </script>
    <!-- Google Fonts for better typography -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,700;1,400&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
            transition: background-color 0.5s ease, color 0.5s ease;
        }

        /* --- THEME SPECIFIC STYLES --- */
        
        /* 1. Classic (Default) */
        body.theme-classic { background-color: #f9f7f1; color: #2b2b2b; }
        .theme-classic header { background: linear-gradient(to bottom, #2b2b2b, #1a1a1a); }
        .theme-classic .btn-action { background-color: #2b2b2b; color: #fff; }
        
        /* 2. Dark */
        body.theme-dark { background-color: #111827; color: #e5e7eb; }
        .theme-dark header { background-color: #000; border-bottom: 1px solid #333; }
        .theme-dark .canvas-wrapper { background-color: #1f2937; border-color: #374151; }
        .theme-dark svg { filter: invert(1) hue-rotate(180deg) brightness(1.2); }
        .theme-dark .btn-card { background-color: #1f2937; border-color: #374151; }

        /* 3. Ocean */
        body.theme-ocean { background-color: #f0f9ff; color: #0c4a6e; }
        .theme-ocean header { background: linear-gradient(135deg, #0f172a 0%, #334155 100%); }
        .theme-ocean .canvas-wrapper { border: 2px solid #bae6fd; box-shadow: 0 4px 15px -3px rgba(14, 165, 233, 0.2); }
        .theme-ocean .btn-action { background: linear-gradient(to right, #0284c7, #2563eb); }
        .theme-ocean .btn-card:hover { border-color: #38bdf8; background-color: #f0f9ff; }

        /* 4. Christmas */
        body.theme-christmas { background-color: #fff0f0; color: #165b33; background-image: radial-gradient(#d1d5db 1px, transparent 1px); background-size: 20px 20px; }
        .theme-christmas header { 
            background: linear-gradient(to right, #165b33, #0b2e19); 
            border-bottom: 4px solid #c41e3a; 
            position: relative;
        }
        .theme-christmas .canvas-wrapper { border: 2px solid #165b33; box-shadow: 0 0 15px rgba(22, 91, 51, 0.2); }
        .theme-christmas .btn-action { background-color: #c41e3a; border-bottom: 4px solid #991b1b; }
        .theme-christmas .btn-action:active { border-bottom: 0; transform: translateY(4px); }
        
        /* Snow Effect for Christmas */
        .snow-overlay { pointer-events: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 50; display: none; }
        body.theme-christmas .snow-overlay { display: block; }
        .snowflake { position: absolute; top: -10px; color: #fff; animation: snow 10s linear infinite; }
        
        /* Common Components */
        .canvas-wrapper {
            width: 100%; display: flex; justify-content: center; align-items: center;
            background: white; border-radius: 16px; overflow: hidden;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
            border: 1px solid rgba(0,0,0,0.05); aspect-ratio: 16/10; max-height: 280px; position: relative;
        }
        .canvas-wrapper svg, .library-canvas svg { width: 100% !important; height: auto !important; display: block; }

        .library-scroll { -webkit-overflow-scrolling: touch; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .control-btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
            cursor: pointer;
        }
        .control-btn:hover { background: rgba(255,255,255,0.2); }
        .control-btn select { background: transparent; color: white; outline: none; border: none; font-weight: 600; cursor: pointer; appearance: none; }
        .control-btn select option { color: #000; }

        .theme-label-text { font-family: 'Playfair Display', serif; }
    </style>
</head>
<body class="theme-classic h-[100dvh] flex flex-col overflow-hidden">

    <!-- Christmas Snow Layer -->
    <div class="snow-overlay" id="snowContainer"></div>

    <!-- Header (Redesigned: 2 Rows) -->
    <header class="text-white pt-4 pb-3 shadow-xl z-20 shrink-0 flex flex-col items-center gap-3">
        
        <!-- Row 1: Title (Solemn & Full Width) -->
        <div class="w-full text-center relative px-4">
            <!-- Decorative line left/right (visible on larger screens) -->
            <div class="hidden sm:block absolute top-1/2 left-4 right-4 h-px bg-white/20 -z-0"></div>
            
            <h1 class="text-2xl md:text-3xl font-bold font-serif tracking-wide text-amber-50 inline-block bg-inherit px-4 relative z-10" style="text-shadow: 0 2px 4px rgba(0,0,0,0.3);">
                <span class="opacity-80 text-xl mr-2">üéπ</span>
                <span data-i18n="appTitle">Liem Sight Reading</span>
            </h1>
        </div>

        <!-- Row 2: Controls (Buttons below) -->
        <div class="flex items-center gap-3 z-10">
            
            <!-- 1. Language -->
            <div class="control-btn" title="Ng√¥n ng·ªØ">
                <span class="text-lg">üåê</span>
                <select id="langSelect" onchange="changeLanguage(this.value)">
                    <option value="vi">Vi·ªát Nam</option>
                    <option value="en">English</option>
                    <option value="fr">Fran√ßais</option>
                    <option value="es">Espa√±ol</option>
                    <option value="th">‡πÑ‡∏ó‡∏¢</option>
                </select>
            </div>

            <!-- 2. Theme Selector -->
            <div class="control-btn" title="Giao di·ªán">
                <span class="text-lg">üé®</span>
                <select id="themeSelect" onchange="changeTheme(this.value)">
                    <option value="classic">Classic</option>
                    <option value="dark">Dark</option>
                    <option value="ocean">Ocean</option>
                    <option value="christmas">Noel üéÑ</option>
                </select>
            </div>

            <!-- 3. Mute Toggle -->
            <button onclick="toggleMute()" class="control-btn" style="padding: 6px 10px;" title="√Çm thanh">
                <svg id="icon-sound-on" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"></path></svg>
                <svg id="icon-sound-off" class="w-5 h-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z m10.657-9.657a1 1 0 011.414 0l4 4a1 1 0 01-1.414 1.414L18.828 9.414a1 1 0 010-1.414z M21.657 16.657a1 1 0 01-1.414 1.414l-4-4a1 1 0 011.414-1.414l4 4z"></path><line x1="1" y1="1" x2="23" y2="23" stroke="currentColor" stroke-width="2"></line></svg>
            </button>
        </div>
    </header>

    <main class="flex-1 flex flex-col p-4 max-w-md mx-auto w-full gap-4 overflow-hidden relative z-0">
        <!-- Error Message -->
        <div id="error-msg" class="hidden absolute inset-0 bg-white/95 z-50 flex flex-col items-center justify-center p-6 text-center text-red-600 backdrop-blur-sm rounded-xl">
            <p class="font-bold text-xl mb-2 font-serif" data-i18n="errorTitle">‚ö† L·ªói t·∫£i th∆∞ vi·ªán</p>
            <p data-i18n="errorMsg">Vui l√≤ng ki·ªÉm tra m·∫°ng v√† t·∫£i l·∫°i trang (F5).</p>
        </div>

        <!-- MENU SCREEN -->
        <div id="menu-screen" class="flex flex-col gap-4 h-full justify-center overflow-y-auto pb-4 px-1">
            <div class="text-center mb-1">
                <div class="inline-block w-12 h-1 bg-gray-300 dark:bg-gray-600 rounded-full mb-4"></div>
                <p class="text-sm uppercase tracking-widest opacity-60 font-semibold" data-i18n="selectMode">Ch·ªçn ch·∫ø ƒë·ªô luy·ªán t·∫≠p</p>
            </div>

            <!-- Mode Buttons with Theme Support -->
            <button onclick="startMode('treble')" class="btn-card bg-white border p-5 rounded-2xl shadow-sm hover:shadow-lg flex items-center justify-between group transition-all duration-300 relative overflow-hidden">
                <div class="absolute w-1.5 h-full left-0 top-0 bg-indigo-500"></div>
                <div class="text-left pl-3">
                    <h3 class="font-bold text-xl font-serif group-hover:text-indigo-600 transition-colors" data-i18n="modeTreble">Kho√° Sol</h3>
                    <p class="text-sm opacity-60" data-i18n="descTreble">Treble Clef ‚Ä¢ Tay ph·∫£i</p>
                </div>
                <span class="text-4xl opacity-80 group-hover:scale-110 group-hover:rotate-12 transition-transform duration-300">üéº</span>
            </button>

            <button onclick="startMode('bass')" class="btn-card bg-white border p-5 rounded-2xl shadow-sm hover:shadow-lg flex items-center justify-between group transition-all duration-300 relative overflow-hidden">
                <div class="absolute w-1.5 h-full left-0 top-0 bg-rose-500"></div>
                <div class="text-left pl-3">
                    <h3 class="font-bold text-xl font-serif group-hover:text-rose-600 transition-colors" data-i18n="modeBass">Kho√° Fa</h3>
                    <p class="text-sm opacity-60" data-i18n="descBass">Bass Clef ‚Ä¢ Tay tr√°i</p>
                </div>
                <span class="text-4xl opacity-80 group-hover:scale-110 group-hover:-rotate-12 transition-transform duration-300">ùÑ¢</span>
            </button>

            <button onclick="startMode('grand')" class="btn-card bg-white border p-5 rounded-2xl shadow-sm hover:shadow-lg flex items-center justify-between group transition-all duration-300 relative overflow-hidden">
                <div class="absolute w-1.5 h-full left-0 top-0 bg-purple-500"></div>
                <div class="text-left pl-3">
                    <h3 class="font-bold text-xl font-serif group-hover:text-purple-600 transition-colors" data-i18n="modeGrand">Grand Staff</h3>
                    <p class="text-sm opacity-60" data-i18n="descGrand">K·∫øt h·ª£p 2 tay</p>
                </div>
                <span class="text-4xl opacity-80 group-hover:scale-110 transition-transform duration-300">üéπ</span>
            </button>

            <button onclick="showLibrary()" class="btn-action bg-gray-800 text-white p-4 rounded-2xl shadow-lg mt-4 flex items-center justify-center gap-2 hover:bg-gray-700 transition-all font-semibold tracking-wide">
                <span>üìö</span> <span data-i18n="library">Th∆∞ vi·ªán n·ªët nh·∫°c</span>
            </button>
        </div>

        <!-- GAME SCREEN -->
        <div id="game-screen" class="hidden flex-col h-full w-full">
            <div class="flex justify-between items-center mb-4 shrink-0">
                <button onclick="goHome()" class="text-sm font-semibold bg-white/50 border px-4 py-2 rounded-lg hover:bg-white transition-colors" data-i18n="menuBack">
                    ‚Üê Menu
                </button>
                <div class="font-bold text-xl font-serif" id="mode-title" data-i18n="modeLabel">Ch·∫ø ƒë·ªô</div>
                <div class="w-16"></div> 
            </div>

            <div class="canvas-wrapper mb-4" id="canvas-wrapper">
                <div id="notation-output"></div>
            </div>

            <div class="flex-1 flex flex-col justify-end gap-2 pb-safe">
                <div id="answer-box" class="flex-1 flex flex-col items-center justify-center opacity-0 transition-opacity duration-300 scale-95">
                    <p class="text-xs uppercase tracking-widest font-bold mb-2 opacity-50" data-i18n="answerLabel">ƒê√°p √°n</p>
                    <div class="bg-white/80 dark:bg-black/20 backdrop-blur-sm px-10 py-5 rounded-2xl border border-gray-100/50 text-center min-w-[200px] shadow-sm">
                        <h2 class="text-5xl font-black font-serif mb-1" id="note-name">C4</h2>
                        <p class="text-lg font-semibold opacity-80" id="note-detail">ƒê√¥ trung</p>
                    </div>
                </div>
                <button id="action-btn" onclick="handleAction()" class="btn-action bg-gray-900 text-white font-bold text-xl py-4 rounded-2xl shadow-lg hover:shadow-xl transition-all mt-auto mb-2" data-i18n="btnShow">
                    Hi·ªán ƒë√°p √°n
                </button>
            </div>
        </div>

        <!-- LIBRARY SCREEN -->
        <div id="library-screen" class="hidden flex-col h-full w-full">
            <div class="flex justify-between items-center mb-4 shrink-0">
                <button onclick="goHome()" class="text-sm font-semibold bg-white/50 border px-4 py-2 rounded-lg hover:bg-white transition-colors" data-i18n="menuBack">
                    ‚Üê Menu
                </button>
                <h2 class="font-bold text-xl font-serif" data-i18n="library">Th∆∞ vi·ªán</h2>
                <div class="w-16"></div>
            </div>
            <div class="flex-1 overflow-y-auto library-scroll space-y-4 px-1 pb-4" id="library-content"></div>
        </div>
    </main>

    <script>
        // --- THEME MANAGEMENT ---
        function initTheme() {
            const savedTheme = localStorage.theme || 'classic';
            document.getElementById('themeSelect').value = savedTheme;
            changeTheme(savedTheme);
            
            // Create snow flakes
            const snowContainer = document.getElementById('snowContainer');
            for(let i=0; i<30; i++) {
                const flake = document.createElement('div');
                flake.className = 'snowflake';
                flake.style.left = Math.random() * 100 + '%';
                flake.style.animationDelay = Math.random() * 5 + 's';
                flake.style.opacity = Math.random();
                flake.style.fontSize = (Math.random() * 10 + 10) + 'px';
                flake.innerText = '‚ùÑ';
                snowContainer.appendChild(flake);
            }
        }

        function changeTheme(themeName) {
            document.body.className = `theme-${themeName} h-[100dvh] flex flex-col overflow-hidden`;
            localStorage.theme = themeName;
        }

        // --- I18N CONFIGURATION ---
        const i18n = {
            vi: {
                appTitle: "Liem Sight Reading",
                selectMode: "Ch·ªçn ch·∫ø ƒë·ªô luy·ªán t·∫≠p",
                modeTreble: "Kho√° Sol", descTreble: "Treble Clef ‚Ä¢ Tay ph·∫£i",
                modeBass: "Kho√° Fa", descBass: "Bass Clef ‚Ä¢ Tay tr√°i",
                modeGrand: "Grand Staff", descGrand: "K·∫øt h·ª£p 2 tay",
                library: "Th∆∞ vi·ªán n·ªët nh·∫°c",
                menuBack: "‚Üê Menu",
                modeLabel: "Ch·∫ø ƒë·ªô",
                answerLabel: "ƒê√°p √°n",
                btnShow: "Hi·ªán ƒë√°p √°n",
                btnNext: "C√¢u ti·∫øp theo ‚û°",
                octave: "Qu√£ng t√°m",
                errorTitle: "‚ö† L·ªói t·∫£i th∆∞ vi·ªán",
                errorMsg: "Vui l√≤ng ki·ªÉm tra m·∫°ng v√† t·∫£i l·∫°i trang (F5)."
            },
            en: {
                appTitle: "Liem Sight Reading",
                selectMode: "Select Practice Mode",
                modeTreble: "Treble Clef", descTreble: "Right Hand",
                modeBass: "Bass Clef", descBass: "Left Hand",
                modeGrand: "Grand Staff", descGrand: "Both Hands",
                library: "Note Library",
                menuBack: "‚Üê Menu",
                modeLabel: "Mode",
                answerLabel: "Answer",
                btnShow: "Show Answer",
                btnNext: "Next Question ‚û°",
                octave: "Octave",
                errorTitle: "‚ö† Library Load Error",
                errorMsg: "Please check internet and reload (F5)."
            },
            fr: {
                appTitle: "Liem Lecture √† Vue",
                selectMode: "Mode d'entra√Ænement",
                modeTreble: "Cl√© de Sol", descTreble: "Main Droite",
                modeBass: "Cl√© de Fa", descBass: "Main Gauche",
                modeGrand: "Port√©e Double", descGrand: "Deux Mains",
                library: "Biblioth√®que",
                menuBack: "‚Üê Menu",
                modeLabel: "Mode",
                answerLabel: "R√©ponse",
                btnShow: "Voir R√©ponse",
                btnNext: "Suivant ‚û°",
                octave: "Octave",
                errorTitle: "‚ö† Erreur de chargement",
                errorMsg: "Veuillez v√©rifier votre connexion."
            },
            es: {
                appTitle: "Liem Lectura Musical",
                selectMode: "Modo de pr√°ctica",
                modeTreble: "Clave de Sol", descTreble: "Mano Derecha",
                modeBass: "Clave de Fa", descBass: "Mano Izquierda",
                modeGrand: "Gran Pentagrama", descGrand: "Ambas Manos",
                library: "Biblioteca",
                menuBack: "‚Üê Men√∫",
                modeLabel: "Modo",
                answerLabel: "Respuesta",
                btnShow: "Ver Respuesta",
                btnNext: "Siguiente ‚û°",
                octave: "Octava",
                errorTitle: "‚ö† Error de carga",
                errorMsg: "Por favor revise su conexi√≥n."
            },
            th: {
                appTitle: "Liem ‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡πÇ‡∏ô‡πâ‡∏ï",
                selectMode: "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏´‡∏°‡∏î‡∏ù‡∏∂‡∏Å‡∏ù‡∏ô",
                modeTreble: "‡∏Å‡∏∏‡∏ç‡πÅ‡∏à‡∏ã‡∏≠‡∏•", descTreble: "‡∏°‡∏∑‡∏≠‡∏Ç‡∏ß‡∏≤",
                modeBass: "‡∏Å‡∏∏‡∏ç‡πÅ‡∏à‡∏ü‡∏≤", descBass: "‡∏°‡∏∑‡∏≠‡∏ã‡πâ‡∏≤‡∏¢",
                modeGrand: "‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î 5 ‡πÄ‡∏™‡πâ‡∏ô‡πÉ‡∏´‡∏ç‡πà", descGrand: "‡∏™‡∏≠‡∏á‡∏°‡∏∑‡∏≠",
                library: "‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏°‡∏∏‡∏î‡πÇ‡∏ô‡πâ‡∏ï",
                menuBack: "‚Üê ‡πÄ‡∏°‡∏ô‡∏π",
                modeLabel: "‡πÇ‡∏´‡∏°‡∏î",
                answerLabel: "‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö",
                btnShow: "‡πÄ‡∏â‡∏•‡∏¢",
                btnNext: "‡∏Ç‡πâ‡∏≠‡∏ï‡πà‡∏≠‡πÑ‡∏õ ‚û°",
                octave: "‡∏≠‡∏≠‡∏Å‡πÄ‡∏ó‡∏ü",
                errorTitle: "‚ö† ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î",
                errorMsg: "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï"
            }
        };

        const noteLocales = {
            vi: ["ƒê√¥", "ƒê√¥#", "R√™", "R√™#", "Mi", "Fa", "Fa#", "Sol", "Sol#", "La", "La#", "Si"],
            en: ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"],
            fr: ["Do", "Do#", "R√©", "R√©#", "Mi", "Fa", "Fa#", "Sol", "Sol#", "La", "La#", "Si"],
            es: ["Do", "Do#", "Re", "Re#", "Mi", "Fa", "Fa#", "Sol", "Sol#", "La", "La#", "Si"],
            th: ["‡πÇ‡∏î", "‡πÇ‡∏î#", "‡πÄ‡∏£", "‡πÄ‡∏£#", "‡∏°‡∏µ", "‡∏ü‡∏≤", "‡∏ü‡∏≤#", "‡∏ã‡∏≠‡∏•", "‡∏ã‡∏≠‡∏•#", "‡∏•‡∏≤", "‡∏•‡∏≤#", "‡∏ó‡∏µ"]
        };

        let currentLang = localStorage.lang || 'vi';

        // --- SETUP ---
        if (typeof Vex === 'undefined') {
            document.getElementById('error-msg').classList.remove('hidden');
            document.getElementById('menu-screen').classList.add('hidden');
        }

        const VF = Vex.Flow;
        let audioContext = null;
        let isMuted = localStorage.muted === 'true';

        // Initialize
        document.getElementById('langSelect').value = currentLang;
        initTheme();
        updateTexts();

        function changeLanguage(lang) {
            currentLang = lang;
            localStorage.lang = lang;
            updateTexts();
            if (!document.getElementById('library-screen').classList.contains('hidden')) {
                document.getElementById('library-content').innerHTML = ""; 
                showLibrary();
            }
            if (currentNotes.length > 0 && document.getElementById('answer-box').style.opacity !== '0') {
                 updateAnswerText(true);
            }
        }

        function updateTexts() {
            const texts = i18n[currentLang];
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (texts[key]) el.innerText = texts[key];
            });
            const btn = document.getElementById('action-btn');
            if (btn.classList.contains('bg-emerald-600') || btn.classList.contains('bg-green-600')) {
                btn.innerText = texts.btnNext;
            } else {
                btn.innerText = texts.btnShow;
            }
        }

        function getLocalizedNote(noteIndex) {
            return noteLocales[currentLang][noteIndex];
        }

        // --- AUDIO ---
        function updateMuteUI() {
            document.getElementById('icon-sound-on').classList.toggle('hidden', isMuted);
            document.getElementById('icon-sound-off').classList.toggle('hidden', !isMuted);
        }
        function toggleMute() {
            isMuted = !isMuted;
            localStorage.muted = isMuted;
            updateMuteUI();
            if (!isMuted) unlockAudio();
        }
        updateMuteUI();

        function unlockAudio() {
            if (audioContext && audioContext.state === 'running') return;
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            if (!audioContext) audioContext = new AudioContext();
            if (audioContext.state === 'suspended') audioContext.resume();
            
            const buffer = audioContext.createBuffer(1, 1, 22050);
            const source = audioContext.createBufferSource();
            source.buffer = buffer;
            source.connect(audioContext.destination);
            source.start(0);
            ['touchstart', 'click'].forEach(e => document.removeEventListener(e, unlockAudio));
        }
        ['touchstart', 'click'].forEach(e => document.addEventListener(e, unlockAudio, {once:true}));

        function playFreq(freq) {
            if (isMuted || !audioContext) return;
            const osc = audioContext.createOscillator();
            const gain = audioContext.createGain();
            osc.type = 'triangle';
            osc.frequency.setValueAtTime(freq, audioContext.currentTime);
            gain.gain.setValueAtTime(0, audioContext.currentTime);
            gain.gain.linearRampToValueAtTime(0.5, audioContext.currentTime + 0.05);
            gain.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 1.2);
            osc.connect(gain);
            gain.connect(audioContext.destination);
            osc.start();
            osc.stop(audioContext.currentTime + 1.2);
        }

        // --- DATA & LOGIC ---
        const baseNoteNames = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
        const notes = [];
        for (let i = 21; i <= 108; i++) {
            const oct = Math.floor(i/12)-1;
            const noteIdx = i%12;
            const name = baseNoteNames[noteIdx];
            notes.push({
                midi: i, noteIdx: noteIdx, oct: oct,
                sci: `${name}${oct}`, acc: name.includes("#"),
                freq: 440 * Math.pow(2, (i-69)/12),
                key: `${name.toLowerCase()}/${oct}`
            });
        }

        let mode = null;
        let currentNotes = [];
        let revealed = false;
        const ranges = { treble: { min: 60, max: 79 }, bass: { min: 41, max: 60 }, gTreble: { min: 60, max: 79 }, gBass: { min: 41, max: 60 } };

        function getRandomNote(min, max) {
            const pool = notes.filter(n => n.midi >= min && n.midi <= max && !n.acc);
            return pool[Math.floor(Math.random() * pool.length)];
        }

        window.startMode = function(m) {
            unlockAudio();
            mode = m;
            document.getElementById('menu-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.replace('hidden', 'flex');
            let titleKey = m === 'treble' ? 'modeTreble' : m === 'bass' ? 'modeBass' : 'modeGrand';
            document.getElementById('mode-title').innerText = i18n[currentLang][titleKey];
            nextCard();
        };

        function updateAnswerText(onlyText = false) {
             const note1Name = getLocalizedNote(currentNotes[0].noteIdx);
             if (currentNotes.length === 2) {
                const note2Name = getLocalizedNote(currentNotes[1].noteIdx);
                if(!onlyText) document.getElementById('note-name').innerHTML = `<span class="text-3xl">${currentNotes[0].sci}</span> & <span class="text-3xl">${currentNotes[1].sci}</span>`;
                document.getElementById('note-detail').innerHTML = `${note1Name} - ${note2Name}`;
             } else {
                if(!onlyText) document.getElementById('note-name').innerText = currentNotes[0].sci;
                document.getElementById('note-detail').innerText = note1Name;
             }
        }

        window.nextCard = function() {
            revealed = false;
            const btn = document.getElementById('action-btn');
            document.getElementById('answer-box').style.opacity = '0';
            document.getElementById('answer-box').classList.add('scale-95');
            
            btn.innerText = i18n[currentLang].btnShow;
            // Reset to Neutral style (depends on Theme)
            btn.className = "btn-action bg-gray-900 text-white font-bold text-xl py-4 rounded-2xl shadow-lg hover:shadow-xl transition-all mt-auto mb-2";

            if (mode === 'grand') {
                currentNotes = [getRandomNote(ranges.gTreble.min, ranges.gTreble.max), getRandomNote(ranges.gBass.min, ranges.gBass.max)];
            } else {
                const r = ranges[mode];
                currentNotes = [getRandomNote(r.min, r.max)];
            }
            updateAnswerText();
            renderGameCanvas();
        };

        window.handleAction = function() {
            if (!revealed) {
                revealed = true;
                currentNotes.forEach(n => playFreq(n.freq));
                document.getElementById('answer-box').style.opacity = '1';
                document.getElementById('answer-box').classList.remove('scale-95');
                const btn = document.getElementById('action-btn');
                
                btn.innerText = i18n[currentLang].btnNext;
                // Green success style
                btn.className = "btn-action bg-emerald-600 text-white font-bold text-xl py-4 rounded-2xl shadow-lg hover:shadow-xl transition-all mt-auto mb-2";
            } else {
                nextCard();
            }
        };

        window.goHome = function() {
            document.getElementById('game-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('flex');
            document.getElementById('library-screen').classList.add('hidden');
            document.getElementById('library-screen').classList.remove('flex');
            document.getElementById('menu-screen').classList.remove('hidden');
        };

        // --- RENDER GAME ---
        function renderGameCanvas() {
            const div = document.getElementById("notation-output");
            div.innerHTML = "";
            const refWidth = 500; const refHeight = 300; 
            const renderer = new VF.Renderer(div, VF.Renderer.Backends.SVG);
            renderer.resize(refWidth, refHeight);
            const ctx = renderer.getContext();
            ctx.setViewBox(0, 0, refWidth, refHeight);
            ctx.scale(1.5, 1.5); 
            const w = refWidth / 1.5; const x = (w - 200) / 2;
            
            if (mode === 'treble') {
                const stave = new VF.Stave(x, 50, 200);
                stave.addClef("treble").setContext(ctx).draw();
                drawNote(ctx, stave, currentNotes[0], "treble");
            } else if (mode === 'bass') {
                const stave = new VF.Stave(x, 50, 200);
                stave.addClef("bass").setContext(ctx).draw();
                drawNote(ctx, stave, currentNotes[0], "bass");
            } else if (mode === 'grand') {
                const s1 = new VF.Stave(x, 20, 200); const s2 = new VF.Stave(x, 110, 200);
                s1.addClef("treble"); s2.addClef("bass");
                new VF.StaveConnector(s1, s2).setType(VF.StaveConnector.type.BRACE).setContext(ctx).draw();
                new VF.StaveConnector(s1, s2).setType(VF.StaveConnector.type.SINGLE_LEFT).setContext(ctx).draw();
                new VF.StaveConnector(s1, s2).setType(VF.StaveConnector.type.SINGLE_RIGHT).setContext(ctx).draw();
                s1.setContext(ctx).draw(); s2.setContext(ctx).draw();
                drawNote(ctx, s1, currentNotes[0], "treble");
                drawNote(ctx, s2, currentNotes[1], "bass");
            }
        }

        function drawNote(ctx, stave, note, clef) {
            const vn = new VF.StaveNote({clef: clef, keys: [note.key], duration: "w", auto_stem: true});
            vn.setStyle({fillStyle: "black", strokeStyle: "black"});
            const v = new VF.Voice({num_beats: 4, beat_value: 4}).addTickables([vn]);
            new VF.Formatter().joinVoices([v]).format([v], 100);
            v.draw(ctx, stave);
        }

        // --- RENDER LIBRARY ---
        window.showLibrary = function() {
            unlockAudio();
            document.getElementById('menu-screen').classList.add('hidden');
            document.getElementById('library-screen').classList.replace('hidden', 'flex');
            const container = document.getElementById('library-content');
            if (container.children.length > 0) return; 

            for (let oct = 1; oct <= 7; oct++) {
                const octNotes = notes.filter(n => n.oct === oct && !n.acc);
                if (octNotes.length === 0) continue;

                const card = document.createElement('div');
                card.className = "bg-white dark:bg-dark-card rounded-xl shadow-sm border border-gray-200 dark:border-dark-border";
                const octaveTitle = i18n[currentLang].octave;
                card.innerHTML = `<div class="px-4 py-3 bg-gray-50 dark:bg-slate-800/50 border-b border-gray-100 dark:border-dark-border font-bold font-serif text-lg dark:text-gray-200 opacity-80">${octaveTitle} ${oct}</div>`;
                
                const scrollWrap = document.createElement('div');
                scrollWrap.className = "overflow-x-auto library-scroll py-2 flex justify-center library-canvas relative no-scrollbar";
                const canvasDiv = document.createElement('div');
                scrollWrap.appendChild(canvasDiv);
                card.appendChild(scrollWrap);
                container.appendChild(card);

                const width = 400; const height = 160; 
                const renderer = new VF.Renderer(canvasDiv, VF.Renderer.Backends.SVG);
                renderer.resize(width, height);
                const ctx = renderer.getContext();
                
                let clef = "treble"; let staveY = 30; 
                if (oct < 4) { clef = "bass"; staveY = 40; } 
                else if (oct >= 6) { staveY = 70; }

                const stave = new VF.Stave(10, staveY, width - 20);
                stave.addClef(clef).setContext(ctx).draw();

                const vfNotes = octNotes.map(n => new VF.StaveNote({clef: clef, keys: [n.key], duration: "q", auto_stem: true}));
                const voice = new VF.Voice({num_beats: vfNotes.length, beat_value: 4}).addTickables(vfNotes);
                new VF.Formatter().joinVoices([voice]).format([voice], width - 60);
                voice.draw(ctx, stave);

                vfNotes.forEach((vn, i) => {
                    const n = octNotes[i];
                    const x = vn.getAbsoluteX();
                    const btn = document.createElement('button');
                    const localizedName = getLocalizedNote(n.noteIdx);
                    btn.className = "absolute top-0 h-full w-10 hover:bg-black/5 flex flex-col justify-end items-center pb-2";
                    btn.style.left = (x - 15) + "px";
                    btn.innerHTML = `<span class="text-xs font-bold text-slate-700 bg-white/95 px-1.5 py-0.5 rounded shadow-sm border border-gray-200 font-sans whitespace-nowrap transition-colors">${localizedName}</span>`;
                    btn.onclick = () => {
                        playFreq(n.freq);
                        const span = btn.firstElementChild;
                        span.classList.remove('text-slate-700', 'bg-white/95');
                        span.classList.add('text-white', 'bg-indigo-500', 'border-indigo-500');
                        setTimeout(() => {
                            span.classList.add('text-slate-700', 'bg-white/95');
                            span.classList.remove('text-white', 'bg-indigo-500', 'border-indigo-500');
                        }, 200);
                    };
                    scrollWrap.appendChild(btn);
                });
            }
        }
    </script>
</body>
</html>
