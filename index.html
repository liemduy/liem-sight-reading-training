<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Liem's Harmony Hub</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- VexFlow (Music Notation) -->
    <script src="https://cdn.jsdelivr.net/npm/vexflow@4.2.3/build/cjs/vexflow.js"></script>
    <!-- Tone.js (Audio Synthesis) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&family=Fira+Code:wght@400;600&family=Mountains+of+Christmas:wght@700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Nunito', sans-serif;
            transition: background 0.5s ease, color 0.3s ease;
            background: var(--bg-gradient, var(--bg-color));
            color: var(--text-color);
            min-height: 100vh;
        }
        
        :root {
            /* --- CLASSIC (Default) --- */
            --bg-color: #f8fafc;
            --bg-gradient: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            --text-color: #1e293b;
            --card-bg: rgba(255, 255, 255, 0.95);
            --card-text: #1e293b;
            --primary-color: #3b82f6;
            --accent-color: #10b981;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --border-radius: 1rem;
            --header-font: 'Nunito', sans-serif;
            --placeholder-color: #94a3b8; /* Slate 400 */
        }

        [data-theme="dark"] {
            --bg-color: #0f172a;
            --bg-gradient: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            --text-color: #e2e8f0;
            --card-bg: rgba(30, 41, 59, 0.95);
            --card-text: #e2e8f0;
            --primary-color: #8b5cf6;
            --accent-color: #2dd4bf;
            --shadow-color: rgba(0, 0, 0, 0.5);
            --placeholder-color: #475569;
        }

        [data-theme="ocean"] {
            --bg-color: #e0f2fe;
            --bg-gradient: linear-gradient(to bottom, #0ea5e9, #e0f2fe);
            --text-color: #0c4a6e;
            --card-bg: rgba(255, 255, 255, 0.9);
            --card-text: #0c4a6e;
            --primary-color: #0284c7;
            --accent-color: #0369a1;
            --shadow-color: rgba(14, 165, 233, 0.2);
            --placeholder-color: #bae6fd;
        }

        [data-theme="coder"] {
            --bg-color: #000000;
            --bg-gradient: repeating-linear-gradient(0deg, transparent, transparent 1px, #001100 1px, #001100 2px);
            --text-color: #00ff41;
            --card-bg: #0d0d0d;
            --card-text: #00ff41;
            --primary-color: #00ff41;
            --accent-color: #008f11;
            --shadow-color: rgba(0, 255, 65, 0.2);
            --border-radius: 0px;
            --placeholder-color: #003300;
            font-family: 'Fira Code', 'Courier New', monospace;
            --header-font: 'Fira Code', monospace;
        }
        [data-theme="coder"] .theme-card { border: 1px solid var(--primary-color); box-shadow: 0 0 10px var(--shadow-color); }
        [data-theme="coder"] .theme-btn-primary { background-color: transparent; border: 1px solid var(--primary-color); color: var(--primary-color); }
        [data-theme="coder"] .theme-btn-primary:hover { background-color: var(--primary-color); color: black; box-shadow: 0 0 15px var(--primary-color); }

        [data-theme="love"] {
            --bg-color: #fff1f2;
            --bg-gradient: radial-gradient(circle, #ffe4e6 0%, #fda4af 100%);
            --text-color: #881337;
            --card-bg: rgba(255, 255, 255, 0.9);
            --card-text: #881337;
            --primary-color: #e11d48;
            --accent-color: #fb7185;
            --shadow-color: rgba(225, 29, 72, 0.2);
            --border-radius: 1.5rem;
            --placeholder-color: #fecdd3;
        }

        /* --- CHRISTMAS THEME (RE-DESIGNED) --- */
        [data-theme="christmas"] {
            --bg-color: #0f392b; /* Dark Pine Green */
            --bg-gradient: radial-gradient(circle at 50% -20%, #b45309 0%, #14532d 40%, #062c21 100%);
            
            --text-color: #fefce8; /* Cream for body text (Light) */
            
            --card-bg: #fffbeb; /* Warm Cream for Cards */
            --card-text: #3f0e0e; /* Dark Red-Brown for text inside cards (High Contrast) */
            
            --primary-color: #b91c1c; /* Christmas Red */
            --accent-color: #d97706; /* Gold */
            
            --shadow-color: rgba(0, 0, 0, 0.4);
            --border-radius: 16px;
            --placeholder-color: #d1d5db; /* Gray for placeholders */
            
            --header-font: 'Mountains of Christmas', cursive;
        }
        [data-theme="christmas"] .theme-card {
            border: 2px solid #f59e0b; /* Gold Border */
            box-shadow: 0 8px 30px rgba(0,0,0,0.3);
        }
        [data-theme="christmas"] .theme-btn-primary {
            background-color: #b91c1c;
            border: 2px solid #f59e0b; /* Gold border button */
            color: #fffbeb;
            font-family: 'Nunito', sans-serif;
            font-weight: 800;
        }
        [data-theme="christmas"] .active-tab {
            background-color: #15803d !important; /* Green Tab */
            color: #fff !important;
            border: 2px solid #f59e0b !important;
        }
        [data-theme="christmas"] select, [data-theme="christmas"] input {
            color: #3f0e0e;
            background-color: #ffffff;
            border: 2px solid #b91c1c;
        }

        [data-theme="retro"] {
            --bg-color: #d7c9a8;
            --bg-gradient: url('https://www.transparenttextures.com/patterns/aged-paper.png'), linear-gradient(#e6d5b8, #d7c9a8);
            --text-color: #4a3b32;
            --card-bg: #fdf6e3;
            --card-text: #4a3b32;
            --primary-color: #b58900;
            --accent-color: #cb4b16;
            --shadow-color: rgba(74, 59, 50, 0.2);
            --border-radius: 2px;
            --placeholder-color: #dcbfa3;
        }

        /* --- UTILITIES --- */
        .theme-card { 
            background-color: var(--card-bg); 
            color: var(--card-text); 
            border-radius: var(--border-radius);
            box-shadow: 0 10px 15px -3px var(--shadow-color), 0 4px 6px -2px var(--shadow-color);
        }
        
        .theme-btn-primary { background-color: var(--primary-color); color: white; border-radius: var(--border-radius); }
        .theme-btn-primary:hover { filter: brightness(110%); transform: translateY(-1px); }
        
        .theme-btn-accent { background-color: var(--accent-color); color: white; border-radius: var(--border-radius); }
        .theme-btn-accent:hover { filter: brightness(110%); transform: translateY(-1px); }
        
        .theme-border { border-color: var(--primary-color); }
        
        /* Font Application */
        h1, h2 { font-family: var(--header-font); }
        /* Fallback for complex text to Nunito */
        p, span, div, button, select, input { font-family: 'Nunito', sans-serif; }

        .vf-stavenote { cursor: pointer; }
        .vf-stavenote:hover path, .vf-stavenote:hover rect { fill: var(--primary-color) !important; stroke: var(--primary-color) !important; }
        
        #flashcard-canvas svg, #ear-vexflow svg, #notation-container svg { display: block; margin: 0 auto; }
        #ear-vexflow { display: flex; justify-content: center; width: 100%; }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .library-scroll::-webkit-scrollbar { width: 6px; }
        .library-scroll::-webkit-scrollbar-track { background: transparent; }
        .library-scroll::-webkit-scrollbar-thumb { background-color: var(--primary-color); border-radius: 20px; opacity: 0.5; }

        .metronome-dot { width: 20px; height: 20px; border-radius: 50%; background-color: #e5e7eb; transition: background-color 0.1s; }
        .metronome-dot.active { background-color: var(--primary-color); box-shadow: 0 0 15px var(--primary-color); }
        
        select { color: var(--card-text); background-color: var(--card-bg); border: 1px solid var(--primary-color); }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        
        .sticky-header { background-color: var(--card-bg); border-bottom: 2px solid var(--primary-color); z-index: 20; }
    </style>
</head>
<body class="min-h-screen flex flex-col" data-theme="classic">

    <!-- Header -->
    <nav class="theme-card rounded-none shadow-md p-3 sticky top-0 z-50 flex justify-center items-center w-full border-b theme-border border-b-2 sm:border-b-0">
        <div class="flex items-center gap-3">
            <i class="fas fa-music text-3xl" style="color: var(--primary-color)"></i>
            <h1 class="text-2xl font-bold md:text-3xl tracking-tight">Liem's Harmony Hub</h1>
            <i class="fas fa-snowflake text-2xl animate-pulse hidden" id="xmas-icon" style="color: #fbbf24"></i>
        </div>
    </nav>

    <!-- Controls Bar -->
    <div class="w-full py-2">
        <div class="container mx-auto flex justify-center items-center gap-3 flex-nowrap px-2" id="controls-bar"></div>
    </div>

    <!-- Main Content -->
    <main class="flex-grow container mx-auto p-4 flex flex-col items-center pt-2">
        
        <!-- Menu Tabs -->
        <div class="w-full overflow-x-auto pb-4 pt-2 mb-2 no-scrollbar px-4">
            <div class="flex gap-3 min-w-max justify-center" id="mode-tabs"></div>
        </div>

        <div id="app-container" class="w-full max-w-5xl flex flex-col items-center mt-2"></div>

    </main>

    <footer class="theme-card rounded-none mt-auto py-4 text-center text-sm font-semibold w-full">
        <p class="opacity-80">¬© 2024 Liem's Harmony Hub. Design with <i class="fas fa-heart text-[var(--primary-color)]"></i> for Music Lovers.</p>
    </footer>

    <script>
        const APP_NAME = "Liem's Harmony Hub";
        
        // --- C·∫§U H√åNH ---
        const DEFAULT_THEME = 'christmas'; 

        const LANGUAGES = {
            vi: {
                flag: "üáªüá≥", name: "Ti·∫øng Vi·ªát",
                modes: ["Kh√≥a Sol", "Kh√≥a Fa", "Hai kh√≥a", "N·ªët", "Luy·ªán tai", "D√≤ n·ªët", "Metronome"],
                ui: {
                    level: "C·∫•p ƒë·ªô", next: "Ti·∫øp theo", result: "K·∫øt qu·∫£", listen: "Nghe", check: "Ki·ªÉm tra",
                    start: "B·∫Øt ƒë·∫ßu", stop: "D·ª´ng", bpm: "Nh·ªãp (BPM)", notes: "S·ªë n·ªët", time: "Th·ªùi gian",
                    seconds: "gi√¢y", detect: "ƒêang nghe...", library: "N·ªët", chords: "H·ª£p √¢m",
                    settings: "C√†i ƒë·∫∑t", theme: "Giao di·ªán", lang: "Ng√¥n ng·ªØ", answer: "ƒê√°p √°n",
                    tapToStart: "Ch·∫°m ƒë·ªÉ b·∫Øt ƒë·∫ßu",
                    sol: "Sol", fa: "Fa", do: "ƒê√¥", re: "R√™", mi: "Mi", fa_note: "Fa", sol_note: "Sol", la: "La", si: "Si",
                    soundOn: "B·∫≠t ti·∫øng", soundOff: "T·∫Øt ti·∫øng", soundType: "√Çm thanh"
                }
            },
            en: {
                flag: "üá¨üáß", name: "English",
                modes: ["Treble Clef", "Bass Clef", "Grand Staff", "Notes", "Ear Training", "Note Check", "Metronome"],
                ui: {
                    level: "Level", next: "Next", result: "Reveal", listen: "Listen", check: "Check",
                    start: "Start", stop: "Stop", bpm: "BPM", notes: "Notes", time: "Time",
                    seconds: "s", detect: "Listening...", library: "Notes", chords: "Chords",
                    settings: "Settings", theme: "Theme", lang: "Language", answer: "Answer",
                    tapToStart: "Tap to Start",
                    sol: "G", fa: "F", do: "C", re: "D", mi: "E", fa_note: "F", sol_note: "G", la: "A", si: "B",
                    soundOn: "Sound On", soundOff: "Mute", soundType: "Sound"
                }
            },
            fr: { flag: "üá´üá∑", name: "Fran√ßais", modes: ["Cl√© de Sol", "Cl√© de Fa", "Grande Port√©e", "Notes", "Oreille", "Note Check", "M√©tronome"], ui: { level: "Niveau", next: "Suivant", result: "R√©sultat", listen: "√âcouter", check: "V√©rifier", start: "D√©marrer", stop: "Arr√™ter", bpm: "BPM", notes: "Notes", time: "Temps", seconds: "s", detect: "√âcoute...", library: "Notes", chords: "Accords", settings: "Param√®tres", theme: "Th√®me", lang: "Langue", answer: "R√©ponse", tapToStart: "Appuyez pour commencer", sol: "Sol", fa: "Fa", do: "Do", re: "R√©", mi: "Mi", fa_note: "Fa", sol_note: "Sol", la: "La", si: "Si", soundOn: "Son activ√©", soundOff: "Muet", soundType: "Son" } },
            zh: { flag: "üá®üá≥", name: "Chinese", modes: ["È´òÈü≥Ë∞±Âè∑", "‰ΩéÈü≥Ë∞±Âè∑", "Â§ßË∞±Ë°®", "Èü≥Á¨¶", "ÁªÉËÄ≥", "Èü≥ÂáÜÊ£ÄÊü•", "ËäÇÊãçÂô®"], ui: { level: "Á≠âÁ∫ß", next: "‰∏ã‰∏Ä‰∏™", result: "ÁªìÊûú", listen: "Âê¨", check: "Ê£ÄÊü•", start: "ÂºÄÂßã", stop: "ÂÅúÊ≠¢", bpm: "BPM", notes: "Èü≥Á¨¶", time: "Êó∂Èó¥", seconds: "Áßí", detect: "Ê≠£Âú®Âê¨...", library: "Èü≥Á¨¶", chords: "ÂíåÂº¶", settings: "ËÆæÁΩÆ", theme: "‰∏ªÈ¢ò", lang: "ËØ≠Ë®Ä", answer: "Á≠îÊ°à", tapToStart: "ÁÇπÂáªÂºÄÂßã", sol: "Sol", fa: "Fa", do: "Do", re: "Re", mi: "Mi", fa_note: "Fa", sol_note: "Sol", la: "La", si: "Si", soundOn: "ÂºÄÈü≥", soundOff: "ÈùôÈü≥", soundType: "Â£∞Èü≥" } },
            th: { flag: "üáπüá≠", name: "Thai", modes: ["‡∏Å‡∏∏‡∏ç‡πÅ‡∏à‡∏ã‡∏≠‡∏•", "‡∏Å‡∏∏‡∏ç‡πÅ‡∏à‡∏ü‡∏≤", "‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î 5 ‡πÄ‡∏™‡πâ‡∏ô", "‡πÇ‡∏ô‡πâ‡∏ï", "‡∏ù‡∏∂‡∏Å‡∏ü‡∏±‡∏á", "‡πÄ‡∏ä‡πá‡∏Ñ‡πÇ‡∏ô‡πâ‡∏ï", "‡πÄ‡∏°‡πÇ‡∏ó‡∏£‡∏ô‡∏≠‡∏°"], ui: { level: "‡∏£‡∏∞‡∏î‡∏±‡∏ö", next: "‡∏ñ‡∏±‡∏î‡πÑ‡∏õ", result: "‡πÄ‡∏â‡∏•‡∏¢", listen: "‡∏ü‡∏±‡∏á", check: "‡∏ï‡∏£‡∏ß‡∏à", start: "‡πÄ‡∏£‡∏¥‡πà‡∏°", stop: "‡∏´‡∏¢‡∏∏‡∏î", bpm: "BPM", notes: "‡πÇ‡∏ô‡πâ‡∏ï", time: "‡πÄ‡∏ß‡∏•‡∏≤", seconds: "‡∏ß‡∏¥", detect: "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ü‡∏±‡∏á...", library: "‡πÇ‡∏ô‡πâ‡∏ï", chords: "‡∏Ñ‡∏≠‡∏£‡πå‡∏î", settings: "‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤", theme: "‡∏ò‡∏µ‡∏°", lang: "‡∏†‡∏≤‡∏©‡∏≤", answer: "‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö", tapToStart: "‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°", sol: "Sol", fa: "Fa", do: "Do", re: "Re", mi: "Mi", fa_note: "Fa", sol_note: "Sol", la: "La", si: "Si", soundOn: "‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á", soundOff: "‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á", soundType: "‡πÄ‡∏™‡∏µ‡∏¢‡∏á" } },
        };

        const THEMES = [
            { id: "classic", name: "Classic", icon: "fa-music" },
            { id: "dark", name: "Dark", icon: "fa-moon" },
            { id: "ocean", name: "Ocean", icon: "fa-water" },
            { id: "coder", name: "Coder (Matrix)", icon: "fa-terminal" },
            { id: "love", name: "Love", icon: "fa-heart" },
            { id: "christmas", name: "Christmas", icon: "fa-tree" },
            { id: "retro", name: "Retro", icon: "fa-coffee" }
        ];

        const METRO_SOUNDS = [
            { id: 'wood', name: 'Woodblock (M√µ)' },
            { id: 'tick', name: 'Tick (T√≠ch t·∫Øc)' },
            { id: 'click', name: 'Digital (ƒêi·ªán t·ª≠)' },
            { id: 'drop', name: 'Drop (Gi·ªçt n∆∞·ªõc)' },
            { id: 'drum', name: 'Drum (Tr·ªëng)' },
            { id: 'bell', name: 'Bell (Chu√¥ng)' }
        ];

        const DURATION_MAP = {
            'w': { tone: '1n', time: 4 },
            'h': { tone: '2n', time: 2 },
            'q': { tone: '4n', time: 1 },
            '8': { tone: '8n', time: 0.5 },
            '16': { tone: '16n', time: 0.25 }
        };

        let state = {
            lang: 'vi', theme: DEFAULT_THEME, mode: 0, level: 1,
            flashcardData: { treble: [], bass: [] }, 
            isRevealed: false, audioEnabled: false, isMuted: false,
            earTrainingNotes: 1, checkTime: 5, 
            metronomeBpm: 60, metronomeActive: false, metroSound: 'tick'
        };

        let synth;
        let metronomeLoop;
        let playbackTimeout;

        // --- HELPERS ---
        function stopSound() {
            if (playbackTimeout) { clearTimeout(playbackTimeout); playbackTimeout = null; }
            if (synth) {
                try { synth.releaseAll(); synth.dispose(); } catch(e) {}
                synth = new Tone.PolySynth(Tone.Synth).toDestination();
                if (state.isMuted) Tone.Destination.mute = true;
            }
        }

        function getNoteName(noteStr) { 
            const toneMap = { 'C': 'do', 'D': 're', 'E': 'mi', 'F': 'fa_note', 'G': 'sol_note', 'A': 'la', 'B': 'si' };
            const noteChar = noteStr.charAt(0);
            const accidental = noteStr.includes('#') ? '#' : (noteStr.includes('b') ? 'b' : '');
            const octave = noteStr.slice(-1);
            const localized = `${LANGUAGES[state.lang].ui[toneMap[noteChar]]}${accidental}`;
            return `${localized} ${octave} (${noteChar}${accidental}${octave})`;
        }
        function rnd(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }

        function playTone(note, durationVex) {
            initAudioIfNeeded();
            if (!state.audioEnabled || !synth) return;
            const dur = DURATION_MAP[durationVex] ? DURATION_MAP[durationVex].tone : '8n';
            synth.triggerAttackRelease(note, dur);
        }
        function playChord(notes) {
            initAudioIfNeeded();
            if (!state.audioEnabled || !synth) return;
            synth.triggerAttackRelease(notes, "2n");
        }

        function toggleMute() {
            initAudioIfNeeded();
            state.isMuted = !state.isMuted;
            Tone.Destination.mute = state.isMuted;
            renderControls(); 
        }

        let audioInitialized = false;
        async function initAudioIfNeeded() {
            if (audioInitialized) return;
            await Tone.start();
            state.audioEnabled = true;
            synth = new Tone.PolySynth(Tone.Synth).toDestination();
            audioInitialized = true;
        }
        document.body.addEventListener('click', initAudioIfNeeded, { once: true });
        document.body.addEventListener('touchstart', initAudioIfNeeded, { once: true });

        // --- RENDER UI ---
        function renderControls() {
            const container = document.getElementById('controls-bar');
            const soundBtn = `<button onclick="toggleMute()" class="theme-card h-10 w-10 flex items-center justify-center rounded-full shadow-sm transition hover:scale-105 ${state.isMuted ? 'bg-gray-300 text-gray-600' : 'bg-[var(--primary-color)] text-white'}" title="${state.isMuted ? 'Unmute' : 'Mute'}"><i class="fas ${state.isMuted ? 'fa-volume-mute' : 'fa-volume-up'}"></i></button>`;
            const themeSelect = `<div class="relative group h-10"><select onchange="state.theme=this.value;initUI()" class="h-full appearance-none theme-card border-none pl-3 pr-8 rounded-full focus:outline-none cursor-pointer font-bold text-sm min-w-[80px]">${THEMES.map(th => `<option value="${th.id}" ${state.theme===th.id?'selected':''}>${th.name.split(' ')[0]}</option>`).join('')}</select><div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-[var(--primary-color)]"><i class="fas fa-palette text-xs"></i></div></div>`;
            const langSelect = `<div class="relative group h-10"><select onchange="state.lang=this.value;initUI()" class="h-full appearance-none theme-card border-none pl-3 pr-8 rounded-full focus:outline-none cursor-pointer font-bold text-sm min-w-[80px]">${Object.keys(LANGUAGES).map(l => `<option value="${l}" ${state.lang===l?'selected':''}>${LANGUAGES[l].flag} ${l.toUpperCase()}</option>`).join('')}</select><div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-[var(--primary-color)]"><i class="fas fa-globe text-xs"></i></div></div>`;
            container.innerHTML = soundBtn + themeSelect + langSelect;
        }

        function renderTabs() {
            const t = LANGUAGES[state.lang];
            const tabs = document.getElementById('mode-tabs');
            tabs.innerHTML = t.modes.map((m, i) => `<button onclick="switchMode(${i})" class="whitespace-nowrap px-5 py-2 rounded-full text-sm font-bold shadow-sm transition hover:scale-105 border ${state.mode === i ? 'active-tab bg-[var(--primary-color)] text-white border-[var(--primary-color)]' : 'theme-card hover:text-[var(--primary-color)]'}">${m}</button>`).join('');
        }

        function initUI() {
            document.body.setAttribute('data-theme', state.theme);
            const xmasIcon = document.getElementById('xmas-icon');
            if(state.theme === 'christmas') { xmasIcon.classList.remove('hidden'); } else { xmasIcon.classList.add('hidden'); }
            renderControls(); renderTabs(); switchMode(state.mode); 
        }

        // --- FLASHCARD LOGIC ---
        const FLASHCARD_LOGIC = {
            generateCard: () => {
                stopSound();
                const levelCounts = {1: 1, 2: 3, 3: 5, 4: 8};
                const count = levelCounts[state.level];
                state.flashcardData = { treble: [], bass: [] };
                const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
                let durationPool = ['w', 'h', 'q'];
                if (state.level > 1) durationPool = ['q', '8', '8', '16', '16', '16', '16'];

                const generateNote = (clef) => {
                    const minMidi = clef === 'treble' ? 60 : 40; 
                    const maxMidi = clef === 'treble' ? 84 : 60;
                    const midi = rnd(minMidi, maxMidi);
                    const noteName = noteNames[midi % 12];
                    const octave = Math.floor(midi / 12) - 1;
                    return { key: `${noteName.toLowerCase()}/${octave}`, toneKey: `${noteName}${octave}`, midi, clef };
                };

                if (state.mode === 2) {
                    for (let i = 0; i < count; i++) {
                        let dur = durationPool[rnd(0, durationPool.length - 1)];
                        if (i === count - 1 && state.level > 1) dur = 'h'; 
                        const tNote = generateNote('treble'); const bNote = generateNote('bass');
                        tNote.duration = dur; bNote.duration = dur;
                        state.flashcardData.treble.push(tNote); state.flashcardData.bass.push(bNote);
                    }
                } else {
                    const clef = state.mode === 0 ? 'treble' : 'bass';
                    for (let i = 0; i < count; i++) {
                        let dur = durationPool[rnd(0, durationPool.length - 1)];
                        if (i === count - 1 && state.level > 1) dur = 'h';
                        const n = generateNote(clef); n.duration = dur;
                        state.flashcardData[clef].push(n);
                    }
                }
                state.isRevealed = false; FLASHCARD_LOGIC.render();
            },
            render: () => {
                const t = LANGUAGES[state.lang].ui;
                let answers = [];
                if (state.mode === 2) {
                    state.flashcardData.treble.forEach((n, i) => {
                        const b = state.flashcardData.bass[i];
                        answers.push(`[${getNoteName(n.toneKey)} + ${getNoteName(b.toneKey)}]`);
                    });
                } else {
                    const data = state.mode === 0 ? state.flashcardData.treble : state.flashcardData.bass;
                    answers = data.map(n => getNoteName(n.toneKey));
                }

                let html = `
                    <div class="theme-card p-8 rounded-2xl shadow-xl w-full text-center border-t-4 theme-border">
                        <div class="flex justify-between items-center mb-6">
                            <select id="level-select" onchange="state.level=parseInt(this.value); FLASHCARD_LOGIC.generateCard()" class="p-2 rounded-lg bg-[var(--bg-color)] border border-[var(--primary-color)] text-sm font-bold focus:outline-none">
                                <option value="1" ${state.level===1?'selected':''}>Lvl 1 (1 Note)</option>
                                <option value="2" ${state.level===2?'selected':''}>Lvl 2 (3 Notes)</option>
                                <option value="3" ${state.level===3?'selected':''}>Lvl 3 (5 Notes)</option>
                                <option value="4" ${state.level===4?'selected':''}>Lvl 4 (8 Notes)</option>
                            </select>
                            <span class="text-xs font-bold uppercase tracking-wider opacity-60">Tap note to play</span>
                        </div>
                        <div id="flashcard-canvas" class="flex justify-center items-center bg-white rounded-xl p-4 mb-8 overflow-x-auto min-h-[220px] shadow-inner border border-gray-100"></div>
                        <div class="min-h-[4rem] flex flex-col items-center justify-center mb-6">
                            ${state.isRevealed 
                                ? `<div class="flex flex-wrap gap-3 justify-center w-full px-4">${answers.map(a => `<span class="bg-[var(--primary-color)] text-white px-4 py-2 rounded-lg font-bold shadow-md text-lg transform transition hover:-translate-y-1">${a}</span>`).join('')}</div>`
                                : `<button onclick="FLASHCARD_LOGIC.reveal()" class="theme-btn-accent px-8 py-3 rounded-full font-bold shadow-lg text-lg transform transition hover:scale-105 active:scale-95">${t.result}</button>`
                            }
                        </div>
                        ${state.isRevealed ? `<button onclick="FLASHCARD_LOGIC.generateCard()" class="theme-btn-primary px-10 py-3 rounded-full text-xl font-bold shadow-xl transform transition hover:scale-105 active:scale-95 animate-bounce">${t.next} <i class="fas fa-arrow-right ml-2"></i></button>` : ''}
                    </div>
                `;
                document.getElementById('app-container').innerHTML = html;
                const div = document.getElementById('flashcard-canvas');
                if (!div) return;
                div.innerHTML = '';
                const { Renderer, Stave, StaveNote, Formatter, StaveConnector, Accidental, Beam } = Vex.Flow;
                const count = Math.max(state.flashcardData.treble.length, state.flashcardData.bass.length);
                const width = Math.max(320, count * 70 + 100);
                const renderer = new Renderer(div, Renderer.Backends.SVG);
                renderer.resize(width, state.mode === 2 ? 280 : 160);
                const ctx = renderer.getContext();
                
                const makeNotes = (d, c) => d.map(n => {
                    const note = new StaveNote({ clef: c, keys: [n.key], duration: n.duration, auto_stem: true });
                    if(n.key.includes('#')) note.addModifier(new Accidental('#'));
                    if(n.key.includes('b') && n.key[0] !== 'b') note.addModifier(new Accidental('b'));
                    return note;
                });

                if (state.mode === 2) {
                    const st = new Stave(10, 20, width - 20).addClef('treble').setContext(ctx).draw();
                    const sb = new Stave(10, 130, width - 20).addClef('bass').setContext(ctx).draw();
                    new StaveConnector(st, sb).setType(StaveConnector.type.BRACE).setContext(ctx).draw();
                    new StaveConnector(st, sb).setType(StaveConnector.type.SINGLE_LEFT).setContext(ctx).draw();
                    new StaveConnector(st, sb).setType(StaveConnector.type.SINGLE_RIGHT).setContext(ctx).draw();
                    const tn = makeNotes(state.flashcardData.treble, 'treble');
                    const bn = makeNotes(state.flashcardData.bass, 'bass');
                    const beamsT = Beam.generateBeams(tn); const beamsB = Beam.generateBeams(bn);
                    const fmt = new Formatter();
                    fmt.joinVoices([new Vex.Flow.Voice({num_beats:4,beat_value:4}).setMode(Vex.Flow.Voice.Mode.SOFT).addTickables(tn)]).format([new Vex.Flow.Voice({num_beats:4,beat_value:4}).setMode(Vex.Flow.Voice.Mode.SOFT).addTickables(tn)], width - 50);
                    tn.forEach(n => n.setStave(st).setContext(ctx).draw()); beamsT.forEach(b => b.setContext(ctx).draw());
                    fmt.format([new Vex.Flow.Voice({num_beats:4,beat_value:4}).setMode(Vex.Flow.Voice.Mode.SOFT).addTickables(bn)], width - 50);
                    bn.forEach(n => n.setStave(sb).setContext(ctx).draw()); beamsB.forEach(b => b.setContext(ctx).draw());
                    const svgs = div.querySelectorAll('.vf-stavenote');
                    state.flashcardData.treble.forEach((n,i)=>addClick(svgs[i], n.toneKey, n.duration));
                    state.flashcardData.bass.forEach((n,i)=>addClick(svgs[state.flashcardData.treble.length+i], n.toneKey, n.duration));
                } else {
                    const clef = state.mode === 0 ? 'treble' : 'bass';
                    const st = new Stave(10, 20, width - 20).addClef(clef).setContext(ctx).draw();
                    const n = makeNotes(state.mode === 0 ? state.flashcardData.treble : state.flashcardData.bass, clef);
                    const beams = Beam.generateBeams(n);
                    Formatter.FormatAndDraw(ctx, st, n);
                    beams.forEach(b => b.setContext(ctx).draw());
                    const svgs = div.querySelectorAll('.vf-stavenote');
                    n.forEach((note, i) => addClick(svgs[i], state.flashcardData[state.mode === 0 ? 'treble' : 'bass'][i].toneKey, state.flashcardData[state.mode === 0 ? 'treble' : 'bass'][i].duration));
                }
            },
            reveal: () => {
                stopSound();
                state.isRevealed = true;
                FLASHCARD_LOGIC.render();
                
                initAudioIfNeeded().then(() => {
                    const now = Tone.now();
                    let currentTime = now;
                    const bpm = 100; 
                    const beatTime = 60 / bpm; 
                    const getDurTime = (d) => DURATION_MAP[d].time * beatTime;

                    if (state.mode === 2) {
                        state.flashcardData.treble.forEach((t, i) => {
                            const b = state.flashcardData.bass[i];
                            const durationTime = getDurTime(t.duration);
                            const durTone = DURATION_MAP[t.duration].tone;
                            synth.triggerAttackRelease([t.toneKey, b.toneKey], durTone, currentTime);
                            currentTime += durationTime;
                        });
                    } else {
                        const data = state.mode === 0 ? state.flashcardData.treble : state.flashcardData.bass;
                        data.forEach((n, i) => {
                            const durationTime = getDurTime(n.duration);
                            const durTone = DURATION_MAP[n.duration].tone;
                            synth.triggerAttackRelease(n.toneKey, durTone, currentTime);
                            currentTime += durationTime;
                        });
                    }
                });
            }
        };

        function addClick(el, tone, durationVex) {
            if(!el) return;
            el.style.cursor = 'pointer';
            el.onclick = (e) => { e.stopPropagation(); playTone(tone, durationVex || '8'); const p=el.querySelectorAll('path,rect'); p.forEach(x=>x.style.fill='var(--accent-color)'); setTimeout(()=>p.forEach(x=>x.style.fill=''),300); };
        }

        // --- LIBRARY LOGIC ---
        const LIBRARY_LOGIC = {
            render: () => {
                const t = LANGUAGES[state.lang].ui;
                document.getElementById('app-container').innerHTML = `
                    <div class="grid md:grid-cols-2 gap-6 w-full h-[80vh]">
                        <div class="theme-card p-0 rounded-2xl shadow-xl overflow-hidden flex flex-col relative">
                            <h2 class="text-2xl font-bold sticky-header p-4 z-10 flex items-center gap-2"><i class="fas fa-book-open text-[var(--primary-color)]"></i> ${t.library}</h2>
                            <div class="overflow-y-auto library-scroll p-6" id="notes-lib-content"></div>
                        </div>
                        <div class="theme-card p-0 rounded-2xl shadow-xl overflow-hidden flex flex-col relative">
                            <h2 class="text-2xl font-bold sticky-header p-4 z-10 flex items-center gap-2"><i class="fas fa-guitar text-[var(--primary-color)]"></i> ${t.chords}</h2>
                            <div class="overflow-y-auto library-scroll p-6" id="chords-lib-content"></div>
                        </div>
                    </div>`;
                setTimeout(LIBRARY_LOGIC.fillContent, 100);
            },
            fillContent: () => {
                const nDiv = document.getElementById('notes-lib-content');
                if(!nDiv) return;
                for (let o = 0; o <= 8; o++) {
                    const id = `lib-oct-${o}`;
                    let lst = ['C','D','E','F','G','A','B']; if(o===0) lst=['A','B']; if(o===8) lst=['C'];
                    const clef = o < 4 ? 'bass' : 'treble';
                    const w = document.createElement('div');
                    w.innerHTML = `<h3 class="font-bold text-md text-[var(--primary-color)] mb-2 uppercase tracking-wide">Octave ${o} (${clef})</h3><div id="${id}" class="bg-white rounded-xl p-2 overflow-x-auto cursor-pointer border border-gray-200 shadow-sm hover:shadow-md transition"></div>`;
                    nDiv.appendChild(w);
                    const notes = lst.map(n => ({ key: `${n.toLowerCase()}/${o}`, toneKey: `${n}${o}`, duration: 'q', midi: 0 }));
                    renderNotation(id, notes, clef, 600, 0.85);
                }
                const cDiv = document.getElementById('chords-lib-content');
                if(!cDiv) return;
                ['C','D','E','F','G','A','B'].forEach(r => {
                    [{t:'M',s:'Major'},{t:'m',s:'Minor'}].forEach(v => {
                        const id = `chord-${r}-${v.t}`;
                        const w = document.createElement('div');
                        w.className = "flex flex-col sm:flex-row items-center gap-4 bg-[var(--bg-color)] p-3 rounded-xl hover:brightness-95 transition cursor-pointer border border-transparent hover:border-[var(--primary-color)]";
                        const d = getChordKeys(r, v.t);
                        w.onclick = () => playChord(d.tones);
                        w.innerHTML = `<div class="font-bold w-full sm:w-24 text-center sm:text-left text-lg text-[var(--text-color)]">${r} ${v.s}</div><div id="${id}" class="bg-white rounded-lg flex-grow w-full sm:w-auto shadow-sm"></div>`;
                        cDiv.appendChild(w);
                        renderChord(id, d.keys);
                    });
                });
            }
        };

        function getChordKeys(r, t) {
            const m = { 'C':{M:['c/4','e/4','g/4'],m:['c/4','eb/4','g/4']}, 'D':{M:['d/4','f#/4','a/4'],m:['d/4','f/4','a/4']}, 'E':{M:['e/4','g#/4','b/4'],m:['e/4','g/4','b/4']}, 'F':{M:['f/4','a/4','c/5'],m:['f/4','ab/4','c/5']}, 'G':{M:['g/4','b/4','d/5'],m:['g/4','bb/4','d/5']}, 'A':{M:['a/4','c#/5','e/5'],m:['a/4','c/5','e/5']}, 'B':{M:['b/4','d#/5','f#/5'],m:['b/4','d/5','f#/5']} };
            const tm = { 'C':{M:['C4','E4','G4'],m:['C4','Eb4','G4']}, 'D':{M:['D4','F#4','A4'],m:['D4','F4','A4']}, 'E':{M:['E4','G#4','B4'],m:['E4','G4','B4']}, 'F':{M:['F4','A4','C5'],m:['F4','Ab4','C5']}, 'G':{M:['G4','B4','D5'],m:['G4','Bb4','D5']}, 'A':{M:['A4','C#5','E5'],m:['A4','C5','E5']}, 'B':{M:['B4','D#5','F#5'],m:['B4','D5','F#5']} };
            return { keys: m[r][t], tones: tm[r][t] };
        }

        function renderNotation(eid, data, clef, w, s) {
            const div = document.getElementById(eid); if(!div) return; div.innerHTML='';
            const r = new Vex.Flow.Renderer(div, Vex.Flow.Renderer.Backends.SVG);
            r.resize(w, 250 * s); const ctx = r.getContext(); ctx.scale(s, s);
            const st = new Vex.Flow.Stave(10, 50, w - 20).addClef(clef).setContext(ctx).draw();
            const n = data.map(d => {
                const note = new Vex.Flow.StaveNote({clef, keys:[d.key], duration:d.duration, auto_stem:true});
                if(d.key.includes('#')) note.addModifier(new Vex.Flow.Accidental('#'));
                if(d.key.includes('b') && d.key[0]!=='b') note.addModifier(new Vex.Flow.Accidental('b'));
                return note;
            });
            Vex.Flow.Formatter.FormatAndDraw(ctx, st, n);
            const svgs = div.querySelectorAll('.vf-stavenote');
            data.forEach((d,i) => addClick(svgs[i], d.toneKey));
        }

        function renderChord(eid, keys) {
            const div = document.getElementById(eid); if(!div) return;
            const r = new Vex.Flow.Renderer(div, Vex.Flow.Renderer.Backends.SVG);
            r.resize(250, 150); const ctx = r.getContext(); ctx.scale(0.55, 0.55);
            const st = new Vex.Flow.Stave(0, 30, 240).addClef('treble').setContext(ctx).draw();
            const n = new Vex.Flow.StaveNote({clef:'treble',keys,duration:'w'});
            keys.forEach((k,i)=>{
                if(k.includes('#')) n.addModifier(new Vex.Flow.Accidental('#'),i);
                if(k.includes('b') && k[0]!=='b') n.addModifier(new Vex.Flow.Accidental('b'),i);
            });
            st.setNoteStartX(st.getNoteStartX()+20);
            Vex.Flow.Formatter.FormatAndDraw(ctx, st, [n]);
        }

        // --- EAR LOGIC ---
        const EAR_LOGIC = {
            targetNotes: [],
            render: () => {
                const t = LANGUAGES[state.lang].ui;
                document.getElementById('app-container').innerHTML = `
                    <div class="theme-card p-8 rounded-2xl shadow-xl w-full text-center max-w-md border-t-4 theme-border">
                        <h2 class="text-2xl font-bold mb-6">${t.ui && t.ui.modes ? t.modes[4] : 'Ear Training'}</h2>
                        <div class="mb-6 flex items-center justify-center gap-4">
                            <label class="font-bold opacity-70">${t.notes}:</label>
                            <div class="flex items-center gap-2">
                                <button onclick="EAR_LOGIC.changeCount(-1)" class="w-10 h-10 rounded-full bg-white border border-[var(--primary-color)] text-[var(--primary-color)] font-bold hover:bg-[var(--primary-color)] hover:text-white transition shadow-sm flex items-center justify-center"><i class="fas fa-minus"></i></button>
                                <span class="text-2xl font-bold w-8">${state.earTrainingNotes}</span>
                                <button onclick="EAR_LOGIC.changeCount(1)" class="w-10 h-10 rounded-full bg-white border border-[var(--primary-color)] text-[var(--primary-color)] font-bold hover:bg-[var(--primary-color)] hover:text-white transition shadow-sm flex items-center justify-center"><i class="fas fa-plus"></i></button>
                            </div>
                        </div>
                        <div id="ear-canvas-container" class="bg-white rounded-xl p-4 min-h-[160px] flex items-center justify-center mb-6 shadow-inner border border-gray-200">
                            ${!state.isRevealed ? `<i class="fas fa-headphones-alt text-6xl text-[var(--placeholder-color)] animate-pulse"></i>` : `<div id="ear-vexflow"></div>`}
                        </div>
                        <div class="flex flex-wrap gap-2 justify-center mb-6 min-h-[3rem] items-center">
                            ${state.isRevealed ? state.targetNotes.map(n => `<span class="bg-[var(--primary-color)] text-white px-3 py-1 rounded-lg font-bold shadow-sm text-xl animate-fade-in">${getNoteName(n)}</span>`).join('') : `<span class="text-3xl font-bold text-gray-400 opacity-50">? ? ?</span>`}
                        </div>
                        <div class="flex gap-4 justify-center">
                            <button onclick="EAR_LOGIC.play()" class="theme-btn-accent px-8 py-3 rounded-full font-bold shadow-lg transform transition hover:scale-105 active:scale-95"><i class="fas fa-volume-up mr-2"></i> ${t.listen}</button>
                            ${!state.isRevealed ? `<button onclick="EAR_LOGIC.reveal()" class="theme-btn-primary px-8 py-3 rounded-full font-bold shadow-lg transform transition hover:scale-105 active:scale-95">${t.result}</button>` : `<button onclick="EAR_LOGIC.newQuestion()" class="theme-btn-primary px-8 py-3 rounded-full font-bold shadow-lg transform transition hover:scale-105 active:scale-95">${t.next}</button>`}
                        </div>
                    </div>`;
                if(state.isRevealed) {
                    const containerWidth = document.getElementById('ear-canvas-container').offsetWidth;
                    const width = Math.min(350, containerWidth - 20); 
                    const no = state.targetNotes.map(s => ({ key: `${s.charAt(0).toLowerCase()}${s.includes('#')?'#':s.includes('b')?'b':''}/${s.slice(-1)}`, toneKey: s, duration:'q', midi:0 }));
                    renderNotation('ear-vexflow', no, 'treble', width, 0.85);
                }
                if(state.targetNotes.length===0) EAR_LOGIC.newQuestion();
            },
            changeCount: (delta) => {
                let v = state.earTrainingNotes + delta;
                if (v < 1) v = 1; if (v > 10) v = 10;
                state.earTrainingNotes = v;
                EAR_LOGIC.newQuestion();
            },
            newQuestion: () => {
                stopSound(); state.targetNotes = [];
                const pool = ['C4','D4','E4','F4','G4','A4','B4','C5'];
                for(let i=0; i<state.earTrainingNotes; i++) state.targetNotes.push(pool[rnd(0, pool.length-1)]);
                state.isRevealed = false; EAR_LOGIC.render(); 
            },
            play: () => { initAudioIfNeeded(); const now = Tone.now(); state.targetNotes.forEach((n,i) => synth.triggerAttackRelease(n, "8n", now + i * 0.6)); },
            reveal: () => { state.isRevealed = true; EAR_LOGIC.render(); }
        };

        const CHECK_LOGIC = {
            isListening: false, detectedNotes: [], timer: null, timeLeft: 0,
            render: () => {
                const t = LANGUAGES[state.lang].ui;
                document.getElementById('app-container').innerHTML = `<div class="theme-card p-8 rounded-2xl shadow-xl w-full text-center max-w-lg border-t-4 theme-border"><h2 class="text-2xl font-bold mb-6">${t.ui && t.ui.modes ? t.modes[5] : 'Note Checking'}</h2><div class="mb-6"><label class="block mb-2 font-bold opacity-80">${t.time}:</label><div class="flex gap-2 justify-center">${[1,3,5,7,10].map(s=>`<button onclick="state.checkTime=${s};CHECK_LOGIC.render()" class="px-4 py-2 rounded-full border border-[var(--primary-color)] transition ${state.checkTime===s?'bg-[var(--primary-color)] text-white shadow-md':'text-[var(--card-text)] hover:bg-gray-200'}">${s}s</button>`).join('')}</div></div><div class="min-h-[120px] flex items-center justify-center bg-[var(--bg-color)] text-[var(--text-color)] rounded-xl mb-8 text-3xl font-mono p-4 border border-dashed border-[var(--primary-color)]">${CHECK_LOGIC.isListening ? `<span class="animate-pulse text-red-500 font-bold"><i class="fas fa-microphone mr-2"></i> ${CHECK_LOGIC.timeLeft}s</span>` : (CHECK_LOGIC.detectedNotes.length?`<span class="text-[var(--primary-color)] font-bold">${CHECK_LOGIC.detectedNotes.map(n => getNoteName(n)).join(", ")}</span>`:"Ready")}</div><button onclick="CHECK_LOGIC.startListening()" ${CHECK_LOGIC.isListening?'disabled':''} class="theme-btn-primary px-10 py-4 rounded-full text-xl font-bold shadow-xl disabled:opacity-50 transform transition hover:scale-105 active:scale-95">${CHECK_LOGIC.isListening?t.detect:`<i class="fas fa-microphone mr-2"></i> ${t.start}`}</button></div>`;
            },
            startListening: async () => {
                if(!state.audioEnabled) { alert("Please click Start first."); return; }
                CHECK_LOGIC.isListening=true; CHECK_LOGIC.timeLeft=state.checkTime; CHECK_LOGIC.detectedNotes=[]; CHECK_LOGIC.render();
                try {
                    const st = await navigator.mediaDevices.getUserMedia({audio:true});
                    const ac = new (window.AudioContext||window.webkitAudioContext)();
                    const an = ac.createAnalyser(); an.fftSize=2048; ac.createMediaStreamSource(st).connect(an);
                    const detect = () => {
                        if(!CHECK_LOGIC.isListening) return;
                        const b = new Float32Array(an.fftSize); an.getFloatTimeDomainData(b);
                        const n = autoCorrelate(b, ac.sampleRate);
                        if(n && n!=='-' && CHECK_LOGIC.detectedNotes[CHECK_LOGIC.detectedNotes.length-1]!==n) CHECK_LOGIC.detectedNotes.push(n);
                        requestAnimationFrame(detect);
                    }; detect();
                    CHECK_LOGIC.timer = setInterval(() => {
                        CHECK_LOGIC.timeLeft--; CHECK_LOGIC.render();
                        if(CHECK_LOGIC.timeLeft<=0) { CHECK_LOGIC.isListening=false; clearInterval(CHECK_LOGIC.timer); st.getTracks().forEach(t=>t.stop()); ac.close(); CHECK_LOGIC.detectedNotes=[...new Set(CHECK_LOGIC.detectedNotes)]; CHECK_LOGIC.render(); }
                    }, 1000);
                } catch(e) { alert("Microphone Error"); CHECK_LOGIC.isListening=false; CHECK_LOGIC.render(); }
            }
        };

        function autoCorrelate(b, r) {
            let s=b.length, rms=0; for(let i=0;i<s;i++) rms+=b[i]*b[i]; if(Math.sqrt(rms/s)<0.01) return '-';
            let r1=0,r2=s-1; for(let i=0;i<s/2;i++) if(Math.abs(b[i])<0.2){r1=i;break;} for(let i=1;i<s/2;i++) if(Math.abs(b[s-i])<0.2){r2=s-i;break;}
            b=b.slice(r1,r2); s=b.length; let c=new Array(s).fill(0); for(let i=0;i<s;i++) for(let j=0;j<s-i;j++) c[i]+=b[j]*b[j+i];
            let d=0; while(c[d]>c[d+1]) d++; let max=-1,t0=-1; for(let i=d;i<s;i++) if(c[i]>max){max=c[i];t0=i;}
            if(t0===-1) return '-';
            let f = r/t0; const nn=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
            const n = Math.round(12*(Math.log(f/440)/Math.log(2))+69); return (n<21||n>108)?null:nn[n%12];
        }

        const METRO_LOGIC = {
            countdown: 0,
            countdownInterval: null,
            render: () => {
                const t = LANGUAGES[state.lang].ui;
                const metroSounds = [
                    {id: 'wood', name: 'Woodblock (M√µ)'},
                    {id: 'tick', name: 'Tick (T√≠ch t·∫Øc)'},
                    {id: 'drop', name: 'Drop (Gi·ªçt n∆∞·ªõc)'},
                    {id: 'click', name: 'Digital (ƒêi·ªán t·ª≠)'},
                    {id: 'drum', name: 'Drum (Tr·ªëng)'},
                    {id: 'bell', name: 'Bell (Chu√¥ng)'}
                ];
                
                document.getElementById('app-container').innerHTML = `
                    <div class="theme-card p-10 rounded-2xl shadow-xl w-full text-center max-w-md border-t-4 theme-border">
                        <h2 class="text-3xl font-bold mb-8">${t.ui && t.ui.modes ? t.modes[6] : 'Metronome'}</h2>
                        
                        <div class="mb-4 w-full">
                            <label class="text-sm font-bold opacity-70 block mb-1 text-left px-2">${t.soundType || 'Sound'}:</label>
                            <select onchange="state.metroSound=this.value" class="w-full p-2 rounded-lg bg-[var(--bg-color)] border border-[var(--primary-color)] font-bold focus:outline-none">
                                ${metroSounds.map(s => `<option value="${s.id}" ${state.metroSound === s.id ? 'selected' : ''}>${s.name}</option>`).join('')}
                            </select>
                        </div>

                        <div class="mb-10 flex flex-col items-center">
                            <div class="flex items-center gap-2 mb-4">
                                <input type="number" min="40" max="200" value="${state.metronomeBpm}" 
                                    onchange="let v=parseInt(this.value); if(isNaN(v))v=60; if(v<40)v=40; if(v>200)v=200; state.metronomeBpm=v; METRO_LOGIC.render()"
                                    class="text-6xl font-bold font-mono text-[var(--primary-color)] text-center bg-transparent border-b-2 border-transparent hover:border-[var(--primary-color)] focus:border-[var(--primary-color)] focus:outline-none w-48">
                            </div>
                            <div class="text-sm font-bold opacity-60 tracking-widest uppercase mb-4">BPM</div>
                            <input type="range" min="40" max="200" value="${state.metronomeBpm}" 
                                oninput="state.metronomeBpm=this.value; document.querySelector('input[type=number]').value=this.value" 
                                onchange="METRO_LOGIC.render()"
                                class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-[var(--primary-color)]">
                        </div>
                        <div class="flex justify-center gap-6 mb-10">
                            ${[1,2,3,4].map(i=>`<div id="metro-dot-${i}" class="metronome-dot shadow-sm"></div>`).join('')}
                        </div>
                        ${METRO_LOGIC.countdown>0?`<div class="text-6xl font-bold text-red-500 mb-6 animate-ping">${METRO_LOGIC.countdown}</div>`:''}
                        <button onclick="METRO_LOGIC.toggle()" class="${state.metronomeActive?'bg-red-500 hover:bg-red-600':'theme-btn-primary'} text-white px-10 py-4 rounded-full text-xl font-bold shadow-lg w-full transition transform hover:scale-105 active:scale-95">
                            ${state.metronomeActive?`<i class="fas fa-stop mr-2"></i> ${t.stop}`:`<i class="fas fa-play mr-2"></i> ${t.start}`}
                        </button>
                    </div>`;
            },
            toggle: () => {
                if(state.metronomeActive) { 
                    // Stop Logic
                    Tone.Transport.stop(); 
                    if(metronomeLoop) metronomeLoop.stop(); 
                    if(METRO_LOGIC.countdownInterval) { clearInterval(METRO_LOGIC.countdownInterval); METRO_LOGIC.countdownInterval = null; }
                    state.metronomeActive=false; 
                    METRO_LOGIC.countdown=0;
                    METRO_LOGIC.render(); 
                }
                else { 
                    // Start Logic
                    initAudioIfNeeded(); // Ensure audio context is ready
                    if(!state.audioEnabled) return; // Should be ready by now due to global listener
                    
                    let c=5; 
                    METRO_LOGIC.countdown=c; 
                    state.metronomeActive=true; 
                    METRO_LOGIC.render(); 
                    
                    METRO_LOGIC.countdownInterval = setInterval(()=>{
                        c--; 
                        METRO_LOGIC.countdown=c; 
                        METRO_LOGIC.render(); 
                        if(c===0){
                            clearInterval(METRO_LOGIC.countdownInterval); 
                            METRO_LOGIC.countdownInterval = null;
                            METRO_LOGIC.startTone();
                        }
                    },1000); 
                }
            },
            startTone: () => {
                Tone.Transport.bpm.value = state.metronomeBpm; 
                let b=0; 
                
                // Synth Factory
                let s;
                if (state.metroSound === 'wood') s = new Tone.MembraneSynth().toDestination();
                else if (state.metroSound === 'tick') s = new Tone.MembraneSynth({envelope:{attack:0.001, decay:0.05, sustain:0}, pitchDecay: 0}).toDestination(); // Short tick
                else if (state.metroSound === 'drop') s = new Tone.MembraneSynth({envelope:{attack:0.001, decay:0.3, sustain:0}, pitchDecay: 0.1, octaves: 2}).toDestination(); // Water drop ish
                else if (state.metroSound === 'click') s = new Tone.MembraneSynth({envelope:{attack:0.001, decay:0.1, sustain:0}}).toDestination();
                else if (state.metroSound === 'drum') s = new Tone.MembraneSynth({pitchDecay:0.05, octaves:4}).toDestination();
                else if (state.metroSound === 'metal') s = new Tone.MetalSynth({frequency:200, envelope:{attack:0.001, decay:0.1, release:0.01}, harmonicity:5.1, modulationIndex:32, resonance:4000, octaves:1.5}).toDestination();
                else s = new Tone.Synth({oscillator:{type:"square"}, envelope:{attack:0.01, decay:0.1, sustain:0}}).toDestination(); // Beep fallback

                metronomeLoop = new Tone.Loop(t=>{ 
                    // Different pitch/tone for first beat
                    let noteHigh, noteLow;
                    if (state.metroSound === 'wood') { noteHigh="C2"; noteLow="C1"; }
                    else if (state.metroSound === 'tick') { noteHigh="G6"; noteLow="C6"; }
                    else if (state.metroSound === 'drop') { noteHigh="A5"; noteLow="D5"; }
                    else if (state.metroSound === 'click') { noteHigh="C6"; noteLow="G5"; }
                    else if (state.metroSound === 'drum') { noteHigh="G2"; noteLow="C2"; }
                    else if (state.metroSound === 'metal') { noteHigh="C5"; noteLow="G4"; } 
                    else { noteHigh="C5"; noteLow="C4"; } 

                    s.triggerAttackRelease(b===0?noteHigh:noteLow, "32n", t);
                    
                    Tone.Draw.schedule(()=>{
                        document.querySelectorAll('.metronome-dot').forEach(d=>d.classList.remove('active'));
                        document.getElementById(`metro-dot-${b+1}`)?.classList.add('active');
                    },t); 
                    b=(b+1)%4; 
                },"4n").start(0); 
                Tone.Transport.start();
            }
        };

        function switchMode(i) { stopSound(); state.mode=i; renderTabs(); if(state.metronomeActive) METRO_LOGIC.toggle(); if(CHECK_LOGIC.isListening) {CHECK_LOGIC.isListening=false; if(CHECK_LOGIC.timer) clearInterval(CHECK_LOGIC.timer);} if(i<=2) FLASHCARD_LOGIC.generateCard(); else if(i===3) LIBRARY_LOGIC.render(); else if(i===4) EAR_LOGIC.newQuestion(); else if(i===5) CHECK_LOGIC.render(); else if(i===6) METRO_LOGIC.render(); }

        initUI();
    </script>
</body>
</html>
