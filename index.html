<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Liem's Harmony Hub</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- VexFlow (Music Notation) -->
    <script src="https://cdn.jsdelivr.net/npm/vexflow@4.2.3/build/cjs/vexflow.js"></script>
    <!-- Tone.js (Audio Synthesis) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Nunito', sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }
        
        :root {
            --bg-color: #f3f4f6;
            --text-color: #1f2937;
            --card-bg: #ffffff;
            --primary-color: #3b82f6;
            --accent-color: #10b981;
        }

        [data-theme="dark"] { --bg-color: #111827; --text-color: #f3f4f6; --card-bg: #1f2937; --primary-color: #60a5fa; --accent-color: #34d399; }
        [data-theme="ocean"] { --bg-color: #e0f2fe; --text-color: #0c4a6e; --card-bg: #ffffff; --primary-color: #0284c7; --accent-color: #0ea5e9; }
        [data-theme="coder"] { --bg-color: #000000; --text-color: #00ff00; --card-bg: #111111; --primary-color: #00ff00; --accent-color: #008f00; font-family: 'Courier New', monospace; }
        [data-theme="love"] { --bg-color: #fff1f2; --text-color: #881337; --card-bg: #fff0f5; --primary-color: #e11d48; --accent-color: #fda4af; }
        [data-theme="christmas"] { --bg-color: #0f3d0f; --text-color: #ffffff; --card-bg: #8b0000; --primary-color: #fbbf24; --accent-color: #ffffff; }
        [data-theme="retro"] { --bg-color: #d7c9a8; --text-color: #5c4033; --card-bg: #fdf5e6; --primary-color: #8b4513; --accent-color: #cd853f; }

        body { background-color: var(--bg-color); color: var(--text-color); }
        .theme-card { background-color: var(--card-bg); color: var(--text-color); }
        .theme-btn-primary { background-color: var(--primary-color); color: white; }
        .theme-btn-accent { background-color: var(--accent-color); color: white; }
        .theme-border { border-color: var(--primary-color); }
        
        .vf-stavenote { cursor: pointer; }
        .vf-stavenote:hover path, .vf-stavenote:hover rect { fill: var(--primary-color) !important; stroke: var(--primary-color) !important; }
        #notation-container canvas, #notation-container svg { max-width: 100%; height: auto; }
        
        .nav-scroll::-webkit-scrollbar { height: 4px; }
        .nav-scroll::-webkit-scrollbar-track { background: transparent; }
        .nav-scroll::-webkit-scrollbar-thumb { background-color: var(--primary-color); border-radius: 20px; }
        
        .library-scroll::-webkit-scrollbar { width: 8px; }
        .library-scroll::-webkit-scrollbar-track { background: transparent; }
        .library-scroll::-webkit-scrollbar-thumb { background-color: var(--primary-color); border-radius: 20px; }

        .metronome-dot { width: 20px; height: 20px; border-radius: 50%; background-color: #ccc; transition: background-color 0.1s; }
        .metronome-dot.active { background-color: var(--primary-color); box-shadow: 0 0 10px var(--primary-color); }
    </style>
</head>
<body class="min-h-screen flex flex-col" data-theme="classic">

    <!-- Header -->
    <nav class="theme-card shadow-sm p-4 sticky top-0 z-50">
        <div class="container mx-auto flex justify-center items-center">
            <div class="flex items-center gap-2">
                <i class="fas fa-music text-3xl" style="color: var(--primary-color)"></i>
                <h1 class="text-2xl font-bold md:text-3xl tracking-tight">Liem's Harmony Hub</h1>
            </div>
        </div>
    </nav>

    <!-- Controls Bar -->
    <div class="w-full bg-opacity-10 bg-gray-500 py-3 backdrop-blur-sm shadow-inner">
        <div class="container mx-auto flex justify-center items-center gap-4 md:gap-8" id="controls-bar"></div>
    </div>

    <!-- Main Content -->
    <main class="flex-grow container mx-auto p-4 flex flex-col items-center">
        
        <div id="start-overlay" class="fixed inset-0 bg-black bg-opacity-80 z-[100] flex flex-col items-center justify-center text-white text-center p-4">
            <h2 class="text-3xl font-bold mb-4">Welcome to Harmony Hub</h2>
            <p class="mb-6 max-w-md">Click Start to enable audio and begin your musical journey.</p>
            <button id="init-audio-btn" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-8 rounded-full text-xl shadow-lg transform transition hover:scale-105">
                <i class="fas fa-play mr-2"></i> START
            </button>
        </div>

        <div class="w-full overflow-x-auto pb-4 mb-2 nav-scroll">
            <div class="flex gap-3 min-w-max justify-center px-4" id="mode-tabs"></div>
        </div>

        <div id="app-container" class="w-full max-w-4xl flex flex-col items-center mt-4"></div>

    </main>

    <footer class="theme-card mt-auto py-6 text-center shadow-inner">
        <p class="opacity-75">¬© 2024 Liem's Harmony Hub. Code with <i class="fas fa-heart text-red-500"></i> & Music.</p>
    </footer>

    <script>
        const APP_NAME = "Liem's Harmony Hub";
        
        // --- C·∫§U H√åNH ---
        const DEFAULT_THEME = 'christmas'; 

        const LANGUAGES = {
            vi: {
                flag: "üáªüá≥", name: "Ti·∫øng Vi·ªát",
                modes: ["Kh√≥a Sol", "Kh√≥a Fa", "Hai kh√≥a", "Th∆∞ vi·ªán", "Luy·ªán tai", "D√≤ n·ªët", "Metronome"],
                ui: {
                    level: "C·∫•p ƒë·ªô", next: "Ti·∫øp theo", result: "K·∫øt qu·∫£", listen: "Nghe", check: "Ki·ªÉm tra",
                    start: "B·∫Øt ƒë·∫ßu", stop: "D·ª´ng", bpm: "Nh·ªãp (BPM)", notes: "S·ªë n·ªët", time: "Th·ªùi gian",
                    seconds: "gi√¢y", detect: "ƒêang nghe...", library: "Th∆∞ vi·ªán", chords: "H·ª£p √¢m",
                    settings: "C√†i ƒë·∫∑t", theme: "Giao di·ªán", lang: "Ng√¥n ng·ªØ", answer: "ƒê√°p √°n",
                    tapToStart: "Ch·∫°m ƒë·ªÉ b·∫Øt ƒë·∫ßu",
                    sol: "Sol", fa: "Fa", do: "ƒê√¥", re: "R√™", mi: "Mi", fa_note: "Fa", sol_note: "Sol", la: "La", si: "Si",
                    soundOn: "B·∫≠t ti·∫øng", soundOff: "T·∫Øt ti·∫øng"
                }
            },
            en: {
                flag: "üá¨üáß", name: "English",
                modes: ["Treble Clef", "Bass Clef", "Grand Staff", "Library", "Ear Training", "Note Check", "Metronome"],
                ui: {
                    level: "Level", next: "Next", result: "Reveal", listen: "Listen", check: "Check",
                    start: "Start", stop: "Stop", bpm: "BPM", notes: "Notes", time: "Time",
                    seconds: "s", detect: "Listening...", library: "Library", chords: "Chords",
                    settings: "Settings", theme: "Theme", lang: "Language", answer: "Answer",
                    tapToStart: "Tap to Start",
                    sol: "G", fa: "F", do: "C", re: "D", mi: "E", fa_note: "F", sol_note: "G", la: "A", si: "B",
                    soundOn: "Sound On", soundOff: "Mute"
                }
            },
             fr: { flag: "üá´üá∑", name: "Fran√ßais", modes: ["Cl√© de Sol", "Cl√© de Fa", "Grande Port√©e", "Biblioth√®que", "Oreille", "Note Check", "M√©tronome"], ui: { level: "Niveau", next: "Suivant", result: "R√©sultat", listen: "√âcouter", check: "V√©rifier", start: "D√©marrer", stop: "Arr√™ter", bpm: "BPM", notes: "Notes", time: "Temps", seconds: "s", detect: "√âcoute...", library: "Biblioth√®que", chords: "Accords", settings: "Param√®tres", theme: "Th√®me", lang: "Langue", answer: "R√©ponse", tapToStart: "Appuyez pour commencer", sol: "Sol", fa: "Fa", do: "Do", re: "R√©", mi: "Mi", fa_note: "Fa", sol_note: "Sol", la: "La", si: "Si", soundOn: "Son activ√©", soundOff: "Muet" } },
        };

        const THEMES = [
            { id: "classic", name: "Classic", icon: "fa-music" },
            { id: "dark", name: "Dark", icon: "fa-moon" },
            { id: "ocean", name: "Ocean", icon: "fa-water" },
            { id: "coder", name: "Coder", icon: "fa-terminal" },
            { id: "love", name: "Love", icon: "fa-heart" },
            { id: "christmas", name: "Christmas", icon: "fa-tree" },
            { id: "retro", name: "Retro", icon: "fa-coffee" }
        ];

        // Mapping VexFlow duration to Tone.js duration and time value (relative to quarter note)
        // w=4 beats, h=2, q=1, 8=0.5, 16=0.25
        const DURATION_MAP = {
            'w': { tone: '1n', time: 4 },
            'h': { tone: '2n', time: 2 },
            'q': { tone: '4n', time: 1 },
            '8': { tone: '8n', time: 0.5 },
            '16': { tone: '16n', time: 0.25 }
        };

        let state = {
            lang: 'vi', theme: DEFAULT_THEME, mode: 0, level: 1,
            flashcardData: { treble: [], bass: [] }, 
            isRevealed: false, audioEnabled: false, isMuted: false,
            earTrainingNotes: 1, checkTime: 5, metronomeBpm: 60, metronomeActive: false
        };

        let synth;
        let metronomeLoop;
        let playbackTimeout;

        // --- HELPERS ---
        function stopSound() {
            if (playbackTimeout) { clearTimeout(playbackTimeout); playbackTimeout = null; }
            if (synth) {
                try { synth.releaseAll(); synth.dispose(); } catch(e) {}
                synth = new Tone.PolySynth(Tone.Synth).toDestination();
                if (state.isMuted) Tone.Destination.mute = true;
            }
        }

        function getNoteName(noteStr) { 
            const toneMap = { 'C': 'do', 'D': 're', 'E': 'mi', 'F': 'fa_note', 'G': 'sol_note', 'A': 'la', 'B': 'si' };
            const noteChar = noteStr.charAt(0);
            const accidental = noteStr.includes('#') ? '#' : (noteStr.includes('b') ? 'b' : '');
            const octave = noteStr.slice(-1);
            return `${LANGUAGES[state.lang].ui[toneMap[noteChar]]}${accidental} ${octave}`;
        }
        function rnd(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }

        function playTone(note, durationVex) {
            if (!state.audioEnabled || !synth) return;
            const dur = DURATION_MAP[durationVex] ? DURATION_MAP[durationVex].tone : '8n';
            synth.triggerAttackRelease(note, dur);
        }
        function playChord(notes) {
            if (!state.audioEnabled || !synth) return;
            synth.triggerAttackRelease(notes, "2n");
        }

        function toggleMute() {
            state.isMuted = !state.isMuted;
            Tone.Destination.mute = state.isMuted;
            renderControls(); 
        }

        // --- RENDER UI ---
        function renderControls() {
            const container = document.getElementById('controls-bar');
            const soundBtn = `<button onclick="toggleMute()" class="flex items-center gap-2 px-4 py-2 rounded-full shadow-sm transition hover:scale-105 ${state.isMuted ? 'bg-gray-300 text-gray-600' : 'bg-[var(--primary-color)] text-white'}"><i class="fas ${state.isMuted ? 'fa-volume-mute' : 'fa-volume-up'}"></i></button>`;
            const themeSelect = `<div class="relative group"><select onchange="state.theme=this.value;document.body.setAttribute('data-theme',this.value)" class="appearance-none bg-white border border-gray-300 hover:border-[var(--primary-color)] px-4 py-2 pr-8 rounded-full shadow-sm focus:outline-none focus:ring-2 focus:ring-[var(--primary-color)] cursor-pointer text-gray-700">${THEMES.map(th => `<option value="${th.id}" ${state.theme===th.id?'selected':''}>${th.name}</option>`).join('')}</select><div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700"><i class="fas fa-palette text-xs"></i></div></div>`;
            const langSelect = `<div class="relative"><select onchange="state.lang=this.value;initUI()" class="appearance-none bg-white border border-gray-300 hover:border-[var(--primary-color)] px-4 py-2 pr-8 rounded-full shadow-sm focus:outline-none focus:ring-2 focus:ring-[var(--primary-color)] cursor-pointer text-gray-700 font-bold">${Object.keys(LANGUAGES).map(l => `<option value="${l}" ${state.lang===l?'selected':''}>${LANGUAGES[l].flag} ${l.toUpperCase()}</option>`).join('')}</select><div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700"><i class="fas fa-globe text-xs"></i></div></div>`;
            container.innerHTML = soundBtn + themeSelect + langSelect;
        }

        function renderTabs() {
            const t = LANGUAGES[state.lang];
            const tabs = document.getElementById('mode-tabs');
            tabs.innerHTML = t.modes.map((m, i) => `<button onclick="switchMode(${i})" class="whitespace-nowrap px-5 py-2.5 rounded-full text-sm font-bold shadow-sm transition hover:scale-105 border ${state.mode === i ? 'bg-[var(--primary-color)] text-white border-[var(--primary-color)]' : 'bg-white text-gray-600 border-gray-200 hover:border-[var(--primary-color)]'}">${m}</button>`).join('');
        }

        function initUI() {
            document.body.setAttribute('data-theme', state.theme);
            renderControls(); renderTabs(); switchMode(state.mode); 
        }

        // --- FLASHCARD LOGIC ---
        const FLASHCARD_LOGIC = {
            generateCard: () => {
                stopSound();
                const levelCounts = {1: 1, 2: 3, 3: 5, 4: 8};
                const count = levelCounts[state.level];
                state.flashcardData = { treble: [], bass: [] };
                const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
                
                // Logic for mixing note durations
                // Level 1: Simple (q, h, w) - mostly quarter for simplicity
                // Level > 1: Mix q, 8, 16 to create beamable patterns
                let durationPool = ['w', 'h', 'q'];
                if (state.level > 1) durationPool = ['q', '8', '8', '16', '16', '16', '16']; // Weighted towards beamable notes

                const generateNote = (clef) => {
                    const minMidi = clef === 'treble' ? 60 : 40; 
                    const maxMidi = clef === 'treble' ? 84 : 60;
                    const midi = rnd(minMidi, maxMidi);
                    const noteName = noteNames[midi % 12];
                    const octave = Math.floor(midi / 12) - 1;
                    return { key: `${noteName.toLowerCase()}/${octave}`, toneKey: `${noteName}${octave}`, midi, clef };
                };

                if (state.mode === 2) {
                    for (let i = 0; i < count; i++) {
                        // Sync duration for both hands to keep it clean visually for flashcards
                        let dur = durationPool[rnd(0, durationPool.length - 1)];
                        // If it's the last note, try to make it longer to "resolve"
                        if (i === count - 1 && state.level > 1) dur = 'h'; 
                        
                        const tNote = generateNote('treble'); const bNote = generateNote('bass');
                        tNote.duration = dur; bNote.duration = dur;
                        state.flashcardData.treble.push(tNote); state.flashcardData.bass.push(bNote);
                    }
                } else {
                    const clef = state.mode === 0 ? 'treble' : 'bass';
                    for (let i = 0; i < count; i++) {
                        let dur = durationPool[rnd(0, durationPool.length - 1)];
                        if (i === count - 1 && state.level > 1) dur = 'h';
                        const n = generateNote(clef); 
                        n.duration = dur;
                        state.flashcardData[clef].push(n);
                    }
                }
                state.isRevealed = false; FLASHCARD_LOGIC.render();
            },
            render: () => {
                const t = LANGUAGES[state.lang].ui;
                let answers = [];
                if (state.mode === 2) {
                    state.flashcardData.treble.forEach((n, i) => {
                        const b = state.flashcardData.bass[i];
                        answers.push(`[${getNoteName(n.toneKey)} + ${getNoteName(b.toneKey)}]`);
                    });
                } else {
                    const data = state.mode === 0 ? state.flashcardData.treble : state.flashcardData.bass;
                    answers = data.map(n => getNoteName(n.toneKey));
                }

                let html = `
                    <div class="theme-card p-6 rounded-xl shadow-lg w-full text-center">
                        <div class="flex justify-between items-center mb-4">
                            <select id="level-select" onchange="state.level=parseInt(this.value); FLASHCARD_LOGIC.generateCard()" class="p-2 rounded border bg-transparent">
                                <option value="1" ${state.level===1?'selected':''}>Lvl 1 (1 Note)</option>
                                <option value="2" ${state.level===2?'selected':''}>Lvl 2 (3 Notes)</option>
                                <option value="3" ${state.level===3?'selected':''}>Lvl 3 (5 Notes)</option>
                                <option value="4" ${state.level===4?'selected':''}>Lvl 4 (8 Notes)</option>
                            </select>
                            <span class="text-sm opacity-60">Click notes to play</span>
                        </div>
                        <div id="flashcard-canvas" class="flex justify-center items-center bg-white rounded p-2 mb-6 overflow-x-auto min-h-[200px]"></div>
                        <div class="min-h-[4rem] flex flex-col items-center justify-center mb-4">
                            ${state.isRevealed 
                                ? `<div class="flex flex-wrap gap-2 justify-center w-full px-4">${answers.map(a => `<span class="bg-[var(--primary-color)] text-white px-4 py-2 rounded-lg font-bold shadow-sm text-lg">${a}</span>`).join('')}</div>`
                                : `<button onclick="FLASHCARD_LOGIC.reveal()" class="theme-btn-accent px-6 py-2 rounded-full font-bold shadow">${t.result}</button>`
                            }
                        </div>
                        ${state.isRevealed ? `<button onclick="FLASHCARD_LOGIC.generateCard()" class="theme-btn-primary px-8 py-3 rounded-full text-xl font-bold shadow-lg transform transition hover:scale-105">${t.next} <i class="fas fa-arrow-right ml-2"></i></button>` : ''}
                    </div>
                `;
                document.getElementById('app-container').innerHTML = html;
                const div = document.getElementById('flashcard-canvas');
                if (!div) return;
                div.innerHTML = '';
                const { Renderer, Stave, StaveNote, Formatter, StaveConnector, Accidental, Beam } = Vex.Flow;
                const count = Math.max(state.flashcardData.treble.length, state.flashcardData.bass.length);
                const width = Math.max(320, count * 70 + 100);
                const renderer = new Renderer(div, Renderer.Backends.SVG);
                renderer.resize(width, state.mode === 2 ? 280 : 160);
                const ctx = renderer.getContext();
                
                const makeNotes = (d, c) => d.map(n => {
                    const note = new StaveNote({ clef: c, keys: [n.key], duration: n.duration, auto_stem: true });
                    if(n.key.includes('#')) note.addModifier(new Accidental('#'));
                    if(n.key.includes('b') && n.key[0] !== 'b') note.addModifier(new Accidental('b'));
                    return note;
                });

                if (state.mode === 2) {
                    const st = new Stave(10, 20, width - 20).addClef('treble').setContext(ctx).draw();
                    const sb = new Stave(10, 130, width - 20).addClef('bass').setContext(ctx).draw();
                    new StaveConnector(st, sb).setType(StaveConnector.type.BRACE).setContext(ctx).draw();
                    new StaveConnector(st, sb).setType(StaveConnector.type.SINGLE_LEFT).setContext(ctx).draw();
                    new StaveConnector(st, sb).setType(StaveConnector.type.SINGLE_RIGHT).setContext(ctx).draw();
                    
                    const tn = makeNotes(state.flashcardData.treble, 'treble');
                    const bn = makeNotes(state.flashcardData.bass, 'bass');
                    
                    // Auto Beam
                    const beamsT = Beam.generateBeams(tn);
                    const beamsB = Beam.generateBeams(bn);

                    const fmt = new Formatter();
                    fmt.joinVoices([new Vex.Flow.Voice({num_beats:4,beat_value:4}).setMode(Vex.Flow.Voice.Mode.SOFT).addTickables(tn)]).format([new Vex.Flow.Voice({num_beats:4,beat_value:4}).setMode(Vex.Flow.Voice.Mode.SOFT).addTickables(tn)], width - 50);
                    
                    tn.forEach(n => n.setStave(st).setContext(ctx).draw());
                    beamsT.forEach(b => b.setContext(ctx).draw());

                    fmt.format([new Vex.Flow.Voice({num_beats:4,beat_value:4}).setMode(Vex.Flow.Voice.Mode.SOFT).addTickables(bn)], width - 50);
                    bn.forEach(n => n.setStave(sb).setContext(ctx).draw());
                    beamsB.forEach(b => b.setContext(ctx).draw());

                    const svgs = div.querySelectorAll('.vf-stavenote');
                    state.flashcardData.treble.forEach((n,i)=>addClick(svgs[i], n.toneKey, n.duration));
                    state.flashcardData.bass.forEach((n,i)=>addClick(svgs[state.flashcardData.treble.length+i], n.toneKey, n.duration));
                } else {
                    const clef = state.mode === 0 ? 'treble' : 'bass';
                    const st = new Stave(10, 20, width - 20).addClef(clef).setContext(ctx).draw();
                    const n = makeNotes(state.mode === 0 ? state.flashcardData.treble : state.flashcardData.bass, clef);
                    
                    const beams = Beam.generateBeams(n);
                    
                    Formatter.FormatAndDraw(ctx, st, n);
                    beams.forEach(b => b.setContext(ctx).draw());

                    const svgs = div.querySelectorAll('.vf-stavenote');
                    n.forEach((note, i) => addClick(svgs[i], state.flashcardData[state.mode === 0 ? 'treble' : 'bass'][i].toneKey, state.flashcardData[state.mode === 0 ? 'treble' : 'bass'][i].duration));
                }
            },
            reveal: () => {
                stopSound();
                state.isRevealed = true;
                FLASHCARD_LOGIC.render();
                const now = Tone.now();
                
                // Play Sequence Logic considering Durations
                let currentTime = now;
                const bpm = 100; // Fixed BPM for playback
                const beatTime = 60 / bpm; // Time for one Quarter note

                const getDurTime = (durChar) => {
                    return DURATION_MAP[durChar].time * beatTime;
                };
                const getToneDur = (durChar) => {
                    return DURATION_MAP[durChar].tone;
                }

                if (state.mode === 2) {
                    state.flashcardData.treble.forEach((t, i) => {
                        const b = state.flashcardData.bass[i];
                        const durationTime = getDurTime(t.duration);
                        const toneDuration = getToneDur(t.duration);
                        
                        synth.triggerAttackRelease([t.toneKey, b.toneKey], toneDuration, currentTime);
                        currentTime += durationTime;
                    });
                } else {
                    const data = state.mode === 0 ? state.flashcardData.treble : state.flashcardData.bass;
                    data.forEach((n, i) => {
                        const durationTime = getDurTime(n.duration);
                        const toneDuration = getToneDur(n.duration);
                        
                        synth.triggerAttackRelease(n.toneKey, toneDuration, currentTime);
                        currentTime += durationTime;
                    });
                }
            }
        };

        function addClick(el, tone, durationVex) {
            if(!el) return;
            el.style.cursor = 'pointer';
            el.onclick = (e) => { 
                e.stopPropagation(); 
                playTone(tone, durationVex || '8'); 
                const p=el.querySelectorAll('path,rect'); p.forEach(x=>x.style.fill='var(--accent-color)'); setTimeout(()=>p.forEach(x=>x.style.fill=''),300); 
            };
        }

        // --- LIBRARY LOGIC ---
        const LIBRARY_LOGIC = {
            render: () => {
                const t = LANGUAGES[state.lang].ui;
                document.getElementById('app-container').innerHTML = `
                    <div class="grid md:grid-cols-2 gap-4 w-full h-[80vh]">
                        <div class="theme-card p-4 rounded-xl shadow overflow-y-auto library-scroll">
                            <h2 class="text-xl font-bold mb-4 sticky top-0 bg-[var(--card-bg)] pb-2 border-b border-[var(--primary-color)]">${t.library} (88 Keys)</h2>
                            <div id="notes-lib-content" class="space-y-6"></div>
                        </div>
                        <div class="theme-card p-4 rounded-xl shadow overflow-y-auto library-scroll">
                            <h2 class="text-xl font-bold mb-4 sticky top-0 bg-[var(--card-bg)] pb-2 border-b border-[var(--primary-color)]">${t.chords}</h2>
                            <div id="chords-lib-content" class="space-y-6"></div>
                        </div>
                    </div>`;
                setTimeout(LIBRARY_LOGIC.fillContent, 100);
            },
            fillContent: () => {
                const nDiv = document.getElementById('notes-lib-content');
                if(!nDiv) return;
                for (let o = 0; o <= 8; o++) {
                    const id = `lib-oct-${o}`;
                    let lst = ['C','D','E','F','G','A','B'];
                    if(o===0) lst=['A','B']; if(o===8) lst=['C'];
                    const clef = o < 4 ? 'bass' : 'treble';
                    const w = document.createElement('div');
                    w.innerHTML = `<h3 class="font-bold text-sm text-[var(--primary-color)]">Octave ${o} (${clef})</h3><div id="${id}" class="bg-white rounded p-2 overflow-x-auto cursor-pointer mb-4 border border-gray-200"></div>`;
                    nDiv.appendChild(w);
                    const notes = lst.map(n => ({ key: `${n.toLowerCase()}/${o}`, toneKey: `${n}${o}`, duration: 'q', midi: 0 }));
                    renderNotation(id, notes, clef, 600, 0.85);
                }
                const cDiv = document.getElementById('chords-lib-content');
                if(!cDiv) return;
                ['C','D','E','F','G','A','B'].forEach(r => {
                    [{t:'M',s:'Major'},{t:'m',s:'Minor'}].forEach(v => {
                        const id = `chord-${r}-${v.t}`;
                        const w = document.createElement('div');
                        w.className = "flex items-center gap-4 bg-[var(--bg-color)] p-2 rounded hover:brightness-95 transition cursor-pointer mb-2";
                        const d = getChordKeys(r, v.t);
                        w.onclick = () => playChord(d.tones);
                        w.innerHTML = `<div class="font-bold w-24 text-sm">${r} ${v.s}</div><div id="${id}" class="bg-white rounded"></div>`;
                        cDiv.appendChild(w);
                        renderChord(id, d.keys);
                    });
                });
            }
        };

        function getChordKeys(r, t) {
            const m = {
                'C':{M:['c/4','e/4','g/4'],m:['c/4','eb/4','g/4']}, 'D':{M:['d/4','f#/4','a/4'],m:['d/4','f/4','a/4']}, 'E':{M:['e/4','g#/4','b/4'],m:['e/4','g/4','b/4']},
                'F':{M:['f/4','a/4','c/5'],m:['f/4','ab/4','c/5']}, 'G':{M:['g/4','b/4','d/5'],m:['g/4','bb/4','d/5']}, 'A':{M:['a/4','c#/5','e/5'],m:['a/4','c/5','e/5']},
                'B':{M:['b/4','d#/5','f#/5'],m:['b/4','d/5','f#/5']}
            };
            const tm = {
                'C':{M:['C4','E4','G4'],m:['C4','Eb4','G4']}, 'D':{M:['D4','F#4','A4'],m:['D4','F4','A4']}, 'E':{M:['E4','G#4','B4'],m:['E4','G4','B4']},
                'F':{M:['F4','A4','C5'],m:['F4','Ab4','C5']}, 'G':{M:['G4','B4','D5'],m:['G4','Bb4','D5']}, 'A':{M:['A4','C#5','E5'],m:['A4','C5','E5']},
                'B':{M:['B4','D#5','F#5'],m:['B4','D5','F#5']}
            };
            return { keys: m[r][t], tones: tm[r][t] };
        }

        function renderNotation(eid, data, clef, w, s) {
            const div = document.getElementById(eid); if(!div) return; div.innerHTML='';
            const r = new Vex.Flow.Renderer(div, Vex.Flow.Renderer.Backends.SVG);
            r.resize(w, 250 * s); const ctx = r.getContext(); ctx.scale(s, s);
            const st = new Vex.Flow.Stave(10, 50, w - 20).addClef(clef).setContext(ctx).draw();
            const n = data.map(d => {
                const note = new Vex.Flow.StaveNote({clef, keys:[d.key], duration:d.duration, auto_stem:true});
                if(d.key.includes('#')) note.addModifier(new Vex.Flow.Accidental('#'));
                if(d.key.includes('b') && d.key[0]!=='b') note.addModifier(new Vex.Flow.Accidental('b'));
                return note;
            });
            Vex.Flow.Formatter.FormatAndDraw(ctx, st, n);
            const svgs = div.querySelectorAll('.vf-stavenote');
            data.forEach((d,i) => addClick(svgs[i], d.toneKey, d.duration));
        }

        function renderChord(eid, keys) {
            const div = document.getElementById(eid); if(!div) return;
            const r = new Vex.Flow.Renderer(div, Vex.Flow.Renderer.Backends.SVG);
            r.resize(250, 150); const ctx = r.getContext(); ctx.scale(0.55, 0.55);
            const st = new Vex.Flow.Stave(0, 30, 240).addClef('treble').setContext(ctx).draw();
            const n = new Vex.Flow.StaveNote({clef:'treble',keys,duration:'w'});
            keys.forEach((k,i)=>{
                if(k.includes('#')) n.addModifier(new Vex.Flow.Accidental('#'),i);
                if(k.includes('b') && k[0]!=='b') n.addModifier(new Vex.Flow.Accidental('b'),i);
            });
            st.setNoteStartX(st.getNoteStartX()+20);
            Vex.Flow.Formatter.FormatAndDraw(ctx, st, [n]);
        }

        // --- EAR LOGIC ---
        const EAR_LOGIC = {
            targetNotes: [],
            render: () => {
                const t = LANGUAGES[state.lang].ui;
                document.getElementById('app-container').innerHTML = `
                    <div class="theme-card p-8 rounded-xl shadow-lg w-full text-center max-w-md">
                        <h2 class="text-2xl font-bold mb-6">${t.ui && t.ui.modes ? t.modes[4] : 'Ear Training'}</h2>
                        <div class="mb-6 flex items-center justify-center gap-2">
                            <label>${t.notes}:</label>
                            <input type="number" min="1" max="10" value="${state.earTrainingNotes}" onchange="let v=parseInt(this.value);if(isNaN(v)||v<1)v=1;if(v>10)v=10;state.earTrainingNotes=v;this.value=v;EAR_LOGIC.newQuestion()" class="border rounded p-2 w-16 text-center text-black">
                        </div>
                        <div id="ear-canvas-container" class="bg-[var(--bg-color)] rounded-xl p-4 min-h-[160px] flex items-center justify-center mb-6 shadow-inner">
                            ${!state.isRevealed ? `<i class="fas fa-music text-6xl text-[var(--text-color)] opacity-50"></i>` : `<div id="ear-vexflow"></div>`}
                        </div>
                        <div class="flex flex-wrap gap-2 justify-center mb-4 min-h-[3rem] items-center">
                            ${state.isRevealed ? state.targetNotes.map(n => `<span class="bg-[var(--primary-color)] text-white px-3 py-1 rounded-lg font-bold shadow-sm text-xl">${getNoteName(n)}</span>`).join('') : `<span class="text-3xl font-bold text-gray-300">? ? ?</span>`}
                        </div>
                        <div class="flex gap-4 justify-center">
                            <button onclick="EAR_LOGIC.play()" class="theme-btn-accent px-6 py-3 rounded-full font-bold shadow"><i class="fas fa-volume-up mr-2"></i> ${t.listen}</button>
                            ${!state.isRevealed ? `<button onclick="EAR_LOGIC.reveal()" class="theme-btn-primary px-6 py-3 rounded-full font-bold shadow">${t.result}</button>` : `<button onclick="EAR_LOGIC.newQuestion()" class="theme-btn-primary px-6 py-3 rounded-full font-bold shadow">${t.next}</button>`}
                        </div>
                    </div>`;
                if(state.isRevealed) {
                    const no = state.targetNotes.map(s => ({ key: `${s.charAt(0).toLowerCase()}${s.includes('#')?'#':s.includes('b')?'b':''}/${s.slice(-1)}`, toneKey: s, duration:'q', midi:0 }));
                    renderNotation('ear-vexflow', no, 'treble', 350, 0.9);
                }
                if(state.targetNotes.length===0) EAR_LOGIC.newQuestion();
            },
            newQuestion: () => {
                stopSound(); state.targetNotes = [];
                const pool = ['C4','D4','E4','F4','G4','A4','B4','C5'];
                for(let i=0; i<state.earTrainingNotes; i++) state.targetNotes.push(pool[rnd(0, pool.length-1)]);
                state.isRevealed = false; EAR_LOGIC.render(); playbackTimeout = setTimeout(() => EAR_LOGIC.play(), 500);
            },
            play: () => { const now = Tone.now(); state.targetNotes.forEach((n,i) => synth.triggerAttackRelease(n, "8n", now + i * 0.6)); },
            reveal: () => { state.isRevealed = true; EAR_LOGIC.render(); }
        };

        const CHECK_LOGIC = {
            isListening: false, detectedNotes: [], timer: null, timeLeft: 0,
            render: () => {
                const t = LANGUAGES[state.lang].ui;
                document.getElementById('app-container').innerHTML = `<div class="theme-card p-6 rounded-xl shadow-lg w-full text-center max-w-lg"><h2 class="text-2xl font-bold mb-4">Note Checking</h2><div class="mb-6"><label class="block mb-2 font-bold">${t.time}:</label><div class="flex gap-2 justify-center">${[1,3,5,7,10].map(s=>`<button onclick="state.checkTime=${s};CHECK_LOGIC.render()" class="px-3 py-1 rounded border ${state.checkTime===s?'bg-[var(--primary-color)] text-white':''}">${s}s</button>`).join('')}</div></div><div class="min-h-[100px] flex items-center justify-center bg-[var(--bg-color)] rounded mb-6 text-2xl font-mono p-4">${CHECK_LOGIC.isListening ? `<span class="animate-pulse text-red-500"><i class="fas fa-microphone"></i> ${CHECK_LOGIC.timeLeft}s</span>` : (CHECK_LOGIC.detectedNotes.length?CHECK_LOGIC.detectedNotes.join(", "):"Ready")}</div><button onclick="CHECK_LOGIC.startListening()" ${CHECK_LOGIC.isListening?'disabled':''} class="theme-btn-primary px-8 py-4 rounded-full text-xl font-bold shadow-lg disabled:opacity-50">${CHECK_LOGIC.isListening?t.detect:`<i class="fas fa-microphone mr-2"></i> ${t.start}`}</button></div>`;
            },
            startListening: async () => {
                if(!state.audioEnabled) { alert("Please click Start first."); return; }
                CHECK_LOGIC.isListening=true; CHECK_LOGIC.timeLeft=state.checkTime; CHECK_LOGIC.detectedNotes=[]; CHECK_LOGIC.render();
                try {
                    const st = await navigator.mediaDevices.getUserMedia({audio:true});
                    const ac = new (window.AudioContext||window.webkitAudioContext)();
                    const an = ac.createAnalyser(); an.fftSize=2048; ac.createMediaStreamSource(st).connect(an);
                    const detect = () => {
                        if(!CHECK_LOGIC.isListening) return;
                        const b = new Float32Array(an.fftSize); an.getFloatTimeDomainData(b);
                        const n = autoCorrelate(b, ac.sampleRate);
                        if(n && n!=='-' && CHECK_LOGIC.detectedNotes[CHECK_LOGIC.detectedNotes.length-1]!==n) CHECK_LOGIC.detectedNotes.push(n);
                        requestAnimationFrame(detect);
                    }; detect();
                    CHECK_LOGIC.timer = setInterval(() => {
                        CHECK_LOGIC.timeLeft--; CHECK_LOGIC.render();
                        if(CHECK_LOGIC.timeLeft<=0) { CHECK_LOGIC.isListening=false; clearInterval(CHECK_LOGIC.timer); st.getTracks().forEach(t=>t.stop()); ac.close(); CHECK_LOGIC.detectedNotes=[...new Set(CHECK_LOGIC.detectedNotes)]; CHECK_LOGIC.render(); }
                    }, 1000);
                } catch(e) { alert("Microphone Error"); CHECK_LOGIC.isListening=false; CHECK_LOGIC.render(); }
            }
        };

        function autoCorrelate(b, r) {
            let s=b.length, rms=0; for(let i=0;i<s;i++) rms+=b[i]*b[i]; if(Math.sqrt(rms/s)<0.01) return '-';
            let r1=0,r2=s-1; for(let i=0;i<s/2;i++) if(Math.abs(b[i])<0.2){r1=i;break;} for(let i=1;i<s/2;i++) if(Math.abs(b[s-i])<0.2){r2=s-i;break;}
            b=b.slice(r1,r2); s=b.length; let c=new Array(s).fill(0); for(let i=0;i<s;i++) for(let j=0;j<s-i;j++) c[i]+=b[j]*b[j+i];
            let d=0; while(c[d]>c[d+1]) d++; let max=-1,t0=-1; for(let i=d;i<s;i++) if(c[i]>max){max=c[i];t0=i;}
            if(t0===-1) return '-';
            let f = r/t0; const nn=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
            const n = Math.round(12*(Math.log(f/440)/Math.log(2))+69); return (n<21||n>108)?null:nn[n%12];
        }

        const METRO_LOGIC = {
            countdown: 0,
            render: () => {
                const t = LANGUAGES[state.lang].ui;
                document.getElementById('app-container').innerHTML = `<div class="theme-card p-8 rounded-xl shadow-lg w-full text-center max-w-sm"><h2 class="text-2xl font-bold mb-6">${t.ui && t.ui.modes ? t.modes[6] : 'Metronome'}</h2><div class="mb-8"><div class="text-6xl font-bold font-mono mb-2 text-[var(--primary-color)]">${state.metronomeBpm}</div><div class="text-sm opacity-60">BPM</div><input type="range" min="40" max="200" value="${state.metronomeBpm}" oninput="state.metronomeBpm=this.value;METRO_LOGIC.render()" class="w-full mt-4 accent-[var(--primary-color)]"></div><div class="flex justify-center gap-4 mb-8">${[1,2,3,4].map(i=>`<div id="metro-dot-${i}" class="metronome-dot"></div>`).join('')}</div>${METRO_LOGIC.countdown>0?`<div class="text-4xl font-bold text-red-500 mb-4">${METRO_LOGIC.countdown}</div>`:''}<button onclick="METRO_LOGIC.toggle()" class="${state.metronomeActive?'bg-red-500':'theme-btn-primary'} text-white px-8 py-4 rounded-full text-xl font-bold shadow-lg w-full transition">${state.metronomeActive?`<i class="fas fa-stop"></i> ${t.stop}`:`<i class="fas fa-play"></i> ${t.start}`}</button></div>`;
            },
            toggle: () => {
                if(state.metronomeActive) { Tone.Transport.stop(); if(metronomeLoop) metronomeLoop.stop(); state.metronomeActive=false; METRO_LOGIC.render(); }
                else { if(!state.audioEnabled) return alert("Start Audio First"); let c=5; METRO_LOGIC.countdown=c; state.metronomeActive=true; METRO_LOGIC.render(); const i = setInterval(()=>{c--; METRO_LOGIC.countdown=c; METRO_LOGIC.render(); if(c===0){clearInterval(i);METRO_LOGIC.startTone();}},1000); }
            },
            startTone: () => {
                Tone.Transport.bpm.value = state.metronomeBpm; let b=0; const s=new Tone.MembraneSynth().toDestination();
                metronomeLoop = new Tone.Loop(t=>{ s.triggerAttackRelease(b===0?"C2":"C1","32n",t); Tone.Draw.schedule(()=>{document.querySelectorAll('.metronome-dot').forEach(d=>d.classList.remove('active'));document.getElementById(`metro-dot-${b+1}`)?.classList.add('active');},t); b=(b+1)%4; },"4n").start(0); Tone.Transport.start();
            }
        };

        function switchMode(i) { stopSound(); state.mode=i; renderTabs(); if(state.metronomeActive) METRO_LOGIC.toggle(); if(CHECK_LOGIC.isListening) {CHECK_LOGIC.isListening=false; if(CHECK_LOGIC.timer) clearInterval(CHECK_LOGIC.timer);} if(i<=2) FLASHCARD_LOGIC.generateCard(); else if(i===3) LIBRARY_LOGIC.render(); else if(i===4) EAR_LOGIC.newQuestion(); else if(i===5) CHECK_LOGIC.render(); else if(i===6) METRO_LOGIC.render(); }

        document.getElementById('init-audio-btn').onclick = async () => { await Tone.start(); state.audioEnabled = true; document.getElementById('start-overlay').style.display='none'; synth = new Tone.PolySynth(Tone.Synth).toDestination(); initUI(); };
        
        // Start without audio initially to render UI
        initUI();
    </script>
</body>
</html>
