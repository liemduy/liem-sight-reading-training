<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Guitar B√†n Nh·∫≠u Pro - Sampler Edition</title>
  <style>
    :root { font-family: 'Segoe UI', sans-serif; }
    body { margin: 0; background: #0b0f14; color: #e7edf5; display: flex; flex-direction: column; align-items: center; padding: 20px; }
    .container { width: 100%; max-width: 900px; display: grid; grid-template-columns: 1fr 300px; gap: 20px; }
    .card { background: #121924; border: 1px solid #223047; border-radius: 15px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
    h2 { color: #f1c40f; margin-top: 0; text-align: center; }
    .controls { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; justify-content: center; }
    button { background: #1f2b3e; color: #fff; border: 1px solid #2d3f5c; padding: 10px 15px; border-radius: 8px; cursor: pointer; transition: 0.2s; }
    button.active { background: #2a4a7a; border-color: #72a7ff; box-shadow: 0 0 10px #72a7ff; }
    .play-btn { background: #27ae60 !important; width: 100%; font-weight: bold; font-size: 1.1em; }
    .stop-btn { background: #c0392b !important; width: 100%; font-weight: bold; }
    .chord-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
    .visualizer { display: grid; grid-template-columns: repeat(8, 1fr); gap: 5px; margin-top: 15px; }
    .beat-dot { height: 40px; background: #0f1520; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 10px; border: 1px solid #2d3f5c; }
    .beat-dot.active { background: #72a7ff; color: #000; font-weight: bold; }
    .status-bar { margin-top: 15px; font-family: monospace; font-size: 12px; color: #5cffb3; text-align: center; }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.18/Tone.js"></script>
</head>
<body>

<div class="container">
  <div class="card">
    <h2>üé∏ GUITAR B√ÄN NH·∫¨U PRO</h2>
    
    <div class="controls">
        <button id="btnInit" style="background: #e67e22;">1. K√çCH HO·∫†T GUITAR</button>
        <button id="btnToggle" class="play-btn" disabled>2. PH√ÅT (START)</button>
    </div>

    <div class="controls">
        <label>ƒêi·ªáu: </label>
        <button class="btn-style active" onclick="setStyle('bolero')">Bolero</button>
        <button class="btn-style" onclick="setStyle('ballad')">Ballad</button>
        <button class="btn-style" onclick="setStyle('disco')">Disco</button>
    </div>

    <div class="visualizer" id="viz"></div>
    <div class="status-bar" id="status">S·∫µn s√†ng nh·∫≠p ti·ªác!</div>
    
    <div style="margin-top:20px;">
        <label>T·ªëc ƒë·ªô (BPM): <span id="bpmVal">75</span></label>
        <input type="range" id="bpmRange" min="60" max="150" value="75" style="width:100%">
    </div>
  </div>

  <div class="card">
    <h3>CH·ªåN H·ª¢P √ÇM</h3>
    <div class="chord-grid" id="chordGrid"></div>
    <div style="margin-top: 20px; font-size: 0.8em; color: #a9b6c8;">
        * H·ª£p √¢m s·∫Ω ƒë·ªïi ch√≠nh x√°c v√†o ƒë·∫ßu m·ªói √¥ nh·ªãp.
    </div>
  </div>
</div>

<script>
  const $ = (id) => document.getElementById(id);
  let guitar, reverb, isPlaying = false;
  let currentStyle = 'bolero';
  let currentChord = 'Am';
  let nextChord = 'Am';
  let stepIndex = 0;

  const CHORDS = {
    "Am": [-1, 0, 2, 2, 1, 0], "Dm": [-1, -1, 0, 2, 3, 1], "E7": [0, 2, 0, 1, 0, 0],
    "C": [-1, 3, 2, 0, 1, 0], "G": [3, 2, 0, 0, 0, 3], "F": [-1, -1, 3, 2, 1, 0]
  };

  const STYLES = {
    bolero: [ {s: 'B', v: 1}, {s: 3, v: 0.4}, {s: 2, v: 0.4}, {s: 1, v: 0.4}, {s: 'C', v: 0.8}, {s: 'B', v: 0.6}, {s: 'C', v: 0.7}, {s: 'B', v: 0.5} ],
    ballad: [ {s: 'B', v: 1}, {s: 3, v: 0.5}, {s: 2, v: 0.5}, {s: 3, v: 0.5}, {s: 1, v: 0.6}, {s: 3, v: 0.5}, {s: 2, v: 0.5}, {s: 3, v: 0.5} ],
    disco:  [ {s: 'B', v: 1}, {s: 'C', v: 0.8}, {s: 'S', v: 0.6}, {s: 'C', v: 0.8}, {s: 'B', v: 0.9}, {s: 'C', v: 0.8}, {s: 'S', v: 0.6}, {s: 'C', v: 0.8} ]
  };

  // Render UI
  const viz = $('viz');
  for(let i=0; i<8; i++) viz.innerHTML += `<div class="beat-dot" id="step-${i}">${i+1}</div>`;

  const grid = $('chordGrid');
  Object.keys(CHORDS).forEach(c => {
    grid.innerHTML += `<button class="btn-chord ${c=='Am'?'active':''}" onclick="setChord('${c}')">${c}</button>`;
  });

  function setStyle(s) {
    currentStyle = s;
    document.querySelectorAll('.btn-style').forEach(b => b.classList.toggle('active', b.innerText.toLowerCase() == s));
  }

  function setChord(c) {
    nextChord = c;
    document.querySelectorAll('.btn-chord').forEach(b => b.classList.toggle('active', b.innerText == c));
  }

  async function initGuitar() {
    $('btnInit').innerText = "ƒêang t·∫£i...";
    await Tone.start();
    guitar = new Tone.Sampler({
      urls: { E2: "E2.ogg", A2: "A2.ogg", D3: "D3.ogg", G3: "G3.ogg", B3: "B3.ogg", E4: "E4.ogg" },
      baseUrl: "https://cdn.jsdelivr.net/npm/tonejs-instrument-guitar-acoustic-ogg@1.1.0/"
    }).toDestination();
    reverb = new Tone.Reverb({ decay: 1.5, wet: 0.1 }).toDestination();
    guitar.connect(reverb);
    await Tone.loaded();
    $('btnInit').innerText = "ƒê√£ t·∫£i xong";
    $('btnToggle').disabled = false;
    $('status').innerText = "Guitar ƒë√£ s·∫µn s√†ng!";
  }

  function playNote(stringNum, time, vol) {
    const frets = CHORDS[currentChord];
    const stringIdx = 6 - stringNum;
    const midi = [40, 45, 50, 55, 59, 64][stringIdx] + frets[stringIdx];
    if (frets[stringIdx] >= 0) guitar.triggerAttackRelease(Tone.Frequency(midi, "midi").toNote(), "2n", time, vol);
  }

  function tick(time) {
    let idx = stepIndex % 8;
    if (idx === 0) currentChord = nextChord;

    // Visual
    Tone.Draw.schedule(() => {
        document.querySelectorAll('.beat-dot').forEach(d => d.classList.remove('active'));
        $('step-' + idx).classList.add('active');
        $('status').innerText = `Nh·ªãp: ${idx + 1} | ƒêi·ªáu: ${currentStyle.toUpperCase()} | H·ª£p √¢m: ${currentChord}`;
    }, time);

    const pattern = STYLES[currentStyle][idx];
    if (pattern.s === 'B') { // Bass
        let bStr = (currentChord === 'Dm' || currentChord === 'F') ? 4 : (currentChord === 'G' || currentChord === 'E7') ? 6 : 5;
        playNote(bStr, time, pattern.v);
    } else if (pattern.s === 'C') { // Ch√°t (Qu·∫°t nh·∫π d√¢y d∆∞·ªõi)
        [1, 2, 3].forEach(s => playNote(s, time, pattern.v));
    } else if (typeof pattern.s === 'number') { // R·∫£i d√¢y ƒë∆°n
        playNote(pattern.s, time, pattern.v);
    }
    stepIndex++;
  }

  $('btnInit').onclick = initGuitar;
  $('btnToggle').onclick = () => {
    if (!isPlaying) {
      Tone.Transport.scheduleRepeat(tick, "8n");
      Tone.Transport.start();
      $('btnToggle').innerText = "D·ª™NG (STOP)";
      $('btnToggle').className = "stop-btn";
    } else {
      Tone.Transport.stop();
      Tone.Transport.cancel();
      $('btnToggle').innerText = "PH√ÅT (START)";
      $('btnToggle').className = "play-btn";
    }
    isPlaying = !isPlaying;
  };

  $('bpmRange').oninput = (e) => {
    Tone.Transport.bpm.value = e.target.value;
    $('bpmVal').innerText = e.target.value;
  };
</script>
</body>
</html>
