<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Bolero Tea Room - Ph√≤ng Tr√†</title>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.18/Tone.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/soundfont-player@0.12.0/dist/soundfont-player.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Roboto:wght@300;400&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg: #1a120b;         /* N√¢u ƒëen cafe */
      --panel: #2e2018;      /* N√¢u g·ªó */
      --gold: #d4af37;       /* V√†ng kim lo·∫°i c·ªï */
      --gold-dim: #8c7322;
      --cream: #f5f5dc;      /* M√†u kem gi·∫•y c≈© */
      --text: #efebe9;
      --highlight: #ffecb3;
      --cue-color: #ff6f00;  /* M√†u cam h·ªï ph√°ch */
      
      --shadow-soft: 0 4px 10px rgba(0,0,0,0.6);
      --border-style: 2px solid var(--gold);
    }

    body {
      background: var(--bg);
      background-image: radial-gradient(circle at center, #2c1e16 0%, #0d0805 100%);
      color: var(--text);
      font-family: 'Roboto', sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 15px;
      margin: 0;
      user-select: none;
      min-height: 100vh;
    }

    h2 {
      font-family: 'Playfair Display', serif;
      color: var(--gold);
      margin: 10px 0;
      text-transform: uppercase;
      letter-spacing: 2px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.8);
      font-size: 1.8rem;
      border-bottom: 1px solid var(--gold-dim);
      padding-bottom: 10px;
    }

    .studio-rack {
      background: var(--panel);
      padding: 25px;
      border-radius: 8px;
      width: 100%;
      max-width: 950px;
      border: 1px solid #4e342e;
      box-shadow: 0 15px 40px rgba(0,0,0,0.7);
      position: relative;
      /* Hi·ªáu ·ª©ng v√¢n g·ªó gi·∫£ */
      background-image: repeating-linear-gradient(45deg, rgba(255,255,255,0.02) 0px, rgba(255,255,255,0.02) 2px, transparent 2px, transparent 4px);
    }

    /* === KHUNG HI·ªÇN TH·ªä === */
    .display-section {
      background: #18100c;
      border: 3px double var(--gold-dim);
      border-radius: 4px;
      padding: 15px;
      margin-bottom: 25px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: inset 0 0 30px rgba(0,0,0,0.9);
    }

    .knob-group {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-right: 15px;
    }
    
    .knob-label { 
      font-family: 'Playfair Display', serif; 
      font-size: 0.8rem; 
      color: var(--gold); 
      margin-bottom: 5px; 
      letter-spacing: 1px;
    }
    
    /* Slider ki·ªÉu c·ªï ƒëi·ªÉn */
    input[type=range].eq-slider {
      -webkit-appearance: none;
      width: 100px; height: 4px; background: #4e342e; border-radius: 2px;
    }
    input[type=range].eq-slider::-webkit-slider-thumb {
      -webkit-appearance: none; width: 16px; height: 16px; 
      background: var(--gold); border: 2px solid #fff; border-radius: 50%; cursor: pointer;
      box-shadow: 0 2px 5px rgba(0,0,0,0.5);
    }

    .string-monitor {
      font-family: 'Playfair Display', serif;
      font-style: italic;
      font-size: 1.8rem;
      color: var(--highlight);
      text-shadow: 0 0 5px var(--gold);
      min-width: 150px;
      text-align: right;
    }
    .string-label { font-size: 0.7rem; color: #8d6e63; text-align: right; text-transform: uppercase; letter-spacing: 2px;}

    /* === TIMELINE (B·∫¢N NH·∫†C) === */
    .timeline-wrapper {
      position: relative;
      height: 140px;
      width: 100%;
      background: #231711;
      border: 2px solid var(--gold-dim);
      border-radius: 4px;
      display: flex;
      overflow: hidden;
      margin-bottom: 25px;
      box-shadow: inset 0 0 20px #000;
    }

    .segment {
      position: relative;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      border-right: 1px solid rgba(212, 175, 55, 0.2); /* V√†ng m·ªù */
      transition: background 0.1s;
    }

    /* M√†u s·∫Øc theo phong c√°ch c·ªï ƒëi·ªÉn */
    .type-bass { background: linear-gradient(to bottom, #3e2723, #281815); color: #ffcc80; }
    .type-fill { background: linear-gradient(to bottom, #263238, #161e22); color: #b0bec5; }
    .type-chat { background: linear-gradient(to bottom, #1b5e20, #0d3311); color: #a5d6a7; }

    /* Hi·ªáu ·ª©ng Playing (S√°ng ƒë√®n v√†ng) */
    .segment.playing {
      filter: brightness(1.3);
      box-shadow: inset 0 0 30px var(--gold);
      border: 1px solid var(--gold);
      z-index: 2;
    }

    /* ƒêi·ªÉm nh·∫•n (CUE) */
    .segment.cue-point {
      border-top: 4px solid var(--cue-color);
    }
    .segment.cue-point.playing {
      background: var(--cue-color); /* Nh√°y cam */
      color: #000;
    }

    .cue-icon {
      position: absolute; top: 4px; right: 4px;
      font-size: 0.6rem; color: var(--cue-color); 
      border: 1px solid var(--cue-color); padding: 1px 3px; border-radius: 2px;
      background: rgba(0,0,0,0.5);
    }

    .note-select {
      background: rgba(0,0,0,0.3); border: 1px solid var(--gold-dim); color: var(--cream);
      font-size: 0.7rem; margin-top: 8px; width: 90%; border-radius: 2px;
      font-family: 'Roboto', sans-serif;
    }

    /* === CONTROLS === */
    .control-deck {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 20px;
      align-items: center;
      margin-bottom: 20px;
      background: #241914;
      padding: 15px;
      border-radius: 6px;
      border: 1px solid #3e2723;
    }

    .btn-main {
      background: linear-gradient(to bottom, #d4af37, #b08d26); /* Gradient V√†ng */
      color: #3e2723;
      border: 1px solid #ffe082;
      padding: 15px; font-size: 1.1rem; font-weight: bold;
      border-radius: 4px; cursor: pointer; width: 100%;
      box-shadow: 0 4px 6px rgba(0,0,0,0.5);
      font-family: 'Playfair Display', serif;
      text-transform: uppercase;
      transition: all 0.1s;
    }
    .btn-main:active { transform: translateY(2px); box-shadow: 0 1px 2px rgba(0,0,0,0.5); }
    .btn-main.stop { background: linear-gradient(to bottom, #c62828, #8e0000); color: #fff; border-color: #ff8a80; }

    .chord-rack { 
      display: flex; gap: 10px; 
      background: #1a120b; padding: 10px; 
      border-radius: 6px; border: 1px solid var(--gold-dim); 
      justify-content: center;
    }
    .btn-chord {
      flex: 1; background: #2e2018; border: 1px solid #5d4037; color: #a1887f;
      padding: 12px; cursor: pointer; 
      font-family: 'Playfair Display', serif; font-size: 1.1rem; font-weight: bold;
      transition: 0.2s;
    }
    .btn-chord.active { 
      background: var(--gold); color: #2e2018; 
      box-shadow: 0 0 15px rgba(212, 175, 55, 0.4); 
      border-color: #fff; 
    }

    /* Overlay Loading */
    #overlay {
      position: absolute; top:0; left:0; width:100%; height:100%;
      background: rgba(20, 10, 5, 0.95); z-index: 999;
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      border-radius: 8px;
    }
    .btn-load {
      background: transparent; border: 2px solid var(--gold); color: var(--gold);
      padding: 15px 40px; font-size: 1.4rem; font-family: 'Playfair Display', serif;
      border-radius: 0; cursor: pointer; transition: 0.3s;
      text-transform: uppercase; letter-spacing: 2px;
    }
    .btn-load:hover { background: var(--gold); color: #1a120b; box-shadow: 0 0 20px var(--gold); }

    .led-text { font-size: 0.9rem; color: #a1887f; margin-top: 15px; font-style: italic; }

    /* Switch */
    .switch input { display:none; }
    .slider-toggle { background: #3e2723; border: 1px solid #5d4037; color: #888; padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; }
    input:checked + .slider-toggle { color: var(--gold); border-color: var(--gold); font-weight: bold; }

  </style>
</head>
<body>

<div class="studio-rack">
  
  <div id="overlay">
    <h2 style="font-size: 2.5rem; margin-bottom: 30px;">BOLERO PH√íNG TR√Ä</h2>
    <button class="btn-load" onclick="initAudio()">B·∫¨T ƒê√ÄN (POWER ON)</button>
    <div class="led-text" id="load-text">Nh·∫°c v√†ng mu√¥n thu·ªü...</div>
  </div>

  <div style="display:flex; justify-content:space-between; align-items:flex-end; margin-bottom: 15px; border-bottom: 1px solid #3e2723; padding-bottom: 10px;">
    <h2>BOLERO STUDIO</h2>
    <button onclick="applyDefaultPreset()" style="background:transparent; color:#8d6e63; border:1px solid #5d4037; padding:5px 10px; cursor:pointer; font-size:0.7rem;">‚Ü∫ Reset M·∫∑c ƒê·ªãnh</button>
  </div>

  <div class="display-section">
    <div class="eq-controls" style="display:flex; gap: 20px;">
      <div class="knob-group">
        <span class="knob-label">BASS</span>
        <input type="range" class="eq-slider" min="-10" max="10" value="4" oninput="updateEQ('low', this.value)">
      </div>
      <div class="knob-group">
        <span class="knob-label">TREBLE</span>
        <input type="range" class="eq-slider" min="-10" max="10" value="2" oninput="updateEQ('high', this.value)">
      </div>
    </div>

    <div style="text-align:right;">
      <div class="string-monitor" id="str-display">---</div>
      <div class="string-label">D√ÇY ƒêANG G·∫¢Y</div>
    </div>
  </div>

  <div class="timeline-wrapper" id="timeline"></div>

  <div class="control-deck">
    <div style="text-align:center;">
      <div class="knob-label">T·ªêC ƒê·ªò (BPM)</div>
      <div style="display:flex; align-items:center; gap:10px; justify-content:center;">
        <input type="range" id="bpm" min="50" max="120" value="75" style="width:100%; accent-color:var(--gold);" oninput="document.getElementById('bpm-v').innerText=this.value">
        <span id="bpm-v" style="font-family:'Playfair Display'; color:var(--gold); font-size: 1.2rem; font-weight:bold;">75</span>
      </div>
    </div>

    <button id="btn-play" class="btn-main" onclick="togglePlay()">‚ñ∂ B·∫ÆT ƒê·∫¶U CH∆†I</button>

    <div style="text-align:right;">
      <div class="knob-label">T·ª∞ ƒê·ªîI H·ª¢P √ÇM</div>
      <label class="switch" style="cursor:pointer;">
        <input type="checkbox" id="chk-auto" checked> 
        <span class="slider-toggle">T·∫ÆT</span> / <span class="slider-toggle" style="color:var(--gold)">B·∫¨T (2 √î Nh·ªãp)</span>
      </label>
    </div>
  </div>

  <div class="chord-rack">
    <button class="btn-chord active" onclick="setChord('Am')">Am (La Th·ª©)</button>
    <button class="btn-chord" onclick="setChord('Dm')">Dm (R√™ Th·ª©)</button>
    <button class="btn-chord" onclick="setChord('E7')">E7 (Mi 7)</button>
  </div>

  <div style="margin-top:15px; display:flex; justify-content:space-between; align-items:center;">
    <div id="msg-box" style="font-size:0.8rem; color:#8d6e63; font-style:italic;">S·∫µn s√†ng ph·ª•c v·ª•...</div>
    <button onclick="applyNotesToPercent()" style="background:#2e2018; color:var(--gold); border:1px solid var(--gold); padding:6px 15px; cursor:pointer; font-weight:bold; font-size:0.8rem; font-family:'Playfair Display';">C·∫¨P NH·∫¨T NH·ªäP</button>
  </div>

</div>

<script>
  // ================= 1. CONFIGURATION & DATA =================
  const NOTES_VAL = [
    { label: "ùÖù Tr√≤n (4.0)", val: 4.0 },
    { label: "ùÖû Tr·∫Øng (2.0)", val: 2.0 },
    { label: "‚ô© ƒêen (1.0)", val: 1.0 },
    { label: "‚ô™ ƒê∆°n (0.5)", val: 0.5 },
    { label: "ùÖ° K√©p (0.25)", val: 0.25 }
  ];

  // Preset Bolero: ƒê∆°n - K√©p - K√©p - ƒê∆°n ...
  const DEFAULT_PRESET = [
    { label: "B√ôM", type: "bass", val: 0.5, cue: true },   // ƒê∆°n (V√†o h√°t)
    { label: "1", type: "fill", val: 0.25 },  // K√©p
    { label: "2", type: "fill", val: 0.25 },  // K√©p (K·∫øt th√∫c ph√°ch 1)
    { label: "3", type: "fill", val: 0.5 },   // ƒê∆°n (ƒê·∫ßu ph√°ch 2)
    { label: "CH√ÅT", type: "chat", val: 0.5 },// ƒê∆°n (H·∫øt ph√°ch 2)
    { label: "B√ôM", type: "bass", val: 0.5 }, // ƒê∆°n (ƒê·∫ßu ph√°ch 3)
    { label: "CH√ÅT", type: "chat", val: 0.5, cue: true }, // ƒê∆°n (Gi·ªØa ph√°ch 3 - V√†o h√°t)
    { label: "B√ôM+1", type: "bass", val: 0.5 },// ƒê∆°n (ƒê·∫ßu ph√°ch 4)
    { label: "CH√ÅT", type: "chat", val: 0.5 } // ƒê∆°n (H·∫øt ph√°ch 4)
  ];

  let steps = JSON.parse(JSON.stringify(DEFAULT_PRESET));
  
  // Audio Objects
  let guitar = null;
  let eq = null;
  
  // State
  let isPlaying = false;
  let currentStep = 0;
  let timer = null;
  let currentChord = "Am";
  let barCount = 0;

  // Music Theory Data
  const TUNING = [40, 45, 50, 55, 59, 64];
  const CHORDS = { "Am":{b:5,f:[0,0,2,2,1,0]}, "Dm":{b:4,f:[-1,0,0,2,3,1]}, "E7":{b:5,f:[0,2,0,1,0,0]} };
  const LOOP = ["Am","Dm","E7"];

  // ================= 2. UI RENDERER =================
  const timeline = document.getElementById('timeline');

  function renderTimeline() {
    timeline.innerHTML = '';
    
    // T√≠nh t·ªïng gi√° tr·ªã n·ªët ƒë·ªÉ chia % width
    const totalVal = steps.reduce((sum, s) => sum + s.val, 0);

    steps.forEach((step, idx) => {
      const pct = (step.val / totalVal) * 100;
      step.pct = pct; 

      const el = document.createElement('div');
      el.className = `segment type-${step.type} ${step.cue ? 'cue-point' : ''}`;
      el.id = `seg-${idx}`;
      el.style.width = `${pct}%`;

      let opts = "";
      NOTES_VAL.forEach(n => {
        const sel = (step.val === n.val) ? "selected" : "";
        opts += `<option value="${n.val}" ${sel}>${n.label}</option>`;
      });

      const cueHtml = step.cue ? `<div class="cue-icon">H√ÅT</div>` : '';

      el.innerHTML = `
        ${cueHtml}
        <span style="font-weight:bold; font-size:0.75rem; margin-top:5px;">${step.label}</span>
        <select class="note-select" onchange="updateStepVal(${idx}, this.value)">
          ${opts}
        </select>
      `;
      timeline.appendChild(el);
    });
    
    validateTotal(totalVal);
  }

  function updateStepVal(idx, val) {
    steps[idx].val = parseFloat(val);
    document.getElementById('msg-box').innerText = "Vui l√≤ng b·∫•m 'C·∫¨P NH·∫¨T NH·ªäP' ƒë·ªÉ √°p d·ª•ng.";
    document.getElementById('msg-box').style.color = "#d4af37";
  }

  function validateTotal(total) {
    const msg = document.getElementById('msg-box');
    if(total === 4.0) {
      msg.innerText = "‚úì Nh·ªãp 4/4 Chu·∫©n (4.0 Ph√°ch)";
      msg.style.color = "#4caf50";
    } else {
      msg.innerText = `‚ö† L∆∞u √Ω: T·ªïng ƒëang l√† ${total} Ph√°ch (Chu·∫©n l√† 4.0)`;
      msg.style.color = "#ff5252";
    }
  }

  window.applyNotesToPercent = function() {
    renderTimeline();
  }
  
  window.applyDefaultPreset = function() {
    if(isPlaying) togglePlay();
    steps = JSON.parse(JSON.stringify(DEFAULT_PRESET));
    renderTimeline();
  }

  // ================= 3. AUDIO ENGINE (FIXED ERROR) =================
  async function initAudio() {
    const loadText = document.getElementById('load-text');
    loadText.innerText = "ƒêang k·∫øt n·ªëi b·ªô loa (Soundfont)...";
    
    await Tone.start();
    
    try {
      eq = new Tone.EQ3(0, 0, 0).toDestination();
      
      // Load Guitar - S·ª≠ d·ª•ng URL ƒë√°ng tin c·∫≠y ho·∫∑c m·∫∑c ƒë·ªãnh
      // Th√™m try catch trong qu√° tr√¨nh load
      guitar = await Soundfont.instrument(Tone.context.rawContext, 'acoustic_guitar_nylon', { 
        destination: eq,
        gain: 3.0 
      });

      // Default EQ
      updateEQ('low', 4);
      updateEQ('high', 2);

      document.getElementById('overlay').style.display = 'none';
      renderTimeline();
    } catch(e) {
      alert("L·ªói t·∫£i √¢m thanh: " + e + ". Vui l√≤ng l√†m m·ªõi trang.");
      loadText.innerText = "T·∫£i th·∫•t b·∫°i. Vui l√≤ng th·ª≠ l·∫°i.";
    }
  }

  window.updateEQ = function(band, val) {
    if(!eq) return;
    if(band === 'low') eq.low.value = val;
    if(band === 'high') eq.high.value = val;
  }

  // ================= 4. PLAYBACK LOGIC (ROBUST) =================
  function togglePlay() {
    const btn = document.getElementById('btn-play');
    if(isPlaying) {
      isPlaying = false; clearTimeout(timer);
      btn.innerHTML = "‚ñ∂ B·∫ÆT ƒê·∫¶U CH∆†I"; btn.classList.remove('stop');
      document.querySelectorAll('.segment').forEach(s => s.classList.remove('playing'));
      document.getElementById('str-display').innerText = "---";
    } else {
      isPlaying = true; btn.innerHTML = "‚èπ D·ª™NG L·∫†I"; btn.classList.add('stop');
      runLoop();
    }
  }

  function runLoop() {
    if(!isPlaying) return;
    
    playStep(currentStep);
    
    // UI Highlight
    document.querySelectorAll('.segment').forEach(s => s.classList.remove('playing'));
    const currentSeg = document.getElementById(`seg-${currentStep}`);
    if(currentSeg) currentSeg.classList.add('playing');

    const bpm = document.getElementById('bpm').value;
    const beatDurMs = (60/bpm) * 1000; 
    const delay = steps[currentStep].val * beatDurMs;

    currentStep++;
    if(currentStep >= steps.length) {
      currentStep = 0;
      barCount++;
      if(document.getElementById('chk-auto').checked && barCount >= 2) {
        barCount = 0;
        let i = LOOP.indexOf(currentChord);
        setChord(LOOP[(i+1)%LOOP.length]);
      }
    }
    
    timer = setTimeout(runLoop, delay);
  }

  function playStep(idx) {
    if(!guitar) return;
    const s = steps[idx];
    const c = CHORDS[currentChord];
    const now = Tone.now();
    const getN = (str) => { 
      let i=6-str; 
      if(i < 0 || i >= TUNING.length) return null;
      let f=c.f[i]; 
      return (f===-1)?null:TUNING[i]+f; 
    };
    
    const dur = s.val * 0.6; 
    let dispStr = "";

    // === TRY CATCH BLOCK ƒê·ªÇ CH·ªêNG CRASH ===
    try {
      if(s.label === "B√ôM") {
        let n = getN(c.b);
        safePlay([n], dur, 1.2);
        dispStr = `D√ÇY ${c.b}`;
      }
      else if(s.label === "B√ôM+1") {
         let alt = c.b+1; if(alt>6) alt=c.b-1;
         safePlay([getN(alt)], dur, 1.1);
         dispStr = `D√ÇY ${alt}`;
      }
      else if(s.label === "1") {
        safePlay([getN(c.b-1)], 0.3, 0.7);
        dispStr = `D√ÇY ${c.b-1}`;
      }
      else if(s.label === "2") {
        safePlay([getN(c.b-2)], 0.3, 0.7);
        dispStr = `D√ÇY ${c.b-2}`;
      }
      else if(s.label === "3") { 
         [3,2,1].forEach((st,i) => { 
           let n=getN(st); 
           if(n) safePlaySingle(n, now+i*0.015, dur, 0.8);
         });
         dispStr = "QU·∫†T 3-2-1";
      }
      else if(s.label === "CH√ÅT") { 
         [1,2,3].forEach((st,i) => { 
           let n=getN(st); 
           if(n) safePlaySingle(n, now+i*0.01, 0.1, 0.9, 0.05);
         });
         dispStr = "CH√ÅT (L√äN)";
      }
    } catch(err) {
      console.warn("L·ªói ph√°t n·ªët (ƒë√£ b·ªè qua):", err);
    }

    document.getElementById('str-display').innerText = dispStr;
  }
  
  function safePlay(ns, d, v) { 
    ns.forEach(n => { 
      if(n !== null && n !== undefined) {
        try { guitar.play(n, Tone.now(), {duration:d, gain:v}); } 
        catch(e) { console.warn("Skip note:", n); }
      }
    }); 
  }

  function safePlaySingle(n, time, dur, gain, release) {
    if(n !== null && n !== undefined) {
      try { 
        let opts = {duration:dur, gain:gain};
        if(release) opts.release = release;
        guitar.play(n, time, opts); 
      } 
      catch(e) { console.warn("Skip note:", n); }
    }
  }

  window.setChord = function(c) {
    currentChord = c;
    document.querySelectorAll('.btn-chord').forEach(b => b.classList.toggle('active', b.innerText.includes(c)));
  }
</script>
</body>
</html>
