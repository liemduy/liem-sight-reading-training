<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Bolero Studio Pro - Ultimate</title>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.18/Tone.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/soundfont-player@0.12.0/dist/soundfont-player.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg: #18181b; 
      --panel: #27272a;
      --accent: #00e676; /* Xanh l√° neon */
      --accent-dim: rgba(0, 230, 118, 0.2);
      --cue-color: #ff3d00; /* Cam ƒë·ªè cho ƒëi·ªÉm nh·∫•n */
      --text: #e4e4e7;
      --led-off: #3f3f46;
      --led-on: #00e676;
      --knob: #52525b;
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Roboto', sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 10px;
      margin: 0;
      user-select: none;
    }

    h2 {
      font-family: 'Orbitron', sans-serif;
      color: var(--accent);
      margin: 10px 0;
      text-shadow: 0 0 10px var(--accent-dim);
      letter-spacing: 2px;
    }

    .studio-rack {
      background: var(--panel);
      padding: 20px;
      border-radius: 16px;
      width: 100%;
      max-width: 950px;
      border: 1px solid #444;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
      position: relative;
    }

    /* === LED DISPLAY SECTION === */
    .display-section {
      background: #000;
      border: 2px solid #555;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: inset 0 0 20px rgba(0,0,0,0.8);
    }

    .eq-controls {
      display: flex;
      gap: 15px;
    }
    
    .knob-group {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    
    .knob-label { font-size: 0.7rem; color: #888; margin-bottom: 5px; font-weight: bold; }
    
    /* Range Slider styled as generic slider for EQ */
    input[type=range].eq-slider {
      -webkit-appearance: none;
      width: 80px; height: 6px; background: #333; border-radius: 3px;
    }
    input[type=range].eq-slider::-webkit-slider-thumb {
      -webkit-appearance: none; width: 14px; height: 14px; background: var(--accent); border-radius: 50%; cursor: pointer;
    }

    .string-monitor {
      font-family: 'Orbitron', monospace;
      font-size: 2rem;
      color: var(--led-on);
      text-shadow: 0 0 10px var(--led-on);
      min-width: 150px;
      text-align: right;
    }
    .string-label { font-size: 0.8rem; color: #555; font-family: sans-serif; text-align: right; margin-top: -5px;}

    /* === TIMELINE === */
    .timeline-wrapper {
      position: relative;
      height: 130px;
      width: 100%;
      background: #111;
      border: 1px solid #333;
      border-radius: 6px;
      display: flex;
      overflow: hidden;
      margin-bottom: 20px;
    }

    .segment {
      position: relative;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      border-right: 1px solid #222;
      transition: background 0.1s;
    }

    /* M√†u ph√¢n lo·∫°i */
    .type-bass { background: linear-gradient(180deg, #4a1c1c 0%, #2a0a0a 100%); color: #ff8a80; }
    .type-fill { background: linear-gradient(180deg, #1c3a4a 0%, #0a1a2a 100%); color: #80d8ff; }
    .type-chat { background: linear-gradient(180deg, #1a3a30 0%, #0a201a 100%); color: #a7ffeb; }

    /* Hi·ªáu ·ª©ng ƒëang ch·∫°y */
    .segment.playing {
      filter: brightness(1.8);
      box-shadow: 0 0 15px currentColor;
      z-index: 2;
    }

    /* Hi·ªáu ·ª©ng CUE (V√†o c√¢u h√°t) */
    .segment.cue-point {
      border-top: 3px solid var(--cue-color);
      border-bottom: 3px solid var(--cue-color);
    }
    .segment.cue-point.playing {
      box-shadow: 0 0 20px var(--cue-color), inset 0 0 20px var(--cue-color);
      border-color: #fff;
      animation: cueFlash 0.2s infinite alternate;
    }

    @keyframes cueFlash {
      from { border-color: var(--cue-color); }
      to { border-color: #fff; }
    }

    .cue-icon {
      position: absolute; top: 5px; right: 5px;
      font-size: 0.7rem; color: var(--cue-color); font-weight: bold;
      opacity: 0.8;
      border: 1px solid var(--cue-color); padding: 1px 3px; border-radius: 3px;
    }

    .note-select {
      background: rgba(0,0,0,0.5); border: 1px solid #444; color: #fff;
      font-size: 0.7rem; margin-top: 5px; width: 90%; border-radius: 4px;
    }

    /* === CONTROLS === */
    .control-deck {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 15px;
      align-items: center;
      margin-bottom: 15px;
    }

    .btn-main {
      background: var(--accent); color: #000;
      border: none; padding: 15px; font-size: 1.1rem; font-weight: bold;
      border-radius: 4px; cursor: pointer; width: 100%;
      box-shadow: 0 4px 0 #00600f;
      transition: transform 0.1s;
    }
    .btn-main:active { transform: translateY(4px); box-shadow: none; }
    .btn-main.stop { background: #d32f2f; color: #fff; box-shadow: 0 4px 0 #9a0007; }

    .chord-rack { display: flex; gap: 5px; background: #000; padding: 5px; border-radius: 6px; border: 1px solid #333; }
    .btn-chord {
      flex: 1; background: #222; border: 1px solid #333; color: #888;
      padding: 10px; cursor: pointer; font-family: 'Orbitron', sans-serif;
    }
    .btn-chord.active { background: var(--accent); color: #000; box-shadow: 0 0 10px var(--accent); border-color: var(--accent); }

    /* Overlay */
    #overlay {
      position: absolute; top:0; left:0; width:100%; height:100%;
      background: rgba(0,0,0,0.95); z-index: 999;
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      border-radius: 16px;
    }
    .btn-load {
      background: transparent; border: 2px solid var(--accent); color: var(--accent);
      padding: 15px 40px; font-size: 1.5rem; font-family: 'Orbitron', sans-serif;
      border-radius: 50px; cursor: pointer; transition: 0.3s;
    }
    .btn-load:hover { background: var(--accent); color: #000; box-shadow: 0 0 20px var(--accent); }

    .led-text { font-size: 0.8rem; color: #aaa; margin-top: 5px; }

  </style>
</head>
<body>

<div class="studio-rack">
  
  <div id="overlay">
    <h2>BOLERO STUDIO</h2>
    <button class="btn-load" onclick="initAudio()">POWER ON</button>
    <div class="led-text">Loading Sound Modules...</div>
  </div>

  <div style="display:flex; justify-content:space-between; align-items:flex-end; margin-bottom: 10px;">
    <h2>PRO ARCHITECT V2</h2>
    <button onclick="applyDefaultPreset()" style="background:#333; color:#fff; border:none; padding:5px 10px; cursor:pointer; font-size:0.7rem; border-radius:4px;">Reset Preset</button>
  </div>

  <div class="display-section">
    <div class="eq-controls">
      <div class="knob-group">
        <span class="knob-label">BASS</span>
        <input type="range" class="eq-slider" min="-10" max="10" value="4" oninput="updateEQ('low', this.value)">
      </div>
      <div class="knob-group">
        <span class="knob-label">TREBLE</span>
        <input type="range" class="eq-slider" min="-10" max="10" value="2" oninput="updateEQ('high', this.value)">
      </div>
    </div>

    <div style="text-align:right;">
      <div class="string-monitor" id="str-display">---</div>
      <div class="string-label">ACTIVE STRING</div>
    </div>
  </div>

  <div class="timeline-wrapper" id="timeline"></div>

  <div class="control-deck">
    <div style="background:#111; padding:10px; border-radius:6px; border:1px solid #333;">
      <div class="knob-label">TEMPO (BPM)</div>
      <div style="display:flex; align-items:center; gap:10px;">
        <input type="range" id="bpm" min="50" max="120" value="75" style="width:100%; accent-color:var(--accent);" oninput="document.getElementById('bpm-v').innerText=this.value">
        <span id="bpm-v" style="font-family:'Orbitron'; color:var(--accent);">75</span>
      </div>
    </div>

    <button id="btn-play" class="btn-main" onclick="togglePlay()">‚ñ∂ START SEQUENCE</button>

    <div style="background:#111; padding:10px; border-radius:6px; border:1px solid #333; display:flex; align-items:center; justify-content:space-between;">
      <span class="knob-label" style="margin:0;">AUTO CHORD</span>
      <label class="switch" style="font-size:0.8rem; color:#fff; display:flex; align-items:center; gap:5px; cursor:pointer;">
        <input type="checkbox" id="chk-auto" checked> 
        <span style="color:var(--accent)">ON</span> (Every 2 Bars)
      </label>
    </div>
  </div>

  <div class="chord-rack">
    <button class="btn-chord active" onclick="setChord('Am')">Am</button>
    <button class="btn-chord" onclick="setChord('Dm')">Dm</button>
    <button class="btn-chord" onclick="setChord('E7')">E7</button>
  </div>

  <div style="margin-top:10px; display:flex; justify-content:space-between; align-items:center;">
    <div id="msg-box" style="font-size:0.8rem; color:#666;">Ready.</div>
    <button onclick="applyNotesToPercent()" style="background:var(--accent-dim); color:var(--accent); border:1px solid var(--accent); padding:5px 15px; cursor:pointer; font-weight:bold; border-radius:4px;">RE-CALCULATE TIMELINE</button>
  </div>

</div>

<script>
  // ================= 1. CONFIGURATION & DATA =================
  const NOTES_VAL = [
    { label: "ùÖù Tr√≤n (4.0)", val: 4.0 },
    { label: "ùÖû Tr·∫Øng (2.0)", val: 2.0 },
    { label: "‚ô© ƒêen (1.0)", val: 1.0 },
    { label: "‚ô™ ƒê∆°n (0.5)", val: 0.5 },
    { label: "ùÖ° K√©p (0.25)", val: 0.25 }
  ];

  // Preset theo y√™u c·∫ßu: ƒê∆°n - K√©p - K√©p - ƒê∆°n ...
  // T·ªïng = 4.0 Ph√°ch
  const DEFAULT_PRESET = [
    { label: "B√ôM", type: "bass", val: 0.5, cue: true },   // ƒê∆°n (V√†o h√°t)
    { label: "1", type: "fill", val: 0.25 },  // K√©p
    { label: "2", type: "fill", val: 0.25 },  // K√©p (K·∫øt th√∫c ph√°ch 1)
    { label: "3", type: "fill", val: 0.5 },   // ƒê∆°n (ƒê·∫ßu ph√°ch 2)
    { label: "CH√ÅT", type: "chat", val: 0.5 },// ƒê∆°n (H·∫øt ph√°ch 2)
    { label: "B√ôM", type: "bass", val: 0.5 }, // ƒê∆°n (ƒê·∫ßu ph√°ch 3)
    { label: "CH√ÅT", type: "chat", val: 0.5, cue: true }, // ƒê∆°n (Gi·ªØa ph√°ch 3 - V√†o h√°t)
    { label: "B√ôM+1", type: "bass", val: 0.5 },// ƒê∆°n (ƒê·∫ßu ph√°ch 4)
    { label: "CH√ÅT", type: "chat", val: 0.5 } // ƒê∆°n (H·∫øt ph√°ch 4)
  ];

  let steps = JSON.parse(JSON.stringify(DEFAULT_PRESET));
  
  // Audio Objects
  let guitar = null;
  let eq = null;
  
  // State
  let isPlaying = false;
  let currentStep = 0;
  let timer = null;
  let currentChord = "Am";
  let barCount = 0;

  // Music Theory Data
  const TUNING = [40, 45, 50, 55, 59, 64];
  const CHORDS = { "Am":{b:5,f:[0,0,2,2,1,0]}, "Dm":{b:4,f:[-1,0,0,2,3,1]}, "E7":{b:5,f:[0,2,0,1,0,0]} };
  const LOOP = ["Am","Dm","E7"];

  // ================= 2. UI RENDERER =================
  const timeline = document.getElementById('timeline');

  function renderTimeline() {
    timeline.innerHTML = '';
    
    // T√≠nh t·ªïng gi√° tr·ªã n·ªët ƒë·ªÉ chia % width
    const totalVal = steps.reduce((sum, s) => sum + s.val, 0);

    steps.forEach((step, idx) => {
      // T√≠nh % width
      const pct = (step.val / totalVal) * 100;
      step.pct = pct; 

      const el = document.createElement('div');
      el.className = `segment type-${step.type} ${step.cue ? 'cue-point' : ''}`;
      el.id = `seg-${idx}`;
      el.style.width = `${pct}%`;

      // T·∫°o Dropdown option
      let opts = "";
      NOTES_VAL.forEach(n => {
        const sel = (step.val === n.val) ? "selected" : "";
        opts += `<option value="${n.val}" ${sel}>${n.label}</option>`;
      });

      // Cue Icon (ƒêi·ªÉm v√†o h√°t)
      const cueHtml = step.cue ? `<div class="cue-icon">CUE</div>` : '';

      el.innerHTML = `
        ${cueHtml}
        <span style="font-weight:bold; font-size:0.8rem; margin-top:5px;">${step.label}</span>
        <select class="note-select" onchange="updateStepVal(${idx}, this.value)">
          ${opts}
        </select>
      `;
      timeline.appendChild(el);
    });
    
    validateTotal(totalVal);
  }

  function updateStepVal(idx, val) {
    steps[idx].val = parseFloat(val);
    // L∆∞u √Ω: User ph·∫£i b·∫•m Re-Calculate ƒë·ªÉ UI update width
    document.getElementById('msg-box').innerText = "Changes pending. Click Re-Calculate.";
    document.getElementById('msg-box').style.color = "#ff9f1c";
  }

  function validateTotal(total) {
    const msg = document.getElementById('msg-box');
    if(total === 4.0) {
      msg.innerText = "‚úì Perfect 4/4 Rhythm (4.0 Beats)";
      msg.style.color = "#00e676";
    } else {
      msg.innerText = `‚ö† Warning: Total is ${total} Beats (Standard is 4.0)`;
      msg.style.color = "#ff5252";
    }
  }

  window.applyNotesToPercent = function() {
    renderTimeline();
  }
  
  window.applyDefaultPreset = function() {
    if(isPlaying) togglePlay();
    steps = JSON.parse(JSON.stringify(DEFAULT_PRESET));
    renderTimeline();
  }

  // ================= 3. AUDIO ENGINE & EQ =================
  async function initAudio() {
    document.querySelector('.led-text').innerText = "Connecting Audio Context...";
    await Tone.start();
    
    try {
      // Create EQ (Low, Mid, High)
      eq = new Tone.EQ3(0, 0, 0).toDestination();
      
      // Load Guitar and connect to EQ
      guitar = await Soundfont.instrument(Tone.context.rawContext, 'acoustic_guitar_nylon', { 
        destination: eq,
        gain: 3.0 // Boost gain
      });

      // Set initial EQ values from sliders
      updateEQ('low', 4);
      updateEQ('high', 2);

      document.getElementById('overlay').style.display = 'none';
      renderTimeline();
    } catch(e) {
      alert("Audio Error: " + e);
    }
  }

  window.updateEQ = function(band, val) {
    if(!eq) return;
    // Tone EQ value range usually -10 to 10 db is good for sliders
    if(band === 'low') eq.low.value = val;
    if(band === 'high') eq.high.value = val;
  }

  // ================= 4. PLAYBACK LOGIC =================
  function togglePlay() {
    const btn = document.getElementById('btn-play');
    if(isPlaying) {
      isPlaying = false; clearTimeout(timer);
      btn.innerHTML = "‚ñ∂ START SEQUENCE"; btn.classList.remove('stop');
      document.querySelectorAll('.segment').forEach(s => s.classList.remove('playing'));
      document.getElementById('str-display').innerText = "---";
    } else {
      isPlaying = true; btn.innerHTML = "‚èπ STOP SEQUENCE"; btn.classList.add('stop');
      runLoop();
    }
  }

  function runLoop() {
    if(!isPlaying) return;
    
    // Play & Visualize
    playStep(currentStep);
    
    // UI Highlight
    document.querySelectorAll('.segment').forEach(s => s.classList.remove('playing'));
    document.getElementById(`seg-${currentStep}`).classList.add('playing');

    // Calc Delay
    const bpm = document.getElementById('bpm').value;
    const totalVal = steps.reduce((sum,s)=>sum+s.val,0); // T·ªïng s·ªë ph√°ch hi·ªán t·∫°i
    const beatDurMs = (60/bpm) * 1000; // 1 ph√°ch d√†i bao nhi√™u ms
    
    // Duration c·ªßa step hi·ªán t·∫°i = gi√° tr·ªã n·ªët * ƒë·ªô d√†i 1 ph√°ch
    const delay = steps[currentStep].val * beatDurMs;

    // Next Step
    currentStep++;
    if(currentStep >= steps.length) {
      currentStep = 0;
      barCount++;
      if(document.getElementById('chk-auto').checked && barCount >= 2) {
        barCount = 0;
        let i = LOOP.indexOf(currentChord);
        setChord(LOOP[(i+1)%LOOP.length]);
      }
    }
    
    timer = setTimeout(runLoop, delay);
  }

  function playStep(idx) {
    if(!guitar) return;
    const s = steps[idx];
    const c = CHORDS[currentChord];
    const now = Tone.now();
    const getN = (str) => { let i=6-str; let f=c.f[i]; return (f===-1)?null:TUNING[i]+f; };
    
    // Calculate Duration in seconds for Tone.js (Approximate based on value)
    // 1.0 val ~ 0.5s at 120bpm. We use generic ratio here.
    const dur = s.val * 0.6; 
    let dispStr = "";

    if(s.label === "B√ôM") {
      let n = getN(c.b);
      playNotes([n], dur, 1.2);
      dispStr = `STR ${c.b}`;
    }
    else if(s.label === "B√ôM+1") {
       let alt = c.b+1; if(alt>6) alt=c.b-1;
       playNotes([getN(alt)], dur, 1.1);
       dispStr = `STR ${alt}`;
    }
    else if(s.label === "1") {
      playNotes([getN(c.b-1)], 0.3, 0.7);
      dispStr = `STR ${c.b-1}`;
    }
    else if(s.label === "2") {
      playNotes([getN(c.b-2)], 0.3, 0.7);
      dispStr = `STR ${c.b-2}`;
    }
    else if(s.label === "3") { // Strum down
       [3,2,1].forEach((st,i) => { let n=getN(st); if(n) guitar.play(n, now+i*0.015, {duration:dur, gain:0.8}); });
       dispStr = "STR 3-2-1";
    }
    else if(s.label === "CH√ÅT") { // Strum up mute
       [1,2,3].forEach((st,i) => { let n=getN(st); if(n) guitar.play(n, now+i*0.01, {duration:0.1, gain:0.9, release:0.05}); });
       dispStr = "CHAT";
    }

    // Update LED Display
    document.getElementById('str-display').innerText = dispStr;
  }
  
  function playNotes(ns, d, v) { ns.forEach(n => { if(n) guitar.play(n, Tone.now(), {duration:d, gain:v}); }); }

  window.setChord = function(c) {
    currentChord = c;
    document.querySelectorAll('.btn-chord').forEach(b => b.classList.toggle('active', b.innerText === c));
  }
</script>
</body>
</html>
