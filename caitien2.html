<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Bolero Tea Room - V4 Final</title>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.18/Tone.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/soundfont-player@0.12.0/dist/soundfont-player.min.js"></script>
  
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Roboto:wght@300;400&display=swap" rel="stylesheet">

  <style>
    /* === GIAO DI·ªÜN & M√ÄU S·∫ÆC === */
    :root {
      --bg: #1a120b; 
      --panel: #2e2018; 
      --gold: #d4af37; 
      --gold-dim: #8c7322;
      --cream: #f5f5dc; 
      --text: #efebe9; 
      --highlight: #ffecb3; 
      --cue-color: #ff6f00;
    }
    body {
      background: var(--bg);
      background-image: radial-gradient(circle at center, #2c1e16 0%, #0d0805 100%);
      color: var(--text); 
      font-family: 'Roboto', sans-serif;
      display: flex; flex-direction: column; align-items: center;
      padding: 15px; margin: 0; user-select: none; min-height: 100vh;
    }
    
    /* Typography */
    h2 {
      font-family: 'Playfair Display', serif; color: var(--gold); margin: 10px 0;
      text-transform: uppercase; letter-spacing: 2px; text-shadow: 0 2px 4px rgba(0,0,0,0.8);
      font-size: 1.8rem; border-bottom: 1px solid var(--gold-dim); padding-bottom: 10px;
    }

    /* Khung ch√≠nh */
    .studio-rack {
      background: var(--panel); padding: 25px; border-radius: 8px; width: 100%; max-width: 950px;
      border: 1px solid #4e342e; box-shadow: 0 15px 40px rgba(0,0,0,0.7); position: relative;
      background-image: repeating-linear-gradient(45deg, rgba(255,255,255,0.02) 0px, rgba(255,255,255,0.02) 2px, transparent 2px, transparent 4px);
    }

    /* M√†n h√¨nh hi·ªÉn th·ªã */
    .display-section {
      background: #18100c; border: 3px double var(--gold-dim); border-radius: 4px;
      padding: 15px; margin-bottom: 25px; display: flex; justify-content: space-between; align-items: center;
      box-shadow: inset 0 0 30px rgba(0,0,0,0.9);
    }
    .knob-group { display: flex; flex-direction: column; align-items: center; margin-right: 15px; }
    .knob-label { font-family: 'Playfair Display', serif; font-size: 0.8rem; color: var(--gold); margin-bottom: 5px; letter-spacing: 1px; }
    
    /* Sliders EQ */
    input[type=range].eq-slider { -webkit-appearance: none; width: 100px; height: 4px; background: #4e342e; border-radius: 2px; }
    input[type=range].eq-slider::-webkit-slider-thumb {
      -webkit-appearance: none; width: 16px; height: 16px; background: var(--gold); border: 2px solid #fff; border-radius: 50%; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.5);
    }

    /* Hi·ªÉn th·ªã d√¢y */
    .string-monitor {
      font-family: 'Playfair Display', serif; font-style: italic; font-size: 1.8rem; color: var(--highlight);
      text-shadow: 0 0 5px var(--gold); min-width: 150px; text-align: right;
    }
    .string-label { font-size: 0.7rem; color: #8d6e63; text-align: right; text-transform: uppercase; letter-spacing: 2px;}

    /* Timeline (Thanh nh·ªãp ƒëi·ªáu) */
    .timeline-wrapper {
      position: relative; height: 140px; width: 100%; background: #231711;
      border: 2px solid var(--gold-dim); border-radius: 4px; display: flex; overflow: hidden; margin-bottom: 25px;
      box-shadow: inset 0 0 20px #000;
    }
    .segment {
      position: relative; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center;
      border-right: 1px solid rgba(212, 175, 55, 0.2); transition: background 0.1s;
    }
    .type-bass { background: linear-gradient(to bottom, #3e2723, #281815); color: #ffcc80; }
    .type-fill { background: linear-gradient(to bottom, #263238, #161e22); color: #b0bec5; }
    .type-chat { background: linear-gradient(to bottom, #1b5e20, #0d3311); color: #a5d6a7; }
    
    .segment.playing { filter: brightness(1.5); box-shadow: inset 0 0 30px var(--gold); border: 1px solid var(--gold); z-index: 2; }
    .segment.cue-point { border-top: 4px solid var(--cue-color); }
    
    .cue-icon {
      position: absolute; top: 4px; right: 4px; font-size: 0.6rem; color: var(--cue-color);
      border: 1px solid var(--cue-color); padding: 1px 3px; border-radius: 2px; background: rgba(0,0,0,0.5);
    }
    .note-select {
      background: rgba(0,0,0,0.3); border: 1px solid var(--gold-dim); color: var(--cream);
      font-size: 0.7rem; margin-top: 8px; width: 90%; border-radius: 2px; font-family: 'Roboto', sans-serif;
    }

    /* Control Deck */
    .control-deck {
      display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; align-items: center; margin-bottom: 20px;
      background: #241914; padding: 15px; border-radius: 6px; border: 1px solid #3e2723;
    }
    .btn-main {
      background: linear-gradient(to bottom, #d4af37, #b08d26); color: #3e2723; border: 1px solid #ffe082;
      padding: 15px; font-size: 1.1rem; font-weight: bold; border-radius: 4px; cursor: pointer; width: 100%;
      box-shadow: 0 4px 6px rgba(0,0,0,0.5); font-family: 'Playfair Display', serif; text-transform: uppercase; transition: all 0.1s;
    }
    .btn-main:active { transform: translateY(2px); box-shadow: 0 1px 2px rgba(0,0,0,0.5); }
    .btn-main:disabled { filter: grayscale(1); cursor: not-allowed; }
    .btn-main.stop { background: linear-gradient(to bottom, #c62828, #8e0000); color: #fff; border-color: #ff8a80; }

    /* H·ª£p √¢m */
    .chord-rack {
      display: flex; gap: 10px; background: #1a120b; padding: 10px; border-radius: 6px;
      border: 1px solid var(--gold-dim); justify-content: center;
    }
    .btn-chord {
      flex: 1; background: #2e2018; border: 1px solid #5d4037; color: #a1887f; padding: 12px;
      cursor: pointer; font-family: 'Playfair Display', serif; font-size: 1.1rem; font-weight: bold; transition: 0.2s;
    }
    .btn-chord.active {
      background: var(--gold); color: #2e2018; box-shadow: 0 0 15px rgba(212, 175, 55, 0.4); border-color: #fff;
    }

    /* M√†n h√¨nh ch·ªù (Overlay) */
    #overlay {
      position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(20, 10, 5, 0.98); z-index: 999;
      display: flex; flex-direction: column; justify-content: center; align-items: center; border-radius: 8px;
    }
    .btn-load {
      background: transparent; border: 2px solid var(--gold); color: var(--gold); padding: 15px 40px;
      font-size: 1.4rem; font-family: 'Playfair Display', serif; cursor: pointer;
      transition: 0.3s; text-transform: uppercase; letter-spacing: 2px;
    }
    .btn-load:hover { background: var(--gold); color: #1a120b; box-shadow: 0 0 20px var(--gold); }
    .led-text { font-size: 1rem; color: #a1887f; margin-top: 20px; font-style: italic; min-height: 20px; }
    
    /* Toggle Switch */
    .switch input { display:none; }
    .slider-toggle { background: #3e2723; border: 1px solid #5d4037; color: #888; padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; }
    input:checked + .slider-toggle { color: var(--gold); border-color: var(--gold); font-weight: bold; }
  </style>
</head>
<body>

<div class="studio-rack">
  
  <div id="overlay">
    <h2 style="font-size: 2.5rem; margin-bottom: 30px; border:none;">BOLERO PH√íNG TR√Ä</h2>
    <button class="btn-load" onclick="initAudio()">B·∫¨T ƒê√ÄN (START)</button>
    <div class="led-text" id="load-text">Nh·∫°c v√†ng mu√¥n thu·ªü...</div>
  </div>

  <div style="display:flex; justify-content:space-between; align-items:flex-end; margin-bottom: 15px; border-bottom: 1px solid #3e2723; padding-bottom: 10px;">
    <h2>BOLERO STUDIO</h2>
    <button onclick="applyDefaultPreset()" style="background:transparent; color:#8d6e63; border:1px solid #5d4037; padding:5px 10px; cursor:pointer; font-size:0.7rem;">‚Ü∫ Reset M·∫∑c ƒê·ªãnh</button>
  </div>

  <div class="display-section">
    <div class="eq-controls" style="display:flex; gap: 20px;">
      <div class="knob-group">
        <span class="knob-label">BASS EQ</span>
        <input type="range" class="eq-slider" min="-10" max="10" value="4" oninput="updateEQ('low', this.value)">
      </div>
      <div class="knob-group">
        <span class="knob-label">TREBLE EQ</span>
        <input type="range" class="eq-slider" min="-10" max="10" value="2" oninput="updateEQ('high', this.value)">
      </div>
    </div>
    <div style="text-align:right;">
      <div class="string-monitor" id="str-display">---</div>
      <div class="string-label">TR·∫†NG TH√ÅI</div>
    </div>
  </div>

  <div class="timeline-wrapper" id="timeline"></div>

  <div class="control-deck">
    <div style="text-align:center;">
      <div class="knob-label">T·ªêC ƒê·ªò (BPM)</div>
      <div style="display:flex; align-items:center; gap:10px; justify-content:center;">
        <input type="range" id="bpm" min="50" max="120" value="75" style="width:100%; accent-color:var(--gold);" oninput="document.getElementById('bpm-v').innerText=this.value">
        <span id="bpm-v" style="font-family:'Playfair Display'; color:var(--gold); font-size: 1.2rem; font-weight:bold;">75</span>
      </div>
    </div>
    
    <button id="btn-play" class="btn-main" onclick="togglePlay()">‚ñ∂ B·∫ÆT ƒê·∫¶U CH∆†I</button>
    
    <div style="text-align:right;">
      <div class="knob-label">T·ª∞ ƒê·ªîI H·ª¢P √ÇM</div>
      <label class="switch" style="cursor:pointer;">
        <input type="checkbox" id="chk-auto" checked> 
        <span class="slider-toggle">T·∫ÆT</span> / <span class="slider-toggle" style="color:var(--gold)">B·∫¨T (2 Bar)</span>
      </label>
    </div>
  </div>

  <div class="chord-rack">
    <button class="btn-chord active" onclick="setChord('Am')">Am (La Th·ª©)</button>
    <button class="btn-chord" onclick="setChord('Dm')">Dm (R√™ Th·ª©)</button>
    <button class="btn-chord" onclick="setChord('E7')">E7 (Mi 7)</button>
  </div>

  <div style="margin-top:15px; display:flex; justify-content:space-between; align-items:center;">
    <div id="msg-box" style="font-size:0.8rem; color:#8d6e63; font-style:italic;">S·∫µn s√†ng ph·ª•c v·ª•...</div>
    <button onclick="applyNotesToPercent()" style="background:#2e2018; color:var(--gold); border:1px solid var(--gold); padding:6px 15px; cursor:pointer; font-weight:bold; font-size:0.8rem; font-family:'Playfair Display';">C·∫¨P NH·∫¨T NH·ªäP</button>
  </div>
</div>

<script>
  /* =========================================
     1. C·∫§U H√åNH D·ªÆ LI·ªÜU & LOGIC BAN ƒê·∫¶U
     ========================================= */
  const NOTES_VAL = [
    { label: "ùÖù Tr√≤n (4.0)", val: 4.0 }, { label: "ùÖû Tr·∫Øng (2.0)", val: 2.0 },
    { label: "‚ô© ƒêen (1.0)", val: 1.0 }, { label: "‚ô™ ƒê∆°n (0.5)", val: 0.5 },
    { label: "ùÖ° K√©p (0.25)", val: 0.25 }
  ];

  // Preset Bolero chu·∫©n
  const DEFAULT_PRESET = [
    { label: "B√ôM", type: "bass", val: 0.5, cue: true },
    { label: "1", type: "fill", val: 0.25 },
    { label: "2", type: "fill", val: 0.25 },
    { label: "3", type: "fill", val: 0.5 },
    { label: "CH√ÅT", type: "chat", val: 0.5 },
    { label: "B√ôM", type: "bass", val: 0.5 },
    { label: "CH√ÅT", type: "chat", val: 0.5, cue: true },
    { label: "B√ôM+1", type: "bass", val: 0.5 },
    { label: "CH√ÅT", type: "chat", val: 0.5 }
  ];
  
  let steps = JSON.parse(JSON.stringify(DEFAULT_PRESET));
  let guitar = null;
  let eq = null;
  let isPlaying = false;
  let currentStep = 0;
  let timer = null;
  let currentChord = "Am";
  let barCount = 0;

  // D·ªØ li·ªáu h·ª£p √¢m v√† n·ªët
  const TUNING = [40, 45, 50, 55, 59, 64]; // E A D G B E
  const CHORDS = { 
    "Am":{b:5,f:[0,0,2,2,1,0]}, 
    "Dm":{b:4,f:[-1,0,0,2,3,1]}, 
    "E7":{b:5,f:[0,2,0,1,0,0]} 
  };
  const LOOP_SEQUENCE = ["Am","Dm","E7"];

  /* =========================================
     2. H·ªÜ TH·ªêNG GIAO DI·ªÜN (UI RENDER)
     ========================================= */
  const timeline = document.getElementById('timeline');
  
  function renderTimeline() {
    timeline.innerHTML = '';
    const totalVal = steps.reduce((sum, s) => sum + s.val, 0);
    
    steps.forEach((step, idx) => {
      const pct = (step.val / totalVal) * 100;
      const el = document.createElement('div');
      el.className = `segment type-${step.type} ${step.cue ? 'cue-point' : ''}`;
      el.id = `seg-${idx}`;
      el.style.width = `${pct}%`;
      
      let opts = "";
      NOTES_VAL.forEach(n => {
        const sel = (step.val === n.val) ? "selected" : "";
        opts += `<option value="${n.val}" ${sel}>${n.label}</option>`;
      });
      
      const cueHtml = step.cue ? `<div class="cue-icon">H√ÅT</div>` : '';
      el.innerHTML = `${cueHtml}
        <span style="font-weight:bold; font-size:0.75rem; margin-top:5px;">${step.label}</span>
        <select class="note-select" onchange="updateStepVal(${idx}, this.value)">${opts}</select>`;
      timeline.appendChild(el);
    });
    validateTotal(totalVal);
  }

  function updateStepVal(idx, val) {
    steps[idx].val = parseFloat(val);
    document.getElementById('msg-box').innerText = "‚ö† D·ªØ li·ªáu thay ƒë·ªïi. Vui l√≤ng b·∫•m 'C·∫¨P NH·∫¨T NH·ªäP'";
    document.getElementById('msg-box').style.color = "#d4af37";
  }

  function validateTotal(total) {
    const msg = document.getElementById('msg-box');
    if(total === 4.0) { 
        msg.innerText = "‚úì Nh·ªãp 4/4 Chu·∫©n (T·ªïng: 4.0 Ph√°ch)"; 
        msg.style.color = "#4caf50"; 
    } else { 
        msg.innerText = `‚ö† L∆∞u √Ω: T·ªïng nh·ªãp l√† ${total} (Chu·∫©n Bolero l√† 4.0)`; 
        msg.style.color = "#ff5252"; 
    }
  }

  window.applyNotesToPercent = function() { renderTimeline(); }
  window.applyDefaultPreset = function() { 
    if(isPlaying) togglePlay(); 
    steps = JSON.parse(JSON.stringify(DEFAULT_PRESET)); 
    renderTimeline(); 
  }

  /* =========================================
     3. AUDIO ENGINE (FIXED & ROBUST)
     ========================================= */
  async function initAudio() {
    const loadText = document.getElementById('load-text');
    const btnLoad = document.querySelector('.btn-load');
    
    loadText.innerText = "ƒêang kh·ªüi ƒë·ªông Tone.js...";
    btnLoad.disabled = true;

    // 1. Kh·ªüi ƒë·ªông Audio Context
    await Tone.start();
    loadText.innerText = "ƒêang t·∫£i b·ªô ti·∫øng Guitar (Nylon)...";

    try {
      // 2. T·∫°o EQ
      eq = new Tone.EQ3(0, 0, 0).toDestination();

      // 3. T·∫£i Guitar (S·ª≠ d·ª•ng c√°ch t·∫£i ƒë∆°n gi·∫£n, ·ªïn ƒë·ªãnh nh·∫•t)
      // Kh√¥ng d√πng URL custom ƒë·ªÉ tr√°nh l·ªói 404
      guitar = await Soundfont.instrument(Tone.context.rawContext, "acoustic_guitar_nylon", {
        destination: eq,
        gain: 3.0 // TƒÉng √¢m l∆∞·ª£ng m·∫∑c ƒë·ªãnh
      });

      // 4. √Åp d·ª•ng EQ m·∫∑c ƒë·ªãnh
      updateEQ('low', 4);
      updateEQ('high', 2);
      
      // Ho√†n t·∫•t
      console.log("Audio Loaded Successfully");
      document.getElementById('overlay').style.display = 'none';
      renderTimeline();

    } catch (e) {
      console.error(e);
      loadText.innerText = "L·ªói k·∫øt n·ªëi! Vui l√≤ng t·∫£i l·∫°i trang.";
      loadText.style.color = "#ff5252";
      btnLoad.disabled = false;
      btnLoad.innerText = "TH·ª¨ L·∫†I";
    }
  }

  window.updateEQ = function(band, val) {
    if(!eq) return;
    if(band === 'low') eq.low.value = val;
    if(band === 'high') eq.high.value = val;
  }

  /* =========================================
     4. LOGIC CH∆†I NH·∫†C (PLAYBACK LOOP)
     ========================================= */
  function togglePlay() {
    const btn = document.getElementById('btn-play');
    if(isPlaying) {
      stopPlaying();
    } else {
      if(!guitar) { alert("Ch∆∞a t·∫£i √¢m thanh!"); return; }
      isPlaying = true; 
      btn.innerHTML = "‚èπ D·ª™NG L·∫†I"; 
      btn.classList.add('stop');
      currentStep = 0;
      runLoop();
    }
  }

  function stopPlaying() {
    isPlaying = false; 
    clearTimeout(timer);
    const btn = document.getElementById('btn-play');
    btn.innerHTML = "‚ñ∂ B·∫ÆT ƒê·∫¶U CH∆†I"; 
    btn.classList.remove('stop');
    
    // X√≥a highlight
    document.querySelectorAll('.segment').forEach(s => s.classList.remove('playing'));
    document.getElementById('str-display').innerText = "---";
  }

  function runLoop() {
    if(!isPlaying) return;

    // 1. Ch∆°i n·ªët hi·ªán t·∫°i
    playStep(currentStep);
    
    // 2. Highlight UI
    document.querySelectorAll('.segment').forEach(s => s.classList.remove('playing'));
    const currentSeg = document.getElementById(`seg-${currentStep}`);
    if(currentSeg) currentSeg.classList.add('playing');

    // 3. T√≠nh to√°n th·ªùi gian delay cho b∆∞·ªõc k·∫ø ti·∫øp
    const bpm = document.getElementById('bpm').value;
    const beatDurMs = (60/bpm) * 1000; 
    const delay = steps[currentStep].val * beatDurMs;

    // 4. Chu·∫©n b·ªã b∆∞·ªõc sau
    currentStep++;
    if(currentStep >= steps.length) {
      currentStep = 0; // Quay l·∫°i ƒë·∫ßu
      barCount++;
      
      // Logic t·ª± ƒë·ªïi h·ª£p √¢m sau 2 √¥ nh·ªãp (2 Bar)
      if(document.getElementById('chk-auto').checked && barCount >= 2) {
        barCount = 0; 
        let i = LOOP_SEQUENCE.indexOf(currentChord); 
        let nextChord = LOOP_SEQUENCE[(i+1) % LOOP_SEQUENCE.length];
        setChord(nextChord);
      }
    }

    // 5. Set timer
    timer = setTimeout(runLoop, delay);
  }

  /* =========================================
     5. K·ª∏ THU·∫¨T GUITAR (TECHNIQUE)
     ========================================= */
  function playStep(idx) {
    if(!guitar) return;
    
    const s = steps[idx]; 
    const c = CHORDS[currentChord]; 
    const now = Tone.now();

    // Helper: L·∫•y MIDI note t·ª´ s·ªë d√¢y (1-6)
    const getN = (str) => { 
      let i = 6 - str; // Chuy·ªÉn d√¢y 6->index 0
      if(i < 0 || i >= TUNING.length) return null; 
      let f = c.f[i]; 
      return (f === -1) ? null : TUNING[i] + f; 
    };

    const dur = s.val * 0.6; // ƒê·ªô d√†i ng√¢n vang
    let dispStr = "";

    try {
      // --- X·ª¨ L√ù C√ÅC KI·ªÇU ƒê√ÅNH ---
      
      if(s.label === "B√ôM") { 
        // ƒê√°nh d√¢y Bass ch·ªß
        let n = getN(c.b); 
        safePlay(n, now, dur, 1.2); 
        dispStr = `BASS (D√ÇY ${c.b})`; 
      }
      else if(s.label === "B√ôM+1") { 
        // ƒê√°nh d√¢y Bass ph·ª• (ƒë·∫£o bass)
        let alt = c.b + 1; if(alt > 5) alt = c.b - 1; 
        safePlay(getN(alt), now, dur, 1.1); 
        dispStr = `BASS ƒê·∫¢O`; 
      }
      else if(s.label === "1") { 
        // M√≥c d√¢y 3
        safePlay(getN(3), now, 0.3, 0.8); 
        dispStr = `M√ìC D√ÇY 3`; 
      }
      else if(s.label === "2") { 
        // M√≥c d√¢y 2
        safePlay(getN(2), now, 0.3, 0.8); 
        dispStr = `M√ìC D√ÇY 2`; 
      }
      else if(s.label === "3") { 
        // Qu·∫°t xu·ªëng nh·∫π (3 d√¢y d∆∞·ªõi)
        [3,2,1].forEach((st, i) => { 
            let n = getN(st); 
            if(n) safePlay(n, now + i*0.015, dur, 0.7); 
        }); 
        dispStr = "QU·∫†T NH·∫∏"; 
      }
      else if(s.label === "CH√ÅT") { 
        // Ch√°t (M√≥c l√™n 3 d√¢y + ng·∫Øt ti·∫øng)
        [1,2,3].forEach((st, i) => { 
            let n = getN(st); 
            // Release ng·∫Øn (0.05) ƒë·ªÉ t·∫°o ti·∫øng 'ch√°t' kh√¥
            if(n) guitar.play(n, now + i*0.01, { duration: 0.1, gain: 1.0, release: 0.05 });
        }); 
        dispStr = "CH√ÅT!"; 
      }
      
    } catch(err) { console.warn("L·ªói ph√°t n·ªët:", err); }
    
    document.getElementById('str-display').innerText = dispStr;
  }
  
  // Wrapper ch∆°i nh·∫°c an to√†n
  function safePlay(note, time, duration, gain) {
    if(note !== null && note !== undefined) {
       guitar.play(note, time, { duration: duration, gain: gain });
    }
  }
  
  window.setChord = function(c) { 
    currentChord = c; 
    document.querySelectorAll('.btn-chord').forEach(b => {
        if(b.innerText.includes(c)) b.classList.add('active');
        else b.classList.remove('active');
    });
  }
</script>
</body>
</html>
