<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Guitar Party Monster</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.18/Tone.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">

  <style>
    :root { 
      --bg: #121212; 
      --panel: #1e1e1e; 
      --neon-blue: #00f3ff;
      --neon-pink: #ff00ff;
      --neon-green: #00ff41;
      --text-main: #e0e0e0;
      --glass: rgba(255,255,255,0.05);
    }
    * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
    body { 
      margin: 0; background: var(--bg); color: var(--text-main); 
      font-family: system-ui, -apple-system, sans-serif; 
      height: 100vh; width: 100vw; overflow: hidden;
    }

    /* === M√ÄN H√åNH XOAY NGANG === */
    #rotateMsg {
      position: fixed; top:0; left:0; right:0; bottom:0; z-index: 999;
      background: #000; display: flex; flex-direction: column; 
      align-items: center; justify-content: center; text-align: center;
      padding: 20px;
    }
    @media (orientation: landscape) { #rotateMsg { display: none; } }

    /* LAYOUT CH√çNH: 3 C·ªòT */
    .deck {
      display: grid;
      grid-template-columns: 280px 1fr 1.2fr; /* Tr√°i (ƒêi·ªáu) - Gi·ªØa (Control) - Ph·∫£i (Ph√≠m ƒë√†n) */
      height: 100%; gap: 2px;
    }

    /* PANEL CHUNG */
    .panel {
      background: var(--panel); border-right: 1px solid #333;
      padding: 10px; display: flex; flex-direction: column; gap: 10px;
      overflow-y: auto;
    }
    h3 { 
      margin: 0; font-size: 12px; color: #888; text-transform: uppercase; letter-spacing: 1px; 
      border-bottom: 1px solid #333; padding-bottom: 4px; margin-bottom: 4px;
    }

    /* C·ªòT 1: RHYTHM STATION */
    .genre-select {
      background: #000; color: var(--neon-blue); border: 1px solid #444; 
      padding: 8px; font-weight: bold; font-size: 14px; border-radius: 4px; width: 100%;
    }
    .pattern-list { display: flex; flex-direction: column; gap: 4px; flex: 1; overflow-y: auto; }
    .pat-btn {
      padding: 10px; background: #2a2a2a; color: #aaa; border: 1px solid #333;
      border-radius: 4px; text-align: left; font-size: 13px; cursor: pointer;
      display: flex; justify-content: space-between;
    }
    .pat-btn.active { 
      background: rgba(0, 243, 255, 0.15); color: var(--neon-blue); border-color: var(--neon-blue); 
    }
    .pat-bpm { font-size: 10px; background: #000; padding: 2px 4px; border-radius: 3px; }

    /* C·ªòT 2: MIXER & FX */
    .lcd-screen {
      background: #000; border: 2px solid #333; color: var(--neon-green);
      padding: 10px; border-radius: 4px; font-family: 'VT323', monospace;
      text-align: center; height: 80px; display: flex; flex-direction: column; justify-content: center;
      box-shadow: inset 0 0 15px rgba(0,255,65,0.1);
      position: relative;
    }
    .lcd-chord { font-size: 38px; line-height: 1; text-shadow: 0 0 5px var(--neon-green); }
    .lcd-info { font-size: 16px; color: #555; display: flex; justify-content: space-between; width: 100%; padding: 0 10px; }
    
    .fx-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
    .btn-fx {
      padding: 15px 5px; border: none; border-radius: 4px; font-weight: bold; font-size: 12px;
      cursor: pointer; color: #000; text-transform: uppercase;
    }
    .btn-intro { background: #ffeb3b; }
    .btn-fill { background: var(--neon-pink); color: white; box-shadow: 0 0 5px var(--neon-pink); }
    .btn-end { background: #ff9800; }
    .btn-break { background: #f44336; color: white; }

    .progression-box {
      background: #151515; border-radius: 4px; padding: 6px;
    }
    .prog-btn {
      width: 100%; background: #333; color: #ccc; border: 1px solid #444; 
      padding: 8px; margin-bottom: 4px; font-size: 11px; text-align: left;
    }
    .prog-btn:hover { background: #444; }

    /* C·ªòT 3: CHORD MATRIX */
    .key-control { display: flex; gap: 5px; margin-bottom: 5px; }
    .key-btn { flex: 1; background: #222; color: white; border: 1px solid #444; padding: 6px; font-size: 12px; }
    
    .matrix { 
      display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; 
      height: 100%; align-content: start; 
    }
    .chord-pad {
      aspect-ratio: 1.4; background: #252525; border: 1px solid #333; border-radius: 6px;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      font-size: 20px; font-weight: bold; color: #888; position: relative;
      transition: all 0.1s;
    }
    .chord-pad span { font-size: 10px; color: #555; margin-top: 2px; }
    .chord-pad.active { 
      background: var(--neon-blue); color: #000; border-color: #fff; 
      box-shadow: 0 0 15px var(--neon-blue); transform: scale(0.98);
    }
    /* M√†u s·∫Øc theo nh√≥m h·ª£p √¢m */
    .chord-pad[data-type="minor"] { border-bottom: 3px solid var(--neon-pink); }
    .chord-pad[data-type="major"] { border-bottom: 3px solid var(--neon-green); }
    .chord-pad[data-type="7th"] { border-bottom: 3px solid #ff9800; }

    /* MASTER CONTROLS */
    .transport { display: flex; gap: 10px; margin-top: auto; }
    .big-btn { 
      flex: 1; padding: 15px; border: none; border-radius: 6px; font-size: 16px; font-weight: bold; 
      cursor: pointer;
    }
    #btnStart { background: #4caf50; color: #fff; }
    #btnStop { background: #333; color: #888; }
    #btnStop.playing { background: #f44336; color: #fff; animation: pulse 1s infinite; }

    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.8; } 100% { opacity: 1; } }
  </style>
</head>
<body>

  <div id="rotateMsg">
    <h1 style="color:var(--neon-blue)">XOAY NGANG ƒêI·ªÜN THO·∫†I</h1>
    <p>ƒê·ªÉ k√≠ch ho·∫°t ch·∫ø ƒë·ªô "Party Monster"</p>
    <div style="font-size:40px;">üîÑ</div>
  </div>

  <div class="deck">
    <div class="panel">
      <h3>1. Rhythm Station</h3>
      <select id="genreSelect" class="genre-select">
        </select>
      <div id="patternList" class="pattern-list">
        </div>
      
      <div style="margin-top:auto">
        <label style="font-size:12px; color:#888;">Tempo</label>
        <input type="range" id="tempo" min="50" max="180" value="80" style="width:100%">
      </div>
    </div>

    <div class="panel">
      <h3>2. Mixer & FX</h3>
      <div class="lcd-screen">
        <div class="lcd-info"><span id="lcdStyle">SLOW SURF</span> <span id="lcdBpm">80</span></div>
        <div class="lcd-chord" id="lcdChord">--</div>
        <div class="lcd-info"><span id="lcdStatus">READY</span></div>
      </div>

      <div class="fx-grid">
        <button class="btn-fx btn-intro" id="btnIntro">Intro (4 bar)</button>
        <button class="btn-fx btn-end" id="btnEnd">Ending</button>
        <button class="btn-fx btn-fill" id="btnFill">‚ö° FILL (D·∫±n)</button>
        <button class="btn-fx btn-break" id="btnBreak">STOP (Ly)</button>
      </div>

      <div class="progression-box">
        <h3>‚ö° Mashup Presets</h3>
        <div id="progList">
          </div>
      </div>
      
      <div class="transport">
        <button id="btnStart" class="big-btn">LOAD LOA</button>
        <button id="btnStop" class="big-btn" disabled>PLAY / STOP</button>
      </div>
    </div>

    <div class="panel" style="background:#111;">
      <h3>3. Chord Matrix</h3>
      <div class="key-control">
        <select id="keySelect" class="genre-select" style="flex:2">
          <option value="C">Key: C (ƒê√¥ tr∆∞·ªüng)</option>
          <option value="Am" selected>Key: Am (La th·ª©)</option>
          <option value="G">Key: G (Sol tr∆∞·ªüng)</option>
          <option value="Em">Key: Em (Mi th·ª©)</option>
          <option value="D">Key: D (R√™ tr∆∞·ªüng)</option>
          <option value="Bm">Key: Bm (Si th·ª©)</option>
          <option value="F">Key: F (Fa tr∆∞·ªüng)</option>
        </select>
        <button id="btnBassMode" class="key-btn" style="background:#333;">Bass: Auto</button>
      </div>
      
      <div id="matrix" class="matrix">
        </div>
    </div>
  </div>

<script>
// ==========================================
// 1. DATA CENTER
// ==========================================

// --- M·ªü r·ªông th∆∞ vi·ªán h·ª£p √¢m (Slash chords, Dim, 7th) ---
const CHORDS_DB = {
  // Basic
  "C":  { f:[-1,3,2,0,1,0], b:5, t:"major" },
  "Am": { f:[-1,0,2,2,1,0], b:5, t:"minor" },
  "Dm": { f:[-1,-1,0,2,3,1], b:4, t:"minor" },
  "G":  { f:[ 3,2,0,0,0,3], b:6, t:"major" },
  "Em": { f:[ 0,2,2,0,0,0], b:6, t:"minor" },
  "F":  { f:[-1,-1,3,2,1,0], b:4, t:"major" }, // F t·∫Øt
  "E":  { f:[ 0,2,2,1,0,0], b:6, t:"major" },
  "A":  { f:[-1,0,2,2,2,0], b:5, t:"major" },
  "D":  { f:[-1,-1,0,2,3,2], b:4, t:"major" },
  "B":  { f:[-1,2,4,4,4,2], b:5, t:"major" },
  "Bm": { f:[-1,2,4,4,3,2], b:5, t:"minor" },
  // 7th (Nh·∫°c v√†ng/Bolero c·∫ßn c√°i n√†y)
  "E7": { f:[ 0,2,0,1,0,0], b:6, t:"7th" },
  "A7": { f:[-1,0,2,0,2,0], b:5, t:"7th" },
  "G7": { f:[ 3,2,0,0,0,1], b:6, t:"7th" },
  "C7": { f:[-1,3,2,3,1,0], b:5, t:"7th" },
  "B7": { f:[-1,2,1,2,0,2], b:5, t:"7th" },
  "D7": { f:[-1,-1,0,2,1,2], b:4, t:"7th" },
  // Slash Chords (Bass ƒëi b·ªô) - Quan tr·ªçng cho Mashup
  "C/B":{ f:[-1,2,2,0,1,0], b:5, t:"major", name:"C/B" }, 
  "Am/G":{ f:[ 3,0,2,2,1,0], b:6, t:"minor", name:"Am/G" },
  "G/F#":{ f:[ 2,2,0,0,0,3], b:6, t:"major", name:"G/F#" },
  "D/F#":{ f:[ 2,0,0,2,3,2], b:6, t:"major", name:"D/F#" },
  // Special
  "Fmaj7":{f:[-1,3,3,2,1,0], b:4, t:"major"},
  "Dim": {f:[-1,-1,1,2,1,2], b:4, t:"7th", name:"Dim7 (any)"} // Fake dim shape
};

// --- Th∆∞ vi·ªán ƒëi·ªáu ph√¢n c·∫•p (Hierarchy) ---
const GENRES = {
  "Bolero / Rumba": [
    { id: "bolero_pick", name: "Bolero R·∫£i (X∆∞a)", bpm: 88, s: "b-3-2-1-2-3-2-1" },
    { id: "bolero_strum", name: "Bolero Qu·∫°t (Sung)", bpm: 92, s: "b-D-x-3-b2-D-x-3" },
    { id: "rumba", name: "Rumba (Nh·∫°c V√†ng)", bpm: 100, s: "b-x-3-2-b2-1-2-3" }
  ],
  "Ballad / Pop": [
    { id: "slow_surf", name: "Slow Surf (Qu·ªëc D√¢n)", bpm: 75, s: "b-3-2-3-1-3-2-3" },
    { id: "piano_ballad", name: "Piano Ballad (16 beat)", bpm: 65, s: "b-3-2-3-1-2-3-2" },
    { id: "blue_ballad", name: "Blue Ballad (6/8)", bpm: 70, type:"6/8", s: "b-3-2-1-2-3" }
  ],
  "S√¥i ƒê·ªông / Nh·∫≠u": [
    { id: "disco", name: "Disco / Vinahouse", bpm: 130, s: "b-D-U-D-b2-D-U-D" },
    { id: "beatop", name: "Bebop / Fox", bpm: 140, s: "b-D-b2-U" },
    { id: "ska", name: "Reggae / Ska", bpm: 100, s: "x-D-x-U-x-D-x-U" }
  ]
};

// --- Preset V√≤ng Ho√† Thanh (Mashup) ---
const PROGRESSIONS = [
  { name: "V√≤ng Canon (Pop)", chords: ["C", "G", "Am", "Em", "F", "C", "F", "G"] },
  { name: "V√≤ng Andalusian (Latin)", chords: ["Am", "G", "F", "E7"] },
  { name: "V√≤ng 12-Bar Blues", chords: ["A7", "A7", "A7", "A7", "D7", "D7", "A7", "A7", "E7", "D7", "A7", "E7"] },
  { name: "V√≤ng ƒêi·ªáp Kh√∫c Vi·ªát", chords: ["Am", "Em", "F", "G", "C", "Dm", "E7", "Am"] }
];

// --- Ma tr·∫≠n h·ª£p √¢m th√¥ng minh theo Key ---
// G·ªìm: I, ii, iii, IV, V, vi, v√† c√°c bi·∫øn th·ªÉ hay d√πng
const KEY_MAPS = {
  "C": ["C", "Dm", "Em", "F", "G", "Am", "C/B", "E7", "G7"],
  "Am": ["Am", "Dm", "C", "G", "F", "Em", "Am/G", "E7", "G7"],
  "G": ["G", "Am", "Bm", "C", "D", "Em", "D/F#", "B7", "D7"],
  "Em": ["Em", "Am", "Bm", "G", "C", "D", "B7", "D/F#", "E7"],
  "D": ["D", "Em", "F#m", "G", "A", "Bm", "A7", "D7", "Bb"], // Bb ƒë·ªÉ chuy·ªÉn ƒëi·ªáu
  "F": ["F", "Gm", "Am", "Bb", "C", "Dm", "C7", "Fmaj7", "A7"]
};

// ==========================================
// 2. AUDIO ENGINE
// ==========================================
let guitar = null, reverb = null;
let isReady = false, isPlaying = false;
let curChord = null;
let curGenre = "Ballad / Pop";
let curPattern = GENRES["Ballad / Pop"][0];
let transportId = null;
let step = 0;
let overrideMode = null; // 'intro', 'fill', 'end', 'break'

// Sample Map
const TUNING = [40, 45, 50, 55, 59, 64]; 
function midi(n) { return Tone.Frequency(n, "midi").toNote(); }

async function init() {
  if(isReady) return;
  await Tone.start();
  const baseUrl = "https://cdn.jsdelivr.net/npm/tonejs-instrument-guitar-acoustic-ogg@1.1.0/";
  
  guitar = new Tone.Sampler({
    urls: { E2:"E2.ogg", A2:"A2.ogg", D3:"D3.ogg", G3:"G3.ogg", B3:"B3.ogg", E4:"E4.ogg" },
    baseUrl: baseUrl,
    onload: () => {
      isReady = true;
      document.getElementById("btnStart").style.display = 'none';
      document.getElementById("btnStop").disabled = false;
      document.getElementById("lcdStatus").innerText = "SYSTEM READY";
    }
  }).toDestination();
  
  reverb = new Tone.Reverb({decay:2, wet:0.2}).toDestination();
  guitar.connect(reverb);
  guitar.volume.value = -3;
}

// H√†m l·∫•y note (quan tr·ªçng)
function getNotes(chord, stringIdx) {
  if (!chord || !CHORDS_DB[chord]) return null;
  const c = CHORDS_DB[chord];
  if (stringIdx === "bass") return midi(TUNING[6-c.b] + c.f[6-c.b]);
  if (stringIdx === "bass2") { // Bass ƒë·∫£o (d√¢y tr√™n ho·∫∑c d∆∞·ªõi)
    let b = c.b === 6 ? 5 : (c.b === 5 ? 6 : 5);
    return midi(TUNING[6-b] + c.f[6-b]);
  }
  // L·∫•y note d√¢y melody
  let s = stringIdx;
  if(c.f[6-s] === -1) return null; // Muted string
  return midi(TUNING[6-s] + c.f[6-s]);
}

function getStrumNotes(chord, down) {
  if (!chord || !CHORDS_DB[chord]) return [];
  let notes = [];
  for(let i=1; i<=6; i++) {
    let n = getNotes(chord, i);
    if(n) notes.push(n);
  }
  return down ? notes.reverse() : notes;
}

// Core Loop
function loop(time) {
  if(!curChord && overrideMode !== 'break') return;

  // X·ª≠ l√Ω Override Pattern (Fill, Intro...)
  let patternCode = curPattern.s;
  let steps = patternCode.split("-");
  
  if (overrideMode === 'fill') steps = ["b","D","x","D","b","D","U","D"];
  if (overrideMode === 'break') {
    // Stop sound
    overrideMode = null;
    return;
  }
  
  // Parse Step
  let s = steps[step % steps.length];
  
  // Play
  if (s === 'b') playNote(getNotes(curChord, "bass"), time, 1);
  else if (s === 'b2') playNote(getNotes(curChord, "bass2"), time, 1);
  else if (s === 'x') { /* mute/rest */ }
  else if (s === 'D') strum(time, true);
  else if (s === 'U') strum(time, false);
  else if (!isNaN(s)) playNote(getNotes(curChord, parseInt(s)), time, 0.7);

  step++;
  // Reset override after 1 bar (8 steps approx)
  if (overrideMode === 'fill' && step % 8 === 0) overrideMode = null;
}

function playNote(n, t, v) { if(n) guitar.triggerAttackRelease(n, "8n", t, v); }
function strum(t, down) {
  let notes = getStrumNotes(curChord, down);
  notes.forEach((n,i) => guitar.triggerAttackRelease(n, "4n", t + i*0.01, 0.8));
}

// ==========================================
// 3. UI LOGIC
// ==========================================

// --- Setup Genre & Patterns ---
const genreSel = document.getElementById("genreSelect");
const patList = document.getElementById("patternList");

function renderGenres() {
  Object.keys(GENRES).forEach(g => {
    let opt = document.createElement("option");
    opt.value = g; opt.innerText = g;
    genreSel.appendChild(opt);
  });
  renderPatterns(Object.keys(GENRES)[0]);
}

function renderPatterns(gName) {
  patList.innerHTML = "";
  GENRES[gName].forEach(p => {
    let div = document.createElement("div");
    div.className = "pat-btn";
    if(p.id === curPattern.id) div.classList.add("active");
    div.innerHTML = `<span>${p.name}</span> <span class="pat-bpm">${p.bpm}</span>`;
    div.onclick = () => {
      document.querySelectorAll(".pat-btn").forEach(e=>e.classList.remove("active"));
      div.classList.add("active");
      curPattern = p;
      updateLCD();
      Tone.Transport.bpm.value = p.bpm;
      document.getElementById("tempo").value = p.bpm;
    };
    patList.appendChild(div);
  });
  curGenre = gName;
}

genreSel.onchange = (e) => renderPatterns(e.target.value);

// --- Setup Chord Matrix ---
const matrix = document.getElementById("matrix");
const keySel = document.getElementById("keySelect");

function renderMatrix(key) {
  matrix.innerHTML = "";
  const chords = KEY_MAPS[key] || KEY_MAPS["Am"];
  
  chords.forEach(c => {
    let btn = document.createElement("div");
    let info = CHORDS_DB[c];
    btn.className = "chord-pad";
    btn.dataset.type = info ? info.t : "major";
    btn.innerHTML = `${info && info.name ? info.name : c}<span>${getRoman(key,c)}</span>`;
    
    // Touch Logic
    const hit = () => {
      document.querySelectorAll(".chord-pad").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      curChord = c;
      document.getElementById("lcdChord").innerText = c;
      if(!isPlaying && isReady) togglePlay(); // Auto start
    };
    
    btn.onmousedown = hit;
    btn.ontouchstart = (e) => { e.preventDefault(); hit(); };
    matrix.appendChild(btn);
  });
}

function getRoman(k, c) { return k===c ? "Root" : ""; } // Simple logic
keySel.onchange = (e) => renderMatrix(e.target.value);

// --- Setup Preset Progressions ---
const progList = document.getElementById("progList");
PROGRESSIONS.forEach(p => {
  let btn = document.createElement("button");
  btn.className = "prog-btn";
  btn.innerText = `‚ñ∂ ${p.name}`;
  btn.onclick = () => {
    // Load chords into Matrix overrides? Or just Play them?
    // Let's simpler: Replace Matrix with these chords for playing
    matrix.innerHTML = "";
    p.chords.forEach(c => {
      let b = document.createElement("div");
      b.className = "chord-pad";
      b.dataset.type = "major";
      b.innerHTML = c;
      b.onclick = () => { curChord = c; document.getElementById("lcdChord").innerText = c; };
      matrix.appendChild(b);
    });
    document.getElementById("lcdStatus").innerText = "MODE: MASHUP " + p.name;
  };
  progList.appendChild(btn);
});

// --- FX Buttons ---
document.getElementById("btnFill").onmousedown = () => { 
  overrideMode = 'fill'; 
  step = 0;
  document.getElementById("lcdStatus").innerText = ">> FILLING <<";
};
document.getElementById("btnBreak").onmousedown = () => { 
  overrideMode = 'break'; 
  document.getElementById("lcdStatus").innerText = "!! STOP !!";
};

// --- Transport ---
function togglePlay() {
  if(!isReady) return;
  isPlaying = !isPlaying;
  const btn = document.getElementById("btnStop");
  if(isPlaying) {
    Tone.Transport.start();
    transportId = Tone.Transport.scheduleRepeat(loop, "8n");
    btn.innerText = "STOP";
    btn.classList.add("playing");
  } else {
    Tone.Transport.stop();
    Tone.Transport.clear(transportId);
    btn.innerText = "PLAY";
    btn.classList.remove("playing");
    step = 0;
  }
}

document.getElementById("btnStart").onclick = init;
document.getElementById("btnStop").onclick = togglePlay;
document.getElementById("tempo").oninput = (e) => {
  Tone.Transport.bpm.value = e.target.value;
  document.getElementById("lcdBpm").innerText = e.target.value;
};

function updateLCD() {
  document.getElementById("lcdStyle").innerText = curPattern.name.toUpperCase().split("(")[0];
  document.getElementById("lcdBpm").innerText = curPattern.bpm;
}

// Init
renderGenres();
renderMatrix("Am");

</script>
</body>
</html>
