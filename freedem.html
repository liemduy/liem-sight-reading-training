<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Guitar Visualizer Pro</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.18/Tone.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">

  <style>
    :root { 
      --bg: #101010; 
      --panel: #1a1a1a; 
      --string: #444;
      --string-active: #00f3ff;
      --neon-gold: #ffd700;
      --neon-red: #ff0055;
      --text: #eee;
    }
    * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
    body { 
      margin: 0; background: var(--bg); color: var(--text); 
      font-family: system-ui, -apple-system, sans-serif; 
      height: 100vh; width: 100vw; overflow: hidden;
    }

    /* XOAY M√ÄN H√åNH */
    #rotateMsg {
      position: fixed; top:0; left:0; right:0; bottom:0; z-index: 9999;
      background: #000; display: flex; flex-direction: column; 
      align-items: center; justify-content: center; text-align: center;
    }
    @media (orientation: landscape) { #rotateMsg { display: none; } }

    /* LAYOUT CH√çNH */
    .deck {
      display: grid;
      grid-template-rows: 100px 1fr; /* Visualizer (100px) - Main Deck */
      height: 100%;
    }

    /* --- PH·∫¶N 1: VISUALIZER (D√ÇY ƒê√ÄN) --- */
    .visualizer {
      background: #050505; border-bottom: 2px solid #333;
      position: relative; display: flex; flex-direction: column; 
      justify-content: space-evenly; padding: 10px 0;
      box-shadow: inset 0 0 20px #000;
    }
    .string-line {
      height: 2px; width: 100%; background: var(--string);
      position: relative; transition: all 0.05s;
    }
    /* D√¢y bass to h∆°n */
    .string-line:nth-child(6) { height: 4px; } 
    .string-line:nth-child(5) { height: 3.5px; }
    .string-line:nth-child(4) { height: 3px; }

    /* Hi·ªáu ·ª©ng rung */
    .string-line.vibrating {
      background: var(--string-active);
      box-shadow: 0 0 10px var(--string-active);
      animation: shake 0.1s infinite;
    }
    @keyframes shake {
      0% { transform: translateY(0); }
      25% { transform: translateY(-2px); }
      75% { transform: translateY(2px); }
      100% { transform: translateY(0); }
    }
    
    .note-bubble {
      position: absolute; right: 50px; top: -10px;
      background: var(--neon-gold); color: #000; font-size: 10px; font-weight: bold;
      padding: 2px 5px; border-radius: 4px; opacity: 0; transition: opacity 0.2s;
    }
    .string-line.vibrating .note-bubble { opacity: 1; }

    /* --- PH·∫¶N 2: B√ÄN ƒêI·ªÄU KHI·ªÇN --- */
    .lower-deck {
      display: grid; grid-template-columns: 220px 1fr 1.3fr; gap: 2px; height: 100%;
    }
    .panel { 
      background: var(--panel); border-right: 1px solid #222; 
      padding: 8px; display: flex; flex-direction: column; gap: 8px; 
    }
    h3 { margin: 0; font-size: 11px; color: #666; text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px solid #333; padding-bottom: 4px; }

    /* LCD Screen Update */
    .lcd-screen {
      background: #000; border: 1px solid #444; color: var(--string-active);
      font-family: 'VT323', monospace; padding: 5px; border-radius: 4px;
      display: flex; justify-content: space-between; align-items: center;
    }
    .lcd-main { font-size: 40px; line-height: 1; text-shadow: 0 0 8px var(--string-active); }
    .lcd-sub { text-align: right; font-size: 14px; color: #888; }
    .lcd-sub span { display: block; }

    /* Transpose Controls */
    .trans-ctrl {
      display: flex; align-items: center; background: #222; border-radius: 4px; overflow: hidden; margin-top: 5px;
    }
    .trans-btn {
      flex: 1; background: #333; border: none; color: white; font-size: 18px; padding: 10px; cursor: pointer;
    }
    .trans-btn:active { background: var(--neon-gold); color: black; }
    .trans-val {
      flex: 1; text-align: center; font-weight: bold; color: var(--neon-gold); font-family: monospace; font-size: 16px;
    }

    /* Chord Matrix */
    .matrix { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; height: 100%; }
    .chord-pad {
      background: #252525; border: 1px solid #333; border-radius: 6px;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      font-size: 20px; font-weight: bold; color: #888; position: relative;
    }
    .chord-pad span { font-size: 10px; color: #555; }
    .chord-pad.active {
      background: var(--string-active); color: #000;
      box-shadow: 0 0 15px var(--string-active); transform: scale(0.96);
    }

    /* Controls */
    .big-btn { width: 100%; padding: 15px; border: none; border-radius: 6px; font-weight: bold; font-size: 16px; color: white; margin-top: auto; }
    #btnStart { background: #4caf50; }
    #btnStop { background: #333; }
    #btnStop.playing { background: var(--neon-red); animation: pulse 1s infinite; }
    @keyframes pulse { 50% { opacity: 0.7; } }

  </style>
</head>
<body>

  <div id="rotateMsg"><h1 style="color:var(--neon-gold)">XOAY NGANG ƒê·ªÇ HI·ªÜN D√ÇY ƒê√ÄN</h1></div>

  <div class="deck">
    <div class="visualizer" id="visualizer">
      <div class="string-line" id="str1"><div class="note-bubble"></div></div>
      <div class="string-line" id="str2"><div class="note-bubble"></div></div>
      <div class="string-line" id="str3"><div class="note-bubble"></div></div>
      <div class="string-line" id="str4"><div class="note-bubble"></div></div>
      <div class="string-line" id="str5"><div class="note-bubble"></div></div>
      <div class="string-line" id="str6"><div class="note-bubble"></div></div>
    </div>

    <div class="lower-deck">
      <div class="panel">
        <h3>1. Rhythm</h3>
        <select id="genreSelect" style="width:100%; padding:8px; background:#000; color:#fff; border:1px solid #444;">
          </select>
        <div id="patternList" style="flex:1; overflow-y:auto; display:flex; flex-direction:column; gap:4px;"></div>
        <div style="font-size:12px; color:#aaa; margin-top:4px;">Tempo</div>
        <input type="range" id="tempo" min="60" max="160" value="80" style="width:100%">
      </div>

      <div class="panel">
        <h3>2. Master Control</h3>
        
        <div class="lcd-screen">
          <div class="lcd-main" id="lcdChord">--</div>
          <div class="lcd-sub">
            <span id="lcdStyle">BALLAD</span>
            <span id="lcdBpm">80 BPM</span>
          </div>
        </div>

        <div style="font-size:11px; color:#aaa; margin-top:5px;">VIRTUAL CAPO</div>
        <div class="trans-ctrl">
          <button class="trans-btn" id="btnTransDown">-</button>
          <div class="trans-val" id="transVal">0</div>
          <button class="trans-btn" id="btnTransUp">+</button>
        </div>

        <div style="display:grid; grid-template-columns:1fr 1fr; gap:5px; margin-top:5px;">
           <button id="btnFill" style="background:#d32f2f; color:white; border:none; padding:10px; border-radius:4px; font-weight:bold;">‚ö° FILL</button>
           <button id="btnMute" style="background:#444; color:white; border:none; padding:10px; border-radius:4px;">üîá MUTE</button>
        </div>

        <button id="btnStart" class="big-btn">üîå B·∫¨T LOA</button>
        <button id="btnStop" class="big-btn" style="display:none;">PLAY / STOP</button>
      </div>

      <div class="panel" style="background:#111;">
        <h3>3. Smart Chords</h3>
        <select id="keySelect" style="width:100%; padding:8px; margin-bottom:5px; background:#222; color:var(--neon-gold); border:1px solid #444;">
          <option value="Am">Key: Am (La th·ª©)</option>
          <option value="C">Key: C (ƒê√¥ tr∆∞·ªüng)</option>
          <option value="G">Key: G (Sol tr∆∞·ªüng)</option>
          <option value="Em">Key: Em (Mi th·ª©)</option>
          <option value="Dm">Key: Dm (R√™ th·ª©)</option>
          <option value="F">Key: F (Fa tr∆∞·ªüng)</option>
        </select>
        <div class="matrix" id="matrix"></div>
      </div>
    </div>
  </div>

<script>
// ==========================================
// 1. DATA CENTER
// ==========================================
const TUNING = [40, 45, 50, 55, 59, 64]; // E2 -> E4 MIDI
function midiToNote(m) { return Tone.Frequency(m, "midi").toNote(); }

const CHORDS_DB = {
  "C":  { f:[-1,3,2,0,1,0], b:5 },
  "Dm": { f:[-1,-1,0,2,3,1], b:4 },
  "Em": { f:[ 0,2,2,0,0,0], b:6 },
  "F":  { f:[-1,-1,3,2,1,0], b:4 }, 
  "G":  { f:[ 3,2,0,0,0,3], b:6 },
  "Am": { f:[-1,0,2,2,1,0], b:5 },
  "E7": { f:[ 0,2,0,1,0,0], b:6 },
  "G7": { f:[ 3,2,0,0,0,1], b:6 },
  "C7": { f:[-1,3,2,3,1,0], b:5 },
  "A7": { f:[-1,0,2,0,2,0], b:5 },
  "D7": { f:[-1,-1,0,2,1,2], b:4 },
  "Bm": { f:[-1,2,4,4,3,2], b:5 },
  "B7": { f:[-1,2,1,2,0,2], b:5 },
  "Fmaj7": { f:[-1,3,3,2,1,0], b:4 },
  "Am/G":{ f:[ 3,0,2,2,1,0], b:6 },
  "C/B":{ f:[-1,2,2,0,1,0], b:5 }
};

const KEY_MAPS = {
  "C":  ["C", "Dm", "Em", "F", "G", "Am", "E7", "G7", "C/B"],
  "Am": ["Am", "Dm", "Em", "C", "F", "G", "E7", "Am/G", "A7"],
  "G":  ["G", "Am", "Bm", "C", "D7", "Em", "B7", "C", "G7"],
  "Em": ["Em", "Am", "Bm", "G", "C", "B7", "D7", "E7", "Am"],
  "F":  ["F", "Gm", "Am", "Bb", "C", "Dm", "C7", "Fmaj7", "A7"]
};

// Patterns: s·ªë l√† d√¢y (1=E high, 6=E low). b=bass root, b2=alt bass
const GENRES = {
  "Ballad": [
    { name: "Slow Surf", bpm: 75, s: ["b","3","2","3","1","3","2","3"] },
    { name: "Piano Style", bpm: 68, s: ["b","3","2","3","1","2","3","2"] }
  ],
  "Bolero": [
    { name: "Bolero Pick", bpm: 88, s: ["b","3","2","1","2","3","2","1"] },
    { name: "Bolero Strum", bpm: 92, s: ["b","D","3","2","b2","D","3","2"] }
  ],
  "S√¥i ƒê·ªông": [
    { name: "Disco", bpm: 130, s: ["b","D","U","D","b2","D","U","D"] },
    { name: "VinaHouse", bpm: 140, s: ["b","x","D","x","b2","x","D","x"] }
  ]
};

// ==========================================
// 2. AUDIO & VISUAL ENGINE
// ==========================================
let guitar, reverb;
let isReady = false, isPlaying = false;
let curChord = null;
let curPattern = GENRES["Ballad"][0];
let step = 0;
let transpose = 0; // S·ªë b√°n cung d·ªãch chuy·ªÉn
let overrideMode = null;

// L·∫•y MIDI note ch√≠nh x√°c c·ªßa d√¢y
function getNoteMidi(chordName, stringNum) {
  if(!CHORDS_DB[chordName]) return null;
  const c = CHORDS_DB[chordName];
  
  let targetString = stringNum;
  if (stringNum === "bass") targetString = c.b;
  else if (stringNum === "bass2") targetString = (c.b===6?5:(c.b===5?6:5));
  else if (isNaN(stringNum)) return null; // D, U, x
  else targetString = parseInt(stringNum);

  // L·∫•y fret
  let fret = c.f[6 - targetString]; 
  if (fret === -1) return null; // Muted string

  // T√≠nh MIDI g·ªëc + Fret + Transpose
  let rawMidi = TUNING[6 - targetString] + fret;
  return rawMidi + transpose;
}

// Visualizer Trigger
function vibrateString(stringNum, noteName) {
  // stringNum: 1-6. N·∫øu l√† bass/bass2 ph·∫£i map l·∫°i
  let sIdx = stringNum;
  if (stringNum === "bass") sIdx = CHORDS_DB[curChord].b;
  if (stringNum === "bass2") sIdx = (CHORDS_DB[curChord].b===6?5:6);
  if (isNaN(sIdx)) return;

  const el = document.getElementById("str" + sIdx);
  if(el) {
    el.classList.remove("vibrating");
    void el.offsetWidth; // Trigger reflow
    el.classList.add("vibrating");
    // Show Note Name
    const bubble = el.querySelector(".note-bubble");
    if(bubble) bubble.innerText = noteName;
  }
}

async function init() {
  await Tone.start();
  guitar = new Tone.Sampler({
    urls: { E2:"E2.ogg", A2:"A2.ogg", D3:"D3.ogg", G3:"G3.ogg", B3:"B3.ogg", E4:"E4.ogg" },
    baseUrl: "https://cdn.jsdelivr.net/npm/tonejs-instrument-guitar-acoustic-ogg@1.1.0/",
    onload: () => {
      isReady = true;
      document.getElementById("btnStart").style.display = 'none';
      document.getElementById("btnStop").style.display = 'block';
      startLoop();
    }
  }).toDestination();
  
  // Reverb nh·∫π ƒë·ªÉ kh√¥ng b·ªã um
  reverb = new Tone.Reverb({decay:1.2, wet:0.2}).toDestination();
  guitar.connect(reverb);
  guitar.volume.value = -2;
}

function startLoop() {
  Tone.Transport.scheduleRepeat((time) => {
    if(!curChord || !isPlaying) return;

    let seq = overrideMode === 'fill' ? ["b","D","x","D","b","D","U","D"] : curPattern.s;
    let s = seq[step % seq.length];

    if (s === "D") strum(time, true);
    else if (s === "U") strum(time, false);
    else if (s === "x") { /* Mute/Rest */ }
    else {
      // Pluck single string
      let midi = getNoteMidi(curChord, s);
      if(midi) {
        guitar.triggerAttackRelease(midiToNote(midi), "8n", time);
        // Visual
        Tone.Draw.schedule(() => {
          vibrateString(s, midiToNote(midi));
        }, time);
      }
    }
    
    step++;
    if(overrideMode === 'fill' && step % 8 === 0) overrideMode = null;

  }, "8n");
}

function strum(time, down) {
  // Strum visual: rung t·∫•t c·∫£ d√¢y active
  let activeStrings = [];
  for(let i=1; i<=6; i++) {
    let m = getNoteMidi(curChord, i);
    if(m) activeStrings.push({s:i, m:m});
  }
  if(!down) activeStrings.reverse();

  activeStrings.forEach((obj, idx) => {
    let t = time + idx * 0.015;
    guitar.triggerAttackRelease(midiToNote(obj.m), "4n", t, 0.7);
    Tone.Draw.schedule(() => {
      vibrateString(obj.s, midiToNote(obj.m));
    }, t);
  });
}

// ==========================================
// 3. UI LOGIC
// ==========================================

// Render Genres
const genreSelect = document.getElementById("genreSelect");
const patternList = document.getElementById("patternList");

Object.keys(GENRES).forEach(g => {
  let opt = document.createElement("option");
  opt.value = g; opt.innerText = g;
  genreSelect.appendChild(opt);
});

function renderPatterns(g) {
  patternList.innerHTML = "";
  GENRES[g].forEach(p => {
    let div = document.createElement("div");
    div.style.padding = "8px";
    div.style.background = "#222";
    div.style.cursor = "pointer";
    div.innerText = p.name;
    if(p.name === curPattern.name) {
      div.style.background = "#00f3ff"; div.style.color = "black"; div.style.fontWeight="bold";
    }
    div.onclick = () => {
      curPattern = p;
      document.getElementById("tempo").value = p.bpm;
      Tone.Transport.bpm.value = p.bpm;
      document.getElementById("lcdStyle").innerText = p.name.toUpperCase();
      document.getElementById("lcdBpm").innerText = p.bpm + " BPM";
      renderPatterns(g);
    };
    patternList.appendChild(div);
  });
}
renderPatterns("Ballad");
genreSelect.onchange = (e) => renderPatterns(e.target.value);

// Chord Matrix
const matrix = document.getElementById("matrix");
function renderMatrix(key) {
  matrix.innerHTML = "";
  KEY_MAPS[key].forEach(c => {
    let btn = document.createElement("div");
    btn.className = "chord-pad";
    btn.innerText = c;
    btn.onmousedown = (e) => {
      e.preventDefault();
      // Smart Muting: Release old notes before new chord
      if(guitar) guitar.releaseAll(); 
      
      document.querySelectorAll(".chord-pad").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      
      curChord = c;
      document.getElementById("lcdChord").innerText = c;
      
      // Auto Start
      if(isReady && !isPlaying) togglePlay();
    };
    btn.ontouchstart = btn.onmousedown;
    matrix.appendChild(btn);
  });
}
document.getElementById("keySelect").onchange = (e) => renderMatrix(e.target.value);
renderMatrix("Am");

// Transpose (Capo) Logic
const btnUp = document.getElementById("btnTransUp");
const btnDown = document.getElementById("btnTransDown");
const valDisplay = document.getElementById("transVal");

function updateTrans(delta) {
  transpose += delta;
  let sign = transpose > 0 ? "+" : "";
  valDisplay.innerText = sign + transpose;
  // Visual feedback: ƒê·ªïi m√†u n·∫øu d√πng capo
  valDisplay.style.color = transpose !== 0 ? "#ff0055" : "#ffd700";
}
btnUp.onclick = () => updateTrans(1);
btnDown.onclick = () => updateTrans(-1);

// Master Controls
function togglePlay() {
  if(!isReady) return;
  isPlaying = !isPlaying;
  const btn = document.getElementById("btnStop");
  if(isPlaying) {
    Tone.Transport.start();
    btn.innerText = "STOP";
    btn.classList.add("playing");
  } else {
    Tone.Transport.stop();
    btn.innerText = "PLAY";
    btn.classList.remove("playing");
    step = 0;
    if(guitar) guitar.releaseAll(); // Stop sound immediately
  }
}
document.getElementById("btnStart").onclick = init;
document.getElementById("btnStop").onclick = togglePlay;

// Fill & Mute
document.getElementById("btnFill").onmousedown = () => overrideMode = 'fill';
document.getElementById("btnMute").onmousedown = () => {
  if(guitar) guitar.releaseAll();
  isPlaying = false;
  Tone.Transport.stop();
  document.getElementById("btnStop").innerText = "PLAY";
  document.getElementById("btnStop").classList.remove("playing");
};

// Tempo
document.getElementById("tempo").oninput = (e) => {
  Tone.Transport.bpm.value = e.target.value;
  document.getElementById("lcdBpm").innerText = e.target.value + " BPM";
};

</script>
</body>
</html>
