<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test K·∫øt N·ªëi Piano MIDI - Roland FP-30X</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; 
            color: #e5e7eb;
        }

        .pulse-animation {
            animation: pulse-ring 0.5s cubic-bezier(0.215, 0.61, 0.355, 1);
        }

        @keyframes pulse-ring {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { transform: scale(1.05); box-shadow: 0 0 0 20px rgba(59, 130, 246, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }

        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #1f2937; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #6b7280; }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden">

    <!-- Header -->
    <header class="bg-gray-800 border-b border-gray-700 p-4 shadow-lg z-10">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl md:text-2xl font-bold text-blue-400 flex items-center gap-2">
                üéπ Roland FP-30X Tester
            </h1>
            <div id="connection-status" class="px-3 py-1 rounded-full text-xs font-semibold bg-gray-700 text-gray-300 border border-gray-600">
                Ch∆∞a kh·ªüi ƒë·ªông
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow flex flex-col md:flex-row p-4 gap-4 container mx-auto h-full pb-20">
        
        <!-- C·ªôt Tr√°i -->
        <div class="w-full md:w-1/2 flex flex-col gap-4">
            <!-- Khu v·ª±c tr·∫°ng th√°i k·∫øt n·ªëi -->
            <div class="bg-gray-800 rounded-xl p-6 shadow-lg border border-gray-700 text-center">
                <button id="btn-connect" class="w-full py-3 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-lg transition-all shadow-lg active:scale-95 mb-4">
                    üîç Qu√©t t√¨m ƒë√†n Roland
                </button>
                <div id="device-list" class="text-left text-sm bg-gray-900 p-3 rounded border border-gray-700 hidden">
                    <p class="text-gray-400 mb-2">Danh s√°ch thi·∫øt b·ªã t√¨m th·∫•y:</p>
                    <ul id="midi-inputs" class="list-disc pl-5 text-green-400 font-mono"></ul>
                </div>
                <div id="mac-instruction" class="hidden mt-4 p-3 bg-yellow-900/30 border border-yellow-700 rounded text-yellow-200 text-xs text-left">
                    ‚ö†Ô∏è <b>Kh√¥ng t√¨m th·∫•y thi·∫øt b·ªã n√†o?</b><br>
                    H√£y m·ªü ·ª©ng d·ª•ng <b>"Thi·∫øt l·∫≠p MIDI √Çm thanh"</b> tr√™n Mac -> C·ª≠a s·ªï -> Hi·ªÉn th·ªã Studio MIDI -> B·∫•m icon Bluetooth ƒë·ªÉ gh√©p ƒë√¥i.
                </div>
            </div>

            <!-- Khu v·ª±c hi·ªÉn th·ªã N·ªët nh·∫°c -->
            <div class="flex-grow bg-gray-800 rounded-xl p-6 shadow-lg border border-gray-700 flex flex-col items-center justify-center relative overflow-hidden">
                <div id="visualizer-circle" class="w-48 h-48 rounded-full border-4 border-gray-600 flex items-center justify-center transition-all duration-100 bg-gray-900 z-10">
                    <div class="text-center">
                        <span id="note-display" class="block text-6xl font-extrabold text-white">--</span>
                        <span id="velocity-display" class="block text-sm text-gray-400 mt-2">L·ª±c: 0</span>
                    </div>
                </div>
                <div class="absolute inset-0 opacity-10 bg-[radial-gradient(ellipse_at_center,_var(--tw-gradient-stops))] from-blue-500 via-gray-900 to-gray-900"></div>
            </div>
        </div>

        <!-- C·ªôt Ph·∫£i: Log -->
        <div class="w-full md:w-1/2 bg-gray-900 rounded-xl border border-gray-700 flex flex-col overflow-hidden shadow-inner">
            <div class="bg-gray-800 p-3 border-b border-gray-700 flex justify-between items-center">
                <h3 class="font-semibold text-gray-300">Nh·∫≠t k√Ω t√≠n hi·ªáu (Log)</h3>
                <button id="btn-clear-log" class="text-xs text-gray-400 hover:text-white underline">X√≥a log</button>
            </div>
            <div id="midi-log" class="flex-grow p-4 overflow-y-auto custom-scrollbar font-mono text-sm space-y-1">
                <div class="text-gray-500 italic">Vui l√≤ng nh·∫•n n√∫t "Qu√©t t√¨m ƒë√†n Roland"...</div>
            </div>
        </div>
    </main>

    <script>
        let midiAccess = null;
        const noteNames = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
        
        const btnConnect = document.getElementById('btn-connect');
        const statusBadge = document.getElementById('connection-status');
        const logContainer = document.getElementById('midi-log');
        const noteDisplay = document.getElementById('note-display');
        const velocityDisplay = document.getElementById('velocity-display');
        const visualizer = document.getElementById('visualizer-circle');
        const btnClearLog = document.getElementById('btn-clear-log');
        const deviceListDiv = document.getElementById('device-list');
        const midiInputsUl = document.getElementById('midi-inputs');
        const macInstruction = document.getElementById('mac-instruction');

        btnConnect.addEventListener('click', () => {
            if (navigator.requestMIDIAccess) {
                log("ƒêang g·ªçi Web MIDI API...", "info");
                navigator.requestMIDIAccess({ sysex: false })
                    .then(onMIDISuccess, onMIDIFailure);
            } else {
                alert("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ MIDI.");
            }
        });

        btnClearLog.addEventListener('click', () => logContainer.innerHTML = '');

        function onMIDISuccess(access) {
            midiAccess = access;
            updateStatus("API Ready", "bg-blue-900 text-blue-200 border-blue-700");
            log("‚úÖ ƒê√£ k·∫øt n·ªëi Web MIDI API.", "success");
            
            btnConnect.textContent = "ƒêang qu√©t thi·∫øt b·ªã...";
            refreshDeviceList();

            // L·∫Øng nghe khi c√≥ thi·∫øt b·ªã c·∫Øm v√†o/r√∫t ra
            midiAccess.onstatechange = (e) => {
                log(`üîå Thay ƒë·ªïi tr·∫°ng th√°i: ${e.port.name} -> ${e.port.state}`, "warning");
                refreshDeviceList();
            };
        }

        function refreshDeviceList() {
            const inputs = midiAccess.inputs;
            midiInputsUl.innerHTML = '';
            deviceListDiv.classList.remove('hidden');
            
            if (inputs.size === 0) {
                midiInputsUl.innerHTML = '<li class="text-red-400">Kh√¥ng t√¨m th·∫•y thi·∫øt b·ªã n√†o!</li>';
                macInstruction.classList.remove('hidden');
                updateStatus("Kh√¥ng c√≥ ƒë√†n", "bg-red-900 text-red-200 border-red-700");
                log("‚ùå Kh√¥ng t√¨m th·∫•y thi·∫øt b·ªã MIDI. Ki·ªÉm tra Bluetooth Mac.", "error");
            } else {
                let foundRoland = false;
                macInstruction.classList.add('hidden');
                
                inputs.forEach((input) => {
                    const li = document.createElement('li');
                    li.textContent = `üéπ ${input.name} (Manufacturer: ${input.manufacturer || 'Unknown'})`;
                    midiInputsUl.appendChild(li);
                    
                    input.onmidimessage = getMIDIMessage;
                    log(`üëâ ƒê√£ k·∫øt n·ªëi v·ªõi: ${input.name}`, "success");
                    
                    if (input.name.toLowerCase().includes("roland") || input.name.toLowerCase().includes("fp")) {
                        foundRoland = true;
                    }
                });

                if (foundRoland) {
                    updateStatus("ƒê√£ n·ªëi Roland", "bg-green-900 text-green-200 border-green-700");
                    btnConnect.textContent = "ƒê√£ k·∫øt n·ªëi Roland ‚úÖ";
                    btnConnect.className = "w-full py-3 bg-green-600 text-white font-bold rounded-lg shadow-lg cursor-default opacity-80 mb-4";
                } else {
                    updateStatus("ƒê√£ n·ªëi MIDI kh√°c", "bg-yellow-900 text-yellow-200 border-yellow-700");
                }
            }
        }

        function onMIDIFailure(msg) {
            log("Kh√¥ng th·ªÉ truy c·∫≠p MIDI: " + msg, "error");
        }

        function getMIDIMessage(message) {
            const command = message.data[0];
            const note = message.data[1];
            const velocity = (message.data.length > 2) ? message.data[2] : 0;

            // B·ªè qua Clock/Sensing
            if (command >= 248) return;

            const cmdType = command & 0xF0; 

            // NOTE ON (144)
            if (cmdType === 144 && velocity > 0) {
                handleNoteOn(note, velocity);
                log(`üéµ Note ON: ${getNoteName(note)} [${note}] (L·ª±c: ${velocity})`, "input");
            } 
            // NOTE OFF (128) ho·∫∑c Note On velocity 0
            else if (cmdType === 128 || (cmdType === 144 && velocity === 0)) {
                handleNoteOff();
            }
            // Control Change (Pedal v.v...)
            else if (cmdType === 176) {
                log(`üéõÔ∏è Control Change (Pedal): Val=${note}, Data=${velocity}`, "gray");
            }
        }

        function getNoteName(noteNumber) {
            const octave = Math.floor(noteNumber / 12) - 1;
            const noteName = noteNames[noteNumber % 12];
            return `${noteName}${octave}`;
        }

        function handleNoteOn(note, velocity) {
            const noteName = getNoteName(note);
            noteDisplay.textContent = noteName;
            noteDisplay.style.color = "#60a5fa";
            velocityDisplay.textContent = `L·ª±c: ${velocity}`;
            
            visualizer.classList.remove('pulse-animation');
            void visualizer.offsetWidth;
            visualizer.classList.add('pulse-animation');
            visualizer.style.borderColor = "#3b82f6";
            
            const opacity = Math.min(velocity / 127 + 0.2, 1);
            visualizer.style.boxShadow = `0 0 30px rgba(59, 130, 246, ${opacity})`;
        }

        function handleNoteOff() {
            visualizer.style.borderColor = "#4b5563";
            visualizer.style.boxShadow = "none";
            noteDisplay.style.color = "#e5e7eb";
        }

        function log(msg, type = "normal") {
            const div = document.createElement('div');
            const time = new Date().toLocaleTimeString('vi-VN', { hour12: false });
            div.textContent = `[${time}] ${msg}`;
            
            if (type === "error") div.className = "text-red-400 font-bold";
            else if (type === "success") div.className = "text-green-400 font-bold";
            else if (type === "warning") div.className = "text-yellow-400";
            else if (type === "input") div.className = "text-blue-300 font-bold border-l-2 border-blue-500 pl-2";
            else if (type === "gray") div.className = "text-gray-500 text-xs";
            else div.className = "text-gray-300";

            logContainer.prepend(div);
        }

        function updateStatus(text, classes) {
            statusBadge.textContent = text;
            statusBadge.className = `px-3 py-1 rounded-full text-xs font-semibold transition-all border ${classes}`;
        }
    </script>
</body>
</html>
