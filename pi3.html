<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test K·∫øt N·ªëi Piano MIDI</title>
    <!-- Tailwind CSS ƒë·ªÉ giao di·ªán ƒë·∫πp v√† g·ªçn nh·∫π -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* Dark mode background */
            color: #e5e7eb;
        }

        /* Hi·ªáu ·ª©ng visualizer khi nh·∫≠n t√≠n hi·ªáu */
        .pulse-animation {
            animation: pulse-ring 0.5s cubic-bezier(0.215, 0.61, 0.355, 1);
        }

        @keyframes pulse-ring {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { transform: scale(1.05); box-shadow: 0 0 0 20px rgba(59, 130, 246, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }

        /* Thanh cu·ªôn t√πy ch·ªânh cho log */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #1f2937; 
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #4b5563; 
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #6b7280; 
        }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden">

    <!-- Header -->
    <header class="bg-gray-800 border-b border-gray-700 p-4 shadow-lg z-10">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl md:text-2xl font-bold text-blue-400 flex items-center gap-2">
                üéπ MIDI Tester
            </h1>
            <div id="connection-status" class="px-3 py-1 rounded-full text-xs font-semibold bg-red-900 text-red-200 border border-red-700">
                Ch∆∞a k·∫øt n·ªëi
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow flex flex-col md:flex-row p-4 gap-4 container mx-auto h-full pb-20">
        
        <!-- C·ªôt Tr√°i: Hi·ªÉn th·ªã Tr·ª±c quan -->
        <div class="w-full md:w-1/2 flex flex-col gap-4">
            <!-- N√∫t kh·ªüi ƒë·ªông -->
            <div class="bg-gray-800 rounded-xl p-6 shadow-lg border border-gray-700 text-center">
                <p class="text-gray-400 mb-4 text-sm">Nh·∫•n n√∫t b√™n d∆∞·ªõi ƒë·ªÉ tr√¨nh duy·ªát qu√©t thi·∫øt b·ªã Roland c·ªßa b·∫°n.</p>
                <button id="btn-connect" class="w-full py-3 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-lg transition-all shadow-lg active:scale-95">
                    B·∫Øt ƒë·∫ßu k·∫øt n·ªëi MIDI
                </button>
            </div>

            <!-- Khu v·ª±c hi·ªÉn th·ªã N·ªët nh·∫°c -->
            <div class="flex-grow bg-gray-800 rounded-xl p-6 shadow-lg border border-gray-700 flex flex-col items-center justify-center relative overflow-hidden">
                <div id="visualizer-circle" class="w-48 h-48 rounded-full border-4 border-gray-600 flex items-center justify-center transition-all duration-100 bg-gray-900 z-10">
                    <div class="text-center">
                        <span id="note-display" class="block text-6xl font-extrabold text-white">--</span>
                        <span id="velocity-display" class="block text-sm text-gray-400 mt-2">L·ª±c b·∫•m: 0</span>
                    </div>
                </div>
                
                <!-- Background decoration -->
                <div class="absolute inset-0 opacity-10 bg-[radial-gradient(ellipse_at_center,_var(--tw-gradient-stops))] from-blue-500 via-gray-900 to-gray-900"></div>
            </div>
        </div>

        <!-- C·ªôt Ph·∫£i: Nh·∫≠t k√Ω t√≠n hi·ªáu (Log) -->
        <div class="w-full md:w-1/2 bg-gray-900 rounded-xl border border-gray-700 flex flex-col overflow-hidden shadow-inner">
            <div class="bg-gray-800 p-3 border-b border-gray-700 flex justify-between items-center">
                <h3 class="font-semibold text-gray-300">Nh·∫≠t k√Ω t√≠n hi·ªáu (Log)</h3>
                <button id="btn-clear-log" class="text-xs text-gray-400 hover:text-white underline">X√≥a log</button>
            </div>
            <div id="midi-log" class="flex-grow p-4 overflow-y-auto custom-scrollbar font-mono text-sm space-y-1">
                <div class="text-gray-500 italic">ƒêang ch·ªù t√≠n hi·ªáu t·ª´ ƒë√†n...</div>
            </div>
        </div>
    </main>

    <!-- H∆∞·ªõng d·∫´n nhanh cho Mac -->
    <footer class="fixed bottom-0 w-full bg-gray-800 border-t border-gray-700 py-2 px-4 text-center text-xs text-gray-400">
        M·∫πo cho Mac M1: N·∫øu kh√¥ng th·∫•y ƒë√†n, h√£y v√†o <b>Audio MIDI Setup</b> tr√™n macOS &rarr; Window &rarr; Show MIDI Studio &rarr; Bluetooth icon ƒë·ªÉ gh√©p ƒë√¥i tr∆∞·ªõc.
    </footer>

    <script>
        // C√°c bi·∫øn to√†n c·ª•c
        let midiAccess = null;
        const noteNames = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
        
        // DOM Elements
        const btnConnect = document.getElementById('btn-connect');
        const statusBadge = document.getElementById('connection-status');
        const logContainer = document.getElementById('midi-log');
        const noteDisplay = document.getElementById('note-display');
        const velocityDisplay = document.getElementById('velocity-display');
        const visualizer = document.getElementById('visualizer-circle');
        const btnClearLog = document.getElementById('btn-clear-log');

        // X·ª≠ l√Ω s·ª± ki·ªán click n√∫t k·∫øt n·ªëi
        btnConnect.addEventListener('click', () => {
            if (navigator.requestMIDIAccess) {
                log("ƒêang y√™u c·∫ßu quy·ªÅn truy c·∫≠p MIDI...", "info");
                navigator.requestMIDIAccess({ sysex: false })
                    .then(onMIDISuccess, onMIDIFailure);
            } else {
                alert("Tr√¨nh duy·ªát n√†y kh√¥ng h·ªó tr·ª£ Web MIDI API. Vui l√≤ng d√πng Chrome, Edge ho·∫∑c Opera.");
                log("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ Web MIDI.", "error");
            }
        });

        // X√≥a log
        btnClearLog.addEventListener('click', () => {
            logContainer.innerHTML = '';
        });

        // Khi k·∫øt n·ªëi th√†nh c√¥ng
        function onMIDISuccess(access) {
            midiAccess = access;
            updateStatus(true);
            log("Web MIDI API ƒë√£ s·∫µn s√†ng!", "success");
            btnConnect.textContent = "ƒê√£ k√≠ch ho·∫°t MIDI";
            btnConnect.disabled = true;
            btnConnect.classList.add('bg-green-600', 'opacity-50', 'cursor-not-allowed');
            btnConnect.classList.remove('bg-blue-600', 'hover:bg-blue-500');

            const inputs = midiAccess.inputs;
            
            if (inputs.size === 0) {
                log("‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y thi·∫øt b·ªã MIDI n√†o. H√£y ki·ªÉm tra k·∫øt n·ªëi Bluetooth.", "warning");
            } else {
                inputs.forEach((input) => {
                    log(`ƒê√£ t√¨m th·∫•y thi·∫øt b·ªã: ${input.name}`, "success");
                    // G√°n s·ª± ki·ªán l·∫Øng nghe t√≠n hi·ªáu cho t·ª´ng thi·∫øt b·ªã
                    input.onmidimessage = getMIDIMessage;
                });
            }

            // L·∫Øng nghe s·ª± ki·ªán c·∫Øm/r√∫t thi·∫øt b·ªã
            midiAccess.onstatechange = (e) => {
                log(`Tr·∫°ng th√°i thi·∫øt b·ªã ${e.port.name}: ${e.port.state}`, "info");
            };
        }

        // Khi k·∫øt n·ªëi th·∫•t b·∫°i
        function onMIDIFailure() {
            log("Kh√¥ng th·ªÉ truy c·∫≠p h·ªá th·ªëng MIDI.", "error");
            updateStatus(false);
        }

        // X·ª≠ l√Ω th√¥ng ƒëi·ªáp MIDI nh·∫≠n ƒë∆∞·ª£c
        function getMIDIMessage(message) {
            const command = message.data[0];
            const note = message.data[1];
            const velocity = (message.data.length > 2) ? message.data[2] : 0;

            // L·ªçc b·ªè t√≠n hi·ªáu Active Sensing (254) v√† Clock (248) th∆∞·ªùng g·ª≠i li√™n t·ª•c g√¢y r√°c log
            if (command === 254 || command === 248) return;

            // D√πng Bitwise ƒë·ªÉ l·∫•y l·∫°i l·ªánh g·ªëc (b·ªè qua k√™nh channel)
            // 0x90 (144) - 0x9F (159) l√† Note On cho 16 k√™nh
            // 0x80 (128) - 0x8F (143) l√† Note Off cho 16 k√™nh
            const cmdType = command & 0xF0; 

            // Debug: In ra s·ªë li·ªáu th√¥ ƒë·ªÉ xem ƒë√†n g·ª≠i g√¨
            console.log(`Raw MIDI: Cmd=${command} Note=${note} Vel=${velocity}`);

            // Ki·ªÉm tra Note On (0x90)
            if (cmdType === 144 && velocity > 0) {
                handleNoteOn(note, velocity);
                log(`‚¨áÔ∏è Note ON:  ${getNoteName(note)} (N·ªët: ${note}, L·ª±c: ${velocity}, Cmd: ${command})`, "input");
            } 
            // Ki·ªÉm tra Note Off (0x80) HO·∫∂C Note On v·ªõi l·ª±c = 0 (c√°ch m·ªôt s·ªë ƒë√†n ho·∫°t ƒë·ªông)
            else if (cmdType === 128 || (cmdType === 144 && velocity === 0)) {
                handleNoteOff();
                // log(`‚¨ÜÔ∏è Note OFF: ${getNoteName(note)}`, "gray"); 
            }
            else {
                // Log c√°c t√≠n hi·ªáu l·∫° (nh∆∞ Pedal, Control Change) ƒë·ªÉ bi·∫øt ƒë√†n c√≥ k·∫øt n·ªëi kh√¥ng
                log(`üì° T√≠n hi·ªáu kh√°c: Cmd=${command}, Data1=${note}, Data2=${velocity}`, "gray");
            }
        }

        // Chuy·ªÉn ƒë·ªïi s·ªë MIDI sang t√™n n·ªët (V√≠ d·ª•: 60 -> C4)
        function getNoteName(noteNumber) {
            const octave = Math.floor(noteNumber / 12) - 1;
            const noteName = noteNames[noteNumber % 12];
            return `${noteName}${octave}`;
        }

        // X·ª≠ l√Ω giao di·ªán khi nh·∫•n ph√≠m
        function handleNoteOn(note, velocity) {
            const noteName = getNoteName(note);
            
            // C·∫≠p nh·∫≠t text
            noteDisplay.textContent = noteName;
            noteDisplay.style.color = "#60a5fa"; // blue-400
            velocityDisplay.textContent = `L·ª±c b·∫•m: ${velocity}`;

            // Hi·ªáu ·ª©ng visualizer
            visualizer.classList.remove('pulse-animation');
            void visualizer.offsetWidth; // Trigger reflow ƒë·ªÉ reset animation
            visualizer.classList.add('pulse-animation');
            visualizer.style.borderColor = "#3b82f6"; // blue-500
            
            // ƒê·ªïi m√†u vi·ªÅn d·ª±a tr√™n l·ª±c b·∫•m (nh·∫°t -> ƒë·∫≠m)
            const opacity = Math.min(velocity / 127 + 0.2, 1);
            visualizer.style.boxShadow = `0 0 30px rgba(59, 130, 246, ${opacity})`;
        }

        // X·ª≠ l√Ω giao di·ªán khi nh·∫£ ph√≠m
        function handleNoteOff() {
            visualizer.style.borderColor = "#4b5563"; // gray-600
            visualizer.style.boxShadow = "none";
            noteDisplay.style.color = "#e5e7eb"; // Tr·ªü v·ªÅ m√†u tr·∫Øng
        }

        // H√†m helper ƒë·ªÉ ghi log ra m√†n h√¨nh
        function log(msg, type = "normal") {
            const div = document.createElement('div');
            const time = new Date().toLocaleTimeString('vi-VN', { hour12: false });
            div.textContent = `[${time}] ${msg}`;
            
            // Style cho t·ª´ng lo·∫°i log
            if (type === "error") div.className = "text-red-400";
            else if (type === "success") div.className = "text-green-400 font-bold";
            else if (type === "warning") div.className = "text-yellow-400";
            else if (type === "input") div.className = "text-blue-300 font-bold border-l-2 border-blue-500 pl-2";
            else if (type === "gray") div.className = "text-gray-600";
            else div.className = "text-gray-300";

            logContainer.prepend(div);
        }

        // C·∫≠p nh·∫≠t badge tr·∫°ng th√°i
        function updateStatus(isConnected) {
            if (isConnected) {
                statusBadge.textContent = "ƒê√£ s·∫µn s√†ng";
                statusBadge.className = "px-3 py-1 rounded-full text-xs font-semibold bg-green-900 text-green-200 border border-green-700 transition-all";
            } else {
                statusBadge.textContent = "L·ªói k·∫øt n·ªëi";
                statusBadge.className = "px-3 py-1 rounded-full text-xs font-semibold bg-red-900 text-red-200 border border-red-700 transition-all";
            }
        }
    </script>
</body>
</html>
