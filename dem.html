<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Đệm hát khi nhậu — 5 hợp âm guitar “real”</title>

  <!-- WebAudioFont core -->
  <script src="https://surikov.github.io/webaudiofont/npm/dist/WebAudioFontPlayer.js"></script>
  <!-- Acoustic steel guitar (LK) preset -->
  <script src="https://surikov.github.io/webaudiofontdata/sound/0250_LK_AcousticSteel_SF2_file.js"></script>
  <!-- preset variable: _tone_0250_LK_AcousticSteel_SF2_file -->
  <style>
    :root { color-scheme: dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 20px; line-height: 1.35; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; margin: 10px 0; }
    button { padding: 10px 12px; border-radius: 10px; border: 1px solid #444; background: #1b1b1b; color: #fff; cursor: pointer; }
    button:active { transform: translateY(1px); }
    .card { border: 1px solid #333; border-radius: 14px; padding: 14px; background: #121212; max-width: 980px; }
    label { display: inline-flex; gap: 8px; align-items: center; }
    input[type="range"] { width: 240px; }
    input[type="number"] { width: 88px; padding: 6px 8px; border-radius: 10px; border: 1px solid #444; background: #0f0f0f; color: #fff; }
    .small { opacity: .85; font-size: 12px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .pill { padding: 4px 10px; border-radius: 999px; border: 1px solid #333; background: #0f0f0f; }
  </style>
</head>

<body>
  <h1>Đệm hát khi nhậu — 5 hợp âm guitar “real”</h1>

  <div class="card">
    <div class="row">
      <button id="btnEnable">Bật âm thanh</button>
      <span class="pill small">Preset: LK AcousticSteel (WebAudioFont)</span>
      <span class="pill small mono" id="status">chưa khởi tạo</span>
    </div>

    <div class="row">
      <label>
        Tempo (BPM)
        <input id="bpm" type="range" min="50" max="200" step="1" value="92" />
        <input id="bpmNum" type="number" min="50" max="200" step="1" value="92" />
      </label>

      <label title="Độ ‘rải’ giữa các dây (tự bám theo BPM)">
        Strum feel
        <input id="feel" type="range" min="0" max="100" step="1" value="55" />
      </label>

      <label title="Humanize timing/velocity để giống người đánh hơn">
        Humanize
        <input id="human" type="range" min="0" max="100" step="1" value="45" />
      </label>
    </div>

    <div class="row">
      <label>
        Metronome
        <input id="metro" type="checkbox" />
      </label>
      <button id="btnStop">Stop (tắt tiếng)</button>
      <span class="small">Mẹo: bấm hợp âm rồi canh theo metronome/BPM cho đúng thực tế.</span>
    </div>

    <hr style="border-color:#2a2a2a" />

    <div class="row">
      <button onclick="playChord('C','down')">C ↓</button>
      <button onclick="playChord('G','down')">G ↓</button>
      <button onclick="playChord('Am','down')">Am ↓</button>
      <button onclick="playChord('D','down')">D ↓</button>
      <button onclick="playChord('Em','down')">Em ↓</button>
    </div>

    <div class="row">
      <button onclick="playChord('C','up')">C ↑</button>
      <button onclick="playChord('G','up')">G ↑</button>
      <button onclick="playChord('Am','up')">Am ↑</button>
      <button onclick="playChord('D','up')">D ↑</button>
      <button onclick="playChord('Em','up')">Em ↑</button>
      <span class="small">(↑ là rải từ dây cao xuống)</span>
    </div>

    <p class="small">
      Nếu bạn muốn đổi “màu” guitar (dày/khô/đanh hơn), chỉ cần thay file preset & biến preset theo catalog WebAudioFontdata.
      (Ví dụ cùng Acoustic Guitar (steel) có nhiều biến thể khác nhau).  [oai_citation:2‡Surikof](https://surikov.github.io/webaudiofontdata/sound/)
    </p>
  </div>

<script>
  // ----------------------------
  // WebAudio setup
  // ----------------------------
  const AudioContextFunc = window.AudioContext || window.webkitAudioContext;
  let ctx = null;
  let player = null;
  let preset = null;

  // Master chain: guitar -> masterGain -> compressor -> eq -> (dry+wet) -> destination
  let masterGain, compressor, hp, lp, convolver, wetGain, dryGain, outGain;
  let activeNodes = []; // for stop()

  function setStatus(t){ document.getElementById('status').textContent = t; }

  function makeImpulseResponse(context, seconds = 1.4, decay = 3.2) {
    // Simple “room” impulse: decaying noise. Not perfect, but makes it feel less dry.
    const rate = context.sampleRate;
    const length = Math.max(1, Math.floor(rate * seconds));
    const ir = context.createBuffer(2, length, rate);
    for (let ch = 0; ch < 2; ch++) {
      const data = ir.getChannelData(ch);
      for (let i = 0; i < length; i++) {
        const t = i / length;
        const env = Math.pow(1 - t, decay);
        data[i] = (Math.random() * 2 - 1) * env;
      }
    }
    return ir;
  }

  async function ensureAudio() {
    if (!ctx) {
      ctx = new AudioContextFunc();
      player = new WebAudioFontPlayer();

      // preset variable from loaded JS:
      // file: 0250_LK_AcousticSteel_SF2_file.js
      // variable: _tone_0250_LK_AcousticSteel_SF2_file
      preset = window._tone_0250_LK_AcousticSteel_SF2_file;

      // decode (important for better runtime performance)
      player.loader.decodeAfterLoading(ctx, '_tone_0250_LK_AcousticSteel_SF2_file');

      // chain
      masterGain = ctx.createGain();
      masterGain.gain.value = 0.95;

      compressor = ctx.createDynamicsCompressor();
      compressor.threshold.value = -22;
      compressor.knee.value = 18;
      compressor.ratio.value = 3.2;
      compressor.attack.value = 0.008;
      compressor.release.value = 0.18;

      hp = ctx.createBiquadFilter();
      hp.type = 'highpass';
      hp.frequency.value = 80;
      hp.Q.value = 0.7;

      lp = ctx.createBiquadFilter();
      lp.type = 'lowpass';
      lp.frequency.value = 9000;
      lp.Q.value = 0.7;

      // Reverb send/return
      convolver = ctx.createConvolver();
      convolver.buffer = makeImpulseResponse(ctx, 1.25, 3.6);

      wetGain = ctx.createGain();
      wetGain.gain.value = 0.18;

      dryGain = ctx.createGain();
      dryGain.gain.value = 1.0;

      outGain = ctx.createGain();
      outGain.gain.value = 0.95;

      // Routing:
      // master -> comp -> hp -> lp -> split (dry + wet) -> out -> destination
      masterGain.connect(compressor);
      compressor.connect(hp);
      hp.connect(lp);

      lp.connect(dryGain);
      lp.connect(convolver);
      convolver.connect(wetGain);

      dryGain.connect(outGain);
      wetGain.connect(outGain);

      outGain.connect(ctx.destination);

      setStatus('ready');
    }

    if (ctx.state !== 'running') {
      await ctx.resume();
    }
  }

  // ----------------------------
  // UI bindings
  // ----------------------------
  const bpm = document.getElementById('bpm');
  const bpmNum = document.getElementById('bpmNum');
  const feel = document.getElementById('feel');
  const human = document.getElementById('human');
  const metro = document.getElementById('metro');

  bpm.addEventListener('input', () => bpmNum.value = bpm.value);
  bpmNum.addEventListener('input', () => bpm.value = bpmNum.value);

  document.getElementById('btnEnable').addEventListener('click', async () => {
    await ensureAudio();
    // tiny “click” to confirm audio unlocked
    click(ctx.currentTime + 0.01, 0.04, 1200);
  });

  document.getElementById('btnStop').addEventListener('click', () => stopAll());

  // ----------------------------
  // Guitar chord voicings (standard tuning)
  // MIDI: E2=40 A2=45 D3=50 G3=55 B3=59 E4=64
  // We pass pitches low->high. Muted strings are omitted.
  // ----------------------------
  const chords = {
    C:  [48, 52, 55, 60, 64],          // x32010
    G:  [43, 47, 50, 55, 59, 67],      // 320003
    Am: [45, 52, 57, 60, 64],          // x02210
    D:  [50, 57, 62, 66],              // xx0232
    Em: [40, 47, 52, 55, 59, 64],      // 022000
  };

  // ----------------------------
  // Humanized strum using queueWaveTable
  // ----------------------------
  function clamp(x, a, b){ return Math.max(a, Math.min(b, x)); }

  function strumParams() {
    const bpmVal = Number(bpm.value);
    const beat = 60 / bpmVal;

    // feel slider controls spread: 0..100 -> tighter..looser
    // Base spread scales with beat, but clamp to keep it musical
    const feel01 = Number(feel.value) / 100;
    const spread = clamp(beat * (0.05 + 0.18 * feel01), 0.020, 0.110);

    const human01 = Number(human.value) / 100;
    const jitter = 0.000 + 0.010 * human01;      // seconds
    const velVar = 0.00 + 0.22 * human01;        // +/- range

    // chord ring time: let it ring ~ 1.6 to 2.6 beats
    const ring = clamp(beat * (1.7 + 0.9 * feel01), 1.0, 3.0);

    return { beat, spread, jitter, velVar, ring };
  }

  function randSigned() { return (Math.random() * 2 - 1); }

  // Soft metronome click
  function click(when, dur, freq) {
    const osc = ctx.createOscillator();
    const g = ctx.createGain();
    osc.type = 'square';
    osc.frequency.value = freq;
    g.gain.setValueAtTime(0.0, when);
    g.gain.linearRampToValueAtTime(0.22, when + 0.002);
    g.gain.exponentialRampToValueAtTime(0.0001, when + dur);
    osc.connect(g);
    g.connect(ctx.destination);
    osc.start(when);
    osc.stop(when + dur + 0.02);
    activeNodes.push(osc, g);
  }

  let metroTimer = null;
  function startMetronome() {
    if (!ctx) return;
    stopMetronome();
    const bpmVal = Number(bpm.value);
    const beat = 60 / bpmVal;

    let next = ctx.currentTime + 0.02;
    const lookahead = 0.10;
    const tick = () => {
      const now = ctx.currentTime;
      while (next < now + lookahead) {
        click(next, 0.032, 1500);
        next += beat;
      }
      metroTimer = setTimeout(tick, 25);
    };
    tick();
  }

  function stopMetronome() {
    if (metroTimer) { clearTimeout(metroTimer); metroTimer = null; }
  }

  metro.addEventListener('change', async () => {
    await ensureAudio();
    if (metro.checked) startMetronome();
    else stopMetronome();
  });

  async function playChord(name, dir='down') {
    await ensureAudio();

    const pitches0 = chords[name];
    if (!pitches0) return;

    // if metronome ON, keep it synced to current BPM changes
    if (metro.checked) startMetronome();

    const { spread, jitter, velVar, ring } = strumParams();
    const when0 = ctx.currentTime + 0.012;

    const pitches = (dir === 'up') ? [...pitches0].reverse() : pitches0;

    // A little “pick emphasis”: stronger at first notes, weaker later
    for (let i = 0; i < pitches.length; i++) {
      const p = pitches[i];
      const t = when0 + i * spread + randSigned() * jitter;

      const baseVel = 0.68 - 0.08 * (i / Math.max(1, pitches.length - 1));
      const vel = clamp(baseVel + randSigned() * velVar, 0.35, 0.95);

      // queueWaveTable(context, target, preset, when, pitch, duration, volume, slides)
      const env = player.queueWaveTable(
        ctx,
        masterGain,             // target node in our chain
        preset,
        t,
        p,
        ring,
        vel
      );
      activeNodes.push(env);
    }
  }

  function stopAll() {
    stopMetronome();
    // Try to cancel envelopes returned by queueWaveTable, if present
    for (const n of activeNodes) {
      try {
        if (n && typeof n.cancel === 'function') n.cancel();
        if (n && typeof n.stop === 'function') n.stop();
        if (n && typeof n.disconnect === 'function') n.disconnect();
      } catch (_) {}
    }
    activeNodes = [];
    if (ctx) setStatus('stopped');
  }

  // Keep BPM sliders in sync on load
  bpmNum.value = bpm.value;
</script>
</body>
</html>