<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Đệm hát khi nhậu — 5 hợp âm</title>
  <style>
    :root { --bg:#0b0f19; --card:#121a2b; --muted:#9fb0d0; --text:#e9eefc; --btn:#2a3b63; --btn2:#1e2a46; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:var(--bg); color:var(--text); }
    .wrap { max-width: 980px; margin: 0 auto; padding: 20px; }
    h1 { margin: 0 0 10px; font-size: 20px; font-weight: 700; }
    p { margin: 6px 0 0; color: var(--muted); line-height: 1.4; }
    .card { background: var(--card); border: 1px solid rgba(255,255,255,.08); border-radius: 14px; padding: 16px; margin-top: 14px; }
    .row { display:flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    .btn {
      appearance:none; border: 1px solid rgba(255,255,255,.12);
      background: var(--btn); color: var(--text);
      padding: 12px 14px; border-radius: 12px; cursor: pointer;
      font-weight: 650; letter-spacing: .2px;
    }
    .btn:hover { background: #324879; }
    .btn.secondary { background: var(--btn2); }
    .btn:disabled { opacity: .55; cursor:not-allowed; }
    .chords { display:grid; grid-template-columns: repeat(5, minmax(120px, 1fr)); gap: 10px; }
    @media (max-width: 720px) { .chords { grid-template-columns: repeat(2, minmax(120px, 1fr)); } }
    label { display:block; font-size: 12px; color: var(--muted); margin-bottom: 6px; }
    input[type="range"] { width: 240px; }
    .pill { display:inline-block; padding: 3px 10px; border-radius: 999px; border: 1px solid rgba(255,255,255,.12); color: var(--muted); font-size: 12px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Đệm hát khi nhậu — 5 hợp âm cơ bản</h1>
    <p>Chọn tempo (BPM), bật metronome nếu cần, rồi bấm hợp âm để phát kiểu gảy xuống (strum).</p>

    <div class="card">
      <div class="row">
        <button id="unlockBtn" class="btn">Bật âm thanh</button>
        <span id="audioState" class="pill">Audio: chưa bật</span>
      </div>

      <div style="height:10px"></div>

      <div class="row">
        <div>
          <label for="tempo">Tempo (BPM)</label>
          <input id="tempo" type="range" min="60" max="200" value="120" />
          <span class="pill"><span id="tempoVal" class="mono">120</span> BPM</span>
        </div>

        <div>
          <label>Metronome</label>
          <button id="metroBtn" class="btn secondary" disabled>Bật metronome</button>
          <span id="metroState" class="pill">Tắt</span>
        </div>
      </div>

      <div style="height:14px"></div>

      <div class="chords">
        <button class="btn chord" data-chord="C"  disabled>C</button>
        <button class="btn chord" data-chord="G"  disabled>G</button>
        <button class="btn chord" data-chord="Am" disabled>Am</button>
        <button class="btn chord" data-chord="F"  disabled>F</button>
        <button class="btn chord" data-chord="Dm" disabled>Dm</button>
      </div>

      <p style="margin-top:12px;">
        Gợi ý: vòng quốc dân <span class="mono">C – G – Am – F</span>. Nếu muốn đổi “độ nhanh” của cú gảy, cứ chỉnh BPM cho khớp bài.
      </p>
    </div>

    <div class="card">
      <p class="mono" style="margin:0;">
        Mẹo dùng nhanh: Bật âm thanh → chỉnh BPM → bật metronome (nếu cần) → bấm hợp âm theo lời.
      </p>
    </div>
  </div>

<script>
(() => {
  // ---------- Audio engine ----------
  let ctx = null;
  let master = null;

  const $ = (sel) => document.querySelector(sel);
  const tempoEl = $("#tempo");
  const tempoValEl = $("#tempoVal");
  const unlockBtn = $("#unlockBtn");
  const audioStateEl = $("#audioState");
  const metroBtn = $("#metroBtn");
  const metroStateEl = $("#metroState");
  const chordBtns = Array.from(document.querySelectorAll(".btn.chord"));

  // Basic chord voicings (simple triads + extra note for fullness).
  // Using MIDI notes (A4=69 => 440Hz). These are "piano-like" voicings, not exact guitar strings.
  const CHORDS = {
    "C":  [48, 52, 55, 60],   // C3 E3 G3 C4
    "G":  [43, 47, 50, 55],   // G2 B2 D3 G3
    "Am": [45, 48, 52, 57],   // A2 C3 E3 A3
    "F":  [41, 45, 48, 53],   // F2 A2 C3 F3
    "Dm": [38, 45, 50, 53],   // D2 A2 D3 F3 (open-ish)
  };

  function midiToHz(m) {
    return 440 * Math.pow(2, (m - 69) / 12);
  }

  function ensureAudio() {
    if (ctx) return;
    ctx = new (window.AudioContext || window.webkitAudioContext)();

    master = ctx.createGain();
    master.gain.value = 0.9;

    // Light “guitar-ish” tone shaping
    const lp = ctx.createBiquadFilter();
    lp.type = "lowpass";
    lp.frequency.value = 2400;
    lp.Q.value = 0.7;

    const hp = ctx.createBiquadFilter();
    hp.type = "highpass";
    hp.frequency.value = 60;

    master.connect(lp);
    lp.connect(hp);
    hp.connect(ctx.destination);
  }

  function pluckNote(freq, t0, dur = 1.2) {
    // Two detuned oscillators + fast decay to mimic a pluck
    const o1 = ctx.createOscillator();
    const o2 = ctx.createOscillator();
    o1.type = "triangle";
    o2.type = "triangle";
    o1.frequency.setValueAtTime(freq, t0);
    o2.frequency.setValueAtTime(freq, t0);
    o2.detune.setValueAtTime(+7, t0); // slight detune in cents

    const g = ctx.createGain();
    g.gain.setValueAtTime(0.0001, t0);
    g.gain.linearRampToValueAtTime(0.9, t0 + 0.006);
    g.gain.exponentialRampToValueAtTime(0.0001, t0 + dur);

    o1.connect(g);
    o2.connect(g);
    g.connect(master);

    o1.start(t0);
    o2.start(t0);
    o1.stop(t0 + dur + 0.02);
    o2.stop(t0 + dur + 0.02);
  }

  function playChordStrum(name) {
    if (!ctx) return;
    const notes = CHORDS[name];
    if (!notes) return;

    const bpm = Number(tempoEl.value);
    // Delay per "string" based on tempo: faster at higher BPM
    const perNoteDelay = (60 / bpm) / 12; // ~0.041s at 120 BPM
    const now = ctx.currentTime + 0.01;

    notes.forEach((midi, i) => {
      const t = now + i * perNoteDelay;
      const freq = midiToHz(midi);
      pluckNote(freq, t, 1.1);
    });
  }

  // ---------- Metronome ----------
  let metroOn = false;
  let metroTimer = null;
  let metroBeat = 0;

  function clickSound(t0, accent=false) {
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type = "square";
    o.frequency.setValueAtTime(accent ? 1500 : 1000, t0);

    g.gain.setValueAtTime(0.0001, t0);
    g.gain.linearRampToValueAtTime(accent ? 0.25 : 0.18, t0 + 0.002);
    g.gain.exponentialRampToValueAtTime(0.0001, t0 + 0.05);

    o.connect(g);
    g.connect(master);

    o.start(t0);
    o.stop(t0 + 0.06);
  }

  function startMetronome() {
    if (!ctx) return;
    if (metroOn) return;
    metroOn = true;
    metroBeat = 0;

    // Simple setInterval is OK for casual use; schedule slightly ahead for stability.
    const scheduleAhead = 0.08;
    let nextTick = ctx.currentTime + 0.02;

    metroTimer = setInterval(() => {
      const bpm = Number(tempoEl.value);
      const spb = 60 / bpm;

      while (nextTick < ctx.currentTime + scheduleAhead) {
        const accent = (metroBeat % 4 === 0);
        clickSound(nextTick, accent);
        nextTick += spb;
        metroBeat++;
      }
    }, 25);

    metroStateEl.textContent = "Bật";
    metroBtn.textContent = "Tắt metronome";
  }

  function stopMetronome() {
    metroOn = false;
    if (metroTimer) clearInterval(metroTimer);
    metroTimer = null;
    metroStateEl.textContent = "Tắt";
    metroBtn.textContent = "Bật metronome";
  }

  // ---------- UI wiring ----------
  tempoEl.addEventListener("input", () => {
    tempoValEl.textContent = tempoEl.value;
  });

  unlockBtn.addEventListener("click", async () => {
    ensureAudio();
    await ctx.resume();

    audioStateEl.textContent = "Audio: đã bật";
    unlockBtn.disabled = true;
    metroBtn.disabled = false;
    chordBtns.forEach(b => b.disabled = false);
  });

  chordBtns.forEach(btn => {
    btn.addEventListener("click", () => {
      if (!ctx) return;
      playChordStrum(btn.dataset.chord);
    });
  });

  metroBtn.addEventListener("click", () => {
    if (!ctx) return;
    if (!metroOn) startMetronome();
    else stopMetronome();
  });

  // Safety: stop metro when tab hidden (optional)
  document.addEventListener("visibilitychange", () => {
    if (document.hidden && metroOn) stopMetronome();
  });
})();
</script>
</body>
</html>