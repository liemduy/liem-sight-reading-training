<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Guitar — Soundfont Player (Fix: HTTPS + Probe + Connect)</title>

  <!-- CDN: soundfont-player -->
  <script src="https://cdn.jsdelivr.net/npm/soundfont-player@0.12.0/dist/soundfont-player.min.js"></script>

  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 16px; line-height: 1.35; }
    .grid { display: grid; gap: 12px; grid-template-columns: 1fr; max-width: 980px; }
    @media (min-width: 900px) { .grid { grid-template-columns: 1.2fr 0.8fr; } }
    .card { border: 1px solid rgba(128,128,128,.35); border-radius: 10px; padding: 12px; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .row3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
    label { display: grid; gap: 6px; font-size: 13px; opacity: .95; }
    input[type="number"], textarea, select {
      width: 100%; padding: 10px; border-radius: 8px; border: 1px solid rgba(128,128,128,.35);
      background: transparent; color: inherit;
    }
    textarea { min-height: 120px; resize: vertical; }
    input[type="range"] { width: 100%; }
    button {
      padding: 10px 12px; border-radius: 8px; border: 1px solid rgba(128,128,128,.35);
      background: rgba(128,128,128,.12); color: inherit; cursor: pointer;
    }
    button.primary { background: rgba(0,128,255,.18); border-color: rgba(0,128,255,.35); }
    button:disabled { opacity: .55; cursor: not-allowed; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size: 12px; }
    .status { white-space: pre-wrap; padding: 10px; border-radius: 8px; border: 1px dashed rgba(128,128,128,.45); }
    .small { font-size: 12px; opacity: .85; }
    .pill { display:inline-block; padding: 3px 8px; border-radius: 999px; border: 1px solid rgba(128,128,128,.35); font-size: 12px; opacity: .9; }
  </style>
</head>

<body>
  <h2>Guitar (Soundfont) — Fix: HTTPS + Probe + Connect</h2>
  <div class="small">
    <span class="pill">soundfont-player</span>
    <span class="pill">mp3-only</span>
    <span class="pill">probe URL</span>
    <span class="pill">force connect</span>
  </div>

  <div class="grid">
    <div class="card">
      <h3>Controls</h3>

      <div class="row3">
        <label>
          Instrument
          <select id="inst">
            <option value="acoustic_guitar_nylon" selected>Acoustic Guitar (Nylon)</option>
            <option value="acoustic_guitar_steel">Acoustic Guitar (Steel)</option>
            <option value="acoustic_grand_piano">Piano (debug)</option>
          </select>
          <div class="small">Thử “Piano (debug)” để loại trừ trường hợp guitar sample bị thiếu/mapping lỗi.</div>
        </label>

        <label>
          Soundfont set
          <select id="sfset">
            <option value="MusyngKite" selected>MusyngKite</option>
            <option value="FluidR3_GM">FluidR3_GM</option>
          </select>
        </label>

        <label>
          Soundfont CDN (HTTPS)
          <select id="cdn">
            <option value="gleitz" selected>gleitz.github.io</option>
            <option value="jsdelivr">jsDelivr (GitHub gh-pages)</option>
            <option value="rawgh">raw.githubusercontent.com (fallback)</option>
          </select>
        </label>
      </div>

      <div class="row">
        <label>
          Output gain
          <input id="outGain" type="range" min="0" max="100" value="80" />
          <div class="small"><span id="outGainLabel">80</span>%</div>
        </label>

        <label>
          Tempo (BPM)
          <input id="bpm" type="number" min="40" max="220" value="84" />
        </label>
      </div>

      <label>
        Progression
        <textarea id="prog">C | G | Am | F</textarea>
      </label>

      <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top: 10px;">
        <button class="primary" id="btnStart">Start Audio / Load</button>
        <button id="btnProbe" disabled>Probe Soundfont URL</button>
        <button id="btnNote" disabled>Play single note (C4)</button>
        <button id="btnPlay" disabled>Play progression</button>
        <button id="btnStop" disabled>Stop</button>
        <button id="btnBeep">Beep test</button>
      </div>

      <div class="status mono" id="status">Ready.</div>
    </div>

    <div class="card">
      <h3>Diagnostics (không cần DevTools)</h3>
      <div class="small">
        Nếu <b>Probe = FAIL</b> thì guitar chắc chắn không kêu (CDN/CORS/network filter). Nếu <b>Probe = OK</b> mà vẫn im lặng,
        khả năng cao là instrument không connect đúng hoặc bị mute bởi gain (file này đã ép connect).
      </div>

      <label class="small">
        Resolved soundfont JS URL
        <div class="status mono" id="sfUrl">—</div>
      </label>

      <label class="small">
        Probe result
        <div class="status mono" id="probe">—</div>
      </label>

      <label class="small">
        Play log
        <div class="status mono" id="playlog">—</div>
      </label>
    </div>
  </div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  const ui = {
    inst: $("inst"),
    sfset: $("sfset"),
    cdn: $("cdn"),
    outGain: $("outGain"),
    outGainLabel: $("outGainLabel"),
    bpm: $("bpm"),
    prog: $("prog"),
    btnStart: $("btnStart"),
    btnProbe: $("btnProbe"),
    btnNote: $("btnNote"),
    btnPlay: $("btnPlay"),
    btnStop: $("btnStop"),
    btnBeep: $("btnBeep"),
    status: $("status"),
    sfUrl: $("sfUrl"),
    probe: $("probe"),
    playlog: $("playlog"),
  };

  function log(msg) { ui.status.textContent = msg; }
  function plog(msg) { ui.playlog.textContent = msg + "\n" + (ui.playlog.textContent || ""); }
  function clamp(x, a, b) { return Math.max(a, Math.min(b, x)); }
  function norm01(v) { return clamp(Number(v) / 100, 0, 1); }
  function lerp(a, b, t) { return a + (b - a) * t; }

  function updateLabels() { ui.outGainLabel.textContent = ui.outGain.value; }
  ui.outGain.addEventListener("input", updateLabels);
  updateLabels();

  // Audio
  let ac = null;
  let instrument = null;

  // simple output chain
  const out = { pre: null, hp: null, lp: null, master: null };

  function ensureAudio() {
    if (ac) return ac;
    const AudioCtx = window.AudioContext || window.webkitAudioContext;
    ac = new AudioCtx({ latencyHint: "interactive" });

    out.pre = ac.createGain();

    out.hp = ac.createBiquadFilter();
    out.hp.type = "highpass";
    out.hp.frequency.value = 80;

    out.lp = ac.createBiquadFilter();
    out.lp.type = "lowpass";
    out.lp.frequency.value = 12000;

    out.master = ac.createGain();

    out.pre.connect(out.hp);
    out.hp.connect(out.lp);
    out.lp.connect(out.master);
    out.master.connect(ac.destination);

    applyGain();
    return ac;
  }

  async function unlock() {
    const ctx = ensureAudio();
    if (ctx.state !== "running") await ctx.resume();
  }

  function applyGain() {
    if (!ac) return;
    const g = Math.pow(norm01(ui.outGain.value), 1.4);
    out.master.gain.setTargetAtTime(g, ac.currentTime, 0.01);
  }
  ui.outGain.addEventListener("input", applyGain);

  // IMPORTANT: build HTTPS URL for midi-js-soundfonts js file
  // soundfont-player documents nameToUrl + destination + notes option, etc.  [oai_citation:2‡GitHub](https://github.com/danigb/soundfont-player)
  function soundfontBase() {
    switch (ui.cdn.value) {
      case "jsdelivr":
        return "https://cdn.jsdelivr.net/gh/gleitz/midi-js-soundfonts@gh-pages/";
      case "rawgh":
        return "https://raw.githubusercontent.com/gleitz/midi-js-soundfonts/gh-pages/";
      case "gleitz":
      default:
        return "https://gleitz.github.io/midi-js-soundfonts/";
    }
  }

  function makeNameToUrl() {
    const base = soundfontBase();
    return (name, soundfont, format) => {
      const sf = soundfont || "MusyngKite";
      const fmt = format || "mp3";
      const url = `${base}${sf}/${name}-${fmt}.js`;
      ui.sfUrl.textContent = url;
      return url;
    };
  }

  async function probeUrl(url) {
    // Try HEAD first (cheap), fallback to GET if blocked.
    ui.probe.textContent = "Probing...";
    try {
      let r;
      try {
        r = await fetch(url, { method: "HEAD", mode: "cors", cache: "no-store" });
      } catch (_) {
        r = null;
      }
      if (r && r.ok) {
        ui.probe.textContent = `OK (HEAD ${r.status})`;
        return true;
      }

      const rg = await fetch(url, { method: "GET", mode: "cors", cache: "no-store" });
      if (!rg.ok) {
        ui.probe.textContent = `FAIL (GET ${rg.status})`;
        return false;
      }
      // read small chunk to confirm it is JS, not an HTML error page
      const text = await rg.text();
      const head = (text || "").slice(0, 120).replace(/\s+/g, " ");
      ui.probe.textContent = `OK (GET ${rg.status})\nFirst 120 chars:\n${head}`;
      return true;
    } catch (e) {
      ui.probe.textContent = `FAIL (fetch error)\n${String(e)}`;
      return false;
    }
  }

  async function loadInstrument() {
    const ctx = ensureAudio();
    const name = ui.inst.value;
    const sfset = ui.sfset.value;

    const nameToUrl = makeNameToUrl();
    const url = nameToUrl(name, sfset, "mp3");

    // Probe first so bạn thấy rõ đang bị chặn hay không
    const ok = await probeUrl(url);
    if (!ok) {
      log("Soundfont URL bị chặn/không truy cập được. Đổi CDN và thử lại.");
      return false;
    }

    log("Loading instrument...");
    try {
      instrument = await window.Soundfont.instrument(ctx, name, {
        soundfont: sfset,
        format: "mp3",
        nameToUrl,
        destination: out.pre,
        gain: 1.0,
        attack: 0.003,
        release: 0.18,
        // NOTE: tạm thời KHÔNG giới hạn notes để loại trừ lỗi “decode thiếu note -> im lặng”
      });

      // Force connect (kể cả đã set destination)
      if (instrument && typeof instrument.connect === "function") {
        instrument.connect(out.pre);
      }

      // “ping” 1 nốt để xác nhận có tiếng thật
      instrument.play(60, ctx.currentTime + 0.05, { gain: 0.8, duration: 0.35, attack: 0.002, release: 0.10 });

      log(`Loaded: ${name} (${sfset}).`);
      plog(`Loaded OK. connect=${typeof instrument.connect === "function"}`);

      ui.btnProbe.disabled = false;
      ui.btnNote.disabled = false;
      ui.btnPlay.disabled = false;
      return true;
    } catch (e) {
      console.error(e);
      log("Load instrument FAILED (xem probe + thử đổi CDN).");
      ui.probe.textContent += `\n\nInstrument load error:\n${String(e)}`;
      return false;
    }
  }

  // very small scheduler for progression (basic)
  let timer = 0;
  let step = 0;
  let chords = [];

  const NOTE_TO_PC = { "C":0,"C#":1,"Db":1,"D":2,"D#":3,"Eb":3,"E":4,"F":5,"F#":6,"Gb":6,"G":7,"G#":8,"Ab":8,"A":9,"A#":10,"Bb":10,"B":11 };

  function chordToPCs(symbol) {
    const s = symbol.trim();
    const rootMatch = s.match(/^([A-G])(#{1}|b{1})?/);
    if (!rootMatch) return null;
    const rootName = rootMatch[1] + (rootMatch[2] || "");
    const rootPc = NOTE_TO_PC[rootName];
    if (rootPc == null) return null;

    const rest = s.slice(rootMatch[0].length).trim().toLowerCase();
    let third = 4, fifth = 7;
    if (rest.startsWith("m") && !rest.startsWith("maj")) third = 3;
    const pcs = [rootPc, (rootPc + third) % 12, (rootPc + fifth) % 12];
    return [...new Set(pcs)];
  }

  function voice(pcs, center=60) {
    const cand = [];
    for (let oct=-2; oct<=3; oct++) {
      for (const pc of pcs) {
        const m = pc + 12*(Math.floor(center/12)+oct);
        if (m>=36 && m<=84) cand.push(m);
      }
    }
    cand.sort((a,b)=>a-b);
    // pick 3 nearest to center
    const pick = cand.map(m => ({m, d: Math.abs(m-center)})).sort((a,b)=>a.d-b.d).slice(0,3).map(x=>x.m).sort((a,b)=>a-b);
    return pick;
  }

  function parseProg(text) {
    return text.replace(/\r/g,"").split(/\n|[|]/g).map(s => s.trim()).filter(Boolean);
  }

  function playChord(symbol, when) {
    if (!instrument) return;
    const pcs = chordToPCs(symbol) || chordToPCs("C");
    const notes = voice(pcs, 60);
    const spread = 0.014;
    notes.forEach((m,i) => instrument.play(m, when + i*spread, { gain: 0.75*(1-i*0.05), duration: 0.7, attack: 0.004, release: 0.12 }));
  }

  function startProg() {
    if (!ac || !instrument) return;
    chords = parseProg(ui.prog.value);
    if (!chords.length) chords = ["C"];
    step = 0;

    const bpm = clamp(Number(ui.bpm.value)||84, 40, 220);
    const beat = 60/bpm;
    const bar = beat*4;

    const startAt = ac.currentTime + 0.08;
    playChord(chords[0], startAt);

    timer = setInterval(() => {
      step = (step + 1) % chords.length;
      playChord(chords[step], ac.currentTime + 0.06);
    }, bar*1000);

    ui.btnPlay.disabled = true;
    ui.btnStop.disabled = false;
    log("Playing progression...");
  }

  function stopProg() {
    if (timer) clearInterval(timer);
    timer = 0;
    try { instrument && instrument.stop && instrument.stop(); } catch (_) {}
    ui.btnPlay.disabled = false;
    ui.btnStop.disabled = true;
    log("Stopped.");
  }

  // Buttons
  ui.btnStart.addEventListener("click", async () => {
    ui.btnStart.disabled = true;
    try {
      await unlock();
      const ok = await loadInstrument();
      if (!ok) ui.btnStart.disabled = false;
      else {
        ui.btnProbe.disabled = false;
        ui.btnNote.disabled = false;
        ui.btnPlay.disabled = false;
      }
    } catch (e) {
      console.error(e);
      log("Start/Load error.");
      ui.btnStart.disabled = false;
    }
  });

  ui.btnProbe.addEventListener("click", async () => {
    await unlock();
    const nameToUrl = makeNameToUrl();
    const url = nameToUrl(ui.inst.value, ui.sfset.value, "mp3");
    await probeUrl(url);
  });

  ui.btnNote.addEventListener("click", async () => {
    await unlock();
    if (!instrument) { log("Chưa load instrument."); return; }
    instrument.play(60, ac.currentTime + 0.03, { gain: 0.9, duration: 0.45, attack: 0.002, release: 0.10 });
    plog("Played single note: C4 (60).");
  });

  ui.btnPlay.addEventListener("click", async () => {
    await unlock();
    startProg();
  });

  ui.btnStop.addEventListener("click", () => stopProg());

  ui.btnBeep.addEventListener("click", async () => {
    await unlock();
    const ctx = ensureAudio();
    const osc = ctx.createOscillator();
    const g = ctx.createGain();
    osc.type = "sine";
    osc.frequency.value = 880;
    g.gain.value = 0.0001;
    osc.connect(g);
    g.connect(ctx.destination);
    const t0 = ctx.currentTime;
    g.gain.setValueAtTime(0.0001, t0);
    g.gain.exponentialRampToValueAtTime(0.15, t0 + 0.02);
    g.gain.exponentialRampToValueAtTime(0.0001, t0 + 0.18);
    osc.start(t0);
    osc.stop(t0 + 0.20);
    log("Beep test fired.");
  });

  document.addEventListener("visibilitychange", () => {
    if (document.hidden) stopProg();
  });
})();
</script>
</body>
</html>